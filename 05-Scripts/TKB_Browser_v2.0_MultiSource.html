<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TKB Browser v2.0 - Multi-Source</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #3d2a1f 0%, #1f1410 100%);
            min-height: 100vh;
            padding: 20px;
            color: #fff;
        }
        .session-btn {
            padding: 12px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.2s;
        }
        .session-btn:hover { opacity: 0.9; transform: translateY(-1px); }
        .source-btn { transition: all 0.2s; }
        .source-btn:hover { opacity: 0.85; }
    </style>
</head>
<body>
    <div style="max-width: 1400px; margin: 0 auto;">
        <h1 style="text-align: center; margin-bottom: 30px; color: #9B7E52; font-size: 2.5rem;">TKB Browser v2.0 - Multi-Source</h1>

        <!-- Data Source Selector -->
        <div style="display: flex; justify-content: center; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
            <button class="source-btn active" data-source="hardcoded" onclick="switchDataSource('hardcoded')"
                    style="padding: 10px 20px; border: 2px solid #9B7E52; border-radius: 4px; background: #9B7E52; color: white; cursor: pointer; font-weight: 600;">
                Hardcoded (18)
            </button>
            <button class="source-btn" data-source="supabase" onclick="switchDataSource('supabase')"
                    style="padding: 10px 20px; border: 2px solid #9B7E52; border-radius: 4px; background: transparent; color: #9B7E52; cursor: pointer; font-weight: 600;">
                Supabase (1800+)
            </button>
            <button class="source-btn" data-source="gdrive" onclick="switchDataSource('gdrive')"
                    style="padding: 10px 20px; border: 2px solid #9B7E52; border-radius: 4px; background: transparent; color: #9B7E52; cursor: pointer; font-weight: 600;">
                Google Drive (170+)
            </button>
        </div>

        <button onclick="openTKBBrowser()" class="session-btn" style="background: linear-gradient(180deg, #9B7E52 0%, #7B6142 100%); display: block; margin: 0 auto 20px auto; font-size: 1.2rem; padding: 15px 40px;">
            Open TKB Browser (18 Real Documents)
        </button>
        <div style="text-align: center; color: #999; font-size: 0.9rem;">
            <p id="statusLine1">Connected to Google Drive</p>
            <p id="statusLine2">Real research findings loaded</p>
            <p>Click documents to open in Google Docs</p>
        </div>
    </div>

    <script>
        // ============================================
        // SUPABASE CONFIGURATION
        // ============================================
        const SUPABASE_URL = 'https://iaxtwrswinygwwwdkvok.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlheHR3cnN3aW55Z3d3d2Rrdm9rIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUyOTc4NjAsImV4cCI6MjA4MDg3Mzg2MH0.JGSdki3TtDiRS7OQrpBDuyN4nxPW1Qc9ImMunnjHFoE';

        // Initialize Supabase client (use var to avoid conflicts)
        var supabaseClient = null;

        // Initialize on page load
        window.addEventListener('DOMContentLoaded', () => {
            if (typeof supabase !== 'undefined') {
                supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                console.log('Supabase client initialized');
                document.getElementById('statusLine1').textContent = 'Supabase connected | Google Drive ready';
            } else {
                console.error('Supabase SDK not loaded');
                document.getElementById('statusLine1').textContent = 'Supabase SDK failed to load';
            }
        });

        // ============================================
        // DATA SOURCE MANAGEMENT
        // ============================================
        let currentDataSource = 'hardcoded';

        function switchDataSource(source) {
            currentDataSource = source;

            // Update button styles
            document.querySelectorAll('.source-btn').forEach(btn => {
                if (btn.dataset.source === source) {
                    btn.style.background = '#9B7E52';
                    btn.style.color = 'white';
                    btn.classList.add('active');
                } else {
                    btn.style.background = 'transparent';
                    btn.style.color = '#9B7E52';
                    btn.classList.remove('active');
                }
            });

            // Update main button text
            const mainBtn = document.querySelector('.session-btn');
            if (source === 'hardcoded') {
                mainBtn.innerHTML = 'Open TKB Browser (18 Real Documents)';
                document.getElementById('statusLine2').textContent = 'Real research findings loaded';
            } else if (source === 'supabase') {
                mainBtn.innerHTML = 'Open TKB Browser (Supabase - 1800+ Docs)';
                document.getElementById('statusLine2').textContent = 'Supabase vector database selected';
            } else if (source === 'gdrive') {
                mainBtn.innerHTML = 'Open TKB Browser (Google Drive - 170+ Docs)';
                document.getElementById('statusLine2').textContent = 'Google Drive research folder selected';
            }

            console.log('Data source switched to:', source);
        }

        // ============================================
        // HARDCODED DOCUMENTS (Original 18)
        // ============================================
        const REAL_DOCUMENTS = [
            {
                id: '1lZQbFPMkTxd9ECBAipMlLDDAYf_w-8aoMvwwWmxc6Q4',
                title: 'Webix JS UI Library & Framework',
                url: 'https://docs.google.com/document/d/1lZQbFPMkTxd9ECBAipMlLDDAYf_w-8aoMvwwWmxc6Q4/edit',
                topic: 'Implementation-Examples',
                created_at: '2025-12-17T15:49:08Z',
                summary: 'JavaScript File Manager widget for managing files hierarchically in web applications'
            },
            {
                id: '1XHwY-gNqPkZYA9UBUe53QwWFZPEl3E7DqMzBXOybqgE',
                title: 'filebrowser Web File Browser',
                url: 'https://docs.google.com/document/d/1XHwY-gNqPkZYA9UBUe53QwWFZPEl3E7DqMzBXOybqgE/edit',
                topic: 'Implementation-Examples',
                created_at: '2025-12-17T15:49:06Z',
                summary: 'Single binary web file browser for upload, delete, preview and edit. Create-your-own-cloud software.'
            },
            {
                id: '1HvLJGd1svkO7vRglvMDE11WQ746Dg6NH4r4xk0lr4FI',
                title: 'The 38 Best JavaScript Libraries and Frameworks',
                url: 'https://docs.google.com/document/d/1HvLJGd1svkO7vRglvMDE11WQ746Dg6NH4r4xk0lr4FI/edit',
                topic: 'Implementation-Examples',
                created_at: '2025-12-17T15:49:01Z',
                summary: 'User-friendly JS file management with built-in widgets, cross-platform support, fast performance.'
            },
            {
                id: '1Jxzt9PG0sT7eVgQy-YdneYfa2gdC7H98BhdRmtGKoNw',
                title: 'File Browser',
                url: 'https://docs.google.com/document/d/1Jxzt9PG0sT7eVgQy-YdneYfa2gdC7H98BhdRmtGKoNw/edit',
                topic: 'Implementation-Examples',
                created_at: '2025-12-17T15:48:58Z',
                summary: 'File managing interface with easy login, sleek interface, user management, file editing, custom commands.'
            },
            {
                id: '1mtIZ_I-NuA4SdrBY5I4o2GHIxFVDuiV9dATro8j8gys',
                title: 'Manage files in the browser in JS',
                url: 'https://docs.google.com/document/d/1mtIZ_I-NuA4SdrBY5I4o2GHIxFVDuiV9dATro8j8gys/edit',
                topic: 'Implementation-Examples',
                created_at: '2025-12-17T15:48:56Z',
                summary: 'File System API in modern browsers. Higher-level API to operate on real file system.'
            },
            {
                id: '1P6OxiFsyx5eifcECY5n1P3zFMw-RiKH_eiRDGotMBtU',
                title: 'pgvector - Open-source vector similarity search for Postgres',
                url: 'https://docs.google.com/document/d/1P6OxiFsyx5eifcECY5n1P3zFMw-RiKH_eiRDGotMBtU/edit',
                topic: 'Supabase-pgvector',
                created_at: '2025-12-17T15:48:53Z',
                summary: 'Store vectors with PostgreSQL. L2 distance, inner product, cosine distance, HNSW/IVFFlat indexes.'
            },
            {
                id: '1VDnVaBKkN9nIXn2otMc460AkfHFd9mjm2YoI0ZO3RCY',
                title: 'Vector Similarity Search with PostgreSQL and pgvector',
                url: 'https://docs.google.com/document/d/1VDnVaBKkN9nIXn2otMc460AkfHFd9mjm2YoI0ZO3RCY/edit',
                topic: 'Supabase-pgvector',
                created_at: '2025-12-17T15:48:50Z',
                summary: 'CREATE TABLE with VECTOR(3) columns. Demonstrate vector searches in PostgreSQL.'
            },
            {
                id: '19pYT1PiCk0x4u0jiRh9A5EdYEKrJ9N189s5UWpG36J0',
                title: 'pgvector Tutorial - Integrate Vector Search into PostgreSQL',
                url: 'https://docs.google.com/document/d/19pYT1PiCk0x4u0jiRh9A5EdYEKrJ9N189s5UWpG36J0/edit',
                topic: 'Supabase-pgvector',
                created_at: '2025-12-17T15:48:48Z',
                summary: 'Efficient storage, fast similarity search, exact/approximate nearest neighbor, SQL integration.'
            },
            {
                id: '12wtQShGUdvbcTfxyuZ-87v6OBvx_faDpUVqdXs5ZfeE',
                title: 'Building AI-Powered Search and RAG with PostgreSQL',
                url: 'https://docs.google.com/document/d/12wtQShGUdvbcTfxyuZ-87v6OBvx_faDpUVqdXs5ZfeE/edit',
                topic: 'RAG-Production',
                created_at: '2025-12-17T15:48:44Z',
                summary: 'Store embeddings as native VECTOR type, perform similarity searches, index vectors, combine with traditional queries.'
            },
            {
                id: '1lyCiI7EsInaYORTV71DFYIXe0cBZn4JwTBPnNcLsuOE',
                title: 'Run a vector similarity search - AlloyDB for PostgreSQL',
                url: 'https://docs.google.com/document/d/1lyCiI7EsInaYORTV71DFYIXe0cBZn4JwTBPnNcLsuOE/edit',
                topic: 'RAG-Production',
                created_at: '2025-12-17T15:48:42Z',
                summary: 'Nearest neighbor search in AlloyDB. Query for semantically similar vectors after storing embeddings.'
            },
            {
                id: '1IhMmXWVabvGJ0M2S_7zxe3P7BRXaKrWMVQpKWUYPWwk',
                title: 'subprocess - Subprocess management Python 3.14.2',
                url: 'https://docs.google.com/document/d/1IhMmXWVabvGJ0M2S_7zxe3P7BRXaKrWMVQpKWUYPWwk/edit',
                topic: 'Electron-Python-IPC',
                created_at: '2025-12-17T15:48:40Z',
                summary: 'SubprocessError, TimeoutExpired exceptions. STDOUT, STDIN, STDERR handling. Security considerations.'
            },
            {
                id: '1EJVQX2N8PGPISTObJovGHZqsDiyvkBg0v1-JGpv-nmk',
                title: 'A Guide to Python Subprocess - Stackify',
                url: 'https://docs.google.com/document/d/1EJVQX2N8PGPISTObJovGHZqsDiyvkBg0v1-JGpv-nmk/edit',
                topic: 'Electron-Python-IPC',
                created_at: '2025-12-17T15:48:35Z',
                summary: 'subprocess.call(), subprocess.check_output() with error handling. Service restart examples.'
            },
            {
                id: '174NSFZIVGzH7TvllsfYipM9iNDMJHlIaM4U5FcqKGmA',
                title: 'Errors - Node.js v25.2.1 Documentation',
                url: 'https://docs.google.com/document/d/174NSFZIVGzH7TvllsfYipM9iNDMJHlIaM4U5FcqKGmA/edit',
                topic: 'Electron-Python-IPC',
                created_at: '2025-12-17T15:48:32Z',
                summary: 'EventEmitter error handler registration, uncaughtException event, synchronous/asynchronous error handling.'
            },
            {
                id: '1yd7XWSFA_UzPBKZUlbcrVJF7J9ALDTIS7Vtt7Sg4ca8',
                title: 'Node.js Error Handling - W3Schools',
                url: 'https://docs.google.com/document/d/1yd7XWSFA_UzPBKZUlbcrVJF7J9ALDTIS7Vtt7Sg4ca8/edit',
                topic: 'Electron-Python-IPC',
                created_at: '2025-12-17T15:48:30Z',
                summary: 'Error types, patterns, best practices. Meaningful feedback, data integrity, good user experience.'
            },
            {
                id: '1WfK0AjijtPTtEu12apnRpo55ZD6G2hQwLencV2Pae8I',
                title: 'Child process - Node.js v25.2.1 Documentation',
                url: 'https://docs.google.com/document/d/1WfK0AjijtPTtEu12apnRpo55ZD6G2hQwLencV2Pae8I/edit',
                topic: 'Electron-Python-IPC',
                created_at: '2025-12-17T15:48:27Z',
                summary: 'subprocess.spawn(), subprocess.send(), callbacks with (error, stdout, stderr) arguments.'
            },
            {
                id: '1-uL8eS-u74O83W9sAfKK1JUdr3QPRmebKnK4AARf2NU',
                title: 'Correct Architecture for React based Electron application',
                url: 'https://docs.google.com/document/d/1-uL8eS-u74O83W9sAfKK1JUdr3QPRmebKnK4AARf2NU/edit',
                topic: 'Agent-Orchestration',
                created_at: '2025-12-17T15:48:25Z',
                summary: 'Architect Electron app so web and desktop applications work hand in hand.'
            },
            {
                id: '1g0JzJnxoIPDpdONgr_O4I6gPbPVr4V5H7_zyhUrpO40',
                title: 'Electron - Build cross-platform desktop apps',
                url: 'https://docs.google.com/document/d/1g0JzJnxoIPDpdONgr_O4I6gPbPVr4V5H7_zyhUrpO40/edit',
                topic: 'Agent-Orchestration',
                created_at: '2025-12-17T15:48:22Z',
                summary: 'Chromium + Node.js for desktop. Cross-platform, open-source, stable, easy development.'
            },
            {
                id: '1clxWAdH7-QoyBAUSyQkcSkGOErLTW7zhs-fOnQsWJSM',
                title: 'Plugin Architecture for Electron apps - Part 1',
                url: 'https://docs.google.com/document/d/1clxWAdH7-QoyBAUSyQkcSkGOErLTW7zhs-fOnQsWJSM/edit',
                topic: 'Agent-Orchestration',
                created_at: '2025-12-17T15:48:19Z',
                summary: 'Write desktop applications with HTML, JavaScript, CSS. Ship features faster across all operating systems.'
            }
        ];

        // ============================================
        // SUPABASE DATA LOADER (Phase 2)
        // ============================================
        async function loadSupabaseDocuments() {
            if (!supabaseClient) {
                alert('Supabase not connected. Check console for errors.');
                return [];
            }

            try {
                console.log('Loading documents from Supabase...');
                const { data, error } = await supabaseClient
                    .from('documents')
                    .select('id, title, content, document_type, metadata, created_at')
                    .limit(50);

                if (error) throw error;

                console.log('Loaded ' + data.length + ' documents from Supabase');
                return data.map(doc => ({
                    id: doc.id.toString(),
                    title: doc.title || 'Untitled',
                    url: 'https://supabase.com/dashboard/project/iaxtwrswinygwwwdkvok/editor/' + doc.id,
                    topic: doc.document_type || 'General',
                    created_at: doc.created_at || new Date().toISOString(),
                    summary: doc.content ? doc.content.substring(0, 150) + '...' : 'No summary available'
                }));
            } catch (error) {
                console.error('Supabase error:', error);
                alert('Failed to load from Supabase: ' + error.message);
                return [];
            }
        }

        // ============================================
        // GOOGLE DRIVE DATA LOADER (Phase 4 - Placeholder)
        // ============================================
        async function loadGDriveDocuments() {
            console.log('Google Drive integration coming in Phase 4');
            alert('Google Drive integration coming in Phase 4.\n\nResearch folder ID: 1GwQY0nI74Q8NeZEho0KVow43IejKhHCM\n\nFalling back to hardcoded documents.');
            return [];
        }

        // ============================================
        // MAIN TKB BROWSER FUNCTION (Now Async)
        // ============================================
        async function openTKBBrowser() {
            if (document.getElementById('tkbBrowserOverlay')) return;

            // Show loading indicator
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'tkbLoading';
            loadingDiv.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #9B7E52; color: white; padding: 20px 40px; border-radius: 8px; z-index: 10001; font-weight: 600;';
            loadingDiv.textContent = 'Loading documents...';
            document.body.appendChild(loadingDiv);

            // Default to hardcoded
            let documents = REAL_DOCUMENTS;

            // Load from selected source
            if (currentDataSource === 'supabase') {
                documents = await loadSupabaseDocuments();
                if (documents.length === 0) {
                    console.log('No documents loaded from Supabase. Falling back to hardcoded.');
                    alert('No documents loaded from Supabase. Falling back to hardcoded.');
                    documents = REAL_DOCUMENTS;
                }
            } else if (currentDataSource === 'gdrive') {
                documents = await loadGDriveDocuments();
                if (documents.length === 0) {
                    console.log('Google Drive not implemented yet. Falling back to hardcoded.');
                    documents = REAL_DOCUMENTS;
                }
            }

            // Remove loading indicator
            document.getElementById('tkbLoading').remove();

            const overlay = document.createElement('div');
            overlay.id = 'tkbBrowserOverlay';
            overlay.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.85); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 20px;';

            const panel = document.createElement('div');
            panel.style.cssText = 'background: #1a1a1a; border: 2px solid #9B7E52; border-radius: 8px; width: 90%; max-width: 1200px; height: 85%; display: flex; flex-direction: column; box-shadow: 0 10px 40px rgba(0,0,0,0.5);';

            const sourceLabel = currentDataSource === 'hardcoded' ? 'Hardcoded' :
                               currentDataSource === 'supabase' ? 'Supabase' : 'Google Drive';

            panel.innerHTML = `
                <div style="background: linear-gradient(180deg, #9B7E52 0%, #7B6142 100%); padding: 20px; border-radius: 6px 6px 0 0; display: flex; align-items: center; justify-content: space-between;">
                    <div>
                        <h2 style="margin: 0; color: #fff; font-size: 1.5rem; font-weight: 600;">TRAJANUS KNOWLEDGE BASE (TKB)</h2>
                        <div style="color: rgba(255,255,255,0.8); font-size: 0.9rem; margin-top: 5px;">Source: ${sourceLabel} | ${documents.length} documents</div>
                    </div>
                    <button onclick="closeTKBBrowser()" style="background: rgba(255,255,255,0.2); border: none; color: #fff; font-size: 1.8rem; width: 40px; height: 40px; border-radius: 4px; cursor: pointer; line-height: 1;">&times;</button>
                </div>
                <div style="padding: 20px; border-bottom: 1px solid rgba(155,126,82,0.3);">
                    <div style="display: grid; grid-template-columns: 1fr auto; gap: 15px;">
                        <input type="text" id="tkbSearch" placeholder="Search documents..." style="padding: 12px; background: rgba(0,0,0,0.4); border: 1px solid rgba(155,126,82,0.5); color: #fff; border-radius: 4px;">
                        <button onclick="refreshTKB()" class="session-btn" style="background: linear-gradient(180deg, #e8922a 0%, #cc6e1f 100%); padding: 12px 20px;">Refresh</button>
                    </div>
                </div>
                <div id="tkbList" style="flex: 1; overflow-y: auto; padding: 20px;"></div>
                <div style="padding: 15px 20px; background: rgba(0,0,0,0.3); border-top: 1px solid rgba(155,126,82,0.3); display: flex; justify-content: space-between; align-items: center;">
                    <div id="tkbCount" style="color: #999; font-size: 0.9rem;">0 documents</div>
                    <button onclick="closeTKBBrowser()" class="session-btn" style="background: rgba(155,126,82,0.3);">Close</button>
                </div>
            `;

            overlay.appendChild(panel);
            document.body.appendChild(overlay);

            window.tkbData = documents;
            renderTKBDocs(documents);
            document.getElementById('tkbSearch').addEventListener('input', searchTKB);
        }

        function closeTKBBrowser() {
            const overlay = document.getElementById('tkbBrowserOverlay');
            if (overlay) overlay.remove();
        }

        function renderTKBDocs(docs) {
            const listDiv = document.getElementById('tkbList');
            const countDiv = document.getElementById('tkbCount');

            if (!docs || docs.length === 0) {
                listDiv.innerHTML = '<div style="text-align: center; padding: 60px 20px; color: #999;"><div style="font-size: 3rem; opacity: 0.3;">No documents</div><div style="font-size: 1.2rem;">No documents found</div></div>';
                countDiv.textContent = '0 documents';
                return;
            }

            const grouped = {};
            docs.forEach(doc => {
                const topic = doc.topic || 'General';
                if (!grouped[topic]) grouped[topic] = [];
                grouped[topic].push(doc);
            });

            let html = '';
            for (const [topic, topicDocs] of Object.entries(grouped)) {
                html += `<div style="margin-bottom: 30px;"><div style="font-size: 1.2rem; font-weight: 600; color: #9B7E52; margin-bottom: 15px; padding-bottom: 8px; border-bottom: 2px solid rgba(155,126,82,0.3);">${topic} (${topicDocs.length})</div>`;

                topicDocs.forEach(doc => {
                    const date = doc.created_at ? new Date(doc.created_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) : 'Unknown date';
                    html += `
                        <div onclick="viewDoc('${doc.id}')" style="background: rgba(155,126,82,0.05); border: 1px solid rgba(155,126,82,0.2); border-radius: 4px; padding: 15px; margin-bottom: 10px; cursor: pointer; transition: all 0.2s;"
                        onmouseover="this.style.background='rgba(155,126,82,0.15)'" onmouseout="this.style.background='rgba(155,126,82,0.05)'">
                            <div style="display: flex; align-items: flex-start; justify-content: space-between;">
                                <div style="flex: 1;">
                                    <div style="font-size: 1.1rem; font-weight: 600; color: #fff; margin-bottom: 8px;">${doc.title}</div>
                                    <div style="font-size: 0.9rem; color: #ccc; margin-bottom: 8px; line-height: 1.4;">${doc.summary || 'No summary'}</div>
                                    <div style="font-size: 0.85rem; color: #999;">${date}</div>
                                </div>
                                <div style="color: #9B7E52; font-size: 1.5rem; margin-left: 15px;">-></div>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
            }

            listDiv.innerHTML = html;
            countDiv.textContent = `${docs.length} document${docs.length !== 1 ? 's' : ''}`;
        }

        function searchTKB() {
            const term = document.getElementById('tkbSearch').value.toLowerCase();
            if (!term) {
                renderTKBDocs(window.tkbData);
                return;
            }
            const filtered = window.tkbData.filter(d =>
                (d.title && d.title.toLowerCase().includes(term)) ||
                (d.summary && d.summary.toLowerCase().includes(term)) ||
                (d.topic && d.topic.toLowerCase().includes(term))
            );
            renderTKBDocs(filtered);
        }

        function refreshTKB() {
            document.getElementById('tkbSearch').value = '';
            renderTKBDocs(window.tkbData);
        }

        function viewDoc(docId) {
            const doc = window.tkbData.find(d => d.id === docId || d.id.toString() === docId);
            if (!doc) return;

            // Open document in new tab
            window.open(doc.url, '_blank');
        }
    </script>
</body>
</html>
