Title: MSPTDA 23: Two Fact Tables? DAX, Power Query or Worksheet Formulas to Convert to 1 Fact Table
Channel: excelisfun
URL: https://www.youtube.com/watch?v=Q5ATZdAihl4
Category: Excel - Data Modeling, DAX, Power Query
Duration: 1:04:59
======================================================================

[MUSIC PLAYING]

Welcome to MSPTDA video number 23. And we have an important data modeling topic. What happens when we're given two fact tables and we're required to have one fact table for the reports that we need to produce? Well, in this video, we're going to see how to solve this fundamental problem using Excel spreadsheet formulas, DAX formulas, and Power Query. Now this video is going to be a compilation of videos that I've already made-- 1493, 1494, and 1498.

In 1493, we addressed the fundamental problem. What happens when you have a fact table that lists a particular invoice? At the invoice level there is a total for shipping and there's a total for discount. But wait a second, the company keeps a second fact table where the individual product line items, from that one invoice, are listed-- 1, 2, 3 different items were sold with individual quantity and units price. We just can't make our reports, whether with a standard pivot table, Power Pivot or Power BI, because the grain is different in both tables. So in this video we're going to get to watch this one where we'll solve it using Excel formulas. Then also in this video, you'll get to see how to solve it with DAX. And finally, we'll get to see how to use Power Query inside of Power BI Desktop to take the two fact tables and convert them to a single fact table.

Now this is going to be important because BI 348 is a class at Highline. And in one of your final projects, you'll have to be able to do this and do it all three ways. You can think of this as 1, 2, 3 different movies for the price of one. But instead of popcorn, you'll want to download the files below the videos for each one of these videos and follow along. Also there's a time hyperlink table of contents below the video, so if you want to jump to any particular movie, you can jump to that movie.

Welcome to Excel Magic Trick number 1493. Hey, here is our amazing topic. But we're going to skip the title and just cut to the chase. Here it is. We have an invoice level fact table or transaction table. And we have an invoice line item transaction or fact table. And guess what? We need to take the shipping cost and invoice discount costs from the invoice level and allocate it down to the transaction line level. Now the reason we have to allocate it over here is because here's the products. That means each line in the invoice has a product. And we would like to create this report, products as the conditions or criteria and discount and total shipping, either created with a formula or with a pivot table.

Now how in the world are we going to do that? Notice, at the invoice or header level, we have the total shipping and total invoice discount. But somehow we need to allocate those amounts down to the line level so that we can use product condition or criteria either for our formulas or our pivot tables to slice the shipping cost and invoice discount amounts. All right, so this is the Excel solution. I'm going to go over to the sheet Excel Solution. Here we have our Invoice Header Fact Table, Shipping and Invoice Discount. Over here we have our Invoice Line Item Fact Table or transaction table. And over here we have our Product Lookup Table. Now we can think of the process as having three distinct steps. We need to allocate the invoice discount amount from the header invoice level over to the line level. Then we need to take shipping cost, allocate it to the correct line item level. Once we have those two columns, that means discount and shipping will be at the right granularity, then we can simply use a pivot table or formulas to slice and dice those amounts by product.

Now the way that we are going to allocate the discount and the shipping are quite different. Now we're going to start with how in the world are we going to allocate invoice discount for this one invoice to these three lines? Well, what is a discount in the first place? It is a certain percentage of the invoice total. But we have the invoice discount amount, not the percentage. If we had the percentage, we could for each line in this line item fact table multiply quantity times unit price times our percentage discount rate, then for each line we'd have the correct granularity for our discount.

Now the missing piece is if we need to calculate the percentage, we actually need a column for total sales for each invoice. Well, the total for each invoice. If we look at the line items, here's three items for the invoice that ends in 47. We just need to multiply quantity times unit price for each one of those rows. And then add them. Now we need to do that over here in the Header Invoice Table, so we can make the division and calculate our percentage. Well, the perfect function to take one column times another column given a particular condition is the SUMPRODUCT function.

So over here, right next to our data set-- by the way this is an Excel table. I've already converted it and named it. But we simply type our new field name. I'm going to call this Invoice Sales. And when I hit Enter, I immediately incorporate a new column into our Excel table, equals SUMPRODUCT. Now SUMPRODUCT is built to take array times array times array of the same size, multiply-- that's the product part-- and then add-- that's the sum part.

All right, so I want the entire quantity column. And look at this. This is an Excel table. So I'm going to use my downward pointing black arrow, click. There's the table name and the field name in square bracket. Comma. Second array, I'm going to get the unit price. There's my black downward pointing arrow. I have unit price. Comma. Now I need to pick out only the rows that match that invoice number. So I click on Invoice Number.

And for that whole column, I ask the question, how many of you are equal to-- and this is going to be the invoice number for this row in the table. Now notice the table formula nomenclature, which is the fancy word for what our ranges and references look like when we're using Excel tables. the table formula nomenclature for a relative cell reference is square brackets for the field name and then the at symbol inside of other square brackets. That means as we copy down, it will always know to get the correct invoice number. Now SUMPRODUCT has a particular problem here. That will yield an array of trues and falses. And SUMPRODUCT cannot handle trues and falses. So we need to convert that whole array to 1's and 0's And the way we do that is with any math operation. The math operation I'm going to choose is double negative. Now we have the open parentheses and close parentheses, because we have to force that equal sign to calculate before the double negative. Now why double negative? Well, a bunch of people throughout Excel history for decades have done tests. And double negative tends to work the fastest, because it's a unitary operator, especially inside of SUMPRODUCT.

But that's it. I'm going to close parentheses on SUMPRODUCT. And I want you to notice what does SUMPRODUCT do? It will take column 1 times column 2 times column 3, which is now 0's and 1's And of course the 0's will eliminate quantity times price, when it's not the correct invoice.

Now this is an Excel table column. So when I hit Enter, the formula is automatically copied down. Now I'm going to go down at least a few cells and hit the F2 key, because I want to verify that all of the cells and ranges are correct. And sure enough, they are. Now I'm going to add a new column. And I'm going to call this Percent Sales Discount. And Enter. Equal sign. The numerator is the Invoice Discount divided by Invoice Sales. Now I want you to notice something. This is an Excel table. And that's the table formula nomenclature for please get the item in this row. When we get over to DAX and even over to Power Query, the syntax is completely different. All right, I'm going to hit Enter. And that copies all the way down. And there it is for invoice 125477. That's our sales discount.

Now we can come over to our Line Item Fact Table and add a new column. And I'm going to call this Line Discount. This over here was Invoice Discount. This is the Line Discount. Enter. And now I need to look up the correct invoice sales discount. So I'm going to use VLOOKUP, the look up value. I'm looking up the invoice number. Comma. Now table array. Now watch this. Inside the table, I'm going to highlight invoice number, because remember VLOOKUP needs the first column with an item to match. And I'm going to go all the way over to Sales Discount. Now I'm going to use the keyboard Control-Shift down arrow. And then keyboard Control-backspace to jump back to the active cell. Now I want you to notice something. It actually did some heavy lifting for us. It put in the complicated table formula nomenclature for please lock that cell reference. The table name and then in double square brackets, actually field name, colon, field name in square brackets, and then brackets on the outside. Sometimes in other videos, we've had to type that out and it's a hassle. Nevertheless, we have our table. Comma. Column index. I'm counting on my fingers 1, 2, 3, 4, fifth column has the item I want to go and get and bring back to the cell. So 5. Comma. We're definitely using exact match lookup. I have this sorted, but just in case this is sorted a different way, I'm using exact match. That means I want to find exactly that invoice number. I can either put false or 0. Close parentheses. If I were to hit Enter, all it did was go and get the correct percentage sales discount for each line in this Line Transaction Table.

F2. Now I need to finish this up. Times quantity. Times unit price. Now I want to hit Enter. There, I have what I want. Now I could round this. But really I don't want to round it. And the reason why is this is an allocation. This is not dollar amount I'm paying out. So I don't really need to worry about the pennies.

All right, so we did our first allocation. Now we need to worry about shipping. Now think about shipping. Shipping is based on weight. And we're selling products, boomerang products. That's the number of quantity for each one of the products in that first invoice. But look at this. We have weight over here. So if we had total weight in this table for each one of the-- for example, the first three invoices, I could calculate the weight for each line divide it by the total weight and that would be my allocation percent to allocate shipping invoice amount.

Now this is different. Whereas, for our sales discount, we had the same sales percentage discount for each line over here for the invoice. Over here, we're going to have a different percentage because, of course, there's a different weight for each product and a different quantity. Now I'm actually going to do this in two steps. I'm first going to calculate the total weight for each line. That means right here in that cell, I need to look up for Sunbell the weight of 6.5 ounces and then multiply it by that 21. So we're going to start off. Here's our new column. This is Line Weight. And Enter. Equals VLOOKUP. We're going to look up the product name, comma, within this table right here. Now notice something about table formula nomenclature. When I highlight the whole table, it puts in just the table name. Over here we had not the whole table. So of course that was different. Comma. Column index number-- 1, 2, 3, 4. So I put a 4. Comma. I'm definitely doing exact match, so 0. Close parentheses. And Enter. Now that's not what I want. Up arrow F2. I need to multiply it times the quantity. When I hit Enter, there's our line weight. That will be the numerator for our percentage.

Now we need to come over here and at the actual invoice level, I want to calculate the total weight. This actually won't be total of the invoice weight. I'm just keeping with the same terms I used over here indicating the total. And Enter. Now let's see we have invoice number. We have invoice number here and some weight. So I simply need to add using SUMIFS, the sum range, line item over there on that table. Comma. Criteria range. Here's the invoice number. Comma. Criteria, that's going to be just the invoice. So close parentheses. And Enter. And there it is, 743. That's the total weight for that particular invoice.

Now we can allocate. Right here I'm going to take numerator, that's the weight for this line, divided by VLOOKUP to get the total invoice weight. And then I'm going to multiply it by VLOOKUP to get the invoice shipping. This column is going to be called Line Shipping. Equal. There's the line weight. Times VLOOKUP. There's the invoice number. Comma. The table array. We're going to have to do the same thing inside our table. Control-Shift down and Control-backspace. There's our locked range. Comma. Column index number. 1, 2, 3, 4, 5, the sixth column. 6 comma 0. Close parentheses. Now if I hit Enter, this gives me the totally wrong number. F2. Oh, look at that, that is not multiplication. We need to divide. Now when I hit Enter, there's the correct decimal or percentage allocation rate per line. And notice for the invoice that only had one line, of course, 1 is the correct allocation rate. Now up at the top times. And at the end, I'm simply going to multiply. Now I need to VLOOKUP. Same invoice number. Comma.

Now watch this. I'm going to cheat. I'm going to highlight, since we want just invoice shipping, just the first two cells right there. Control-Shift down arrow and Control-backspace. Comma. That would make the column index number 2. Comma 0. Close parentheses. And Enter. And there I have Line Shipping.

We have allocated shipping in our Line Discount so that we have the correct granularity. And now we can make our product report. Now there's two ways we can make our product report-- formulas and pivot tables. Pivot tables are much easier. I'm going to make sure and click in a single cell. Go up to Insert Pivot Table. Or I can use my keyboard, Alt-N-V. It got the table right. I want to put it on this existing sheet. Location cell Q23. Click OK. Scroll over. Drag product down to rows. Instantly, I get a sorted unique list, Line Discount down to Values, Line Shipping down to Values.

Right click Line Discount. Number formatting, something like currency, Enter. Right click. Number Formatting. Currency. And Enter. And there we have it, our product report for Line Discount and Line Shipping.

Now if we're going to do formulas, we have always the problem of creating this unique list. Now I'm just going to cheat. I'm going to highlight. Control-C. Come down a few rows, right click. And up here there's Paste Special Values. Now I'm going to add some formatting. All right, now I'm going to create the same calculation up here. We need to add Line Discount and Line Shipping based on the single condition in the product column. That's the perfect job for the SUMIFS function. Now SUMRANGE. Luckily I put Line Discount and Line Shipping right next to each other.

Actually, I didn't. Watch this. I'm going to cheat. I'm going to click in the top cell for Line Shipping. I should have done this before when I set the table up. Control-Shift down arrow. Control-backspace to jump back to the active cell. Now I want to move this so it's right next to Line Discount. I'm simply going to use my Move cursor. And since this is an Excel table, when I click with my Move cursor to drag, it actually knows to move the column. If we were in the spreadsheet cells, we'd have to hold Shift and click. All right, so now we have Line Discount and Line Shipping right next to each other, same order as here. So I can use the SUMIFS function and learn something for the SUMRANGE about table formula nomenclature. Now I'm going to click at the top with my black downward pointing arrow. It puts table name and in square brackets, the field name.

Now the interesting thing about table formula nomenclature is when you have just a single column is when you copy it down, it's locked. But when you copy it to the side, it automatically moves to the next column. That means when you use just a straight column in table formula nomenclature, it's actually a mixed range, locked when you go down, but free to move relatively as you move to the side. And that's exactly what we want. Comma. Criteria range. We need the product column. And we need it to be locked. Now here's what we talked about earlier in this video. How do we lock it? We can't use the F4 key, because it doesn't work. So if I don't want it to move as a relative range, I actually have to come and type open square brackets, colon, open square brackets. And I'll just down arrow to get product. Close square bracket, close square bracket. That is crazy. That's the difference between locked and mixed-- locked going down, but not to the side. Now I comma. In the criteria, a regular cell reference there. And I need it locked. So I'm going to hit the F4 key, 1, 2, 3, times. It needs to be locked across the column, but free to move when I copy it down. Close parentheses. Control-Enter.

Copy it to the side. Double click and send it down. Go to the last cell. Hit F2. I'm verifying that all of the ranges are correct. Now I'm going to highlight. Control-1. Currency. And Enter. Wow, that was a lot of fun with taking different numbers at different granularity, making sure that whatever condition or criteria we wanted have the numbers at the correct granularity. And then of course, we can make pivot table or formula reports.

Welcome to Excel magic trick number 1494. Hey, in this video we got to see how to allocate invoice header amounts to the transaction line item table. And in this video, we're going to see how to do this with DAX and Power Pivot.

Now the fundamental problem is still that we have two different transaction or fact tables. And this is an invoice level fact table where the shipping and invoice discount amounts are for the entire invoice. So the grain or level of the detail here is for the whole invoice. In this fact table, the grain or level of the amounts are at the invoice line level or the product level. And that means, if we want to use this column product to create a report that slices these amounts, we somehow need to allocate these total invoice amounts down to the line item level. Now we are using DAX and Power Pivot.

So we're actually going to have a data model. Our tables will be stored in the behind the scenes Power Pivot columnar our database. Instead of using VLOOKUP or other types of lookups, like we did in our last couple of videos, we'll have relationships. The header level fact table here, since there's only one invoice number, that's the one side. Of course, when we get down to the line item level of an invoice, we can have many lines. So that's the many side. But look at. This over here this is product. And the weight for each product is in a lookup table or a dimension table. This is the one side, because it's exactly one product and one weight for each product. Over here though, of course, we sell many of the same products many times. So this is a one to many.

This is a one to many. And the beautiful thing about the data model and relationships is we can use functions like RELATED to look up a single item on the one side or RELATEDTABLE, where we can be on the one side and for a given invoice, we can look up just the quantities, unit price, or whatever we want from this side, getting many values for one invoice and bringing it back over to the one side. Not only that, but we can use SUMX, which is an iterator, and will replace doing our huge array formulas we did the last two videos, because we can pull just the exact rows we want with RELATEDTABLE. And then SUMX will allow us to make a calculation as if it was a little mini array formula across RELATEDTABLE.

So this is going to be an exciting DAX Power Pivot video. Let's go over to the sheet DAX Power Pivot Tables. Now in order to use the data model and create calculated columns, you have to have Power Pivot. Once you have Power Pivot, you can access the data model. Now in order to bring tables of data from Excel into our data model, we actually have to first convert each one of these to Excel tables.

Now I've already converted all these by clicking in a single cell, going up to Insert, clicking table, and then very importantly, I named these. So each one of these has a smart name. I'm going to click in a single cell, go up to Power Pivot ribbon tab, and there it is, Add to the data model.

Now we have our three tables. And we want to create our relationships, which allow us to look things up on either the one side or the many side. Invoice number, this is the header level. Invoice total, so there is one invoice. Over here, this is the line item invoice detail. So when I drag this here, this is the many side, one to many. Here's a lookup table, we need to eventually look up the weight for each product. And we also need to create a report based on the criteria or filter or dimension product. This is the one side. So I drag it over to Product. That's the many side. Now once we have these relationships, we can use RELATED and RELATEDTABLE. Now remember, our ultimate goal is we need a product report that can slice and dice the total invoice shipping and discount. Well, the problem is we first from this fact table at a different granularity, we need to allocate these correctly down to this fact table, which is at the line item level or granularity. Let's go back over to Data View.

We can see the tabs down here for our three tables. We go over to the header level. Now Invoice Discount and Invoice Shipping. We're going to start with the discount amount first. How are we going to allocate this? Well, we'll have two extra DAX calculated columns where we'll calculate total sales for the invoice and the percentage discount for the invoice. Then with that percentage discount, we can use that in the other line item table to calculate the discount for each line item. All right, our first calculated column. I'm going to double click and call this Invoice Sales and Enter.

We click up in the formula bar. And what do we need to do here? Well, there's the invoice 125447. So if I could pull from the line item table just the lines for that invoice that had the units and price, and then multiply them, I could get my invoice sales total. Now remember, how we did it the last couple videos. We used the SUMPRODUCT function in Excel and had to do huge whole column array calculations.

Watch what we're going to do here. We're not going to use SUMPRODUCT. We're going to use SUMX. You first have to give it a table that it can iterate down across the rows of that table. And what do we want? We want a little mini table that only has units and discount for that invoice. So this is where we use RELATEDTABLE. Look at that highlighted in blue. I hit Tab F-L. We get down to fLineItemInvoiceDetail table. Tab. Close parentheses. Now you're not going to believe this. This RELATED table looks up from the one side over to the many side. And because there's a relationship based on that invoice, it'll bring back just the rows for that invoice.

That's much different than what we did an Excel. In Excel our array formula using SUMPRODUCT actually had to make a calculation cross every single column in the table. Instead of when we use RELATEDTABLE for this one invoice, they'll just be three rows in that table. It brings the filtered table over to SUMX. Now the second argument, I type a comma, is the expression. We need to multiply which two columns from RELATEDTABLE F-L and I'm going to use Unit Price times F-L. And I'm going to down arrow to Quantity. That is profound. We're allowed to take two columns from that RELATEDTABLE, Unit Price and Quantity, and it will multiply across the three rows just like SUMPRODUCT multiplies arrays. Internally SUMX will multiply those two columns and then the sum part will add when I hit Enter. That's the total for 125447. There's the total for the next invoice and the next one. Now we have what we want.

We have discount and total sales amount. We can calculate our percentage. Double click. Now we simply need to divide Invoice Discount by Invoice Sales. And we could do straight division. But guess what? There's a divide function in DAX. The numerator, well over here and Power Pivot I can click on Invoice Discount. It properly puts the correct syntax in, table name and field name. Now I type a comma. The denominator, invoice sales. Now when we get over to Power BI Desktop, we actually can't click on columns. We have to type it out. But over here and Power Pivot, you can click. And it properly puts table name and field name in. Now when I hit Enter, because this is a DAX calculated column, it will know to get the correct amounts from each row using something called row context and calculate the correct amount. And there we have it. There's our percentage discounts.

Now we can use these percentages over in line item invoice detail. Now we can calculate for each line. Remember, there's three different lines for that first invoice. We can calculate sales for each line and then look up from this many side to the one side to get that percentage discount. So I'll double click. And we're going to call this Line Discount. DAX calculated column. I come up here. And I'm first going to use RELATED. That RELATED is what we used when we're on the many side and we want to go get something on the one side. F-I. And there it is. Percentage Invoice Discount. Tab. Close parentheses. If I hit Enter here, that just pulls over for that invoice, three times, the correct percentage discount. Now I can multiply times quantity, times unit price, row context. When I hit Enter, it will calculate exactly the correct amount. So for the first invoice, we've taken the total amount and allocated it to each line. Now our next task is actually to use Line Discount in a pivot table and slice it by product. So I click in the measure grid, come up to the formula bar, and you first type the name of the measure. Now I'm going to call this measure, Discount on Invoice.

We have to type colon, equal sign, and then we can type our measure formula. SUM F-L. And I want the line Discount. Tab. Close parentheses. And Enter. We can see the answer down here. I want to add number formatting. So I come over to Home. There it is, Formatting. Dropdown and English. ALT-Tab to go back over to Excel. And there it is. Now we can click and drag. And there we have Discount on Invoice sliced by the product as a condition or filter or as the dimension to make our calculation. All right, so we have allocated discount and created the first part of our report. ALT-Tab. Back over here to the data model.

I want to go look at Diagram View. As we saw at the beginning of the video, if we're going to allocate shipping, weight is a way we can do that. Now eventually, we're going to have to use weight in a few different ways. We're actually going to use weight to calculate total weight for the invoice. Then we're going to have to use weight, again, times quantity for each line here. Then we can compare the two, the weight of the line to the total weight of the invoice. And that will give us the proper percentage allocation rate to allocate shipping. Now what's cool about the formula we're about to do is we're going to traverse both of the relationships, because if we need total weight over here, we're actually going to have for each invoice to go and get using related table, the quantity. So for our first invoice, as we saw, there should be three lines with quantities. But once we have that over here, we're also going to need to go and get through the second relationship, the weight of each product for each line here. Then we'll multiply them and add them. And that will give us the total invoice weight.

Back over to Data View. Over to Invoice Header. Our third column here, I'm going to double click. Now we're going to use SUMX again. And SUMX, the table, RELATEDTABLE. And we're going to get the same F-L. And there I see my line item fact table. Close parentheses. Now again, what this does is this gets the three lines from that table. But what do we want-- comma-- as the expression? Well, I definitely want from the RELATEDTABLE. F-L down arrow to Quantity. And I need to multiply it by the weight of each product for each of the three lines for this first invoice.

Here's where this is just awesome. Because we have brought RELATEDTABLE over here and that little mini table has a relationship to the product table that has weight, now we can use RELATED. But we're using RELATED off the RELATEDTABLE here. That's the many side. And now we're going to use RELATED to go to the one side to get the weight. And the product we're going to look up is weight. So I'm going to down arrow to dProduct weight. Close parentheses.

I love this. We're doing from the Header table a look up from the one side to the many side. And then once we start doing a calculation and iterating over that table, we're going to use that relationship to look up the weight. And I hit Enter. That's absolutely amazing. So here's how that formula works. From the Header table we use RELATEDTABLE table and pull line items over to the Header table. Then using RELATED, we pull over the weights then SUMX multiplies them, gets the line weight for each line in the RELATEDTABLE, then SUMX Add. That's how we get the total invoice weight. So this is a clear example of DAX and the Power Pivot Data Model solving a business problem in a much more efficient way than some crazy array formula.

Now this is the header level or the invoice level. We're going to need that 743 total invoice weight over in our line item fact table. So we'll use RELATED to get to this. Now we go back over to our line level table. And I want not Line Discount, but double click, Line Shipping. And Enter. Now for each line in the table, we have to create our allocation percentage. Then we're going to have to look up the invoice shipping amount and multiply it by our allocation rate.

Let's first look up from the header invoice level the total weight. So I use RELATED. Fact Invoice. And all the way down at the bottom is Total Weight. So we're just looking up the total weight. And we should get a repeat, 743, for each one of the repeated invoices. That's the denominator. Now we come back up to the formula bar. And right after the equals sign, we have to calculate the numerator. That means the line weight. So open parentheses. And line weight is going to be quantity times, please look up the weight for the given product. So right after the parentheses, I'm just going to click on Quantity times and looking up the weight RELATED. Now we're going to the dProduct table to get individual product weight. Tab. Close parentheses. Close parentheses on the first parentheses. And divide. Now when I hit Enter, that's the allocation rate we can use for each line. The only remaining part of this formula is for each invoice number, we have to look up the total shipping cost.

No problem. Right after the allocation percentage, I simply multiply. And this is the third RELATED we've used in this formula. F-I. And I need Invoice Shipping. Tab. Close parentheses. And Enter. And there I have allocated the total shipping for invoice 125447 across the three lines. This one, of course, there's a single line for that invoice. So that matches the total over in the header table.

Now let's create our measure, because we want to use that in our pivot table. So we come down here. Shipping on Invoice. Colon. Equal sign. SUM F-L. Line Shipping. Tab. Close parentheses. And Enter. Now we can add number formatting. Now we have our measure. Alt-Tab back over to the pivot table. And there it is our second measure. F of x, I click and drag. I love that, it brought over the number formatting and everything.

So that is our Product Report for Invoice Discount and Shipping. We saw some cool DAX formulas. Alt-Tab. in the Header Table. We calculated invoice sales using SUMX and RELATEDTABLE. We saw the divide function to divide items in the row. We also saw this amazing formula where we used SUMX, RELATEDTABLE, and RELATED to get the total weight over in the Line Item Table. We did Line Discount using RELATED in two columns. And then the formula we just did, three RELATED in one formula to calculate line shipping. We also did our measures down in the measure grid. And then our pivot table.

Welcome to a video where we'll see how to use Power Query inside Power BI Desktop to go from two fact tables into a proper star schema. Now this is actually Excel Magic 1498. But we're really not going to be using Excel proper, even though the data model is going to start in Excel. We're going to be using Power Query inside Power BI desktop. Now that said, whatever we do with Power Query in this video can also be done in Excel, Power Query and Power Pivot. So everything we do here can be done either in Power BI Desktop or over in Excel.

Now the problem is we have two fact tables and we have dimension tables, or Excel people think of these as lookup tables. These are what we use for the final reporting for filtering. And this model will not work. We have a filter that can work on this table, filters that can work on this table, and we have numbers at different granularity. So this model is not going to allow us to, in our final reporting, pull criteria from all of the tables. If we can transform this model into a proper star schema model where we have one fact table, all the numbers are at the same level or granularity, and we have many to one relationships to all of our dimension tables, then we can build whatever reports we want with the measures we want in our reports and then use any of the conditions, criteria, or filters from the dimension tables.

So our goal-- use Power Query as we're importing all of these tables to transform them into star schema and then dump it into the data model. Now I happen to have the tables here in Excel. If we go look at the Power Pivot data model over here in diagram view, that's our starting point. Now for this video, I happen to have the data model here in Excel. But you easily could have this in an SQL database, in text files, online. Wherever your starting point is, it's easy in Power Query to connect. So for us we're going to connect to this Excel data model.

Now before we jump over to Power BI Desktop and import this, let's just think about what we have to do. We want to bring two numbers, shipping cost and invoice discount, from the invoice level over to the line level. So we'll have to allocate those. We'll first calculate a percentage invoice discount rate and then use that to allocate the discount down to each line. Then we'll figure out how to allocate shipping costs based on weight and then use that to allocate shipping down to each line.

Then we're going to have to make sure and pull sales rep ID and date over from this side to the line side, so that then we can connect on this many side over to the two dimension tables over here. So it'll be a two-step process. Allocate the two numbers, then bring the many date and sales rep ID's over and connect these two dimension tables. Then we'll have everything we want, all of the numbers at the correct line, level, or granularity, and our dimension tables surrounded in a star schema. Now I'm going to close this. Now I opened up a blank Power BI Desktop model. We can see up here it's not named. For those of you that have not used Power BI Desktop, it is a free download, just download it. Now I want to save this so I'm going to hit the F12 key to open up Save As. I'm going to save it to the desktop. Call it something like that. That'll be the final name if you want to download this final file.

Now over here in Power BI Desktop, where's Power Query. It's the whole external data. This Get Data button-- this is actually over in Excel data ribbon tab, Get and Transform. You can connect to whatever data source you want before you do all these Power Query steps to transform.

We're going to connect to Excel. So I click that. I find the file. I have it on the desktop. The file you can download this. The link is below the video. Double click. Navigator opens up. Each one of these tables with that blue line at the top means these are Excel tables. Those are Excel sheets. I'm going to select each one. And we do not want to click Load. We want to click Edit, because we want to transform it before it gets dumped into the data model. So I click Edit. Here is our five tables. Now we're going to start at the fLineItemInvoiceDetail table.

And actually most of the steps we see in this video, we actually have seen the last few videos. But we're going to have to have some extra steps to make sure we end up in that star schema. All right, the very first thing we need to do is we want to calculate line item sales. So I'm going to click on Quantity. Hold Control. Click on Unit Price. Up to Add Column. Over to From Number. Standard. And I'm going to multiply. I can see the Table.AddColumn. It's important to realize that Table.AddColumn function is Power Query M Code. That's a Power Query function, not a DAX function. There's four arguments here. I want to edit the second one. So I double click multiplication. And this will be called Sales. Now in the last few videos, I called this Line Sales, because we wanted to distinguish between Invoice and Line Sales, because we had lots of steps. But this is going to be part of our final data dump. And I don't want it to say Line Sales I just want it to say Sales. And there it is. It calculated the line sales. Now we need to look up weight over in the Product table.

We go up to Home. Over to Merge. Merge queries. Here's the product. This is the many side. We're going to select dProduct. This is the one side. We're going to do a Left Outer join to bring in all of the proper weights for each line. Click OK. We want to expand because the only thing we want-- uncheck that, uncheck everything-- is weight. Click OK.

Now that we have weight, we're going to click on that. Hold Control. Click on Quantity. Backup to Add Columns. And we'll use Multiply. Double click. And we're going to call this Line Weight. And Enter. Now our next step is we need to add each line sale and line weight. That means for each invoice, we're going to have to add. So for 125477, we're going to have to add sales and line weight. Now once we have the total sales for an invoice and total weight for an invoice, we can use those numbers as the denominator to create an allocation rate to allocate the shipping and discount. That means we're going to have to come over to the invoice number column and use Group By to make an aggregation on line sales and line weight.

And guess what? We're going to need the line sales and the line weight and the product column later in our query. So we're also, when we Group By, going to group the actual rows or records. So we'll have three Group By's. Aggregate sum. Aggregate sum. And please take all of the records and save them for later calculations. So I come over to Invoice Number. Right click. Group By. Advanced. Down to New Column. And the first column name, Invoice Sales. We'll Sum. And we'll add up the sales, which is the line sales. Add aggregation. This will be called Invoice Weight. Sum. We want line weight. And now add aggregation. And this will be something like Invoice Records. And we're going to take all the rows. Click OK. For each invoice, we now have exactly what we want-- invoice sales, weight. And if I click off to the side, not on the yellow table, there's the records saved up where I can expand this column later in the query and use these columns. Now this table is currently sitting at the header invoice level. We're saving these up later, because later we're going to have to go back to for the final fact table, back to the line level.

But now we need to join this header invoice level table to the header table, because we need to pull the two numbers at the header invoice level and the date and sales rep ID on the many side so we can connect later to sales rep and date. So I go up to Home, over to Merge, Merge. Here's our invoice number that's going to connect to our header table invoice number, this is in essence a one-to-one. It's going to pull one record for each one record. Left Outer join this fine. Click OK. Now we have two tables. This one we're saving up for later. But down here we can see date, sales reps, shipping cost, and invoice. So I click to expand. Uncheck invoice number. We only need date, sales rep, and these two numbers. Click OK. Date and sales rep ID. These are the foreign keys on the many side. We'll use those later to connect to our dimension tables. Now look at this. We have, if we click on Invoice Discount, that's going to be used in the numerator. I hold Control click. That's the second click on Invoice Sales.

I want to Calculate Invoice Percentage Discount. Add Column. Standard. And we're going to divide. Because we clicked on Invoice Discount first, it's the numerator. Double click. And the second argument of Table.AddColumn we're going to call this Invoice Percent Discount. And Enter. Now if we scroll over here, that percentage can be used. That's how many pennies for every $1.00 of sales was given as a discount. So we can use that later when we expand back to the line level. And we'll use that on each line. The weight, however, if I click over on Invoice Records, notice if we're going to allocate this shipping costs, so 98.7 for this invoice on this row, we're going to allocate that, we're going to use 743 in the denominator and then each one of the weights, a different weight for each line in the numerator. So we'll have a different percentage for each line. And the total percentages will add up to, of course, 100%. And that will be what we use to allocate shipping cost.

All right, so we're ready to expand. We're going to click the Expand. Uncheck everything. We definitely need Line Weight, Sales. And we're going to need Product. That'll be our foreign key on the many side that will connect us to the Product Dimension table. Now we have to choose. We might want Quantity, if we're going to analyze that. And by the way, this Unit Price sometimes unit price is stored as a fact, which it is here, because it changes so often. If it didn't change a lot, then we'd store it over in the Product table. Now if you're going to analyze this like the max or min or something like that, you might want to bring that in. We're not going to bring this one in. And we're not going to bring Weight either, because we don't need that at all. Now I click OK. And if we scroll over, we can see there we're back to the line item level. Now Product we'll actually use as a foreign key to connect to the product dimension table. Quantity and Sales will be in our final fact table. We might want to analyze quantity. We're definitely going to use Sales in a calculation in just a moment. And we'll use it as a final column. Weight will only be used in a calculation before we get to the final fact table. Now I want to change the data types here. So I'm going to click ABC icon for data type. This is going to be text. Notice, it added a line here. We'll do the same thing for Quantity. This is whole number. Sales, this will be fixed decimal or currency.

Notice they all got consolidated into one step. We can see up here in the Table.TransformColumnTypes, Product Quantity and Sales with the correct data type. Now one advantage of doing this step right here is Sales, we're actually going to use it in a subsequent multiplication calculation. And because this is currency, Table.AddColumn will correctly apply currency when we calculate discount. So yes, in the next two steps, we need to allocate Shipping and Invoice Discount. All right, let's do Invoice Discount. That simply is invoice percentage discount. Hold Control. Over to sales.

Add column. Standard. Dropdown. And multiply. We can see Table.AddColumn. It got currency at the end. We definitely want to double click. And this will be a final column called Discount. And Enter. If I scroll over there, we have allocated 1, 2, 3 lines in the line item table to split up that 144. Now we need to add a custom column to allocate our shipping costs. So we're going to go up to Add columns. Custom columns. We'll call this Shipping. And our formula, actually, I forgot to round. We'll go back and round. Here we're going to round. So we're using Number.Round. Open parentheses in our calculation. First is the allocation rate. So I take line weight. Double click. There it is. That's the numerator. Divided by invoice weight. That's the denominator. That will give us the proper percentage for each line. And we'll multiply it by shipping cost, which, of course, got properly repeated three times when we expanded the records for each invoice. Now comma 2, because we want to round to the penny. Close parentheses. Now when I click OK, we can look up in the formula bar, there's Table.AddColumn. There's the previous step that this line acted on, the name. There's each calculation for each row. But it left the type out. So at the very end, I'm going to just type it in. Comma. And I notice from the last step-- we should have looked at it. But when we changed the type for currency, it's Currency.Type.

Now hopefully, I spelled it right. And got the big C and the big T. And I hit Enter. There we are, rounded with the correct data type. Now let's come back to insert multiplication right here, which is really just the discount. I forgot I wanted to round. So I'm going to edit Table.AddColumn after the each. Number.Round. Open parentheses. Comma. 2. Close parentheses. And Enter. One difference between doing this over here in Power Query is that Round function actually does banker's rounding or halfway even rounding, which is more accurate over large columns of numbers than is the Round function inside of Excel and DAX. So if we did the rounding over in DAX and compared it to this column here in Power Query, we'd be off by a few pennies, maybe even up to $1.00. All right, we click the right at the bottom. We can see we have 1, 2, our allocated shipping and discount for each line. Now we want to only have some of these columns in the final fact table. Now Invoice Number, you may or may not want that. I'm going to leave it. Invoice Sales, we definitely don't want. We don't want Invoice Weight. Product, I do. So I'm holding Control, clicking on Product. Quantity. Sales. Don't want Line. Date. Sales rep ID.

Still holding Control. Still holding Control. I don't want any of these. But I do want Discount and Shipping. Any one of these columns, right click. Remove all other columns. Click. And there is our final line item fact table. We went from two fact tables down to a single table and allocated discount and shipping and calculated the sales. Now I don't need-- when I load this into the data model, I don't want this invoice header to be loaded.

So I'm going to come to the left, right click. And I'm going to uncheck Enable Load. That way that little italic right there means that was just used as part of this Power Query transformation. Now here is the moment of truth. We can come up and Close and Apply. We can see the four tables are being loaded. And if we go over to Relationships View, there is our almost correct model. There is our one fact table. Their Sales Rep. There's Product. Those ones were picked up correctly-- Product and Sales Rep. But this one, we're going to drag Date over to Date. And there we have 1, 2, 3 dimension tables. And we might have more also. And our one fact table. Now I want to go and add some measures before we create a visualization. Selecting Line Item Table.

Model a New Measure. Up in the formula bar, total sales equal SUM. And we're going to do the F down arrow to sales. Tab. Close parentheses. And Enter. Modeling. We're going to add and attach some number formatting. So whenever we use this measure, number formatting will be applied. We can see over here in our list of items in this table, that icon. That's a little calculator means measure. New measure. So our total discount sum. And we're going to add up. There it is, our discount. Close parentheses. Enter. Add some number formatting. A new measure. Total shipping equals SUM f and then down arrow to shipping. Tab. Close parentheses. And Enter. Add some number formatting.

Now I'd actually like to compare Discount and Shipping to Sales. So we're going to add two more measures, which basically divide each of those items against Sales, so something like Percentage Discount on Sales. And I'm going to use that divide function. In the numerator, now we've created measures for our aggregation. So I type a square bracket. So total discount. I see it there, so tab. Comma. Denominator. Square bracket. Total sales. Tab. Close parentheses. And Enter. New measure something like Percent Shipping on Sales. Divide. Square bracket. I'm going to get total shipping as a measure. Comma. Square bracket. And there's total sales. Tab. Close parentheses. And Enter. Now I definitely want number formatting for both of these. So I'm going to click the percentage. And over here in Power BI Desktop, it'll add two decimals by default. Click over on Percentage Discount. Add the same percentage number formatting. Now I'm going to come over to Line Item Sales and right click Date and point to Hide and Report view. I do not want to use that field. Same with Discount, Hide and Report view. Now we have built our model.

If we go over here, star schema. Now we can use these measures. And any one of these dimension tables, conditions, criteria, filters will work on our measures. Now we go over to report view. And we want to make a simple visualization. Now here's our tables. We can expand. And notice that we only see our measures in our line item fact table. And then here are each one of the dimension tables. Now we're going to select Table. And I'm going to pull a conditional criteria from Product. Selecting Product, we see a unique list there. Now I'm going to select with a check box Total Sales, Total Shipping, Percent Shipping, Total Discount, and Percent Discount. We can come over and pull the edge. Here's our simple visualization. We're going to come up. And there's the paintbrush for painting the wall of your house or adding formatting to our visualization. Table style, I'm going to click the dropdown and select flashy rows, the grid. We're going to increase the font, maybe to 12. Pull down the edge here. Some more formatting, perhaps. You can format it however you'd like. Column headers. Background color, I'm going to pick some dark green. And then font, white. All right, now we want to surround it with some slicers. So off to the side, I click on the white and I click on the slicer. Let's go to the data. All I want is year. I do not want that slider. Come over to the paintbrush. Slider off. Click and drag.

Now you would think that over here somewhere would be the ability to turn this into a list. But sometimes you have to hunt around, especially as Excel people. If you click the dropdown, oh, there are some options. And the List is the one I want. That looks like a little slicer. I'm going to drag Year over here. This is a big list. So I'm going to drag it over here. Click and drag. And now here are all the measures from our one fact table. I can select the year. Instantly that works. Select the particular manufacturer and some employees. If I hold Control, those are the employees on the particular team I want to see, 2018-19 gel boomerangs.

And our one fact table with all of our measures can be sliced and diced with any of the dimension tables. All right, so in this video, we saw how to go from two fact tables into the star schema. We learned all about it. And we can actually access and edit the Power Query transformation at any time clicking Edit queries. Over here we did all of these steps, transforming from two fact tables and dimension tables into our star schema. Then we created some measures and built a simple visualization.

All right, if you liked that video, "Two Fact Tables Into One Fact Table Using Excel, DAX, or Power Query," click that thumbs, up leave a comment, and subscribe, because there's always a lots more videos to come from Excelisfun. We'll see you next MSPTDA.
