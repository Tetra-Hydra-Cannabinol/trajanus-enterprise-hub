# Trajanus Command Center - Project Context

## Project Overview
- **Name:** Trajanus Enterprise Hub
- **Type:** Electron Desktop Application
- **Purpose:** AI-augmented construction project management platform for federal/military projects (USACE, DoD)
- **Tech Stack:** Electron 28.0.0, HTML/CSS/JavaScript, Node.js
- **Current Status:** Operational (Electron fixed, KB IPC integrated 2025-12-14)
- **Owner:** Bill King, PMP, CQM-C - Trajanus USA

## Architecture

### File Structure
```
G:\My Drive\00 - Trajanus USA\00-Command-Center\
├── main.js                 # Electron main process
├── preload.js              # IPC bridge (main <-> renderer)
├── index.html              # Primary UI (~5000+ lines)
├── package.json            # Dependencies and scripts
├── .env                    # Supabase credentials
├── .claude.md              # THIS FILE - Project context
├── changelog.md            # Decision log and lessons learned
├── plan.md                 # Current task tracking
├── playwright-research.md  # Playwright MCP research
├── playwright-validation-workflow.md  # UI testing workflow
├── test-playwright-electron.js  # Screenshot test script
│
├── services/               # Backend service modules
│   └── kb-service.js       # Supabase KB integration
├── screenshots/            # Playwright test screenshots
├── test-kb-ipc.js          # KB integration test script
├── 05-Scripts/             # Python automation scripts
├── Archive/                # Historical backups
├── Index-Backups/          # index.html version backups
├── Reference-Original-2025-11-30/  # Original reference files
├── Documentation/          # Session summaries, journals
├── Session-Logs/           # Session tracking
├── MASTER_DOCUMENTS/       # Google Doc links
├── Credentials/            # API keys, tokens
├── assets/                 # Icons and images
└── node_modules/           # Dependencies (DO NOT DELETE)
```

### Core Files

#### main.js (Electron Main Process)
- **Location:** `G:\My Drive\00 - Trajanus USA\00-Command-Center\main.js`
- **Lines:** ~340
- **Purpose:** Electron entry point, IPC handlers
- **Key Functions:**
  - `createWindow()` - Creates main BrowserWindow (1600x1000)
  - IPC Handlers:
    - `list-directory` - File browser functionality
    - `run-command` - Shell command execution
    - `run-python-script` - Python script runner
    - `open-external` - Opens URLs in default browser
    - `open-file` - Opens files with default app
    - `show-in-folder` - Shows file in Explorer
    - `show-open-dialog` / `show-save-dialog` - File dialogs
    - `read-file` / `write-file` - File operations
    - `get-app-info` - Returns version/platform info
  - **KB IPC Handlers (added 2025-12-14):**
    - `kb:search` - Search knowledge base
    - `kb:listSources` - List all document sources
    - `kb:getByUrl` - Get document by URL
    - `kb:browseBySource` - Browse by category
    - `kb:getRecent` - Get recent documents
    - `kb:getCategories` - Get source categories
    - `kb:testConnection` - Test Supabase connection

#### preload.js (IPC Bridge)
- **Location:** `G:\My Drive\00 - Trajanus USA\00-Command-Center\preload.js`
- **Lines:** ~160
- **Purpose:** Securely exposes IPC methods to renderer
- **window.electronAPI Methods:**
  - `listDirectory(path)` - List directory contents
  - `runCommand(command)` - Run shell command
  - `runPythonScript(scriptName, args)` - Run Python script
  - `openExternal(url)` - Open URL
  - `openFile(filePath)` - Open file
  - `showInFolder(filePath)` - Show in Explorer
  - `showOpenDialog(options)` / `showSaveDialog(options)` - Dialogs
  - `readFile(filePath)` / `writeFile(filePath, content)` - File I/O
  - `getAppInfo()` - Get app metadata
- **window.kb Methods (Knowledge Base - added 2025-12-14):**
  - `kb.search(query, options)` - Search knowledge base
  - `kb.listSources()` - List all document sources
  - `kb.getByUrl(url)` - Get document chunks by URL
  - `kb.browseBySource(source, limit)` - Browse by category
  - `kb.getRecent(limit)` - Get recent documents
  - `kb.getCategories()` - Get source categories
  - `kb.testConnection()` - Test Supabase connection

#### index.html (Primary UI)
- **Location:** `G:\My Drive\00 - Trajanus USA\00-Command-Center\index.html`
- **Lines:** ~5000+
- **Purpose:** All UI, styles, and client-side JavaScript
- **Structure:**
  - CSS variables (`:root`) - Brown/orange/cream color scheme
  - Sidebar with project buttons
  - Main workspace area with tabbed interface
  - Terminal-style tool panels
  - QCM Submittal Review Workspace

### Workspaces (All in index.html)

1. **Developer Workspace v2.0.0**
   - Development utilities, learning resources, code tools
   - Terminal interface for script execution
   - Developer mode toggle

2. **PM Toolkit v1.0.0 / v2.1.3**
   - Project management suite for construction oversight
   - Active projects: Guatemala SOUTHCOM, Fort Liberty, Fort Campbell

3. **QCM Toolkit v1.0.0 / v2.0.5**
   - Quality control and inspection management
   - Active on 2 DoD projects
   - Submittal Review workspace

4. **QCM Submittal Review Workspace**
   - Interactive document review
   - File browser (Supabase KB / Google Drive tabs)
   - Template and reference document selection
   - Claude integration for review assistance
   - **Key Functions:**
     - `openQCMWorkspace()` - Opens workspace
     - `loadBrowserFiles()` - Loads file browser
     - `switchBrowserTab(mode)` - Switches between KB/GDrive
     - `addSelectedFilesToProject()` - Adds files to review
     - `saveQCMSetup()` / `loadQCMSetup()` - Persist workspace state

## Technical Details

### Startup Process
1. `npm start` runs `electron .`
2. `main.js` loaded by Electron
3. `createWindow()` creates BrowserWindow with `preload.js`
4. `index.html` loaded into window
5. DevTools opened automatically (line 30 in main.js)
6. IPC handlers registered for renderer communication

### Dependencies (package.json)
```json
{
  "dependencies": {
    "@supabase/supabase-js": "^2.39.0"  // NOT YET USED - integration pending
  },
  "devDependencies": {
    "electron": "^28.0.0",
    "electron-builder": "^24.9.1"
  }
}
```

### Environment Variables (.env)
- `SUPABASE_URL` - Supabase project URL
- `SUPABASE_ANON_KEY` - Public anon key for Supabase
- **Status:** Credentials present but NOT integrated into main.js

## Known Issues & Constraints

### Google Drive + npm (CRITICAL)
- **Problem:** Running `npm install` on Google Drive causes TAR_ENTRY_ERROR
- **Cause:** Google Drive File Stream locks files during extraction
- **Impact:** Cannot add/update npm packages normally
- **Solution:**
  1. NEVER run `npm install` directly on Google Drive
  2. Use existing node_modules only
  3. If new packages needed: copy project to local drive, install, copy back

### Electron Launch Requirements
- Requires `node_modules/.bin/electron.cmd` shim
- Requires `node_modules/electron/dist/electron.exe` binary
- If corrupted: manually recreate .bin shims or reinstall electron on local drive
- **Fallback:** `node node_modules\electron\cli.js .`

### Supabase Integration (COMPLETE)
- **Status:** ✅ Fully integrated via IPC (TASK-010 completed 2025-12-14)
- **Service Module:** `services/kb-service.js`
- **IPC Handlers:** 7 handlers in main.js (kb:search, kb:listSources, etc.)
- **Renderer API:** `window.kb` object exposed via preload.js
- **MCP Access:** Also available via trajanus-kb MCP

### Supabase Status (as of 2025-12-14)

**Connection:** ✅ Working (IPC + MCP)
**Schema:** ✅ Production ready
**Data:** ✅ 1,805 rows, 84 documents
**Embeddings:** ✅ 99.9% coverage
**IPC Integration:** ✅ Complete (6/6 tests passed)

**Table:** `knowledge_base`
- Columns: id, url, chunk_number, title, summary, content, metadata, embedding
- Embeddings: vector(1536) - OpenAI text-embedding-3-small
- RPC functions: match_knowledge_base, list_knowledge_sources, search_by_text, get_url_content

**Test Script:** `node test-kb-ipc.js` - Verifies all KB operations
**Full Report:** TASK-005_Supabase_Schema_Report.md

### Trajanus KB MCP
- **Status:** Connected and working
- **Script:** `05-Scripts/kb_mcp_server.py`
- **Tools Available:**
  - `search_knowledge_base` - Text search across title, summary, content
  - `list_knowledge_sources` - List all documents in KB
- **Usage:** Search is automatic when Claude Code needs KB info
- **Note:** Uses text search (ilike), not vector embeddings (no OpenAI key)

## Design Decisions

### Why Electron?
- Desktop app provides file system access for construction documents
- Offline capability for job site use
- Integration with local tools (MS Office, file browsers)
- Claude Code integration for AI-assisted workflows

### Why Google Drive for Storage?
- Sync across devices (office, job site)
- Bill's existing workflow uses Google Drive
- Collaboration with team members
- **Trade-off:** npm operations are problematic

### Why Single index.html?
- All UI in one file for simplicity
- Easy to backup/restore (single file)
- No build step required
- **Trade-off:** File is large (~5000+ lines)

## Playwright MCP & Testing

### MCP Configuration
- **Status:** Installed and connected
- **Scope:** User (available across all projects)
- **Config:** `~/.claude.json`
- **Command:** `claude mcp add playwright -s user npx @playwright/mcp@latest`
- **Verify:** `claude mcp list`

### Electron Testing Setup
Since standard Playwright MCP controls browsers (not Electron apps), we use Playwright's native Electron API:

**Playwright Location:** `C:\temp\electron-fix\` (cannot npm install on Google Drive)

**Run Screenshot Test:**
```powershell
cd "C:\temp\electron-fix"
node test-playwright-electron.js
```

### Common Playwright Commands
```javascript
const { _electron: electron } = require('playwright');

// Launch app
const electronApp = await electron.launch({
  args: ['G:\\My Drive\\00 - Trajanus USA\\00-Command-Center'],
  executablePath: 'node_modules/electron/dist/electron.exe'
});

// Get window
const window = await electronApp.firstWindow();

// Screenshot
await window.screenshot({ path: 'screenshot.png' });

// Navigate
await window.click('text=QCM');

// Viewport testing
await window.setViewportSize({ width: 1920, height: 1080 });

// Close
await electronApp.close();
```

### Screenshots Directory
- **Location:** `screenshots/`
- **Files:** main-window.png, qcm-workspace.png, viewport-*.png
- **Workflow:** See `playwright-validation-workflow.md`

## Important Locations

### Backup Files
- **Golden backup:** `Index-Backups/index_GOLDEN_BACKUP_20251205.html`
- **Pre-Supabase:** `index_ARCHIVE_2025-12-12_1700_BeforeFunctionRename.html`
- **Archive folder:** `Archive/Trajanus_COMPLETE_Archive_2025-12-07/`

### Backup Naming Convention
- `index_BACKUP_YYYY-MM-DD_HHMM_Description.html`
- `index_ARCHIVE_YYYY-MM-DD_HHMM_Description.html`
- `index_v#.#.#_Description.html`

## Development Workflow

### How to Launch
```powershell
cd "G:\My Drive\00 - Trajanus USA\00-Command-Center"
npm start
```

### How to Backup Before Changes
```powershell
# Copy current index.html to backup
Copy-Item "index.html" "index_BACKUP_$(Get-Date -Format 'yyyy-MM-dd_HHmm')_BeforeChangeName.html"
```

### How to Restore from Backup
```powershell
Copy-Item "index_BACKUP_NAME.html" "index.html" -Force
```

## Integration Points

### Supabase Knowledge Base
- **Table:** `knowledge_base`
- **Columns:** id, url, chunk_number, title, summary, content, metadata, embedding
- **Status:** NOT INTEGRATED - handlers need to be added to main.js
- **Credentials:** In .env file

### Google Drive File Browser
- Uses `electronAPI.listDirectory()` for folder navigation
- Root path: `G:\My Drive\00 - Trajanus USA`
- Document filter: .pdf, .docx, .gdoc, .md, .xlsx, .xls

### Claude AI Assistant
- Interface in QCM workspace for document review
- Currently placeholder - not connected to Claude API

## Quick Reference

### Find QCM Workspace Initialization
- **File:** index.html
- **Function:** `openQCMWorkspace()` (~line 5785)
- **Workspace Container ID:** `terminal-qcm-submittal`

### Find File Browser Logic
- **File:** index.html
- **Functions:** `loadBrowserFiles()`, `switchBrowserTab()`, `renderBrowserFiles()`
- **Modes:** 'kb' (Supabase), 'gdrive' (file system)

### Find IPC Handler
- **File:** main.js
- **Pattern:** `ipcMain.handle('handler-name', async (event, ...args) => { })`

### Add New IPC Handler
1. Add handler in main.js: `ipcMain.handle('new-handler', async (event) => { })`
2. Expose in preload.js: `newHandler: () => ipcRenderer.invoke('new-handler')`
3. Call in index.html: `await window.electronAPI.newHandler()`

## Next Steps
1. ~~Fix Electron launch~~ - COMPLETED 2025-12-14
2. ~~Install Playwright MCP~~ - COMPLETED 2025-12-14
3. Properly integrate Supabase with direct table queries
4. Connect Claude Assistant to actual Claude API
5. Complete QCM workflow with document review

## References
- **TKB:** `G:\My Drive\00 - Trajanus USA\TKB-Trajanus-Knowledge-Base\`
- **Operational Protocols:** See 02-Core-Protocols folder
- **Session History:** Check changelog.md

---
**Last Updated:** 2025-12-14
**Maintained By:** Claude Code
**Status:** Active Development
