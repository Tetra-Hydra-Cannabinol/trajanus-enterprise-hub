<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Developer Toolkit - Trajanus EI</title>
    <link rel="stylesheet" href="../styles/main.css">
    <style>
        /* Developer Toolkit - 4 Panel Layout */
        .dev-wrapper {
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
            background: var(--bg-base);
        }

        .dev-main {
            flex: 1;
            padding: var(--space-md);
            padding-top: calc(60px + var(--space-md));
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .panel-grid {
            flex: 1;
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 1fr 1fr;
            gap: var(--space-md);
            min-height: 0;
        }

        .panel {
            display: flex;
            flex-direction: column;
            min-height: 0;
            overflow: hidden;
            background: var(--bg-card);
            border: 1px solid var(--bg-elevated);
            border-radius: 8px;
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: var(--bg-surface);
            border-bottom: 1px solid var(--bg-elevated);
            flex-shrink: 0;
        }

        .panel-title {
            color: var(--accent-gold);
            font-size: 0.8rem;
            font-weight: 600;
            letter-spacing: 0.1em;
            text-transform: uppercase;
        }

        .panel-actions {
            display: flex;
            gap: 8px;
        }

        .panel-btn {
            background: transparent;
            border: 1px solid var(--border-subtle);
            color: var(--text-muted);
            padding: 4px 12px;
            font-size: 0.75rem;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .panel-btn:hover {
            border-color: var(--accent-gold);
            color: var(--accent-gold);
        }

        .panel-content {
            flex: 1;
            overflow-y: auto;
            min-height: 0;
        }

        /* Chat Panel */
        .chat-panel .panel-content {
            display: flex;
            flex-direction: column;
            padding: 0;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: var(--space-md);
            display: flex;
            flex-direction: column;
            gap: var(--space-md);
        }

        .chat-welcome {
            color: var(--text-muted);
            text-align: center;
            padding: var(--space-xl);
            line-height: 1.6;
        }

        .message {
            max-width: 90%;
            padding: 12px 16px;
            border-radius: 8px;
            line-height: 1.6;
            font-size: 0.9rem;
        }

        .message.user {
            align-self: flex-end;
            background: var(--accent-gold);
            color: var(--bg-base);
        }

        .message.assistant {
            align-self: flex-start;
            background: var(--bg-elevated);
            color: var(--text-white);
            border-left: 3px solid var(--accent-gold);
        }

        .message pre {
            background: var(--bg-surface);
            padding: var(--space-md);
            border-radius: 4px;
            overflow-x: auto;
            margin: var(--space-sm) 0;
            font-family: var(--font-mono);
            font-size: 0.85rem;
        }

        .message code {
            font-family: var(--font-mono);
            background: var(--bg-surface);
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.85rem;
        }

        .message pre code {
            background: transparent;
            padding: 0;
        }

        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 12px 16px;
            align-self: flex-start;
        }

        .typing-indicator span {
            width: 8px;
            height: 8px;
            background: var(--accent-gold);
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }

        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); opacity: 0.4; }
            30% { transform: translateY(-4px); opacity: 1; }
        }

        .chat-input-area {
            padding: var(--space-md);
            background: var(--bg-surface);
            border-top: 1px solid var(--bg-elevated);
            display: flex;
            gap: var(--space-sm);
            flex-shrink: 0;
        }

        .chat-input-area textarea {
            flex: 1;
            background: var(--bg-input);
            border: 1px solid var(--bg-elevated);
            color: var(--text-white);
            padding: 12px;
            border-radius: 4px;
            resize: none;
            font-family: inherit;
            font-size: 0.9rem;
            min-height: 60px;
            max-height: 150px;
        }

        .chat-input-area textarea:focus {
            outline: none;
            border-color: var(--accent-gold);
        }

        .chat-input-area textarea::placeholder {
            color: var(--text-muted);
        }

        /* Script Browser */
        .script-list {
            display: flex;
            flex-direction: column;
            gap: var(--space-sm);
            padding: var(--space-md);
        }

        .script-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--space-sm) var(--space-md);
            background: var(--bg-surface);
            border-radius: 4px;
            border: 1px solid var(--bg-elevated);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .script-item:hover {
            background: var(--bg-elevated);
            border-color: var(--accent-gold);
        }

        .script-name {
            color: var(--text-white);
            font-size: 0.85rem;
        }

        .script-run {
            background: var(--accent-gold);
            color: var(--bg-base);
            border: none;
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .script-run:hover {
            background: var(--accent-hover);
        }

        /* Document Viewer */
        .doc-empty {
            color: var(--text-muted);
            text-align: center;
            padding: var(--space-xl);
        }

        .doc-content {
            font-family: var(--font-mono);
            font-size: 0.85rem;
            line-height: 1.6;
            white-space: pre-wrap;
            color: var(--text-white);
            padding: var(--space-md);
        }

        /* Output Panel */
        .output-content {
            font-family: var(--font-mono);
            font-size: 0.8rem;
            line-height: 1.6;
            color: var(--text-white);
            padding: var(--space-md);
        }

        .output-line {
            padding: 2px 0;
        }

        .output-line.info { color: var(--text-muted); }
        .output-line.success { color: var(--status-success); }
        .output-line.error { color: var(--status-error); }
        .output-line.warning { color: var(--status-warning); }

        /* Session Tools Bar */
        .session-bar {
            display: flex;
            gap: var(--space-md);
            padding: var(--space-md);
            background: var(--bg-surface);
            border-top: 1px solid var(--bg-elevated);
            flex-wrap: wrap;
            flex-shrink: 0;
        }

        .session-bar .tool-button {
            padding: 8px 16px;
            font-size: 0.8rem;
        }

        /* Responsive */
        @media (max-width: 1199px) {
            .panel-grid {
                grid-template-columns: 1fr;
                grid-template-rows: repeat(4, minmax(250px, 1fr));
            }
        }
    </style>
</head>
<body>
    <div class="dev-wrapper">
        <!-- Header -->
        <header class="workspace-header">
            <div class="workspace-header-left">
                <a href="../index.html" class="home-button">
                    <span class="home-icon">&#9670;</span>
                    <span>Hub</span>
                </a>
                <h1 class="workspace-title">Developer Toolkit</h1>
            </div>
            <div class="header-controls">
                <button class="header-icon-btn" title="Settings">&#9881;</button>
            </div>
        </header>

        <!-- Main 4-Panel Layout -->
        <main class="dev-main">
            <div class="panel-grid">
                <!-- Panel 1: Claude Full Chat -->
                <div class="panel chat-panel">
                    <div class="panel-header">
                        <span class="panel-title">Claude Full Chat</span>
                        <div class="panel-actions">
                            <button class="panel-btn" onclick="Chat.newConversation()">New</button>
                            <button class="panel-btn" onclick="Chat.exportConversation()">Export</button>
                            <button class="panel-btn" onclick="Chat.clear()">Clear</button>
                        </div>
                    </div>
                    <div class="panel-content">
                        <div class="chat-messages" id="chatMessages">
                            <div class="chat-welcome">
                                Welcome to Claude Full Chat. This is your AI workspace for extended conversations,
                                research, planning, and document generation.<br><br>
                                This is Trajanus Engineered Intelligence (EI).
                            </div>
                        </div>
                        <div class="chat-input-area">
                            <textarea id="chatInput" placeholder="Message Claude..." rows="3" onkeydown="Chat.handleKeydown(event)"></textarea>
                            <button class="tool-button primary" id="sendBtn" onclick="Chat.send()">Send</button>
                        </div>
                    </div>
                </div>

                <!-- Panel 2: Document Viewer -->
                <div class="panel">
                    <div class="panel-header">
                        <span class="panel-title">Document Viewer</span>
                        <div class="panel-actions">
                            <button class="panel-btn" onclick="DocViewer.open()">Open</button>
                            <button class="panel-btn" onclick="DocViewer.save()">Save</button>
                            <button class="panel-btn" onclick="DocViewer.clear()">Clear</button>
                        </div>
                    </div>
                    <div class="panel-content" id="docContent">
                        <div class="doc-empty">
                            No document open.<br><br>
                            Click "Open" to browse files, or copy content from Claude responses.
                        </div>
                    </div>
                </div>

                <!-- Panel 3: Script Browser -->
                <div class="panel">
                    <div class="panel-header">
                        <span class="panel-title">Script Browser</span>
                        <div class="panel-actions">
                            <button class="panel-btn" onclick="Scripts.refresh()">Refresh</button>
                        </div>
                    </div>
                    <div class="panel-content">
                        <div class="script-list" id="scriptList">
                            <!-- Scripts loaded dynamically -->
                        </div>
                    </div>
                </div>

                <!-- Panel 4: Output / Terminal -->
                <div class="panel">
                    <div class="panel-header">
                        <span class="panel-title">Output</span>
                        <div class="panel-actions">
                            <button class="panel-btn" onclick="Output.clear()">Clear</button>
                        </div>
                    </div>
                    <div class="panel-content">
                        <div class="output-content" id="outputContent">
                            <div class="output-line info">[System] Developer Toolkit initialized</div>
                            <div class="output-line info">[System] Trajanus Engineered Intelligence ready</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Session Tools Bar -->
            <div class="session-bar">
                <button class="tool-button" onclick="Session.newSession()">New Session</button>
                <button class="tool-button" onclick="Session.saveSession()">Save Session</button>
                <button class="tool-button" onclick="Terminals.launchClaudeCode()">Claude Code</button>
                <button class="tool-button" onclick="Terminals.launchVSCode()">VS Code</button>
                <button class="tool-button" onclick="Terminals.launchPowerShell()">PowerShell</button>
                <button class="tool-button" onclick="Scripts.runScript('CONVERT_MD_TO_GDOCS_PERMANENT.py')">MD to Docs</button>
                <button class="tool-button" onclick="Scripts.runScript('file_ingestion.py')">File Ingestion</button>
            </div>
        </main>
    </div>

    <script>
        const { invoke } = window.__TAURI__.core;
        const PROJECT_PATH = 'C:\\Dev\\trajanus-command-center';
        const SCRIPTS_PATH = 'G:\\My Drive\\00 - Trajanus USA\\00-Command-Center\\05-Scripts\\';

        // Chat Controller
        const Chat = {
            messages: [],
            isStreaming: false,
            conversationId: Date.now(),

            async send() {
                const input = document.getElementById('chatInput');
                const message = input.value.trim();
                if (!message || this.isStreaming) return;

                this.addMessage('user', message);
                input.value = '';

                this.isStreaming = true;
                document.getElementById('sendBtn').disabled = true;
                const typingEl = this.showTyping();

                try {
                    const context = `You are Claude, an AI assistant embedded in the Trajanus Developer Toolkit.
This is a professional command center for construction project management, federal contracts, and software development.
You help with: extended conversations, creating specifications and prompts, research and planning sessions, document generation, and full context management.
Be thorough, professional, and helpful. Format responses with markdown when appropriate.
This is Trajanus Engineered Intelligence (EI).`;

                    const response = await invoke('chat_with_claude', {
                        message: message,
                        context: context
                    });

                    typingEl.remove();
                    this.addMessage('assistant', response);
                    Output.log('success', 'Claude response received');
                } catch (error) {
                    typingEl.remove();
                    this.addMessage('assistant', 'Error connecting to Claude. Please check your API connection and try again.');
                    Output.log('error', 'Failed to connect to Claude API: ' + error);
                    console.error('Chat error:', error);
                }

                this.isStreaming = false;
                document.getElementById('sendBtn').disabled = false;
            },

            addMessage(role, content) {
                const container = document.getElementById('chatMessages');
                const welcome = container.querySelector('.chat-welcome');
                if (welcome) welcome.remove();

                const msgEl = document.createElement('div');
                msgEl.className = `message ${role}`;
                msgEl.innerHTML = this.formatMessage(content);
                container.appendChild(msgEl);
                container.scrollTop = container.scrollHeight;

                this.messages.push({ role, content, timestamp: new Date().toISOString() });
            },

            formatMessage(text) {
                // Handle code blocks first
                text = text.replace(/```(\w*)\n?([\s\S]*?)```/g, (match, lang, code) => {
                    return `<pre><code>${this.escapeHtml(code.trim())}</code></pre>`;
                });

                // Handle inline code
                text = text.replace(/`([^`]+)`/g, '<code>$1</code>');

                // Handle bold
                text = text.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');

                // Handle italic
                text = text.replace(/\*([^*]+)\*/g, '<em>$1</em>');

                // Handle headers
                text = text.replace(/^### (.+)$/gm, '<h4 style="color: var(--accent-gold); margin: 8px 0;">$1</h4>');
                text = text.replace(/^## (.+)$/gm, '<h3 style="color: var(--accent-gold); margin: 8px 0;">$1</h3>');
                text = text.replace(/^# (.+)$/gm, '<h2 style="color: var(--accent-gold); margin: 8px 0;">$1</h2>');

                // Handle lists
                text = text.replace(/^- (.+)$/gm, '<li style="margin-left: 16px;">$1</li>');

                // Handle newlines
                text = text.replace(/\n/g, '<br>');

                return text;
            },

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            },

            showTyping() {
                const container = document.getElementById('chatMessages');
                const typing = document.createElement('div');
                typing.className = 'typing-indicator';
                typing.innerHTML = '<span></span><span></span><span></span>';
                container.appendChild(typing);
                container.scrollTop = container.scrollHeight;
                return typing;
            },

            handleKeydown(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    this.send();
                }
            },

            clear() {
                document.getElementById('chatMessages').innerHTML = `
                    <div class="chat-welcome">
                        Welcome to Claude Full Chat. This is your AI workspace for extended conversations,
                        research, planning, and document generation.<br><br>
                        This is Trajanus Engineered Intelligence (EI).
                    </div>
                `;
                this.messages = [];
                Output.log('info', 'Chat cleared');
            },

            newConversation() {
                this.conversationId = Date.now();
                this.clear();
                Output.log('info', 'New conversation started');
            },

            exportConversation() {
                if (this.messages.length === 0) {
                    Output.log('warning', 'No messages to export');
                    return;
                }

                const content = this.messages.map(m =>
                    `[${m.role.toUpperCase()}] ${m.timestamp}\n${m.content}\n`
                ).join('\n---\n\n');

                const blob = new Blob([content], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `claude-conversation-${this.conversationId}.txt`;
                a.click();
                URL.revokeObjectURL(url);

                Output.log('success', 'Conversation exported');
            }
        };

        // Document Viewer Controller
        const DocViewer = {
            currentPath: null,
            content: '',

            async open() {
                Output.log('info', 'Document browser - feature coming soon');
            },

            async save() {
                if (!this.content) {
                    Output.log('warning', 'No document to save');
                    return;
                }
                Output.log('info', 'Document save - feature coming soon');
            },

            clear() {
                this.content = '';
                this.currentPath = null;
                document.getElementById('docContent').innerHTML = `
                    <div class="doc-empty">
                        No document open.<br><br>
                        Click "Open" to browse files, or copy content from Claude responses.
                    </div>
                `;
                Output.log('info', 'Document cleared');
            },

            setContent(content, path = null) {
                this.content = content;
                this.currentPath = path;
                document.getElementById('docContent').innerHTML =
                    `<div class="doc-content">${content}</div>`;
            }
        };

        // Scripts Controller
        const Scripts = {
            scripts: [
                { name: 'CONVERT_MD_TO_GDOCS_PERMANENT.py', desc: 'Convert Markdown to Google Docs' },
                { name: 'SCRIPT_BROWSER.py', desc: 'Browse and run scripts' },
                { name: 'file_ingestion.py', desc: 'Ingest files to knowledge base' },
                { name: 'batch_ingest_files.py', desc: 'Batch file ingestion' },
                { name: 'batch_extract_transcripts.py', desc: 'Extract YouTube transcripts' },
                { name: 'query_kb.py', desc: 'Query knowledge base' },
                { name: 'CONVERT_TXT_TO_GDOCS.py', desc: 'Convert TXT to Google Docs' },
                { name: 'CONVERT_DOCX_TO_GDOCS.py', desc: 'Convert DOCX to Google Docs' }
            ],

            init() {
                this.render();
            },

            render() {
                const container = document.getElementById('scriptList');
                container.innerHTML = this.scripts.map(s => `
                    <div class="script-item" onclick="Scripts.runScript('${s.name}')">
                        <span class="script-name">${s.name}</span>
                        <button class="script-run" onclick="event.stopPropagation(); Scripts.runScript('${s.name}')">RUN</button>
                    </div>
                `).join('');
            },

            async runScript(name) {
                Output.log('info', `Running: ${name}...`);
                try {
                    await invoke('run_python_script', {
                        scriptPath: SCRIPTS_PATH + name
                    });
                    Output.log('success', `Script launched: ${name}`);
                } catch (error) {
                    Output.log('error', `Failed to run ${name}: ${error}`);
                }
            },

            refresh() {
                this.render();
                Output.log('info', 'Script list refreshed');
            }
        };

        // Terminal Launchers
        const Terminals = {
            async launchClaudeCode() {
                Output.log('info', 'Launching Claude Code...');
                try {
                    await invoke('launch_claude_code', { path: PROJECT_PATH });
                    Output.log('success', 'Claude Code launched');
                } catch (e) {
                    Output.log('error', `Error: ${e}`);
                }
            },

            async launchVSCode() {
                Output.log('info', 'Launching VS Code...');
                try {
                    await invoke('launch_vscode', { path: PROJECT_PATH });
                    Output.log('success', 'VS Code launched');
                } catch (e) {
                    Output.log('error', `Error: ${e}`);
                }
            },

            async launchPowerShell() {
                Output.log('info', 'Launching PowerShell...');
                try {
                    await invoke('open_terminal', { path: PROJECT_PATH });
                    Output.log('success', 'PowerShell launched');
                } catch (e) {
                    Output.log('error', `Error: ${e}`);
                }
            }
        };

        // Output Controller
        const Output = {
            log(type, message) {
                const container = document.getElementById('outputContent');
                const timestamp = new Date().toLocaleTimeString();
                const line = document.createElement('div');
                line.className = `output-line ${type}`;
                line.textContent = `[${timestamp}] ${message}`;
                container.appendChild(line);
                container.scrollTop = container.scrollHeight;
            },

            clear() {
                document.getElementById('outputContent').innerHTML =
                    '<div class="output-line info">[System] Output cleared</div>';
            }
        };

        // Session Controller
        const Session = {
            newSession() {
                Chat.newConversation();
                DocViewer.clear();
                Output.clear();
                Output.log('success', 'New session started');
            },

            saveSession() {
                Output.log('info', 'Session save - feature coming soon');
            }
        };

        // Initialize on load
        document.addEventListener('DOMContentLoaded', () => {
            Scripts.init();
            Output.log('info', 'Developer Toolkit ready');
        });
    </script>
</body>
</html>
