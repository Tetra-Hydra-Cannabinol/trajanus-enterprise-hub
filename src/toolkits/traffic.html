<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Traffic Studies - Trajanus Enterprise Hub</title>
    <style>
        /* ==================== CSS VARIABLES ==================== */
        :root {
            /* TRAJANUS BLACK/SILVER PALETTE - ALL SILVER ON BLACK */
            --bg-base: #0a0a0a;
            --bg-surface: #0a0a0a;
            --bg-card: #0a0a0a;
            --bg-elevated: #1a1a1a;
            --bg-hover: #2a2a2a;
            --border-subtle: #c0c0c0;
            --border-accent: #c0c0c0;
            --text-light: #c0c0c0;
            --text-primary: #c0c0c0;
            --text-secondary: #c0c0c0;
            --text-muted: #c0c0c0;
            --accent: #c0c0c0;
            --accent-silver: #c0c0c0;
            --silver: #c0c0c0;
            --silver-light: #e0e0e0;
            --silver-dark: #a0a0a0;
            --gold: #00AAFF;
            --gold-light: #33BBFF;
            --gold-dark: #0088CC;
            --blue: #4a90d9;
            --blue-light: #6ab0f9;
            --blue-dark: #3a70b9;
            --success: #4ade80;
            --info: #60a5fa;
            --warning: #fbbf24;
            --error: #f87171;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: var(--bg-base);
            color: var(--text-light);
            line-height: 1.5;
            border: 2px solid #0066CC;
        }

        /* ==================== STICKY HERO SECTION ==================== */
        .hero-section {
            position: sticky;
            top: 0;
            z-index: 1000;
            background: var(--bg-base);
            border-bottom: 1px solid var(--gold);
            padding: 16px 32px;
        }

        .hero-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .hero-brand {
            display: flex;
            flex-direction: column;
            gap: 4px;
            align-items: center;
            text-align: center;
            flex: 1;
        }

        .hero-company {
            font-size: 12px;
            font-weight: 500;
            color: var(--gold);
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .hero-company .tm {
            font-size: 8px;
            vertical-align: super;
        }

        .hero-toolkit {
            font-family: Tahoma, sans-serif;
            font-size: 24px;
            font-weight: 700;
            color: var(--gold);
            letter-spacing: 1px;
        }

        .hero-description {
            font-size: 13px;
            color: var(--text-light);
            max-width: 400px;
            line-height: 1.4;
            margin-top: 4px;
        }

        .hero-nav {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .hero-home-btn {
            width: 130px;
            height: 36px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.75rem;
            font-weight: 600;
            transition: all 0.15s ease;
            border: 1px solid #00AAFF;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            color: #00AAFF;
            background: transparent;
            text-decoration: none;
        }

        .hero-home-btn:hover {
            background: rgba(0, 170, 255, 0.15);
            color: #33BBFF;
            border-color: #33BBFF;
        }

        /* ==================== INTRODUCTION SECTION ==================== */
        .intro-section {
            padding: 24px 32px;
            background: var(--bg-base);
            border-bottom: 1px solid var(--border-subtle);
        }

        .intro-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            cursor: pointer;
        }

        .intro-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--gold);
            text-transform: uppercase;
            letter-spacing: 1.5px;
        }

        .intro-toggle {
            font-size: 14px;
            color: var(--text-muted);
            transition: transform 0.3s;
        }

        .intro-toggle.collapsed {
            transform: rotate(180deg);
        }

        .intro-content {
            display: grid;
            gap: 24px;
            transition: all 0.3s ease;
        }

        .intro-content.collapsed {
            display: none;
        }

        /* Decision Tree */
        .intro-decision {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
        }

        .decision-card {
            padding: 16px;
            background: var(--bg-base);
            border: 1px solid var(--blue);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .decision-card:hover {
            background: var(--bg-hover);
            border-color: var(--gold);
            transform: translateY(-2px);
        }

        .decision-card.selected {
            border-color: var(--gold);
            background: var(--bg-elevated);
        }

        .decision-icon {
            font-size: 28px;
            margin-bottom: 8px;
        }

        .decision-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-light);
            margin-bottom: 4px;
        }

        .decision-desc {
            font-size: 11px;
            color: var(--text-muted);
        }

        /* Tools Grid */
        .intro-tools-section {
            margin-top: 8px;
        }

        .intro-section-label {
            font-size: 11px;
            font-weight: 600;
            color: var(--gold);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 12px;
        }

        .intro-tools-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 12px;
        }

        .intro-tool-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            padding: 12px 8px;
            background: var(--bg-base);
            border: 1px solid var(--blue);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .intro-tool-card:hover {
            background: var(--bg-hover);
            border-color: var(--gold);
        }

        .intro-tool-icon {
            font-size: 24px;
        }

        .intro-tool-name {
            font-size: 11px;
            color: var(--text-light);
            text-align: center;
        }

        /* Workflow Overview */
        .intro-workflow {
            margin-top: 8px;
        }

        .intro-workflow-steps {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .intro-workflow-step {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 12px;
            background: var(--bg-base);
            border: 1px solid var(--border-subtle);
            border-radius: 4px;
            font-size: 11px;
            color: var(--text-light);
        }

        .intro-workflow-step .step-num {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 18px;
            height: 18px;
            background: var(--gold);
            color: var(--bg-base);
            border-radius: 50%;
            font-size: 10px;
            font-weight: 700;
        }

        .intro-workflow-connector {
            color: var(--text-muted);
            font-size: 12px;
        }

        /* Folders Reference */
        .intro-folders {
            margin-top: 8px;
        }

        .intro-folders-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
        }

        .intro-folder {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 12px;
            background: var(--bg-base);
            border: 1px solid var(--border-subtle);
            border-radius: 4px;
            font-size: 11px;
            color: var(--text-light);
        }

        .intro-folder-icon {
            font-size: 16px;
        }

        /* Tips Section */
        .intro-tips {
            margin-top: 8px;
        }

        .intro-tips-list {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
        }

        .intro-tip {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding: 12px;
            background: var(--bg-base);
            border: 1px solid var(--border-subtle);
            border-radius: 6px;
        }

        .intro-tip-icon {
            font-size: 18px;
            flex-shrink: 0;
        }

        .intro-tip-text {
            font-size: 11px;
            color: var(--text-muted);
            line-height: 1.4;
        }

        /* ==================== WORKSPACE CONTAINER ==================== */
        .workspace-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* ==================== HEADER ==================== */
        .workspace-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 32px;
            background: var(--bg-base);
            border-bottom: 1px solid var(--border-subtle);
        }

        .header-title h1 {
            color: var(--accent-silver);
            font-size: 22px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .header-title p {
            color: var(--text-muted);
            font-size: 13px;
        }

        .home-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            background: transparent;
            border: 1px solid var(--accent-silver);
            color: var(--accent-silver);
            font-size: 14px;
            border-radius: 6px;
            cursor: pointer;
            text-decoration: none;
            transition: all 0.2s;
        }

        .home-btn:hover {
            background: var(--accent-silver);
            color: var(--bg-base);
        }

        /* ==================== MAIN CONTENT ==================== */
        .main-content {
            flex: 1;
            padding: 24px 32px;
            overflow-y: auto;
        }

        /* ==================== SECTION DIVIDERS ==================== */
        .section-divider {
            display: flex;
            align-items: center;
            gap: 16px;
            margin: 32px 0 20px 0;
        }

        .section-divider:first-child {
            margin-top: 0;
        }

        .section-title {
            font-size: 14px;
            font-weight: 600;
            color: #00AAFF;
            text-transform: uppercase;
            letter-spacing: 2px;
            white-space: nowrap;
        }

        .section-line {
            flex: 1;
            height: 2px;
            background: linear-gradient(90deg, #00AAFF 0%, #0066CC 50%, transparent 100%);
        }

        .section-description {
            color: var(--text-secondary);
            font-size: 14px;
            margin-top: 4px;
            max-width: 800px;
        }

        /* ==================== APP GRID ==================== */
        .app-category {
            margin-bottom: 20px;
        }

        .category-label {
            font-size: 11px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }

        .app-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 12px;
        }

        .app-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            padding: 16px 12px;
            background: var(--bg-base);
            border: 1px solid var(--blue);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
        }

        .app-card:hover {
            background: var(--bg-hover);
            border-color: var(--blue-light);
            transform: translateY(-2px);
        }

        .app-icon {
            font-size: 28px;
            color: var(--accent-silver);
        }

        .app-label {
            font-size: 12px;
            color: var(--text-light);
            text-align: center;
        }

        /* ==================== SCRIPT CARDS ==================== */
        .script-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 12px;
        }

        .script-card {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 14px 16px;
            background: var(--bg-base);
            border: 1px solid var(--blue);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .script-card:hover {
            background: var(--bg-hover);
            border-color: var(--blue-light);
        }

        .script-icon {
            font-size: 22px;
            color: var(--accent-silver);
        }

        .script-info {
            flex: 1;
        }

        .script-name {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-light);
            margin-bottom: 2px;
        }

        .script-desc {
            font-size: 12px;
            color: var(--text-muted);
        }

        /* ==================== DOCUMENT SECTIONS ==================== */
        .doc-category {
            margin-bottom: 20px;
        }

        .doc-category-header {
            font-size: 12px;
            font-weight: 500;
            color: var(--accent-silver);
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .doc-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
            gap: 10px;
        }

        .doc-card {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 14px;
            background: var(--bg-base);
            border: 1px solid var(--blue);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .doc-card:hover {
            background: var(--bg-hover);
            border-color: var(--blue-light);
        }

        .doc-icon {
            font-size: 20px;
            color: var(--accent-silver);
        }

        .doc-info {
            flex: 1;
        }

        .doc-name {
            font-size: 13px;
            color: var(--text-light);
        }

        .doc-meta {
            font-size: 11px;
            color: var(--text-muted);
        }

        /* ==================== AGENT CARDS ==================== */
        .agent-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 12px;
        }

        .agent-card {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 16px;
            background: var(--bg-base);
            border: 1px solid var(--blue);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .agent-card:hover {
            background: var(--bg-hover);
            border-color: var(--blue-light);
        }

        .agent-icon {
            font-size: 24px;
            color: var(--accent-silver);
        }

        .agent-info {
            flex: 1;
        }

        .agent-name {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-light);
            margin-bottom: 2px;
        }

        .agent-desc {
            font-size: 12px;
            color: var(--text-muted);
        }

        .agent-status {
            font-size: 10px;
            padding: 3px 8px;
            border-radius: 4px;
            background: rgba(169, 180, 192, 0.1);
            color: var(--accent-silver);
        }

        /* ==================== CHAT SECTION ==================== */
        .chat-section {
            background: var(--bg-base);
            border: 1px solid var(--blue);
            border-radius: 8px;
            overflow: hidden;
        }

        .chat-header {
            padding: 14px 18px;
            background: var(--bg-surface);
            border-bottom: 1px solid var(--blue);
        }

        .chat-header-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--gold);
        }

        .chat-header-subtitle {
            font-size: 12px;
            color: var(--text-muted);
        }

        /* Chat Messages Area - Brain Waves Background */
        .chat-messages {
            height: 500px;
            overflow-y: auto;
            padding: 16px;
            position: relative;
            background-image: url('../assets/ai-generated-8909412_1280.jpg');
            background-size: contain;
            background-position: center;
            background-repeat: no-repeat;
        }

        .chat-messages::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(10, 10, 10, 0.88);
            pointer-events: none;
        }

        .chat-messages > * {
            position: relative;
            z-index: 1;
        }

        .chat-message {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 10px;
            font-size: 14px;
            line-height: 1.5;
        }

        .chat-message.assistant {
            background: rgba(0, 170, 255, 0.1);
            border-left: 3px solid #00AAFF;
            color: #00AAFF;
            font-family: Tahoma, sans-serif;
            margin-right: 15%;
        }

        .chat-message.user {
            background: rgba(46, 204, 113, 0.15);
            border: 1px solid rgba(46, 204, 113, 0.3);
            color: #2ECC71;
            font-family: Arial, sans-serif;
            margin-left: 15%;
        }

        .chat-input-area {
            display: flex;
            gap: 10px;
            padding: 16px;
            border-top: 1px solid var(--blue);
        }

        .chat-input {
            flex: 1;
            padding: 12px 14px;
            background: var(--bg-base);
            border: 1px solid var(--blue);
            border-radius: 6px;
            color: var(--text-light);
            font-size: 14px;
            font-family: inherit;
            resize: none;
        }

        .chat-input:focus {
            outline: none;
            border-color: var(--blue-light);
        }

        .chat-input::placeholder {
            color: var(--text-muted);
        }

        .chat-send-btn {
            padding: 12px 24px;
            background: var(--blue);
            color: var(--bg-base);
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .chat-send-btn:hover {
            background: var(--blue-light);
        }

        /* ==================== TYPING INDICATOR ==================== */
        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 12px 16px;
            background: var(--bg-surface);
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
            margin-right: 15%;
            width: fit-content;
        }

        .typing-indicator span {
            width: 6px;
            height: 6px;
            background: var(--accent-silver);
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out;
        }

        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); opacity: 0.4; }
            30% { transform: translateY(-4px); opacity: 1; }
        }

        /* ==================== NOTIFICATION ==================== */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 8px;
            z-index: 9999;
            animation: slideIn 0.3s ease;
        }

        .notification.info {
            background: var(--bg-surface);
            border: 1px solid var(--accent-silver);
            color: var(--text-light);
        }

        .notification.warning {
            background: #2d2a00;
            border: 1px solid var(--accent-gold);
            color: var(--accent-gold);
        }

        .notification.success {
            background: #1a3a1a;
            border: 1px solid var(--success);
            color: var(--success);
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* ==================== TRAJANUS WINDOW SYSTEM ==================== */
        .trajanus-window-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.2s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .trajanus-window {
            background: #1a1a1a;
            border: 2px solid #c0c0c0;
            border-radius: 8px;
            min-width: 500px;
            max-width: 800px;
            max-height: 80vh;
            box-shadow: 0 0 30px rgba(192, 192, 192, 0.2), 0 0 60px rgba(0, 0, 0, 0.5);
            animation: windowSlide 0.2s ease;
        }

        @keyframes windowSlide {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .trajanus-window-header {
            background: linear-gradient(180deg, #2d2d2d 0%, #1a1a1a 100%);
            border-bottom: 1px solid #c0c0c0;
            padding: 14px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 6px 6px 0 0;
        }

        .trajanus-window-title {
            color: #c0c0c0;
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 3px;
        }

        .trajanus-window-close {
            background: transparent;
            border: 1px solid #4a4a4a;
            color: #c0c0c0;
            width: 28px;
            height: 28px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .trajanus-window-close:hover {
            border-color: #c0c0c0;
            background: #2d2d2d;
        }

        .trajanus-window-body {
            padding: 24px;
            color: #ffffff;
            max-height: 60vh;
            overflow-y: auto;
        }

        /* Terminal styling */
        .terminal-output {
            background: #0a0a0a;
            border: 1px solid #4a4a4a;
            font-family: 'Consolas', 'Monaco', monospace;
        }

        .terminal-line {
            padding: 2px 0;
            line-height: 1.4;
        }

        .terminal-line.success { color: #4ade80; }
        .terminal-line.error { color: #f87171; }
        .terminal-line.info { color: #60a5fa; }
        .terminal-line.warning { color: #fbbf24; }

        /* ==================== TSE WORKFLOW ADDITIONS ==================== */

        /* Project Bar */
        .project-bar {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 12px 32px;
            background: var(--bg-surface);
            border-bottom: 1px solid var(--blue);
        }

        .project-bar-label {
            font-size: 12px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .project-select {
            flex: 1;
            max-width: 400px;
            padding: 8px 12px;
            background: var(--bg-base);
            border: 1px solid var(--blue);
            border-radius: 6px;
            color: var(--text-light);
            font-size: 14px;
        }

        .project-select:focus {
            outline: none;
            border-color: var(--blue-light);
        }

        .new-project-btn {
            padding: 8px 16px;
            background: transparent;
            border: 1px solid var(--blue);
            color: var(--text-light);
            font-size: 13px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .new-project-btn:hover {
            background: var(--blue);
            color: var(--bg-base);
        }

        /* Workflow Tracker */
        .workflow-tracker {
            background: var(--bg-surface);
            border: 1px solid var(--blue);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 24px;
        }

        .workflow-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .workflow-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--gold);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .workflow-progress {
            font-size: 12px;
            color: var(--text-muted);
        }

        .workflow-steps {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .workflow-step {
            flex: 1 1 calc(20% - 8px);
            min-width: 100px;
            max-width: calc(20% - 8px);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            padding: 12px 8px;
            background: var(--bg-base);
            border: 1px solid var(--blue);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            box-sizing: border-box;
        }

        .workflow-step:hover {
            border-color: var(--blue-light);
        }

        .workflow-step.active {
            border-color: var(--gold);
            background: var(--bg-elevated);
        }

        .workflow-step.completed {
            border-color: var(--success);
        }

        .workflow-step-number {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background: var(--bg-surface);
            border: 1px solid var(--blue);
            font-size: 11px;
            font-weight: 600;
            color: var(--text-muted);
        }

        .workflow-step.active .workflow-step-number {
            background: var(--gold);
            border-color: var(--gold);
            color: var(--bg-base);
        }

        .workflow-step.completed .workflow-step-number {
            background: var(--success);
            border-color: var(--success);
            color: var(--bg-base);
        }

        /* ==================== WORKFLOW ANIMATIONS ==================== */
        @keyframes stepCompletePulse {
            0% { transform: scale(1); }
            40% { transform: scale(1.15); }
            100% { transform: scale(1); }
        }

        @keyframes checkmarkReveal {
            0% { opacity: 0; transform: scale(0.5); }
            100% { opacity: 1; transform: scale(1); }
        }

        @keyframes stepColorShift {
            0% { background: var(--gold); border-color: var(--gold); }
            100% { background: var(--success); border-color: var(--success); }
        }

        @keyframes calcSpinner {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes calcPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .workflow-step.calculating .workflow-step-number {
            position: relative;
            background: transparent;
            border-color: transparent;
            color: transparent;
        }

        .workflow-step.calculating .workflow-step-number::after {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            border: 2px solid var(--gold);
            border-top-color: transparent;
            border-radius: 50%;
            animation: calcSpinner 0.8s linear infinite;
        }

        .workflow-step.calculating .workflow-step-name {
            animation: calcPulse 1s ease-in-out infinite;
        }

        .workflow-step.completing .workflow-step-number {
            animation: stepCompletePulse 0.6s ease-out, stepColorShift 0.6s ease-out forwards;
        }

        .workflow-step.completing .workflow-step-number::after {
            content: '\2713';
            position: absolute;
            font-size: 12px;
            color: var(--bg-base);
            animation: checkmarkReveal 0.4s ease-out 0.2s both;
        }

        .ws-submit-btn.calculating {
            pointer-events: none;
            opacity: 0.7;
            position: relative;
        }

        .ws-submit-btn.calculating::after {
            content: '';
            display: inline-block;
            width: 14px;
            height: 14px;
            border: 2px solid currentColor;
            border-top-color: transparent;
            border-radius: 50%;
            animation: calcSpinner 0.8s linear infinite;
            margin-left: 8px;
            vertical-align: middle;
        }

        /* ==================== PIPELINE PROGRESS ==================== */
        .pipeline-progress {
            height: 6px;
            background: var(--bg-elevated);
            border-radius: 3px;
            margin: 8px 0 4px;
            overflow: hidden;
        }

        .pipeline-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--blue), var(--success));
            border-radius: 3px;
            transition: width 0.6s ease;
            position: relative;
        }

        .pipeline-progress-fill::after {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.15), transparent);
            animation: shimmer 2s ease-in-out infinite;
        }

        .pipeline-progress-label {
            display: flex;
            justify-content: space-between;
            font-size: 10px;
            color: var(--text-muted);
            margin-bottom: 8px;
        }

        /* ==================== PROJECT LIFECYCLE ==================== */
        .lifecycle-toolbar {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 16px;
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            border-radius: 6px;
            margin: 10px 0;
            flex-wrap: wrap;
        }
        .lifecycle-toolbar .toolbar-label {
            font-size: 11px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-right: 4px;
        }
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border: 1px solid;
        }
        .status-badge.status-draft { color: #888; border-color: #555; background: rgba(136,136,136,0.1); }
        .status-badge.status-active { color: #4a90d9; border-color: #4a90d9; background: rgba(74,144,217,0.1); }
        .status-badge.status-in-review { color: #f5a623; border-color: #f5a623; background: rgba(245,166,35,0.1); }
        .status-badge.status-approved { color: #4ade80; border-color: #4ade80; background: rgba(74,222,128,0.1); }
        .status-badge.status-delivered { color: #fbbf24; border-color: #fbbf24; background: rgba(251,191,36,0.15); }
        .transition-btn {
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            border: 1px solid var(--border-subtle);
            background: var(--bg-hover);
            color: var(--text-primary);
            transition: all 0.2s;
        }
        .transition-btn:hover { background: var(--blue); color: #fff; border-color: var(--blue); }
        .transition-btn.btn-danger { border-color: #f87171; color: #f87171; }
        .transition-btn.btn-danger:hover { background: #f87171; color: #fff; }
        .transition-btn.btn-success { border-color: #4ade80; color: #4ade80; }
        .transition-btn.btn-success:hover { background: #4ade80; color: #000; }
        .transition-btn.btn-warn { border-color: #fbbf24; color: #fbbf24; }
        .transition-btn.btn-warn:hover { background: #fbbf24; color: #000; }
        .lock-banner {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: rgba(251,191,36,0.12);
            border: 1px solid #fbbf24;
            border-radius: 6px;
            margin: 8px 0;
            font-size: 12px;
            color: #fbbf24;
        }
        .lock-banner .lock-icon { font-size: 16px; }
        .workspace-container.locked input,
        .workspace-container.locked select,
        .workspace-container.locked textarea,
        .workspace-container.locked button:not(.transition-btn):not(.lifecycle-action) {
            opacity: 0.5;
            pointer-events: none;
        }
        .lifecycle-separator { width: 1px; height: 20px; background: var(--border-subtle); }
        .lifecycle-toolbar .toolbar-right {
            margin-left: auto;
            display: flex;
            gap: 6px;
            align-items: center;
        }
        /* Transition confirmation modal */
        .transition-modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.7); z-index: 10000;
            display: flex; align-items: center; justify-content: center;
        }
        .transition-modal {
            background: var(--bg-elevated); border: 1px solid var(--border-subtle);
            border-radius: 8px; padding: 24px; width: 420px; max-width: 90vw;
        }
        .transition-modal h3 { margin-bottom: 12px; font-size: 16px; }
        .transition-modal .status-flow {
            display: flex; align-items: center; gap: 8px; margin: 12px 0;
            font-size: 13px;
        }
        .transition-modal .status-flow .arrow { color: var(--text-muted); }
        .transition-modal textarea {
            width: 100%; padding: 8px; border-radius: 4px; margin: 8px 0 12px;
            background: var(--bg-base); border: 1px solid var(--border-subtle);
            color: var(--text-primary); font-size: 12px; resize: vertical;
            min-height: 60px;
        }
        .transition-modal .modal-actions {
            display: flex; gap: 8px; justify-content: flex-end;
        }
        .transition-modal .warn-text {
            color: #f87171; font-size: 11px; margin: 6px 0;
        }
        /* Preview All modal */
        .preview-all-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.85); z-index: 10000;
            overflow-y: auto; padding: 24px;
        }
        .preview-all-container {
            max-width: 900px; margin: 0 auto;
            background: var(--bg-elevated); border: 1px solid var(--border-subtle);
            border-radius: 8px; padding: 24px;
        }
        .preview-all-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid var(--border-subtle);
        }
        .preview-all-header h2 { font-size: 18px; }
        .preview-step-section {
            margin-bottom: 20px; padding: 16px;
            border: 1px solid var(--border-subtle); border-radius: 6px;
        }
        .preview-step-section h3 {
            font-size: 14px; margin-bottom: 8px; color: var(--blue);
            border-bottom: 1px solid var(--border-subtle); padding-bottom: 6px;
        }
        @media print {
            .preview-all-overlay { position: static; background: #fff; padding: 0; }
            .preview-all-container { border: none; max-width: 100%; }
            .preview-all-header button { display: none; }
        }

        /* ==================== STEP PREVIEW ==================== */
        .step-preview-btn {
            display: none;
            font-size: 9px;
            padding: 2px 6px;
            border: 1px solid var(--border-subtle);
            border-radius: 3px;
            background: transparent;
            color: var(--text-muted);
            cursor: pointer;
            margin-top: 4px;
            transition: all 0.2s;
        }

        .step-preview-btn:hover {
            border-color: var(--gold);
            color: var(--gold);
        }

        .workflow-step.completed .step-preview-btn {
            display: inline-block;
        }

        .preview-report {
            font-size: 13px;
            color: var(--text-light);
            line-height: 1.6;
        }

        .preview-report h4 {
            font-size: 14px;
            color: var(--gold);
            margin: 16px 0 8px;
            padding-bottom: 4px;
            border-bottom: 1px solid var(--border-subtle);
        }

        .preview-report h4:first-child {
            margin-top: 0;
        }

        .preview-table {
            width: 100%;
            border-collapse: collapse;
            margin: 8px 0 16px;
            font-size: 12px;
        }

        .preview-table th {
            background: var(--bg-elevated);
            padding: 6px 10px;
            text-align: left;
            font-weight: 600;
            color: var(--text-light);
            border: 1px solid var(--border-subtle);
        }

        .preview-table td {
            padding: 6px 10px;
            border: 1px solid var(--border-subtle);
            color: var(--text-secondary);
        }

        .preview-field {
            display: flex;
            gap: 8px;
            margin: 4px 0;
        }

        .preview-field-label {
            font-weight: 600;
            color: var(--text-muted);
            min-width: 120px;
        }

        .preview-field-value {
            color: var(--text-light);
        }

        .preview-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }

        .preview-badge.met { background: rgba(74, 222, 128, 0.15); color: var(--success); }
        .preview-badge.not-met { background: rgba(248, 113, 113, 0.15); color: var(--error); }
        .preview-badge.accepted { background: rgba(74, 222, 128, 0.15); color: var(--success); }

        .los-grade { font-weight: 700; }
        .los-grade.a, .los-grade.b { color: var(--success); }
        .los-grade.c, .los-grade.d { color: var(--warning); }
        .los-grade.e, .los-grade.f { color: var(--error); }

        /* ==================== AUTOSAVE INDICATOR ==================== */
        .autosave-indicator {
            font-size: 11px;
            color: var(--text-muted);
            opacity: 0;
            transition: opacity 0.3s;
            margin-left: 12px;
        }

        .workflow-step-name {
            font-size: 11px;
            color: var(--text-secondary);
            text-align: center;
        }

        .workflow-step.active .workflow-step-name {
            color: var(--text-light);
        }

        /* ==================== WORKFLOW WORKSPACE PANELS ==================== */
        .workflow-workspace {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease, opacity 0.3s ease;
            opacity: 0;
            margin-bottom: 0;
        }

        .workflow-workspace.open {
            max-height: 2000px;
            opacity: 1;
            margin-bottom: 24px;
        }

        .workspace-panel {
            background: var(--bg-surface);
            border: 1px solid var(--blue);
            border-radius: 8px;
            padding: 24px;
            display: none;
        }

        .workspace-panel.active {
            display: block;
        }

        .workspace-panel h3 {
            font-size: 16px;
            font-weight: 600;
            color: var(--gold);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin: 0 0 20px 0;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--blue);
        }

        .ws-form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 24px;
        }

        .ws-form-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .ws-form-group.full-width {
            grid-column: 1 / -1;
        }

        .ws-form-group label {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .ws-form-group input,
        .ws-form-group select {
            background: var(--bg-base);
            border: 1px solid var(--blue);
            border-radius: 6px;
            padding: 10px 12px;
            color: var(--text-light);
            font-size: 14px;
            font-family: inherit;
            transition: border-color 0.2s;
        }

        .ws-form-group input:focus,
        .ws-form-group select:focus {
            outline: none;
            border-color: var(--gold);
        }

        .ws-form-group input::placeholder {
            color: #555;
        }

        .ws-section-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--gold);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin: 24px 0 12px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .ws-section-title::after {
            content: '';
            flex: 1;
            height: 1px;
            background: var(--blue);
        }

        /* Buildings Table */
        .buildings-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-bottom: 12px;
        }

        .buildings-table th {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 8px 10px;
            text-align: left;
            border-bottom: 1px solid var(--blue);
        }

        .buildings-table td {
            padding: 6px 4px;
        }

        .buildings-table input[type="text"],
        .buildings-table input[type="number"] {
            background: var(--bg-base);
            border: 1px solid var(--blue);
            border-radius: 4px;
            padding: 8px 10px;
            color: var(--text-light);
            font-size: 13px;
            font-family: inherit;
            width: 100%;
            box-sizing: border-box;
        }

        .buildings-table input:focus {
            outline: none;
            border-color: var(--gold);
        }

        .buildings-table input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: var(--gold);
        }

        .buildings-table .remove-building-btn {
            background: transparent;
            border: 1px solid #ff4444;
            color: #ff4444;
            border-radius: 4px;
            padding: 6px 10px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }

        .buildings-table .remove-building-btn:hover {
            background: #ff4444;
            color: #fff;
        }

        .add-building-btn {
            background: transparent;
            border: 1px dashed var(--blue);
            color: var(--blue-light);
            border-radius: 6px;
            padding: 10px 20px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.2s;
            margin-bottom: 24px;
        }

        .add-building-btn:hover {
            border-color: var(--gold);
            color: var(--gold);
            background: var(--bg-elevated);
        }

        /* File Drop Zone */
        .ws-drop-zone {
            border: 2px dashed var(--blue);
            border-radius: 8px;
            padding: 32px;
            text-align: center;
            color: var(--text-muted);
            font-size: 14px;
            transition: all 0.2s;
            cursor: pointer;
            margin-bottom: 24px;
        }

        .ws-drop-zone:hover {
            border-color: var(--gold);
            background: var(--bg-elevated);
        }

        .ws-drop-zone.dragover {
            border-color: var(--gold);
            background: var(--bg-elevated);
            color: var(--gold);
        }

        .ws-drop-icon {
            font-size: 32px;
            margin-bottom: 8px;
        }

        .ws-drop-text {
            font-size: 14px;
            margin-bottom: 4px;
        }

        .ws-drop-subtext {
            font-size: 11px;
            color: #555;
        }

        /* Submit Button */
        .ws-submit-btn {
            background: var(--gold);
            color: var(--bg-base);
            border: none;
            border-radius: 6px;
            padding: 14px 32px;
            font-size: 14px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.2s;
            width: 100%;
        }

        .ws-submit-btn:hover {
            filter: brightness(1.15);
        }

        /* ==================== VALIDATION UI ==================== */
        .ws-section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }
        .ws-section-header .ws-section-title {
            margin-bottom: 0;
        }
        .ws-section-badge {
            font-size: 11px;
            font-weight: 600;
            padding: 3px 10px;
            border-radius: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .ws-section-badge.incomplete {
            background: rgba(255,255,255,0.06);
            color: var(--text-muted);
            border: 1px solid #333;
        }
        .ws-section-badge.valid {
            background: rgba(74,222,128,0.12);
            color: var(--success);
            border: 1px solid var(--success);
        }
        .ws-section-badge.warning {
            background: rgba(251,191,36,0.12);
            color: #fbbf24;
            border: 1px solid #fbbf24;
        }
        .ws-validation-panel {
            background: var(--bg-base);
            border: 1px solid #222;
            border-radius: 8px;
            padding: 14px 16px;
            margin-bottom: 20px;
            display: none;
        }
        .ws-validation-panel.visible {
            display: block;
        }
        .ws-validation-panel h4 {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-muted);
            margin: 0 0 10px 0;
        }
        .ws-val-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 0;
            font-size: 13px;
            color: var(--text-light);
            border-bottom: 1px solid #1a1a1a;
        }
        .ws-val-item:last-child {
            border-bottom: none;
        }
        .ws-val-icon {
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            flex-shrink: 0;
        }
        .ws-val-icon.pass { color: var(--success); }
        .ws-val-icon.fail { color: #ef4444; }
        .ws-val-icon.warn { color: #fbbf24; }
        .ws-val-detail {
            color: var(--text-muted);
            font-size: 11px;
            margin-left: auto;
            flex-shrink: 0;
        }

        /* ==================== PROJECT SUMMARY CARD ==================== */
        .project-summary-card {
            background: var(--bg-surface);
            border: 1px solid var(--gold);
            border-radius: 8px;
            padding: 24px;
            margin-bottom: 24px;
        }

        .project-summary-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--blue);
        }

        .project-summary-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--gold);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .project-summary-status {
            font-size: 12px;
            padding: 4px 12px;
            border-radius: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .project-summary-status.active {
            background: rgba(74, 222, 128, 0.15);
            color: var(--success);
            border: 1px solid var(--success);
        }

        .project-summary-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 12px;
            margin-bottom: 16px;
        }

        .project-summary-field {
            background: var(--bg-base);
            border: 1px solid var(--blue);
            border-radius: 6px;
            padding: 10px 12px;
        }

        .project-summary-field .field-label {
            font-size: 10px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }

        .project-summary-field .field-value {
            font-size: 14px;
            color: var(--text-light);
            font-weight: 500;
        }

        .project-summary-buildings {
            margin-top: 12px;
        }

        .project-summary-buildings .building-tag {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: var(--bg-base);
            border: 1px solid var(--blue);
            border-radius: 4px;
            padding: 6px 12px;
            font-size: 12px;
            color: var(--text-light);
            margin: 0 6px 6px 0;
        }

        /* ==================== PROJECT FOLDER TRACKER ==================== */
        .project-folder-tracker {
            background: var(--bg-surface);
            border: 1px solid var(--blue);
            border-radius: 8px;
            padding: 24px;
            margin-bottom: 24px;
        }

        .folder-tracker-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--blue);
        }

        .folder-tracker-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--gold);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .folder-tracker-progress {
            font-size: 12px;
            color: var(--text-muted);
        }

        .folder-step-group {
            margin-bottom: 16px;
        }

        .folder-step-label {
            font-size: 11px;
            font-weight: 600;
            color: var(--gold);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .folder-step-label .step-badge {
            background: var(--bg-base);
            border: 1px solid var(--blue);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            color: var(--text-muted);
        }

        .folder-step-label .step-badge.done {
            background: var(--success);
            border-color: var(--success);
            color: var(--bg-base);
        }

        .folder-step-label .step-badge.partial {
            background: rgba(251,191,36,0.15);
            border-color: #fbbf24;
            color: #fbbf24;
            border-radius: 10px;
            width: auto;
            padding: 0 6px;
            font-size: 9px;
        }

        .folder-dep-note {
            padding: 6px 12px 6px 42px;
            margin-bottom: 4px;
        }

        .item-status.pending {
            color: var(--text-muted);
            font-size: 11px;
        }

        .item-status.done {
            color: var(--success);
            font-size: 11px;
        }

        .folder-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            background: var(--bg-base);
            border: 1px solid var(--blue);
            border-radius: 4px;
            margin-bottom: 4px;
            font-size: 13px;
            color: var(--text-light);
        }

        .folder-item.pending {
            opacity: 0.5;
            border-style: dashed;
        }

        .folder-item .item-icon {
            font-size: 14px;
            flex-shrink: 0;
        }

        .folder-item .item-name {
            flex: 1;
        }

        .folder-item .item-status {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .folder-item .item-status.done {
            color: var(--success);
        }

        .folder-item .item-status.pending {
            color: var(--text-muted);
        }

        /* Required Documents Panel */
        .docs-panel {
            background: var(--bg-surface);
            border: 1px solid var(--blue);
            border-radius: 8px;
            margin-bottom: 24px;
        }

        .docs-panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            cursor: pointer;
            border-bottom: 1px solid var(--blue);
        }

        .docs-panel-header:hover {
            background: var(--bg-elevated);
        }

        .docs-panel-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--gold);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .docs-panel-toggle {
            font-size: 12px;
            color: var(--text-muted);
        }

        .docs-panel-body {
            padding: 16px 20px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }

        .docs-panel-body.collapsed {
            display: none;
        }

        /* ==================== SUPPLEMENTAL FILES PANEL ==================== */
        .supp-files-panel {
            background: var(--bg-card);
            border: 1px solid var(--blue);
            border-radius: 8px;
            margin-bottom: 24px;
            overflow: hidden;
        }
        .supp-files-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 20px;
            cursor: pointer;
            border-bottom: 1px solid var(--blue);
            background: var(--bg-elevated);
        }
        .supp-files-header:hover { background: var(--bg-hover); }
        .supp-files-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--gold);
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .supp-files-count {
            background: var(--blue);
            color: #fff;
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 10px;
            min-width: 20px;
            text-align: center;
        }
        .supp-files-body { padding: 16px 20px; }
        .supp-files-body.collapsed { display: none; }
        .supp-files-dropzone {
            border: 2px dashed var(--blue);
            border-radius: 8px;
            padding: 24px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 12px;
            color: var(--text-muted);
            font-size: 13px;
        }
        .supp-files-dropzone:hover, .supp-files-dropzone.dragover {
            border-color: var(--gold);
            background: rgba(192, 192, 192, 0.05);
            color: var(--gold);
        }
        .supp-files-list {
            max-height: 300px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .supp-file-card {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 14px;
            background: var(--bg-base);
            border: 1px solid #222;
            border-radius: 6px;
        }
        .supp-file-icon { font-size: 20px; flex-shrink: 0; }
        .supp-file-info { flex: 1; min-width: 0; }
        .supp-file-name {
            font-size: 13px;
            color: var(--text-light);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .supp-file-meta {
            font-size: 11px;
            color: var(--text-muted);
            display: flex;
            gap: 10px;
            margin-top: 2px;
        }
        .supp-file-tag {
            font-size: 10px;
            padding: 1px 6px;
            border-radius: 4px;
            background: var(--blue);
            color: #fff;
        }
        .supp-file-actions { display: flex; gap: 6px; flex-shrink: 0; }
        .supp-file-actions button {
            background: none;
            border: 1px solid #333;
            color: var(--text-muted);
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
        }
        .supp-file-actions button:hover {
            border-color: var(--gold);
            color: var(--gold);
        }
        .supp-files-empty {
            text-align: center;
            color: var(--text-muted);
            font-size: 13px;
            padding: 16px 0;
        }
        .supp-files-filter {
            display: flex;
            gap: 6px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }
        .supp-files-filter button {
            background: var(--bg-base);
            border: 1px solid #333;
            color: var(--text-muted);
            padding: 4px 10px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 11px;
        }
        .supp-files-filter button.active {
            border-color: var(--gold);
            color: var(--gold);
            background: rgba(192, 192, 192, 0.1);
        }

        /* ==================== AERIAL FETCH SECTION ==================== */
        .aerial-fetch-section {
            background: var(--bg-base);
            border: 1px solid var(--blue);
            border-radius: 8px;
            padding: 16px 20px;
            margin-bottom: 16px;
        }
        .aerial-fetch-section .ws-section-title {
            margin-bottom: 12px;
        }
        .aerial-fetch-row {
            display: flex;
            gap: 10px;
            align-items: flex-end;
            flex-wrap: wrap;
            margin-bottom: 12px;
        }
        .aerial-fetch-row .ws-form-group {
            flex: 1;
            min-width: 120px;
        }
        .aerial-fetch-row .ws-form-group label {
            font-size: 11px;
            margin-bottom: 4px;
            display: block;
        }
        #aerial-preview {
            border: 1px solid #333;
            border-radius: 6px;
            overflow: hidden;
            max-height: 400px;
            margin-top: 12px;
        }
        #aerial-preview img {
            width: 100%;
            height: auto;
            display: block;
        }
        #aerial-status {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 6px;
        }

        /* ==================== LAYOUT EDITOR OVERLAY ==================== */
        .layout-editor-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-base);
            z-index: 10001;
            display: none;
            flex-direction: column;
        }
        .layout-editor-overlay.visible {
            display: flex;
        }
        .layout-editor-toolbar {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            background: var(--bg-elevated);
            border-bottom: 2px solid var(--blue);
            flex-shrink: 0;
            overflow-x: auto;
        }
        .layout-editor-toolbar .le-btn {
            background: var(--bg-base);
            border: 1px solid #333;
            color: var(--text-light);
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .layout-editor-toolbar .le-btn:hover { border-color: var(--gold); color: var(--gold); }
        .layout-editor-toolbar .le-btn.active { border-color: var(--gold); background: rgba(192,192,192,0.1); color: var(--gold); }
        .layout-editor-toolbar .le-sep {
            width: 1px;
            height: 24px;
            background: #333;
            margin: 0 4px;
        }
        .layout-editor-body {
            display: flex;
            flex: 1;
            overflow: hidden;
        }
        .layout-canvas-wrap {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #111;
            overflow: auto;
            position: relative;
        }
        .layout-props-panel {
            width: 240px;
            background: var(--bg-elevated);
            border-left: 1px solid #333;
            overflow-y: auto;
            padding: 12px;
            flex-shrink: 0;
        }
        .layout-props-panel h4 {
            font-size: 12px;
            color: var(--gold);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 10px;
        }
        .layout-props-panel label {
            font-size: 11px;
            color: var(--text-muted);
            display: block;
            margin-bottom: 3px;
        }
        .layout-props-panel input,
        .layout-props-panel select {
            width: 100%;
            background: var(--bg-base);
            border: 1px solid #333;
            color: var(--text-light);
            padding: 5px 8px;
            border-radius: 4px;
            font-size: 12px;
            margin-bottom: 8px;
        }
        .layout-statusbar {
            display: flex;
            gap: 20px;
            padding: 6px 16px;
            background: var(--bg-elevated);
            border-top: 1px solid #333;
            font-size: 11px;
            color: var(--text-muted);
            flex-shrink: 0;
        }

        .docs-category-title {
            font-size: 11px;
            font-weight: 600;
            color: var(--gold);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 10px;
            padding-bottom: 6px;
            border-bottom: 1px solid var(--blue);
        }

        .doc-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 0;
        }

        .doc-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: var(--success);
        }

        .doc-item-label {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .doc-item.checked .doc-item-label {
            color: var(--success);
            text-decoration: line-through;
        }

        /* Step Instructions Panel */
        .step-instructions {
            background: var(--bg-surface);
            border: 1px solid var(--blue);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 24px;
        }

        .step-instructions-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--gold);
            margin-bottom: 12px;
        }

        .step-instructions-content {
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.7;
        }

        .step-instructions-content ol {
            margin-left: 20px;
            margin-top: 8px;
        }

        .step-instructions-content li {
            margin-bottom: 8px;
        }

        .step-instructions-content strong {
            color: var(--text-light);
        }

        /* Step Actions */
        .step-actions {
            display: flex;
            gap: 12px;
            margin-top: 20px;
            padding-top: 16px;
            border-top: 1px solid var(--blue);
        }

        .action-btn {
            padding: 12px 24px;
            background: linear-gradient(145deg, #00BBFF, #0088CC);
            border: 1px solid #00CCFF;
            color: #ffffff;
            font-size: 14px;
            font-weight: 600;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.15s ease;
            box-shadow: 0 3px 0 #005588, 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        .action-btn:hover {
            background: linear-gradient(145deg, #33CCFF, #00AAFF);
            color: #ffffff;
            box-shadow: 0 2px 0 #005588, 0 3px 6px rgba(0, 0, 0, 0.3);
            transform: translateY(1px);
        }

        .action-btn:active {
            transform: translateY(3px);
            box-shadow: 0 0 0 #005588, 0 1px 3px rgba(0, 0, 0, 0.3);
        }

        /* Step Tools */
        .step-tools {
            margin-top: 20px;
            padding-top: 16px;
            border-top: 1px solid var(--blue);
        }

        .step-tools-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--gold);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 12px;
        }

        .step-tools-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .step-tool-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            background: transparent;
            border: 1px solid var(--blue);
            color: var(--accent-silver);
            font-size: 13px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .step-tool-btn:hover {
            background: var(--blue);
            color: var(--bg-base);
        }

        .step-tool-icon {
            font-size: 18px;
        }

        /* New Project Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10000;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.visible {
            display: flex;
        }

        .modal-content {
            background: var(--bg-surface);
            border: 2px solid var(--blue);
            border-radius: 8px;
            width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid var(--blue);
        }

        .modal-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--gold);
        }

        .modal-close {
            background: transparent;
            border: 1px solid var(--blue);
            color: var(--text-muted);
            width: 28px;
            height: 28px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 18px;
        }

        .modal-close:hover {
            border-color: var(--blue-light);
            color: var(--text-light);
        }

        .modal-body {
            padding: 20px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            font-size: 12px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
        }

        .form-input, .form-select {
            width: 100%;
            padding: 10px 12px;
            background: var(--bg-base);
            border: 1px solid var(--blue);
            border-radius: 6px;
            color: var(--text-light);
            font-size: 14px;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: var(--blue-light);
        }

        .modal-footer {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            padding: 16px 20px;
            border-top: 1px solid var(--blue);
        }

        .btn-secondary {
            padding: 10px 20px;
            background: transparent;
            border: 1px solid var(--blue);
            color: var(--text-secondary);
            font-size: 14px;
            border-radius: 6px;
            cursor: pointer;
        }

        .btn-secondary:hover {
            border-color: var(--blue-light);
            color: var(--text-light);
        }

        .btn-primary {
            padding: 10px 20px;
            background: var(--blue);
            border: 1px solid var(--blue);
            color: var(--bg-base);
            font-size: 14px;
            font-weight: 600;
            border-radius: 6px;
            cursor: pointer;
        }

        .btn-primary:hover {
            background: var(--blue-light);
        }

        /* ==================== PLATFORM GUIDANCE SECTION ==================== */
        /* BLACK/SILVER/GOLD Color Scheme */
        .guidance-section {
            padding: 24px 32px;
            background: #0a0a0a;
            border-bottom: 1px solid #00AAFF;
        }

        .guidance-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            cursor: pointer;
        }

        .guidance-title {
            font-size: 16px;
            font-weight: 600;
            color: #00AAFF;
            text-transform: uppercase;
            letter-spacing: 1.5px;
        }

        .guidance-toggle {
            font-size: 14px;
            color: #c0c0c0;
            transition: transform 0.3s;
        }

        .guidance-toggle.collapsed {
            transform: rotate(180deg);
        }

        .guidance-content {
            display: grid;
            gap: 24px;
            transition: all 0.3s ease;
        }

        .guidance-content.collapsed {
            display: none;
        }

        .guidance-description {
            font-size: 14px;
            color: #c0c0c0;
            line-height: 1.6;
            margin-bottom: 8px;
            padding: 16px;
            background: #1a1a1a;
            border-left: 3px solid #00AAFF;
            border-radius: 0 6px 6px 0;
        }

        .guidance-tools-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
        }

        @media (max-width: 900px) {
            .guidance-tools-grid {
                grid-template-columns: 1fr;
            }
        }

        .guidance-tool-card {
            background: #0a0a0a;
            border: 1px solid #c0c0c0;
            border-radius: 10px;
            padding: 20px;
            transition: all 0.2s;
        }

        .guidance-tool-card:hover {
            border-color: #00AAFF;
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(212, 175, 55, 0.2);
        }

        .guidance-tool-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .guidance-tool-icon {
            font-size: 28px;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #1a1a1a;
            border-radius: 8px;
            border: 1px solid #c0c0c0;
        }

        .guidance-tool-name {
            font-size: 15px;
            font-weight: 600;
            color: #00AAFF;
        }

        .guidance-tool-status {
            font-size: 10px;
            padding: 3px 8px;
            border-radius: 4px;
            margin-left: auto;
        }

        .guidance-tool-status.active {
            background: rgba(74, 222, 128, 0.2);
            color: #4ade80;
            border: 1px solid #4ade80;
        }

        .guidance-tool-status.available {
            background: rgba(192, 192, 192, 0.1);
            color: #c0c0c0;
            border: 1px solid #c0c0c0;
        }

        .guidance-tool-status.embed {
            background: rgba(212, 175, 55, 0.2);
            color: #00AAFF;
            border: 1px solid #00AAFF;
        }

        .guidance-tool-desc {
            font-size: 13px;
            color: #c0c0c0;
            line-height: 1.5;
            margin-bottom: 16px;
        }

        .guidance-tool-uses {
            font-size: 11px;
            color: #808080;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .guidance-use-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .guidance-use-list li {
            font-size: 12px;
            color: #c0c0c0;
            padding: 6px 0;
            padding-left: 16px;
            position: relative;
            border-bottom: 1px solid rgba(192, 192, 192, 0.1);
        }

        .guidance-use-list li:last-child {
            border-bottom: none;
        }

        .guidance-use-list li::before {
            content: "";
            position: absolute;
            left: 0;
            color: #00AAFF;
        }

        .guidance-tool-action {
            margin-top: 16px;
            padding-top: 12px;
            border-top: 1px solid rgba(192, 192, 192, 0.2);
        }

        .guidance-action-btn {
            width: 100%;
            padding: 10px 16px;
            background: linear-gradient(145deg, #5a5a5a, #3a3a3a);
            border: 1px solid #6a6a6a;
            border-radius: 6px;
            color: #C0C0C0;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: 0 2px 0 #2a2a2a, 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .guidance-action-btn:hover {
            background: linear-gradient(145deg, #6a6a6a, #4a4a4a);
            color: #ffffff;
            box-shadow: 0 1px 0 #2a2a2a, 0 1px 3px rgba(0, 0, 0, 0.3);
            transform: translateY(1px);
        }

        .guidance-action-btn:active {
            transform: translateY(2px);
            box-shadow: 0 0 0 #2a2a2a, 0 1px 2px rgba(0, 0, 0, 0.3);
        }

        .guidance-action-btn.primary {
            background: linear-gradient(145deg, #00BBFF, #0088CC);
            color: #ffffff;
            border: 1px solid #00CCFF;
            box-shadow: 0 2px 0 #005588, 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .guidance-action-btn.primary:hover {
            background: linear-gradient(145deg, #33CCFF, #00AAFF);
            box-shadow: 0 1px 0 #005588, 0 1px 3px rgba(0, 0, 0, 0.3);
        }

        /* Claude Prime Embed Container */
        .claude-embed-container {
            margin-top: 24px;
            padding: 20px;
            background: #1a1a1a;
            border: 1px solid #00AAFF;
            border-radius: 10px;
            display: none;
        }

        .claude-embed-container.active {
            display: block;
        }

        .claude-embed-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .claude-embed-title {
            font-size: 14px;
            font-weight: 600;
            color: #00AAFF;
        }

        .claude-embed-close {
            background: transparent;
            border: 1px solid #808080;
            color: #808080;
            padding: 4px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .claude-embed-close:hover {
            border-color: #c0c0c0;
            color: #c0c0c0;
        }

        .claude-embed-frame {
            width: 100%;
            height: 500px;
            border: 1px solid #c0c0c0;
            border-radius: 6px;
            background: #0a0a0a;
        }

        .claude-embed-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 200px;
            background: #0a0a0a;
            border: 1px dashed #00AAFF;
            border-radius: 6px;
            color: #808080;
            text-align: center;
        }

        .claude-embed-placeholder span {
            font-size: 32px;
            margin-bottom: 12px;
        }

        .claude-embed-placeholder p {
            font-size: 13px;
            max-width: 300px;
        }

        /* ============================================
           EXTERNAL PROGRAM BUTTONS - FIXED 120x44px
           ============================================ */

        .ext-btn {
            width: 120px;
            height: 44px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 600;
            color: #C0C0C0;
            background: #0d0d0d;
            position: relative;
            transition: all 0.2s ease;
            box-shadow:
                0 0 0 1px rgba(0, 170, 255, 0.5),
                0 0 0 3px #0a0a0a,
                0 0 15px rgba(0, 170, 255, 0.15),
                inset 0 0 20px rgba(0, 170, 255, 0.03);
            text-shadow: 0 0 8px rgba(0, 170, 255, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .ext-btn::before {
            content: '';
            position: absolute;
            top: -1px;
            left: 10%;
            right: 10%;
            height: 2px;
            background: linear-gradient(90deg, transparent, #00AAFF, transparent);
            border-radius: 2px;
        }

        .ext-btn:hover {
            box-shadow:
                0 0 0 1px rgba(0, 170, 255, 0.8),
                0 0 0 3px #0a0a0a,
                0 0 25px rgba(0, 170, 255, 0.3),
                inset 0 0 30px rgba(0, 170, 255, 0.05);
            text-shadow: 0 0 12px rgba(0, 170, 255, 0.8);
            transform: translateY(-1px);
        }

        .ext-btn:active {
            box-shadow:
                0 0 0 1px rgba(255, 140, 0, 0.8),
                0 0 0 3px #0a0a0a,
                0 0 20px rgba(255, 140, 0, 0.3),
                inset 0 0 25px rgba(255, 140, 0, 0.05);
            text-shadow: 0 0 10px rgba(255, 140, 0, 0.6);
            transform: translateY(1px);
        }

        .ext-btn-icon {
            width: 32px;
            height: 32px;
            filter: drop-shadow(0 0 4px rgba(0, 170, 255, 0.5));
        }

        /* ============================================
           TRAJANUS SCRIPT BUTTONS - V2 SYNAPSE STYLE
           Neural glow with double-ring border effect
           ============================================ */

        .script-btn {
            width: 160px;
            height: 50px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-family: 'Segoe UI', sans-serif;
            font-size: 13px;
            font-weight: 600;
            letter-spacing: 0.8px;
            color: #00AAFF;
            background: #0a0a0a;
            box-shadow:
                0 0 0 1px rgba(0, 170, 255, 0.5),
                0 0 0 3px #0a0a0a,
                0 0 0 4px rgba(0, 170, 255, 0.3),
                0 0 15px rgba(0, 170, 255, 0.2),
                inset 0 0 30px rgba(0, 170, 255, 0.03);
            text-shadow: 0 0 8px rgba(0, 170, 255, 0.5);
            transition: all 0.25s ease;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .script-btn::before {
            content: '';
            position: absolute;
            top: -1px;
            left: 10%;
            right: 10%;
            height: 2px;
            background: linear-gradient(90deg, transparent, #00AAFF, transparent);
            border-radius: 2px;
        }

        .script-btn:hover {
            transform: translateY(-2px);
            color: #fff;
            box-shadow:
                0 0 0 1px rgba(0, 170, 255, 0.8),
                0 0 0 3px #0a0a0a,
                0 0 0 4px rgba(0, 170, 255, 0.5),
                0 0 25px rgba(0, 170, 255, 0.4),
                0 0 50px rgba(0, 170, 255, 0.15),
                inset 0 0 40px rgba(0, 170, 255, 0.05);
            text-shadow: 0 0 15px rgba(0, 170, 255, 0.9);
        }

        .script-btn:active {
            transform: translateY(1px);
            color: #FFB347;
            box-shadow:
                0 0 0 1px rgba(255, 149, 0, 0.8),
                0 0 0 3px #0a0a0a,
                0 0 0 4px rgba(255, 149, 0, 0.4),
                0 0 20px rgba(255, 149, 0, 0.3),
                inset 0 0 30px rgba(255, 149, 0, 0.05);
            text-shadow: 0 0 10px rgba(255, 149, 0, 0.7);
        }

        /* Script Button Brain Icon */
        .script-btn-icon {
            width: 26px;
            height: 26px;
            border-radius: 4px;
            object-fit: cover;
            filter: drop-shadow(0 0 4px rgba(0, 170, 255, 0.5));
        }

        /* ============================================
           NAV BUTTON - Return to Hub - 140x44px
           ============================================ */

        .nav-btn {
            width: 140px;
            height: 44px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 600;
            transition: all 0.15s ease;
            border: 1px solid #6a6a6a;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            color: #C0C0C0;
            background: linear-gradient(145deg, #5a5a5a, #3a3a3a);
            box-shadow: 0 3px 0 #2a2a2a, 0 4px 8px rgba(0,0,0,0.3);
        }

        .nav-btn:hover {
            transform: translateY(-2px);
            color: #ffffff;
            filter: brightness(1.15);
        }

        /* Brand colors removed - ext-btn uses V2 Synapse glow style from main.css */

        /* ============================================ */
        /* PROJECT PROGRESS - TWO PANEL LAYOUT         */
        /* ============================================ */
        .progress-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
            align-items: stretch;
        }

        .progress-section > * {
            min-height: 100%;
        }

        .progress-checklist {
            background: var(--bg-base);
            border: 2px solid #00AAFF;
            border-radius: 12px;
            padding: 20px;
            overflow-y: auto;
        }

        .checklist-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid rgba(192, 192, 192, 0.2);
        }

        .checklist-title {
            font-size: 14px;
            font-weight: 600;
            color: #00AAFF;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .checklist-count {
            font-size: 12px;
            color: var(--text-muted);
            font-family: var(--font-mono);
        }

        .checklist-items {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .checklist-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            background: var(--bg-elevated);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .checklist-item:hover {
            background: var(--bg-hover);
        }

        .checklist-item.completed {
            opacity: 0.6;
        }

        .checklist-checkbox {
            width: 18px;
            height: 18px;
            border: 2px solid #00AAFF;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: all 0.2s ease;
        }

        .checklist-item.completed .checklist-checkbox {
            background: #4ade80;
            border-color: #4ade80;
        }

        .checklist-checkbox::after {
            content: '';
            width: 6px;
            height: 10px;
            border: solid white;
            border-width: 0 2px 2px 0;
            transform: rotate(45deg) scale(0);
            transition: transform 0.2s ease;
        }

        .checklist-item.completed .checklist-checkbox::after {
            transform: rotate(45deg) scale(1);
        }

        .checklist-text {
            font-size: 13px;
            color: var(--text-primary);
            flex: 1;
        }

        .checklist-item.completed .checklist-text {
            text-decoration: line-through;
            color: var(--text-muted);
        }

        .checklist-badge {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .checklist-badge.critical { background: rgba(248, 113, 113, 0.2); color: #f87171; }
        .checklist-badge.high { background: rgba(251, 191, 36, 0.2); color: #fbbf24; }
        .checklist-badge.medium { background: rgba(0, 170, 255, 0.2); color: #00AAFF; }
        .checklist-badge.low { background: rgba(192, 192, 192, 0.2); color: #c0c0c0; }

        .progress-tracker {
            background: var(--bg-base);
            border: 2px solid #00AAFF;
            border-radius: 12px;
            padding: 20px;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .progress-title {
            font-size: 16px;
            font-weight: 600;
            color: #00AAFF;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .progress-title-icon {
            font-size: 20px;
        }

        .progress-overall {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .progress-percent {
            font-size: 28px;
            font-weight: 700;
            color: #00AAFF;
            font-family: var(--font-mono);
        }

        .progress-label {
            font-size: 12px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .progress-phases {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .progress-phase {
            display: grid;
            grid-template-columns: 120px 1fr 60px;
            align-items: center;
            gap: 16px;
        }

        .phase-name {
            font-size: 13px;
            color: var(--text-primary);
            font-weight: 500;
        }

        .phase-bar-container {
            height: 24px;
            background: var(--bg-elevated);
            border-radius: 12px;
            overflow: hidden;
            position: relative;
            border: 1px solid rgba(192, 192, 192, 0.2);
        }

        .phase-bar {
            height: 100%;
            border-radius: 12px;
            position: relative;
            transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .phase-bar.complete {
            background: linear-gradient(90deg, #22c55e 0%, #4ade80 50%, #22c55e 100%);
            box-shadow: 0 0 12px rgba(74, 222, 128, 0.4);
        }

        .phase-bar.in-progress {
            background: linear-gradient(90deg, #0088CC 0%, #00AAFF 50%, #0088CC 100%);
            box-shadow: 0 0 12px rgba(0, 170, 255, 0.4);
            animation: progressPulse 2s ease-in-out infinite;
        }

        .phase-bar.pending {
            background: linear-gradient(90deg, #4a4a4a 0%, #6a6a6a 50%, #4a4a4a 100%);
        }

        .phase-bar.blocked {
            background: linear-gradient(90deg, #dc2626 0%, #f87171 50%, #dc2626 100%);
            box-shadow: 0 0 12px rgba(248, 113, 113, 0.4);
        }

        .phase-bar.in-progress::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        @keyframes progressPulse {
            0%, 100% { box-shadow: 0 0 12px rgba(0, 170, 255, 0.4); }
            50% { box-shadow: 0 0 20px rgba(0, 170, 255, 0.7); }
        }

        .phase-percent {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
            font-family: var(--font-mono);
            text-align: right;
        }

        .phase-percent.complete { color: #4ade80; }
        .phase-percent.in-progress { color: #00AAFF; }
        .phase-percent.blocked { color: #f87171; }

        .phase-tasks {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 11px;
            color: rgba(255,255,255,0.9);
            font-weight: 600;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
        }

        .progress-footer {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
            padding-top: 16px;
            border-top: 1px solid rgba(192, 192, 192, 0.2);
        }

        .progress-stat {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .stat-value {
            font-size: 20px;
            font-weight: 700;
            font-family: var(--font-mono);
        }

        .stat-value.green { color: #4ade80; }
        .stat-value.blue { color: #00AAFF; }
        .stat-value.gray { color: #6a6a6a; }
        .stat-value.red { color: #f87171; }

        .stat-label {
            font-size: 11px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* ============================================ */
        /* JURISDICTION BROWSER STYLES                 */
        /* ============================================ */
        .jurisdiction-browser {
            display: grid;
            grid-template-columns: 280px 1fr;
            gap: 20px;
            margin: 20px 0;
        }

        .jurisdiction-list {
            background: var(--bg-elevated);
            border: 2px solid #00AAFF;
            border-radius: 12px;
            padding: 16px;
            max-height: 600px;
            overflow-y: auto;
        }

        .jurisdiction-list-header {
            font-size: 12px;
            font-weight: 600;
            color: #00AAFF;
            text-transform: uppercase;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(192, 192, 192, 0.2);
        }

        .jurisdiction-search {
            width: 100%;
            padding: 8px 12px;
            background: var(--bg-base);
            border: 1px solid var(--border-subtle);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 13px;
            margin-bottom: 12px;
        }

        .jurisdiction-search:focus {
            outline: none;
            border-color: #00AAFF;
        }

        .jurisdiction-items {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .jurisdiction-item {
            padding: 10px 12px;
            background: var(--bg-base);
            border: 1px solid transparent;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .jurisdiction-item:hover {
            border-color: var(--border-subtle);
            background: var(--bg-hover);
        }

        .jurisdiction-item.active {
            border-color: #00AAFF;
            background: rgba(0, 170, 255, 0.1);
        }

        .jurisdiction-item-name {
            font-size: 13px;
            font-weight: 500;
            color: var(--text-primary);
        }

        .jurisdiction-item-type {
            font-size: 11px;
            color: var(--text-muted);
            text-transform: capitalize;
        }

        .jurisdiction-detail {
            background: var(--bg-elevated);
            border: 2px solid #00AAFF;
            border-radius: 12px;
            padding: 20px;
            max-height: 600px;
            overflow-y: auto;
        }

        .jurisdiction-detail-empty {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--text-muted);
            text-align: center;
        }

        .jurisdiction-detail-empty-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .jurisdiction-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid rgba(192, 192, 192, 0.2);
        }

        .jurisdiction-title {
            font-size: 18px;
            font-weight: 700;
            color: #00AAFF;
            margin-bottom: 4px;
        }

        .jurisdiction-subtitle {
            font-size: 12px;
            color: var(--text-muted);
        }

        .jurisdiction-population {
            text-align: right;
        }

        .jurisdiction-population-value {
            font-size: 20px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .jurisdiction-population-label {
            font-size: 10px;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .jurisdiction-section {
            margin-bottom: 20px;
        }

        .jurisdiction-section-title {
            font-size: 12px;
            font-weight: 600;
            color: #00AAFF;
            text-transform: uppercase;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(192, 192, 192, 0.2);
        }

        .jurisdiction-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .jurisdiction-field {
            background: var(--bg-base);
            padding: 10px 12px;
            border-radius: 6px;
        }

        .jurisdiction-field-label {
            font-size: 10px;
            color: var(--text-muted);
            text-transform: uppercase;
            margin-bottom: 4px;
        }

        .jurisdiction-field-value {
            font-size: 13px;
            color: var(--text-primary);
        }

        .jurisdiction-list-items {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .jurisdiction-list-item {
            font-size: 13px;
            color: var(--text-primary);
            padding: 6px 0;
            padding-left: 16px;
            position: relative;
        }

        .jurisdiction-list-item::before {
            content: "";
            position: absolute;
            left: 0;
            color: #00AAFF;
        }

        .jurisdiction-contact-card {
            background: var(--bg-base);
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 12px;
        }

        .jurisdiction-contact-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .jurisdiction-contact-item {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        .jurisdiction-contact-link {
            color: #00AAFF;
            text-decoration: none;
        }

        .jurisdiction-contact-link:hover {
            text-decoration: underline;
        }

        .jurisdiction-steps {
            counter-reset: step;
        }

        .jurisdiction-step {
            font-size: 13px;
            color: var(--text-primary);
            padding: 8px 0 8px 28px;
            position: relative;
        }

        .jurisdiction-step::before {
            counter-increment: step;
            content: counter(step);
            position: absolute;
            left: 0;
            width: 20px;
            height: 20px;
            background: #00AAFF;
            color: var(--bg-base);
            border-radius: 50%;
            font-size: 11px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .jurisdiction-issue {
            background: rgba(248, 113, 113, 0.1);
            border-left: 3px solid #f87171;
            padding: 8px 12px;
            margin-bottom: 8px;
            border-radius: 0 6px 6px 0;
            font-size: 13px;
            color: var(--text-primary);
        }

    </style>
</head>
<body>
    <!-- Sticky Hero Section with Logo -->
    <section class="hero-section">
        <div class="hero-content">
            <div class="hero-brand">
                <!-- Neural Grid Logo (2026-01-16) -->
                <style>
                    .toolkit-logo-lockup {
                        display: flex;
                        align-items: center;
                        position: relative;
                    }
                    .toolkit-hero-logo {
                        width: 70px;
                        height: 70px;
                        object-fit: contain;
                        filter: drop-shadow(0 0 6px rgba(255, 255, 255, 0.15));
                    }
                    .toolkit-brand-text {
                        display: flex;
                        flex-direction: column;
                        justify-content: center;
                        margin-left: -18px;
                        height: 70px;
                    }
                    .toolkit-brand-title {
                        color: #00AAFF;
                        font-family: Tahoma, sans-serif;
                        font-size: 28px;
                        font-weight: 300;
                        letter-spacing: 6px;
                        margin: 0;
                    }
                    .toolkit-brand-tagline {
                        color: #C0C0C0;
                        font-size: 8px;
                        letter-spacing: 2.5px;
                        margin: 2px 0 0 0;
                    }
                    .toolkit-brand-tagline .tm {
                        font-size: 6px;
                        vertical-align: super;
                        margin-left: 1px;
                        opacity: 0.7;
                    }
                </style>
                <div class="toolkit-logo-lockup">
                    <img src="../assets/trajanus-logo-white-grid.png" alt="Trajanus Logo" class="toolkit-hero-logo">
                    <div class="toolkit-brand-text">
                        <h1 class="toolkit-brand-title">TRAJANUS</h1>
                        <p class="toolkit-brand-tagline">ENGINEERED INTELLIGENCE<span class="tm"></span></p>
                    </div>
                </div>
                <div class="hero-toolkit">TRAFFIC STUDIES TOOLKIT</div>
            </div>
            <div class="hero-nav">
                <a href="../index.html" class="hero-home-btn" id="home-btn"> Return to Hub</a>
            </div>
        </div>
    </section>

    <!-- Introduction Section (Collapsible) -->
    <section class="intro-section" id="intro-section">
        <div class="intro-header" onclick="toggleIntro()">
            <span class="intro-title"> Platform Introduction</span>
            <span class="intro-toggle" id="intro-toggle"></span>
        </div>
        <div class="intro-content" id="intro-content">
            <!-- Decision Tree -->
            <div class="intro-decision">
                <div class="decision-card" data-action="new-study">
                    <div class="decision-icon"></div>
                    <div class="decision-title">New Study</div>
                    <div class="decision-desc">Start fresh TIA from scratch</div>
                </div>
                <div class="decision-card" data-action="continue-study">
                    <div class="decision-icon"></div>
                    <div class="decision-title">Continue Existing</div>
                    <div class="decision-desc">Resume work on active project</div>
                </div>
                <div class="decision-card" data-action="research">
                    <div class="decision-icon"></div>
                    <div class="decision-title">Research Only</div>
                    <div class="decision-desc">Traffic data lookup, counts, LOS</div>
                </div>
                <div class="decision-card" data-action="templates">
                    <div class="decision-icon"></div>
                    <div class="decision-title">Review Templates</div>
                    <div class="decision-desc">Access report templates & standards</div>
                </div>
            </div>

            <!-- Tools Grid -->
            <div class="intro-tools-section">
                <div class="intro-section-label">Core Tools</div>
                <div class="intro-tools-grid">
                    <div class="intro-tool-card" title="Traffic signal timing & simulation">
                        <span class="intro-tool-icon"></span>
                        <span class="intro-tool-name">Synchro</span>
                    </div>
                    <div class="intro-tool-card" title="Highway Capacity Software">
                        <span class="intro-tool-icon"></span>
                        <span class="intro-tool-name">HCS</span>
                    </div>
                    <div class="intro-tool-card" title="ITE Trip Generation Manual">
                        <span class="intro-tool-icon"></span>
                        <span class="intro-tool-name">Trip Gen</span>
                    </div>
                    <div class="intro-tool-card" title="AutoCAD for site plans">
                        <span class="intro-tool-icon"></span>
                        <span class="intro-tool-name">AutoCAD</span>
                    </div>
                    <div class="intro-tool-card" title="Google Maps for site location">
                        <span class="intro-tool-icon"></span>
                        <span class="intro-tool-name">Maps</span>
                    </div>
                    <div class="intro-tool-card" title="Microsoft Word for reports">
                        <span class="intro-tool-icon"></span>
                        <span class="intro-tool-name">Word</span>
                    </div>
                </div>
            </div>

            <!-- 10-Step Workflow Overview -->
            <div class="intro-workflow">
                <div class="intro-section-label">10-Step TIA Workflow</div>
                <div class="intro-workflow-steps">
                    <div class="intro-workflow-step"><span class="step-num">1</span> Setup</div>
                    <span class="intro-workflow-connector"></span>
                    <div class="intro-workflow-step"><span class="step-num">2</span> Data Collection</div>
                    <span class="intro-workflow-connector"></span>
                    <div class="intro-workflow-step"><span class="step-num">3</span> Trip Generation</div>
                    <span class="intro-workflow-connector"></span>
                    <div class="intro-workflow-step"><span class="step-num">4</span> Distribution</div>
                    <span class="intro-workflow-connector"></span>
                    <div class="intro-workflow-step"><span class="step-num">5</span> Future Volumes</div>
                    <span class="intro-workflow-connector"></span>
                    <div class="intro-workflow-step"><span class="step-num">6</span> Capacity Analysis</div>
                    <span class="intro-workflow-connector"></span>
                    <div class="intro-workflow-step"><span class="step-num">7</span> Site Access</div>
                    <span class="intro-workflow-connector"></span>
                    <div class="intro-workflow-step"><span class="step-num">8</span> Signal Warrants</div>
                    <span class="intro-workflow-connector"></span>
                    <div class="intro-workflow-step"><span class="step-num">9</span> Report Assembly</div>
                    <span class="intro-workflow-connector"></span>
                    <div class="intro-workflow-step"><span class="step-num">10</span> Final Delivery</div>
                </div>
            </div>

            <!-- Folder Structure -->
            <div class="intro-folders">
                <div class="intro-section-label">Project Folder Structure</div>
                <div class="intro-folders-grid">
                    <div class="intro-folder"><span class="intro-folder-icon"></span> 01-Input</div>
                    <div class="intro-folder"><span class="intro-folder-icon"></span> 02-Working</div>
                    <div class="intro-folder"><span class="intro-folder-icon"></span> 03-Output</div>
                    <div class="intro-folder"><span class="intro-folder-icon"></span> 04-Correspondence</div>
                    <div class="intro-folder"><span class="intro-folder-icon"></span> 05-Final</div>
                </div>
            </div>

            <!-- Quick Tips -->
            <div class="intro-tips">
                <div class="intro-section-label">Quick Tips</div>
                <div class="intro-tips-list">
                    <div class="intro-tip">
                        <span class="intro-tip-icon"></span>
                        <span class="intro-tip-text">Select your project from the dropdown or create a new one to get started with the workflow tracker.</span>
                    </div>
                    <div class="intro-tip">
                        <span class="intro-tip-icon"></span>
                        <span class="intro-tip-text">Use the AI Assistant (Trajanus) for guidance on methodology, calculations, and jurisdiction requirements.</span>
                    </div>
                    <div class="intro-tip">
                        <span class="intro-tip-icon"></span>
                        <span class="intro-tip-text">The workflow steps update as you progress. Each step provides relevant tools and documentation links.</span>
                    </div>
                </div>
            </div>
        </div>
    </section>


    <div class="workspace-container">

        <!-- Project Bar -->
        <div class="project-bar">
            <span class="project-bar-label">Project:</span>
            <select class="project-select" id="project-status-filter" style="width:auto;min-width:80px;font-size:11px;padding:4px 6px;background:var(--bg-hover);border:1px solid var(--border-subtle);color:var(--text-primary);border-radius:4px;margin-right:4px;">
                <option value="all">All</option>
                <option value="draft">Draft</option>
                <option value="active">Active</option>
                <option value="in-review">In Review</option>
                <option value="approved">Approved</option>
                <option value="delivered">Delivered</option>
            </select>
            <select class="project-select" id="project-select">
                <option value="">-- Select Project --</option>
            </select>
            <button class="new-project-btn" id="new-project-btn">+ New Project</button>
            <button class="new-project-btn" id="import-project-btn" style="background:var(--bg-hover);border:1px solid var(--border-subtle);">Import</button>
            <input type="file" id="import-project-file" accept=".json,.tse-project.json" style="display:none;">
            <span class="autosave-indicator" id="autosave-indicator"></span>
        </div>

        <!-- Main Scrollable Content -->
        <main class="main-content">
            <!-- ==================== WORKFLOW TRACKER ==================== -->
            <div class="workflow-tracker" id="workflow-tracker">
                <div class="workflow-header">
                    <span class="workflow-title">TIA Workflow</span>
                    <span class="workflow-progress" id="workflow-progress">Step 0 of 10</span>
                </div>
                <div class="workflow-steps">
                    <div class="workflow-step active" data-step="1">
                        <span class="workflow-step-number">1</span>
                        <span class="workflow-step-name">Setup</span>
                        <button class="step-preview-btn" data-preview="1">Preview</button>
                    </div>
                    <div class="workflow-step" data-step="2">
                        <span class="workflow-step-number">2</span>
                        <span class="workflow-step-name">Data Collection</span>
                        <button class="step-preview-btn" data-preview="2">Preview</button>
                    </div>
                    <div class="workflow-step" data-step="3">
                        <span class="workflow-step-number">3</span>
                        <span class="workflow-step-name">Trip Gen</span>
                        <button class="step-preview-btn" data-preview="3">Preview</button>
                    </div>
                    <div class="workflow-step" data-step="4">
                        <span class="workflow-step-number">4</span>
                        <span class="workflow-step-name">Distribution</span>
                        <button class="step-preview-btn" data-preview="4">Preview</button>
                    </div>
                    <div class="workflow-step" data-step="5">
                        <span class="workflow-step-number">5</span>
                        <span class="workflow-step-name">Future Vol</span>
                        <button class="step-preview-btn" data-preview="5">Preview</button>
                    </div>
                    <div class="workflow-step" data-step="6">
                        <span class="workflow-step-number">6</span>
                        <span class="workflow-step-name">Capacity</span>
                        <button class="step-preview-btn" data-preview="6">Preview</button>
                    </div>
                    <div class="workflow-step" data-step="7">
                        <span class="workflow-step-number">7</span>
                        <span class="workflow-step-name">Site Access</span>
                        <button class="step-preview-btn" data-preview="7">Preview</button>
                    </div>
                    <div class="workflow-step" data-step="8">
                        <span class="workflow-step-number">8</span>
                        <span class="workflow-step-name">Warrants</span>
                        <button class="step-preview-btn" data-preview="8">Preview</button>
                    </div>
                    <div class="workflow-step" data-step="9">
                        <span class="workflow-step-number">9</span>
                        <span class="workflow-step-name">Report</span>
                        <button class="step-preview-btn" data-preview="9">Preview</button>
                    </div>
                    <div class="workflow-step" data-step="10">
                        <span class="workflow-step-number">10</span>
                        <span class="workflow-step-name">Final</span>
                        <button class="step-preview-btn" data-preview="10">Preview</button>
                    </div>
                </div>
                <div class="pipeline-progress">
                    <div class="pipeline-progress-fill" id="pipeline-fill" style="width: 0%"></div>
                </div>
                <div class="pipeline-progress-label">
                    <span id="pipeline-label">0 / 10 steps complete</span>
                    <span id="pipeline-percent">0%</span>
                </div>
            </div>

            <!-- ==================== WORKFLOW WORKSPACE ==================== -->
            <div class="workflow-workspace" id="workflow-workspace">

                <!-- STEP 1: PROJECT SETUP -->
                <div class="workspace-panel active" id="ws-panel-1" data-step="1">
                    <h3>Step 1  Project Setup</h3>

                    <div class="ws-form-grid">
                        <div class="ws-form-group">
                            <label for="ws-project-name">Project Name</label>
                            <input type="text" id="ws-project-name" placeholder="e.g., Grace Fellowship Church TIS">
                        </div>
                        <div class="ws-form-group">
                            <label for="ws-project-number">Project Number</label>
                            <input type="text" id="ws-project-number" placeholder="e.g., TRA-2026-001">
                        </div>
                        <div class="ws-form-group full-width">
                            <label for="ws-site-address">Site Address</label>
                            <input type="text" id="ws-site-address" placeholder="e.g., 12345 N Oracle Rd, Tucson, AZ 85737">
                        </div>
                        <div class="ws-form-group">
                            <label for="ws-jurisdiction">Jurisdiction</label>
                            <select id="ws-jurisdiction">
                                <option value="">-- Select Jurisdiction --</option>
                                <option value="pima">Pima County</option>
                                <option value="marana">Town of Marana</option>
                                <option value="tucson">City of Tucson</option>
                                <option value="oro-valley">Town of Oro Valley</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="ws-form-group">
                            <label for="ws-opening-year">Opening Year</label>
                            <input type="number" id="ws-opening-year" placeholder="2027" min="2025" max="2050">
                        </div>
                        <div class="ws-form-group">
                            <label for="ws-horizon-year">Horizon Year</label>
                            <input type="number" id="ws-horizon-year" placeholder="2032" min="2025" max="2060">
                        </div>
                        <div class="ws-form-group">
                            <label for="ws-growth-rate">Annual Growth Rate %</label>
                            <input type="number" id="ws-growth-rate" placeholder="2.0" step="0.1" min="0" max="20">
                        </div>
                    </div>

                    <div class="ws-section-title">Buildings</div>
                    <table class="buildings-table" id="buildings-table">
                        <thead>
                            <tr>
                                <th style="width:28%">Building Name</th>
                                <th style="width:18%">Square Footage</th>
                                <th style="width:22%">ITE LUC Code</th>
                                <th style="width:12%">Drive-Thru</th>
                                <th style="width:10%"></th>
                            </tr>
                        </thead>
                        <tbody id="buildings-tbody">
                            <tr>
                                <td><input type="text" placeholder="e.g., Main Building"></td>
                                <td><input type="number" placeholder="10,000"></td>
                                <td><input type="text" placeholder="e.g., 560"></td>
                                <td style="text-align:center"><input type="checkbox"></td>
                                <td><button class="remove-building-btn" onclick="this.closest('tr').remove()"></button></td>
                            </tr>
                        </tbody>
                    </table>
                    <button class="add-building-btn" id="add-building-btn">+ Add Building</button>

                    <div class="ws-section-title">Site Documents</div>
                    <div class="ws-drop-zone" id="ws-drop-zone">
                        <div class="ws-drop-icon"></div>
                        <div class="ws-drop-text">Drop site plan, plat, or aerial here</div>
                        <div class="ws-drop-subtext">PDF, PNG, JPG</div>
                    </div>
                    <div style="display:flex;gap:12px;margin-bottom:24px;">
                        <button class="action-btn" id="ws-browse-files" style="flex:1;padding:12px;font-size:13px;cursor:pointer;"> Browse Files (Native Dialog)</button>
                        <button class="action-btn" id="ws-browse-local" style="flex:1;padding:12px;font-size:13px;cursor:pointer;"> Browse Local (HTML)</button>
                    </div>
                    <div id="ws-attached-files" style="margin-bottom:16px;"></div>

                    <!-- INTERSECTION AERIAL FETCH -->
                    <div class="aerial-fetch-section">
                        <div class="ws-section-title">Intersection Aerial</div>
                        <div class="aerial-fetch-row">
                            <div class="ws-form-group">
                                <label for="aerial-lat">Latitude</label>
                                <input type="number" id="aerial-lat" class="ws-input" placeholder="32.2540" step="0.0001" style="width:100%;">
                            </div>
                            <div class="ws-form-group">
                                <label for="aerial-lon">Longitude</label>
                                <input type="number" id="aerial-lon" class="ws-input" placeholder="-110.9742" step="0.0001" style="width:100%;">
                            </div>
                            <div class="ws-form-group" style="flex:0.6;">
                                <label for="aerial-zoom">Zoom</label>
                                <input type="number" id="aerial-zoom" class="ws-input" value="18" min="17" max="20" style="width:100%;">
                            </div>
                            <div class="ws-form-group" style="flex:0.5;">
                                <button class="action-btn" id="aerial-fetch-btn" style="padding:10px 16px;font-size:13px;cursor:pointer;width:100%;margin-top:18px;">Fetch</button>
                            </div>
                        </div>
                        <div class="ws-form-group" style="margin-bottom:8px;">
                            <label for="aerial-api-key">Google Maps API Key</label>
                            <input type="password" id="aerial-api-key" class="ws-input" placeholder="AIza..." style="width:100%;">
                        </div>
                        <div id="aerial-preview"></div>
                        <div id="aerial-status"></div>
                    </div>

                    <button class="ws-submit-btn" id="ws-submit-step1">Submit Project Setup</button>
                </div>

                <!-- STEP 2: DATA COLLECTION -->
                <div class="workspace-panel" id="ws-panel-2" data-step="2">
                    <h3>Step 2  Data Collection</h3>

                    <!-- SECTION 1: TMC COUNT INFO -->
                    <div class="ws-section-header">
                        <div class="ws-section-title">TMC Count Info</div>
                        <span class="ws-section-badge incomplete" id="badge-tmc-info">Incomplete</span>
                    </div>
                    <div class="ws-form-grid">
                        <div class="ws-form-group">
                            <label for="ws-count-date">Count Date</label>
                            <input type="date" id="ws-count-date" style="background:var(--bg-base);border:1px solid var(--blue);border-radius:6px;padding:10px;color:var(--text-light);font-size:14px;">
                        </div>
                        <div class="ws-form-group">
                            <label for="ws-day-of-week">Day of Week</label>
                            <select id="ws-day-of-week" style="background:var(--bg-base);border:1px solid var(--blue);border-radius:6px;padding:10px;color:var(--text-light);font-size:14px;">
                                <option value="">-- Select --</option>
                                <option value="tuesday">Tuesday</option>
                                <option value="wednesday">Wednesday</option>
                                <option value="thursday">Thursday</option>
                                <option value="monday">Monday</option>
                                <option value="friday">Friday</option>
                            </select>
                        </div>
                        <div class="ws-form-group">
                            <label>AM Window</label>
                            <div style="display:flex;gap:8px;align-items:center;">
                                <input type="time" id="ws-am-start" value="06:00" style="background:var(--bg-base);border:1px solid var(--blue);border-radius:6px;padding:10px;color:var(--text-light);font-size:14px;flex:1;">
                                <span style="color:var(--text-muted);">to</span>
                                <input type="time" id="ws-am-end" value="09:00" style="background:var(--bg-base);border:1px solid var(--blue);border-radius:6px;padding:10px;color:var(--text-light);font-size:14px;flex:1;">
                            </div>
                        </div>
                        <div class="ws-form-group">
                            <label>PM Window</label>
                            <div style="display:flex;gap:8px;align-items:center;">
                                <input type="time" id="ws-pm-start" value="15:00" style="background:var(--bg-base);border:1px solid var(--blue);border-radius:6px;padding:10px;color:var(--text-light);font-size:14px;flex:1;">
                                <span style="color:var(--text-muted);">to</span>
                                <input type="time" id="ws-pm-end" value="18:00" style="background:var(--bg-base);border:1px solid var(--blue);border-radius:6px;padding:10px;color:var(--text-light);font-size:14px;flex:1;">
                            </div>
                        </div>
                    </div>
                    <div class="ws-validation-panel" id="val-tmc-info">
                        <h4>Requirements Check</h4>
                        <div id="val-tmc-info-items"></div>
                    </div>

                    <!-- SECTION 2: TMC SPREADSHEET UPLOAD -->
                    <div class="ws-section-header">
                        <div class="ws-section-title">TMC Spreadsheet Upload</div>
                        <span class="ws-section-badge incomplete" id="badge-tmc-upload">Incomplete</span>
                    </div>
                    <div class="ws-drop-zone" id="ws-drop-zone-tmc" style="min-height:140px;cursor:pointer;">
                        <div class="ws-drop-icon" style="font-size:36px;"></div>
                        <div class="ws-drop-text" style="font-size:15px;">Drop TMC spreadsheet here</div>
                        <div class="ws-drop-subtext">.xlsx, .csv  or click to browse</div>
                    </div>
                    <div id="ws-tmc-file-info" style="margin-bottom:16px;"></div>
                    <div class="ws-validation-panel" id="val-tmc-upload">
                        <h4>File Validation</h4>
                        <div id="val-tmc-upload-items"></div>
                    </div>
                    <button class="ws-submit-btn" id="ws-parse-tmc-btn" style="display:none;background:var(--blue);margin-bottom:24px;">Parse TMC Data</button>
                    <div class="ws-validation-panel" id="val-tmc-parsed">
                        <h4>TMC Data Analysis</h4>
                        <div id="val-tmc-parsed-items"></div>
                    </div>

                    <!-- SECTION 3: INTERSECTION PHOTOS -->
                    <div class="ws-section-header">
                        <div class="ws-section-title">Intersection Photos</div>
                        <span class="ws-section-badge incomplete" id="badge-photos">Incomplete</span>
                    </div>
                    <div class="ws-drop-zone" id="ws-drop-zone-photos" style="min-height:90px;cursor:pointer;">
                        <div class="ws-drop-icon"></div>
                        <div class="ws-drop-text">Drop intersection photos here</div>
                        <div class="ws-drop-subtext">.jpg, .png, .heic  or click to browse</div>
                    </div>
                    <div id="ws-photos-info" style="margin-bottom:8px;"></div>
                    <div class="ws-validation-panel" id="val-photos">
                        <h4>Photo Validation</h4>
                        <div id="val-photos-items"></div>
                    </div>

                    <!-- SUBMIT -->
                    <button class="ws-submit-btn" id="ws-submit-step2">Submit Data Collection</button>
                </div>

                <!-- STEP 3: TRIP GENERATION -->
                <div class="workspace-panel" id="ws-panel-3" data-step="3">
                    <h3>Step 3  Trip Generation</h3>

                    <!-- DEPENDENCY CHECK -->
                    <div class="ws-validation-panel visible" id="val-step3-dep" style="border-color:#fbbf24;">
                        <h4>Dependency Check</h4>
                        <div id="val-step3-dep-items"></div>
                    </div>

                    <!-- LAND USE TABLE (auto-populated from Step 1) -->
                    <div class="ws-section-header">
                        <div class="ws-section-title">ITE Trip Generation</div>
                        <span class="ws-section-badge incomplete" id="badge-trip-gen">Incomplete</span>
                    </div>
                    <div style="overflow-x:auto;margin-bottom:16px;">
                        <table class="buildings-table" id="trip-gen-table" style="min-width:700px;">
                            <thead>
                                <tr>
                                    <th style="width:18%">Land Use</th>
                                    <th style="width:8%">ITE Code</th>
                                    <th style="width:10%">Size</th>
                                    <th style="width:6%">Units</th>
                                    <th style="width:8%">AM In</th>
                                    <th style="width:8%">AM Out</th>
                                    <th style="width:8%">PM In</th>
                                    <th style="width:8%">PM Out</th>
                                    <th style="width:8%">Daily</th>
                                    <th style="width:8%">Source</th>
                                    <th style="width:5%"></th>
                                </tr>
                            </thead>
                            <tbody id="trip-gen-tbody">
                                <!-- Populated by JS from Step 1 buildings -->
                            </tbody>
                            <tfoot>
                                <tr style="background:var(--bg-elevated);font-weight:700;">
                                    <td colspan="4" style="text-align:right;padding-right:12px;">Total Gross Trips</td>
                                    <td id="trip-total-am-in">0</td>
                                    <td id="trip-total-am-out">0</td>
                                    <td id="trip-total-pm-in">0</td>
                                    <td id="trip-total-pm-out">0</td>
                                    <td id="trip-total-daily">0</td>
                                    <td colspan="2"></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                    <button class="add-building-btn" id="add-trip-row-btn">+ Add Land Use</button>

                    <!-- REDUCTIONS -->
                    <div class="ws-section-header" style="margin-top:20px;">
                        <div class="ws-section-title">Trip Reductions</div>
                        <span class="ws-section-badge incomplete" id="badge-reductions">Optional</span>
                    </div>
                    <div class="ws-form-grid">
                        <div class="ws-form-group">
                            <label for="ws-passby-pct">Pass-by Reduction (%)</label>
                            <input type="number" id="ws-passby-pct" value="0" min="0" max="100" step="1" placeholder="0" style="background:var(--bg-base);border:1px solid var(--blue);border-radius:6px;padding:10px;color:var(--text-light);font-size:14px;">
                        </div>
                        <div class="ws-form-group">
                            <label for="ws-internal-pct">Internal Capture (%)</label>
                            <input type="number" id="ws-internal-pct" value="0" min="0" max="100" step="1" placeholder="0" style="background:var(--bg-base);border:1px solid var(--blue);border-radius:6px;padding:10px;color:var(--text-light);font-size:14px;">
                        </div>
                        <div class="ws-form-group full-width">
                            <label for="ws-reduction-notes">Justification / Notes</label>
                            <textarea id="ws-reduction-notes" rows="2" placeholder="e.g., ITE pass-by rate for LUC 934 = 34% per ITE Trip Gen Manual 11th Ed." style="background:var(--bg-base);border:1px solid var(--blue);border-radius:6px;padding:10px;color:var(--text-light);font-size:13px;resize:vertical;width:100%;box-sizing:border-box;font-family:inherit;"></textarea>
                        </div>
                    </div>

                    <!-- NET NEW TRIPS SUMMARY -->
                    <div class="ws-section-header" style="margin-top:8px;">
                        <div class="ws-section-title">Net New Trips</div>
                    </div>
                    <div style="display:grid;grid-template-columns:repeat(5,1fr);gap:8px;margin-bottom:24px;">
                        <div style="background:var(--bg-base);border:1px solid var(--blue);border-radius:6px;padding:12px;text-align:center;">
                            <div style="font-size:11px;color:var(--text-muted);margin-bottom:4px;">AM In</div>
                            <div style="font-size:18px;font-weight:700;color:var(--gold);" id="net-am-in">0</div>
                        </div>
                        <div style="background:var(--bg-base);border:1px solid var(--blue);border-radius:6px;padding:12px;text-align:center;">
                            <div style="font-size:11px;color:var(--text-muted);margin-bottom:4px;">AM Out</div>
                            <div style="font-size:18px;font-weight:700;color:var(--gold);" id="net-am-out">0</div>
                        </div>
                        <div style="background:var(--bg-base);border:1px solid var(--blue);border-radius:6px;padding:12px;text-align:center;">
                            <div style="font-size:11px;color:var(--text-muted);margin-bottom:4px;">PM In</div>
                            <div style="font-size:18px;font-weight:700;color:var(--gold);" id="net-pm-in">0</div>
                        </div>
                        <div style="background:var(--bg-base);border:1px solid var(--blue);border-radius:6px;padding:12px;text-align:center;">
                            <div style="font-size:11px;color:var(--text-muted);margin-bottom:4px;">PM Out</div>
                            <div style="font-size:18px;font-weight:700;color:var(--gold);" id="net-pm-out">0</div>
                        </div>
                        <div style="background:var(--bg-base);border:1px solid var(--success);border-radius:6px;padding:12px;text-align:center;">
                            <div style="font-size:11px;color:var(--text-muted);margin-bottom:4px;">Daily</div>
                            <div style="font-size:18px;font-weight:700;color:var(--success);" id="net-daily">0</div>
                        </div>
                    </div>

                    <div class="ws-validation-panel" id="val-trip-gen">
                        <h4>Trip Generation Validation</h4>
                        <div id="val-trip-gen-items"></div>
                    </div>

                    <!-- SUBMIT -->
                    <button class="ws-submit-btn" id="ws-submit-step3">Submit Trip Generation</button>
                </div>

                <!-- STEP 4: TRIP DISTRIBUTION -->
                <div class="workspace-panel" id="ws-panel-4" data-step="4">
                    <h3>Step 4  Trip Distribution</h3>

                    <!-- DEPENDENCY CHECK -->
                    <div class="ws-validation-panel visible" id="val-step4-dep" style="border-color:#fbbf24;">
                        <h4>Dependency Check</h4>
                        <div id="val-step4-dep-items"></div>
                    </div>

                    <!-- DISTRIBUTION METHOD -->
                    <div class="ws-section-header">
                        <div class="ws-section-title">Distribution Method</div>
                        <span class="ws-section-badge incomplete" id="badge-dist-method">Incomplete</span>
                    </div>
                    <div class="ws-form-grid">
                        <div class="ws-form-group">
                            <label for="ws-dist-method">Method</label>
                            <select id="ws-dist-method" style="background:var(--bg-base);border:1px solid var(--blue);border-radius:6px;padding:10px;color:var(--text-light);font-size:14px;">
                                <option value="">-- Select --</option>
                                <option value="existing">Existing Traffic Patterns</option>
                                <option value="gravity">Gravity Model</option>
                                <option value="analogous">Analogous Site</option>
                                <option value="engineering">Engineering Judgment</option>
                            </select>
                        </div>
                        <div class="ws-form-group">
                            <label for="ws-dist-source">Data Source</label>
                            <select id="ws-dist-source" style="background:var(--bg-base);border:1px solid var(--blue);border-radius:6px;padding:10px;color:var(--text-light);font-size:14px;">
                                <option value="">-- Select --</option>
                                <option value="tmc">TMC Count Data</option>
                                <option value="adot">ADOT Traffic Counts</option>
                                <option value="pag">PAG Model Data</option>
                                <option value="manual">Manual Assignment</option>
                            </select>
                        </div>
                        <div class="ws-form-group full-width">
                            <label for="ws-dist-notes">Distribution Justification</label>
                            <textarea id="ws-dist-notes" rows="2" placeholder="e.g., Distribution based on existing AM/PM peak turning movement proportions at study intersections." style="background:var(--bg-base);border:1px solid var(--blue);border-radius:6px;padding:10px;color:var(--text-light);font-size:13px;resize:vertical;width:100%;box-sizing:border-box;font-family:inherit;"></textarea>
                        </div>
                    </div>

                    <!-- DIRECTIONAL DISTRIBUTION TABLE -->
                    <div class="ws-section-header">
                        <div class="ws-section-title">Directional Split</div>
                        <span class="ws-section-badge incomplete" id="badge-dist-split">Incomplete</span>
                    </div>
                    <div style="overflow-x:auto;margin-bottom:16px;">
                        <table class="buildings-table" id="dist-table">
                            <thead>
                                <tr>
                                    <th style="width:25%">Approach / Route</th>
                                    <th style="width:12%">Direction</th>
                                    <th style="width:12%">AM %</th>
                                    <th style="width:12%">PM %</th>
                                    <th style="width:12%">AM Trips</th>
                                    <th style="width:12%">PM Trips</th>
                                    <th style="width:5%"></th>
                                </tr>
                            </thead>
                            <tbody id="dist-tbody">
                                <!-- Default 4 cardinal directions -->
                            </tbody>
                            <tfoot>
                                <tr style="background:var(--bg-elevated);font-weight:700;">
                                    <td colspan="2" style="text-align:right;padding-right:12px;">Totals</td>
                                    <td id="dist-total-am-pct" style="text-align:center;">0%</td>
                                    <td id="dist-total-pm-pct" style="text-align:center;">0%</td>
                                    <td id="dist-total-am-trips" style="text-align:center;">0</td>
                                    <td id="dist-total-pm-trips" style="text-align:center;">0</td>
                                    <td></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                    <button class="add-building-btn" id="add-dist-row-btn">+ Add Route</button>

                    <!-- VALIDATION -->
                    <div class="ws-validation-panel" id="val-dist">
                        <h4>Distribution Validation</h4>
                        <div id="val-dist-items"></div>
                    </div>

                    <!-- SUBMIT -->
                    <button class="ws-submit-btn" id="ws-submit-step4">Submit Trip Distribution</button>
                </div>

                <!-- ==================== STEP 5: FUTURE VOLUMES ==================== -->
                <div class="workspace-panel" id="ws-panel-5">
                    <h3>Step 5: Future Volumes</h3>
                    <p style="color: var(--text-muted); margin-bottom: 16px;">Build volume scenarios: Existing, Background (with growth), and Total Future (background + site trips).</p>

                    <!-- DEPENDENCY CHECK -->
                    <div class="ws-validation-panel visible" id="dep-check-step5" style="margin-bottom: 16px;">
                        <h4>Dependency Check</h4>
                        <div id="dep-check-step5-items"></div>
                    </div>

                    <!-- GROWTH PARAMETERS -->
                    <div class="ws-section-header">
                        <h4>Growth Parameters</h4>
                        <span class="ws-section-badge incomplete" id="badge-growth-params">Incomplete</span>
                    </div>
                    <div class="form-row" style="display: flex; gap: 12px; margin-bottom: 16px;">
                        <div style="flex: 1;">
                            <label>Base Year</label>
                            <input type="number" id="ws-vol-base-year" class="ws-input" placeholder="2025" min="2020" max="2040">
                        </div>
                        <div style="flex: 1;">
                            <label>Opening Year</label>
                            <input type="number" id="ws-vol-open-year" class="ws-input" placeholder="2027" min="2020" max="2050" readonly style="opacity: 0.7;">
                        </div>
                        <div style="flex: 1;">
                            <label>Horizon Year</label>
                            <input type="number" id="ws-vol-horizon-year" class="ws-input" placeholder="2032" min="2020" max="2060" readonly style="opacity: 0.7;">
                        </div>
                        <div style="flex: 1;">
                            <label>Annual Growth Rate (%)</label>
                            <input type="number" id="ws-vol-growth-rate" class="ws-input" placeholder="2.0" min="0" max="15" step="0.1" readonly style="opacity: 0.7;">
                        </div>
                    </div>

                    <!-- GROWTH FACTORS SUMMARY -->
                    <div style="display: flex; gap: 12px; margin-bottom: 20px;">
                        <div class="trip-summary-card" style="flex: 1;">
                            <div class="trip-summary-label">Opening Year Factor</div>
                            <div class="trip-summary-value" id="vol-open-factor"></div>
                        </div>
                        <div class="trip-summary-card" style="flex: 1;">
                            <div class="trip-summary-label">Horizon Year Factor</div>
                            <div class="trip-summary-value" id="vol-horizon-factor"></div>
                        </div>
                        <div class="trip-summary-card" style="flex: 1;">
                            <div class="trip-summary-label">Years to Opening</div>
                            <div class="trip-summary-value" id="vol-years-open"></div>
                        </div>
                        <div class="trip-summary-card" style="flex: 1;">
                            <div class="trip-summary-label">Years to Horizon</div>
                            <div class="trip-summary-value" id="vol-years-horizon"></div>
                        </div>
                    </div>

                    <!-- EXISTING VOLUMES -->
                    <div class="ws-section-header">
                        <h4>Existing Volumes (from TMC Data)</h4>
                        <span class="ws-section-badge incomplete" id="badge-existing-vol">Incomplete</span>
                    </div>
                    <p style="color: var(--text-muted); font-size: 12px; margin-bottom: 8px;">Enter existing intersection volumes by direction. These come from your TMC counts (Step 2).</p>
                    <div class="table-container">
                        <table class="buildings-table">
                            <thead>
                                <tr>
                                    <th>Intersection / Segment</th>
                                    <th>Direction</th>
                                    <th>AM Peak</th>
                                    <th>PM Peak</th>
                                    <th>Daily</th>
                                </tr>
                            </thead>
                            <tbody id="existing-vol-tbody"></tbody>
                        </table>
                    </div>
                    <button class="add-building-btn" id="add-existing-vol-btn">+ Add Location</button>

                    <!-- VOLUME SCENARIOS TABLE -->
                    <div class="ws-section-header" style="margin-top: 20px;">
                        <h4>Volume Scenarios</h4>
                        <span class="ws-section-badge incomplete" id="badge-vol-scenarios">Incomplete</span>
                    </div>
                    <p style="color: var(--text-muted); font-size: 12px; margin-bottom: 8px;">Auto-calculated from existing volumes, growth factors, and site-generated trips (Steps 3 &amp; 4).</p>
                    <div class="table-container">
                        <table class="buildings-table">
                            <thead>
                                <tr>
                                    <th rowspan="2">Location</th>
                                    <th rowspan="2">Dir</th>
                                    <th colspan="2" style="text-align:center; border-bottom: 1px solid #333;">Existing</th>
                                    <th colspan="2" style="text-align:center; border-bottom: 1px solid #333;">Background (Opening)</th>
                                    <th colspan="2" style="text-align:center; border-bottom: 1px solid #333;">Background (Horizon)</th>
                                    <th colspan="2" style="text-align:center; border-bottom: 1px solid #333;">+ Site Trips</th>
                                    <th colspan="2" style="text-align:center; border-bottom: 1px solid #333;">Total Future (Opening)</th>
                                    <th colspan="2" style="text-align:center; border-bottom: 1px solid #333;">Total Future (Horizon)</th>
                                </tr>
                                <tr>
                                    <th>AM</th><th>PM</th>
                                    <th>AM</th><th>PM</th>
                                    <th>AM</th><th>PM</th>
                                    <th>AM</th><th>PM</th>
                                    <th>AM</th><th>PM</th>
                                    <th>AM</th><th>PM</th>
                                </tr>
                            </thead>
                            <tbody id="vol-scenarios-tbody"></tbody>
                        </table>
                    </div>

                    <!-- NET NEW TRIPS SUMMARY -->
                    <h4 style="margin-top: 20px;">Net Site Trip Summary (from Steps 3 &amp; 4)</h4>
                    <div style="display: flex; gap: 12px; margin-bottom: 20px;">
                        <div class="trip-summary-card" style="flex: 1;">
                            <div class="trip-summary-label">AM In</div>
                            <div class="trip-summary-value" id="vol-site-am-in"></div>
                        </div>
                        <div class="trip-summary-card" style="flex: 1;">
                            <div class="trip-summary-label">AM Out</div>
                            <div class="trip-summary-value" id="vol-site-am-out"></div>
                        </div>
                        <div class="trip-summary-card" style="flex: 1;">
                            <div class="trip-summary-label">PM In</div>
                            <div class="trip-summary-value" id="vol-site-pm-in"></div>
                        </div>
                        <div class="trip-summary-card" style="flex: 1;">
                            <div class="trip-summary-label">PM Out</div>
                            <div class="trip-summary-value" id="vol-site-pm-out"></div>
                        </div>
                    </div>

                    <!-- VALIDATION -->
                    <div class="ws-validation-panel" id="val-volumes">
                        <h4>Volume Validation</h4>
                        <div id="val-volumes-items"></div>
                    </div>

                    <!-- SUBMIT -->
                    <button class="ws-submit-btn" id="ws-submit-step5">Submit Future Volumes</button>
                </div>

                <!-- ==================== STEP 6: CAPACITY ANALYSIS ==================== -->
                <div class="workspace-panel" id="ws-panel-6">
                    <h3>Step 6: Capacity Analysis</h3>
                    <p style="color: var(--text-muted); margin-bottom: 16px;">Document intersection capacity analysis  Synchro/HCS models and Level of Service results for each scenario.</p>

                    <!-- DEPENDENCY CHECK -->
                    <div class="ws-validation-panel visible" id="dep-check-step6" style="margin-bottom: 16px;">
                        <h4>Dependency Check</h4>
                        <div id="dep-check-step6-items"></div>
                    </div>

                    <!-- SYNCHRO MODEL FILES -->
                    <div class="ws-section-header">
                        <h4>Synchro / HCS Model Files</h4>
                        <span class="ws-section-badge incomplete" id="badge-synchro-files">Incomplete</span>
                    </div>
                    <p style="color: var(--text-muted); font-size: 12px; margin-bottom: 8px;">Upload or reference your Synchro (.syn) or HCS files. One model per scenario is typical.</p>
                    <div class="table-container">
                        <table class="buildings-table">
                            <thead>
                                <tr>
                                    <th>Scenario</th>
                                    <th>Software</th>
                                    <th>File Name</th>
                                    <th>Notes</th>
                                </tr>
                            </thead>
                            <tbody id="synchro-tbody">
                                <tr>
                                    <td style="color: var(--text-light);">Existing</td>
                                    <td><select class="ws-input cap-software" style="width:110px;">
                                        <option value="Synchro">Synchro</option>
                                        <option value="HCS">HCS</option>
                                        <option value="Sidra">Sidra</option>
                                        <option value="SimTraffic">SimTraffic</option>
                                        <option value="Other">Other</option>
                                    </select></td>
                                    <td><input type="text" class="ws-input cap-filename" placeholder="Existing.syn" style="width:100%;"></td>
                                    <td><input type="text" class="ws-input cap-file-notes" placeholder="Notes" style="width:100%;"></td>
                                </tr>
                                <tr>
                                    <td style="color: var(--text-light);">Background (Opening)</td>
                                    <td><select class="ws-input cap-software" style="width:110px;">
                                        <option value="Synchro">Synchro</option><option value="HCS">HCS</option><option value="Sidra">Sidra</option><option value="SimTraffic">SimTraffic</option><option value="Other">Other</option>
                                    </select></td>
                                    <td><input type="text" class="ws-input cap-filename" placeholder="Background_Opening.syn" style="width:100%;"></td>
                                    <td><input type="text" class="ws-input cap-file-notes" placeholder="Notes" style="width:100%;"></td>
                                </tr>
                                <tr>
                                    <td style="color: var(--text-light);">Total Future (Opening)</td>
                                    <td><select class="ws-input cap-software" style="width:110px;">
                                        <option value="Synchro">Synchro</option><option value="HCS">HCS</option><option value="Sidra">Sidra</option><option value="SimTraffic">SimTraffic</option><option value="Other">Other</option>
                                    </select></td>
                                    <td><input type="text" class="ws-input cap-filename" placeholder="TotalFuture_Opening.syn" style="width:100%;"></td>
                                    <td><input type="text" class="ws-input cap-file-notes" placeholder="Notes" style="width:100%;"></td>
                                </tr>
                                <tr>
                                    <td style="color: var(--text-light);">Total Future (Horizon)</td>
                                    <td><select class="ws-input cap-software" style="width:110px;">
                                        <option value="Synchro">Synchro</option><option value="HCS">HCS</option><option value="Sidra">Sidra</option><option value="SimTraffic">SimTraffic</option><option value="Other">Other</option>
                                    </select></td>
                                    <td><input type="text" class="ws-input cap-filename" placeholder="TotalFuture_Horizon.syn" style="width:100%;"></td>
                                    <td><input type="text" class="ws-input cap-file-notes" placeholder="Notes" style="width:100%;"></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- LOS SUMMARY TABLE -->
                    <div class="ws-section-header" style="margin-top: 20px;">
                        <h4>Level of Service Summary</h4>
                        <span class="ws-section-badge incomplete" id="badge-los-table">Incomplete</span>
                    </div>
                    <p style="color: var(--text-muted); font-size: 12px; margin-bottom: 8px;">Enter LOS results per intersection and scenario. LOS grades A-F with average delay (sec/veh).</p>
                    <div class="table-container" style="overflow-x: auto;">
                        <table class="buildings-table">
                            <thead>
                                <tr>
                                    <th rowspan="2">Intersection</th>
                                    <th rowspan="2">Control</th>
                                    <th rowspan="2">Peak</th>
                                    <th colspan="2" style="text-align:center; border-bottom: 1px solid #333;">Existing</th>
                                    <th colspan="2" style="text-align:center; border-bottom: 1px solid #333;">Background</th>
                                    <th colspan="2" style="text-align:center; border-bottom: 1px solid #333;">Total Future</th>
                                    <th rowspan="2">Mitigation Needed?</th>
                                </tr>
                                <tr>
                                    <th>LOS</th><th>Delay</th>
                                    <th>LOS</th><th>Delay</th>
                                    <th>LOS</th><th>Delay</th>
                                </tr>
                            </thead>
                            <tbody id="los-tbody"></tbody>
                        </table>
                    </div>
                    <button class="add-building-btn" id="add-los-row-btn">+ Add Intersection</button>

                    <!-- MITIGATION NOTES -->
                    <div class="ws-section-header" style="margin-top: 20px;">
                        <h4>Mitigation Measures</h4>
                    </div>
                    <textarea id="ws-mitigation-notes" class="ws-input" rows="4" placeholder="Describe any required mitigation measures (turn lanes, signal timing, new signals, etc.)" style="width: 100%; resize: vertical;"></textarea>

                    <!-- VALIDATION -->
                    <div class="ws-validation-panel" id="val-capacity">
                        <h4>Capacity Analysis Validation</h4>
                        <div id="val-capacity-items"></div>
                    </div>

                    <!-- SUBMIT -->
                    <button class="ws-submit-btn" id="ws-submit-step6">Submit Capacity Analysis</button>
                </div>

                <!-- ==================== STEP 7: SITE ACCESS ==================== -->
                <div class="workspace-panel" id="ws-panel-7">
                    <h3>Step 7: Site Access</h3>
                    <p style="color: var(--text-muted); margin-bottom: 16px;">Document site driveways, turn lane requirements, sight distance evaluation, and access spacing compliance.</p>

                    <!-- DEPENDENCY CHECK -->
                    <div class="ws-validation-panel visible" id="dep-check-step7" style="margin-bottom: 16px;">
                        <h4>Dependency Check</h4>
                        <div id="dep-check-step7-items"></div>
                    </div>

                    <!-- DRIVEWAY INVENTORY -->
                    <div class="ws-section-header">
                        <h4>Driveway Inventory</h4>
                        <span class="ws-section-badge incomplete" id="badge-driveways">Incomplete</span>
                    </div>
                    <p style="color: var(--text-muted); font-size: 12px; margin-bottom: 8px;">Document each proposed site access point  location, type, lanes, and control.</p>
                    <div class="table-container" style="overflow-x: auto;">
                        <table class="buildings-table">
                            <thead>
                                <tr>
                                    <th>Driveway Name</th>
                                    <th>Road</th>
                                    <th>Type</th>
                                    <th>Movements</th>
                                    <th>Lanes In</th>
                                    <th>Lanes Out</th>
                                    <th>Control</th>
                                    <th>Spacing (ft)</th>
                                </tr>
                            </thead>
                            <tbody id="driveway-tbody"></tbody>
                        </table>
                    </div>
                    <button class="add-building-btn" id="add-driveway-btn">+ Add Driveway</button>

                    <!-- TURN LANE ANALYSIS -->
                    <div class="ws-section-header" style="margin-top: 20px;">
                        <h4>Turn Lane Analysis</h4>
                        <span class="ws-section-badge incomplete" id="badge-turn-lanes">Incomplete</span>
                    </div>
                    <p style="color: var(--text-muted); font-size: 12px; margin-bottom: 8px;">Document turn lane warrants and recommendations at each access point.</p>
                    <div class="table-container" style="overflow-x: auto;">
                        <table class="buildings-table">
                            <thead>
                                <tr>
                                    <th>Location</th>
                                    <th>Movement</th>
                                    <th>Peak Vol (vph)</th>
                                    <th>Warrant Method</th>
                                    <th>Warranted?</th>
                                    <th>Recommended</th>
                                    <th>Storage (ft)</th>
                                </tr>
                            </thead>
                            <tbody id="turnlane-tbody"></tbody>
                        </table>
                    </div>
                    <button class="add-building-btn" id="add-turnlane-btn">+ Add Turn Lane Analysis</button>

                    <!-- SIGHT DISTANCE -->
                    <div class="ws-section-header" style="margin-top: 20px;">
                        <h4>Sight Distance</h4>
                        <span class="ws-section-badge incomplete" id="badge-sight-dist">Incomplete</span>
                    </div>
                    <p style="color: var(--text-muted); font-size: 12px; margin-bottom: 8px;">Intersection sight distance (ISD) checks per AASHTO at each access point.</p>
                    <div class="table-container">
                        <table class="buildings-table">
                            <thead>
                                <tr>
                                    <th>Driveway</th>
                                    <th>Direction</th>
                                    <th>Design Speed (mph)</th>
                                    <th>Required ISD (ft)</th>
                                    <th>Available ISD (ft)</th>
                                    <th>Adequate?</th>
                                </tr>
                            </thead>
                            <tbody id="sight-tbody"></tbody>
                        </table>
                    </div>
                    <button class="add-building-btn" id="add-sight-btn">+ Add Sight Check</button>

                    <!-- ACCESS NOTES -->
                    <div class="ws-section-header" style="margin-top: 20px;">
                        <h4>Access Spacing &amp; Compliance Notes</h4>
                    </div>
                    <textarea id="ws-access-notes" class="ws-input" rows="4" placeholder="Document jurisdiction access spacing standards, compliance notes, variance requests, ADA considerations, etc." style="width: 100%; resize: vertical;"></textarea>

                    <!-- VALIDATION -->
                    <div class="ws-validation-panel" id="val-access">
                        <h4>Site Access Validation</h4>
                        <div id="val-access-items"></div>
                    </div>

                    <!-- SUBMIT -->
                    <button class="ws-submit-btn" id="ws-submit-step7">Submit Site Access</button>
                </div>

                <!-- ==================== STEP 8: SIGNAL WARRANTS ==================== -->
                <div class="workspace-panel" id="ws-panel-8">
                    <h3>Step 8: Signal Warrants</h3>
                    <p style="color: var(--text-muted); margin-bottom: 16px;">Evaluate MUTCD signal warrants at study intersections. Document which warrants are met and recommendations.</p>

                    <!-- DEPENDENCY CHECK -->
                    <div class="ws-validation-panel visible" id="dep-check-step8" style="margin-bottom: 16px;">
                        <h4>Dependency Check</h4>
                        <div id="dep-check-step8-items"></div>
                    </div>

                    <!-- INTERSECTIONS FOR WARRANT ANALYSIS -->
                    <div class="ws-section-header">
                        <h4>Intersections Evaluated</h4>
                        <span class="ws-section-badge incomplete" id="badge-warrant-ints">Incomplete</span>
                    </div>
                    <p style="color: var(--text-muted); font-size: 12px; margin-bottom: 8px;">Select intersections requiring signal warrant evaluation (typically unsignalized with site impact).</p>
                    <div class="table-container">
                        <table class="buildings-table">
                            <thead>
                                <tr>
                                    <th>Intersection</th>
                                    <th>Current Control</th>
                                    <th>Major Rd Vol (vph)</th>
                                    <th>Minor Rd Vol (vph)</th>
                                    <th>Scenario</th>
                                </tr>
                            </thead>
                            <tbody id="warrant-int-tbody"></tbody>
                        </table>
                    </div>
                    <button class="add-building-btn" id="add-warrant-int-btn">+ Add Intersection</button>

                    <!-- MUTCD WARRANT CHECKLIST -->
                    <div class="ws-section-header" style="margin-top: 20px;">
                        <h4>MUTCD Warrant Results</h4>
                        <span class="ws-section-badge incomplete" id="badge-warrant-results">Incomplete</span>
                    </div>
                    <p style="color: var(--text-muted); font-size: 12px; margin-bottom: 8px;">Document warrant analysis results per intersection. Check each warrant evaluated.</p>
                    <div class="table-container" style="overflow-x: auto;">
                        <table class="buildings-table">
                            <thead>
                                <tr>
                                    <th>Intersection</th>
                                    <th title="Warrant 1: 8-Hour Volume">W1</th>
                                    <th title="Warrant 2: 4-Hour Volume">W2</th>
                                    <th title="Warrant 3: Peak Hour">W3</th>
                                    <th title="Warrant 4: Pedestrian Volume">W4</th>
                                    <th title="Warrant 5: School Crossing">W5</th>
                                    <th title="Warrant 6: Coordinated Signal">W6</th>
                                    <th title="Warrant 7: Crash Experience">W7</th>
                                    <th title="Warrant 8: Roadway Network">W8</th>
                                    <th title="Warrant 9: Near Railroad">W9</th>
                                    <th>Warrants Met</th>
                                    <th>Recommendation</th>
                                </tr>
                            </thead>
                            <tbody id="warrant-results-tbody"></tbody>
                        </table>
                    </div>
                    <button class="add-building-btn" id="add-warrant-result-btn">+ Add Warrant Analysis</button>

                    <!-- WARRANT LEGEND -->
                    <div style="margin-top: 12px; padding: 10px 14px; background: var(--bg-base); border: 1px solid #222; border-radius: 8px; font-size: 11px; color: var(--text-muted);">
                        <strong style="color: var(--text-light);">MUTCD Warrant Reference:</strong><br>
                        W1: Eight-Hour Vehicular Volume &nbsp;|&nbsp; W2: Four-Hour Vehicular Volume &nbsp;|&nbsp; W3: Peak Hour<br>
                        W4: Pedestrian Volume &nbsp;|&nbsp; W5: School Crossing &nbsp;|&nbsp; W6: Coordinated Signal System<br>
                        W7: Crash Experience &nbsp;|&nbsp; W8: Roadway Network &nbsp;|&nbsp; W9: Intersection Near Railroad
                    </div>

                    <!-- SIGNAL WARRANT NOTES -->
                    <div class="ws-section-header" style="margin-top: 20px;">
                        <h4>Analysis Notes &amp; Recommendations</h4>
                    </div>
                    <textarea id="ws-warrant-notes" class="ws-input" rows="4" placeholder="Document signal warrant analysis methodology, engineering judgment, timing recommendations, coordination needs, etc." style="width: 100%; resize: vertical;"></textarea>

                    <!-- VALIDATION -->
                    <div class="ws-validation-panel" id="val-warrants">
                        <h4>Signal Warrant Validation</h4>
                        <div id="val-warrant-items"></div>
                    </div>

                    <!-- SUBMIT -->
                    <button class="ws-submit-btn" id="ws-submit-step8">Submit Signal Warrants</button>
                </div>

                <!-- ==================== STEP 9: REPORT ASSEMBLY ==================== -->
                <div class="workspace-panel" id="ws-panel-9">
                    <h3>Step 9: Report Assembly</h3>
                    <p style="color: var(--text-muted); margin-bottom: 16px;">Assemble the TIA report  verify all sections, manage exhibits/figures, and prepare the draft document.</p>

                    <!-- DEPENDENCY CHECK -->
                    <div class="ws-validation-panel visible" id="dep-check-step9" style="margin-bottom: 16px;">
                        <h4>Dependency Check  All Analysis Steps</h4>
                        <div id="dep-check-step9-items"></div>
                    </div>

                    <!-- REPORT SECTIONS CHECKLIST -->
                    <div class="ws-section-header">
                        <h4>Report Sections</h4>
                        <span class="ws-section-badge incomplete" id="badge-report-sections">Incomplete</span>
                    </div>
                    <p style="color: var(--text-muted); font-size: 12px; margin-bottom: 8px;">Standard TIA report outline. Check off each section as drafted. Data auto-populated from previous steps.</p>
                    <div id="report-sections-list" style="display: flex; flex-direction: column; gap: 6px; margin-bottom: 16px;">
                        <label class="rpt-section-item" style="display: flex; align-items: center; gap: 10px; padding: 8px 12px; background: var(--bg-base); border: 1px solid #222; border-radius: 6px; cursor: pointer;">
                            <input type="checkbox" class="rpt-section-check" data-section="intro">
                            <span style="flex:1; color: var(--text-light);">1. Introduction &amp; Purpose</span>
                            <span class="rpt-data-status" style="font-size: 11px; color: var(--text-muted);">Step 1</span>
                        </label>
                        <label class="rpt-section-item" style="display: flex; align-items: center; gap: 10px; padding: 8px 12px; background: var(--bg-base); border: 1px solid #222; border-radius: 6px; cursor: pointer;">
                            <input type="checkbox" class="rpt-section-check" data-section="existing">
                            <span style="flex:1; color: var(--text-light);">2. Existing Conditions</span>
                            <span class="rpt-data-status" style="font-size: 11px; color: var(--text-muted);">Steps 2, 5</span>
                        </label>
                        <label class="rpt-section-item" style="display: flex; align-items: center; gap: 10px; padding: 8px 12px; background: var(--bg-base); border: 1px solid #222; border-radius: 6px; cursor: pointer;">
                            <input type="checkbox" class="rpt-section-check" data-section="tripgen">
                            <span style="flex:1; color: var(--text-light);">3. Trip Generation</span>
                            <span class="rpt-data-status" style="font-size: 11px; color: var(--text-muted);">Step 3</span>
                        </label>
                        <label class="rpt-section-item" style="display: flex; align-items: center; gap: 10px; padding: 8px 12px; background: var(--bg-base); border: 1px solid #222; border-radius: 6px; cursor: pointer;">
                            <input type="checkbox" class="rpt-section-check" data-section="distribution">
                            <span style="flex:1; color: var(--text-light);">4. Trip Distribution &amp; Assignment</span>
                            <span class="rpt-data-status" style="font-size: 11px; color: var(--text-muted);">Step 4</span>
                        </label>
                        <label class="rpt-section-item" style="display: flex; align-items: center; gap: 10px; padding: 8px 12px; background: var(--bg-base); border: 1px solid #222; border-radius: 6px; cursor: pointer;">
                            <input type="checkbox" class="rpt-section-check" data-section="volumes">
                            <span style="flex:1; color: var(--text-light);">5. Future Volume Development</span>
                            <span class="rpt-data-status" style="font-size: 11px; color: var(--text-muted);">Step 5</span>
                        </label>
                        <label class="rpt-section-item" style="display: flex; align-items: center; gap: 10px; padding: 8px 12px; background: var(--bg-base); border: 1px solid #222; border-radius: 6px; cursor: pointer;">
                            <input type="checkbox" class="rpt-section-check" data-section="capacity">
                            <span style="flex:1; color: var(--text-light);">6. Capacity Analysis &amp; LOS</span>
                            <span class="rpt-data-status" style="font-size: 11px; color: var(--text-muted);">Step 6</span>
                        </label>
                        <label class="rpt-section-item" style="display: flex; align-items: center; gap: 10px; padding: 8px 12px; background: var(--bg-base); border: 1px solid #222; border-radius: 6px; cursor: pointer;">
                            <input type="checkbox" class="rpt-section-check" data-section="access">
                            <span style="flex:1; color: var(--text-light);">7. Site Access &amp; Turn Lanes</span>
                            <span class="rpt-data-status" style="font-size: 11px; color: var(--text-muted);">Step 7</span>
                        </label>
                        <label class="rpt-section-item" style="display: flex; align-items: center; gap: 10px; padding: 8px 12px; background: var(--bg-base); border: 1px solid #222; border-radius: 6px; cursor: pointer;">
                            <input type="checkbox" class="rpt-section-check" data-section="warrants">
                            <span style="flex:1; color: var(--text-light);">8. Signal Warrant Analysis</span>
                            <span class="rpt-data-status" style="font-size: 11px; color: var(--text-muted);">Step 8</span>
                        </label>
                        <label class="rpt-section-item" style="display: flex; align-items: center; gap: 10px; padding: 8px 12px; background: var(--bg-base); border: 1px solid #222; border-radius: 6px; cursor: pointer;">
                            <input type="checkbox" class="rpt-section-check" data-section="conclusions">
                            <span style="flex:1; color: var(--text-light);">9. Conclusions &amp; Recommendations</span>
                            <span class="rpt-data-status" style="font-size: 11px; color: var(--text-muted);">All Steps</span>
                        </label>
                    </div>

                    <!-- REPORT PROGRESS -->
                    <div style="display: flex; gap: 12px; margin-bottom: 20px;">
                        <div class="trip-summary-card" style="flex: 1;">
                            <div class="trip-summary-label">Sections Drafted</div>
                            <div class="trip-summary-value" id="rpt-sections-count">0 / 9</div>
                        </div>
                        <div class="trip-summary-card" style="flex: 1;">
                            <div class="trip-summary-label">Data Steps Complete</div>
                            <div class="trip-summary-value" id="rpt-data-steps">0 / 8</div>
                        </div>
                        <div class="trip-summary-card" style="flex: 1;">
                            <div class="trip-summary-label">Exhibits Listed</div>
                            <div class="trip-summary-value" id="rpt-exhibits-count">0</div>
                        </div>
                    </div>

                    <!-- EXHIBITS / FIGURES -->
                    <div class="ws-section-header">
                        <h4>Exhibits &amp; Figures</h4>
                        <span class="ws-section-badge incomplete" id="badge-exhibits">Incomplete</span>
                    </div>
                    <p style="color: var(--text-muted); font-size: 12px; margin-bottom: 8px;">List all figures and exhibits to include in the report appendix.</p>
                    <div class="table-container">
                        <table class="buildings-table">
                            <thead>
                                <tr>
                                    <th>Figure #</th>
                                    <th>Title</th>
                                    <th>Type</th>
                                    <th>Source Step</th>
                                    <th>Status</th>
                                    <th>Layout</th>
                                </tr>
                            </thead>
                            <tbody id="exhibits-tbody"></tbody>
                        </table>
                    </div>
                    <button class="add-building-btn" id="add-exhibit-btn">+ Add Exhibit</button>

                    <!-- REPORT FILE REFERENCE -->
                    <div class="ws-section-header" style="margin-top: 20px;">
                        <h4>Report Document</h4>
                    </div>
                    <div class="form-row" style="display: flex; gap: 12px; margin-bottom: 16px;">
                        <div style="flex: 2;">
                            <label>Report File Name</label>
                            <input type="text" id="ws-report-filename" class="ws-input" placeholder="e.g. TIA_ProjectName_Draft_v1.docx" style="width: 100%;">
                        </div>
                        <div style="flex: 1;">
                            <label>Version</label>
                            <input type="text" id="ws-report-version" class="ws-input" placeholder="Draft v1" style="width: 100%;">
                        </div>
                        <div style="flex: 1;">
                            <label>Date</label>
                            <input type="date" id="ws-report-date" class="ws-input" style="width: 100%;">
                        </div>
                    </div>
                    <div>
                        <label>Author / Reviewer Notes</label>
                        <textarea id="ws-report-notes" class="ws-input" rows="3" placeholder="Internal notes on report status, reviewer comments, outstanding items..." style="width: 100%; resize: vertical;"></textarea>
                    </div>

                    <!-- VALIDATION -->
                    <div class="ws-validation-panel" id="val-report">
                        <h4>Report Assembly Validation</h4>
                        <div id="val-report-items"></div>
                    </div>

                    <!-- SUBMIT -->
                    <button class="ws-submit-btn" id="ws-submit-step9">Submit Report Assembly</button>
                    <button class="action-btn" id="generate-pptx-step9" style="width:100%;padding:14px;font-size:14px;margin-top:12px;cursor:pointer;border:2px solid var(--gold);background:var(--bg-base);color:var(--gold);border-radius:8px;" disabled>Generate PPTX Report Deck</button>
                </div>

                <!-- ==================== STEP 10: FINAL DELIVERY ==================== -->
                <div class="workspace-panel" id="ws-panel-10">
                    <h3>Step 10: Final Delivery</h3>
                    <p style="color: var(--text-muted); margin-bottom: 16px;">Final QC, deliverables packaging, and submission tracking. Complete this step to close out the project.</p>

                    <!-- DEPENDENCY CHECK -->
                    <div class="ws-validation-panel visible" id="dep-check-step10" style="margin-bottom: 16px;">
                        <h4>Dependency Check</h4>
                        <div id="dep-check-step10-items"></div>
                    </div>

                    <!-- QC CHECKLIST -->
                    <div class="ws-section-header">
                        <h4>Quality Control Checklist</h4>
                        <span class="ws-section-badge incomplete" id="badge-qc-checklist">Incomplete</span>
                    </div>
                    <div id="qc-checklist" style="display: flex; flex-direction: column; gap: 6px; margin-bottom: 16px;">
                        <label class="rpt-section-item" style="display: flex; align-items: center; gap: 10px; padding: 8px 12px; background: var(--bg-base); border: 1px solid #222; border-radius: 6px; cursor: pointer;">
                            <input type="checkbox" class="qc-check" data-qc="proj-info">
                            <span style="flex:1; color: var(--text-light);">Project info correct (name, number, address, jurisdiction)</span>
                        </label>
                        <label class="rpt-section-item" style="display: flex; align-items: center; gap: 10px; padding: 8px 12px; background: var(--bg-base); border: 1px solid #222; border-radius: 6px; cursor: pointer;">
                            <input type="checkbox" class="qc-check" data-qc="trip-calcs">
                            <span style="flex:1; color: var(--text-light);">Trip generation calculations verified</span>
                        </label>
                        <label class="rpt-section-item" style="display: flex; align-items: center; gap: 10px; padding: 8px 12px; background: var(--bg-base); border: 1px solid #222; border-radius: 6px; cursor: pointer;">
                            <input type="checkbox" class="qc-check" data-qc="volumes">
                            <span style="flex:1; color: var(--text-light);">Volume scenarios balance-checked</span>
                        </label>
                        <label class="rpt-section-item" style="display: flex; align-items: center; gap: 10px; padding: 8px 12px; background: var(--bg-base); border: 1px solid #222; border-radius: 6px; cursor: pointer;">
                            <input type="checkbox" class="qc-check" data-qc="los-results">
                            <span style="flex:1; color: var(--text-light);">LOS results match Synchro output</span>
                        </label>
                        <label class="rpt-section-item" style="display: flex; align-items: center; gap: 10px; padding: 8px 12px; background: var(--bg-base); border: 1px solid #222; border-radius: 6px; cursor: pointer;">
                            <input type="checkbox" class="qc-check" data-qc="figures">
                            <span style="flex:1; color: var(--text-light);">All figures/exhibits final and numbered</span>
                        </label>
                        <label class="rpt-section-item" style="display: flex; align-items: center; gap: 10px; padding: 8px 12px; background: var(--bg-base); border: 1px solid #222; border-radius: 6px; cursor: pointer;">
                            <input type="checkbox" class="qc-check" data-qc="formatting">
                            <span style="flex:1; color: var(--text-light);">Report formatting, headers, page numbers</span>
                        </label>
                        <label class="rpt-section-item" style="display: flex; align-items: center; gap: 10px; padding: 8px 12px; background: var(--bg-base); border: 1px solid #222; border-radius: 6px; cursor: pointer;">
                            <input type="checkbox" class="qc-check" data-qc="pe-seal">
                            <span style="flex:1; color: var(--text-light);">PE seal and signature applied</span>
                        </label>
                        <label class="rpt-section-item" style="display: flex; align-items: center; gap: 10px; padding: 8px 12px; background: var(--bg-base); border: 1px solid #222; border-radius: 6px; cursor: pointer;">
                            <input type="checkbox" class="qc-check" data-qc="spell-check">
                            <span style="flex:1; color: var(--text-light);">Spell check and proofreading complete</span>
                        </label>
                    </div>

                    <!-- DELIVERABLES -->
                    <div class="ws-section-header">
                        <h4>Deliverables Package</h4>
                        <span class="ws-section-badge incomplete" id="badge-deliverables">Incomplete</span>
                    </div>
                    <p style="color: var(--text-muted); font-size: 12px; margin-bottom: 8px;">List all files included in the final delivery package.</p>
                    <div class="table-container">
                        <table class="buildings-table">
                            <thead>
                                <tr>
                                    <th>File Name</th>
                                    <th>Type</th>
                                    <th>Description</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="deliverables-tbody"></tbody>
                        </table>
                    </div>
                    <button class="add-building-btn" id="add-deliverable-btn">+ Add Deliverable</button>

                    <!-- SUBMISSION TRACKING -->
                    <div class="ws-section-header" style="margin-top: 20px;">
                        <h4>Submission Tracking</h4>
                        <span class="ws-section-badge incomplete" id="badge-submission">Incomplete</span>
                    </div>
                    <div class="form-row" style="display: flex; gap: 12px; margin-bottom: 12px;">
                        <div style="flex: 1;">
                            <label>Submitted To</label>
                            <input type="text" id="ws-submit-to" class="ws-input" placeholder="e.g. City of Phoenix Traffic Dept" style="width: 100%;">
                        </div>
                        <div style="flex: 1;">
                            <label>Submission Date</label>
                            <input type="date" id="ws-submit-date" class="ws-input" style="width: 100%;">
                        </div>
                        <div style="flex: 1;">
                            <label>Submission Method</label>
                            <select id="ws-submit-method" class="ws-input" style="width: 100%;">
                                <option value=""> Select </option>
                                <option value="Email">Email</option>
                                <option value="Portal Upload">Portal Upload</option>
                                <option value="Hard Copy">Hard Copy</option>
                                <option value="FTP">FTP / File Share</option>
                                <option value="In Person">In Person</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row" style="display: flex; gap: 12px; margin-bottom: 16px;">
                        <div style="flex: 1;">
                            <label>Contact Name</label>
                            <input type="text" id="ws-submit-contact" class="ws-input" placeholder="Reviewer name" style="width: 100%;">
                        </div>
                        <div style="flex: 1;">
                            <label>Contact Email</label>
                            <input type="email" id="ws-submit-email" class="ws-input" placeholder="reviewer@jurisdiction.gov" style="width: 100%;">
                        </div>
                        <div style="flex: 1;">
                            <label>Review Status</label>
                            <select id="ws-review-status" class="ws-input" style="width: 100%;">
                                <option value="Not Submitted">Not Submitted</option>
                                <option value="Submitted">Submitted</option>
                                <option value="Under Review">Under Review</option>
                                <option value="Comments Received">Comments Received</option>
                                <option value="Resubmitted">Resubmitted</option>
                                <option value="Approved">Approved</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label>Submission Notes</label>
                        <textarea id="ws-submit-notes" class="ws-input" rows="3" placeholder="Tracking notes, review comments, resubmittal items..." style="width: 100%; resize: vertical;"></textarea>
                    </div>

                    <!-- PROJECT COMPLETION SUMMARY -->
                    <div style="margin-top: 20px; padding: 16px; background: linear-gradient(135deg, rgba(0,170,255,0.08), rgba(74,222,128,0.08)); border: 1px solid rgba(0,170,255,0.2); border-radius: 10px;">
                        <h4 style="margin: 0 0 12px 0; color: var(--gold);">Project Completion Summary</h4>
                        <div style="display: flex; gap: 12px;" id="completion-summary-cards">
                            <div class="trip-summary-card" style="flex: 1;">
                                <div class="trip-summary-label">Steps Complete</div>
                                <div class="trip-summary-value" id="final-steps-complete">0 / 10</div>
                            </div>
                            <div class="trip-summary-card" style="flex: 1;">
                                <div class="trip-summary-label">QC Items Passed</div>
                                <div class="trip-summary-value" id="final-qc-count">0 / 8</div>
                            </div>
                            <div class="trip-summary-card" style="flex: 1;">
                                <div class="trip-summary-label">Deliverables</div>
                                <div class="trip-summary-value" id="final-deliverables-count">0</div>
                            </div>
                            <div class="trip-summary-card" style="flex: 1;">
                                <div class="trip-summary-label">Review Status</div>
                                <div class="trip-summary-value" id="final-review-status" style="font-size: 14px;"></div>
                            </div>
                        </div>
                    </div>

                    <!-- VALIDATION -->
                    <div class="ws-validation-panel" id="val-delivery">
                        <h4>Final Delivery Validation</h4>
                        <div id="val-delivery-items"></div>
                    </div>

                    <!-- SUBMIT -->
                    <button class="ws-submit-btn" id="ws-submit-step10" style="background: linear-gradient(135deg, var(--gold), var(--success)); font-size: 15px;">Complete Project  Final Delivery</button>
                    <button class="action-btn" id="generate-pptx-step10" style="width:100%;padding:14px;font-size:14px;margin-top:12px;cursor:pointer;border:2px solid var(--gold);background:var(--bg-base);color:var(--gold);border-radius:8px;">Generate PPTX Report Deck</button>
                </div>

            </div>

            <!-- ==================== PROJECT SUMMARY CARD ==================== -->
            <div class="project-summary-card" id="project-summary-card">
                <div class="project-summary-header">
                    <span class="project-summary-title">Project Summary</span>
                    <span class="project-summary-status active" id="project-summary-status">Active</span>
                </div>
                <div class="project-summary-grid" id="project-summary-grid">
                    <!-- Populated by JS on Step 1 submit -->
                </div>
                <div class="project-summary-buildings" id="project-summary-buildings">
                    <!-- Building tags populated by JS -->
                </div>
            </div>

            <!-- ==================== SUPPLEMENTAL FILES PANEL ==================== -->
            <div class="supp-files-panel" id="supplemental-files-panel">
                <div class="supp-files-header" id="supp-files-toggle">
                    <span class="supp-files-title">Supplemental Files</span>
                    <span class="supp-files-count" id="supp-files-count">0</span>
                </div>
                <div class="supp-files-body" id="supp-files-body">
                    <div class="supp-files-filter" id="supp-files-filter">
                        <button class="active" data-filter="all">All</button>
                        <button data-filter="1">Step 1</button>
                        <button data-filter="2">Step 2</button>
                        <button data-filter="3">Step 3</button>
                        <button data-filter="aerial">Aerial</button>
                    </div>
                    <div class="supp-files-dropzone" id="supp-files-dropzone">
                        <div style="font-size:24px;margin-bottom:6px;"></div>
                        <div>Drop files here or click to browse</div>
                        <div style="font-size:11px;margin-top:4px;">PDF, PNG, JPG, DOCX, XLSX  Max 10MB per file</div>
                        <input type="file" id="supp-files-input" multiple style="display:none;" accept=".pdf,.png,.jpg,.jpeg,.docx,.xlsx,.csv,.dwg,.zip">
                    </div>
                    <div class="supp-files-list" id="supp-files-list">
                        <div class="supp-files-empty">No files attached</div>
                    </div>
                </div>
            </div>

            <!-- ==================== PROJECT FOLDER TRACKER ==================== -->
            <div class="project-folder-tracker" id="project-folder-tracker">
                <div class="folder-tracker-header">
                    <span class="folder-tracker-title">Project Folder</span>
                    <span class="folder-tracker-progress" id="folder-tracker-progress">0 / 10 steps complete</span>
                </div>

                <!-- Step 1: Setup -->
                <div class="folder-step-group" data-folder-step="1">
                    <div class="folder-step-label"><span class="step-badge" id="folder-badge-1">1</span> Project Setup</div>
                    <div class="folder-item pending" id="folder-project-info">
                        <span class="item-icon"></span>
                        <span class="item-name">Project Information</span>
                        <span class="item-status pending">Missing</span>
                    </div>
                    <div class="folder-item pending" id="folder-site-docs">
                        <span class="item-icon"></span>
                        <span class="item-name">Site Plan / Plat / Aerial</span>
                        <span class="item-status pending">Missing</span>
                    </div>
                </div>

                <!-- Step 2: Data Collection -->
                <div class="folder-step-group" data-folder-step="2">
                    <div class="folder-step-label"><span class="step-badge" id="folder-badge-2">2</span> Data Collection</div>
                    <div class="folder-item pending" id="folder-intersections">
                        <span class="item-icon"></span>
                        <span class="item-name">Study Intersections</span>
                        <span class="item-status pending">Missing</span>
                    </div>
                    <div class="folder-item pending" id="folder-tmc-counts">
                        <span class="item-icon"></span>
                        <span class="item-name">TMC Counts (AM/PM)</span>
                        <span class="item-status pending">Missing</span>
                    </div>
                    <div class="folder-item pending" id="folder-adt-counts">
                        <span class="item-icon"></span>
                        <span class="item-name">ADT / Tube Counts</span>
                        <span class="item-status pending">Missing</span>
                    </div>
                </div>

                <!-- Step 3: Trip Generation -->
                <div class="folder-step-group" data-folder-step="3">
                    <div class="folder-step-label"><span class="step-badge" id="folder-badge-3">3</span> Trip Generation</div>
                    <div class="folder-item pending" id="folder-trip-calcs">
                        <span class="item-icon"></span>
                        <span class="item-name">ITE Trip Calculations</span>
                        <span class="item-status pending">Missing</span>
                    </div>
                    <div class="folder-item pending" id="folder-trip-worksheet">
                        <span class="item-icon"></span>
                        <span class="item-name">Trip Generation Worksheet</span>
                        <span class="item-status pending">Missing</span>
                    </div>
                </div>

                <!-- Step 4: Distribution -->
                <div class="folder-step-group" data-folder-step="4">
                    <div class="folder-step-label"><span class="step-badge" id="folder-badge-4">4</span> Trip Distribution</div>
                    <div class="folder-item pending" id="folder-distribution">
                        <span class="item-icon"></span>
                        <span class="item-name">Distribution Percentages</span>
                        <span class="item-status pending">Missing</span>
                    </div>
                </div>

                <!-- Step 5: Future Volumes -->
                <div class="folder-step-group" data-folder-step="5">
                    <div class="folder-step-label"><span class="step-badge" id="folder-badge-5">5</span> Future Volumes</div>
                    <div class="folder-item pending" id="folder-volumes">
                        <span class="item-icon"></span>
                        <span class="item-name">Volume Scenarios (Existing / Background / Site)</span>
                        <span class="item-status pending">Missing</span>
                    </div>
                </div>

                <!-- Step 6: Capacity Analysis -->
                <div class="folder-step-group" data-folder-step="6">
                    <div class="folder-step-label"><span class="step-badge" id="folder-badge-6">6</span> Capacity Analysis</div>
                    <div class="folder-item pending" id="folder-synchro">
                        <span class="item-icon"></span>
                        <span class="item-name">Synchro Models (.syn)</span>
                        <span class="item-status pending">Missing</span>
                    </div>
                    <div class="folder-item pending" id="folder-los">
                        <span class="item-icon"></span>
                        <span class="item-name">LOS Summary Table</span>
                        <span class="item-status pending">Missing</span>
                    </div>
                </div>

                <!-- Step 7: Site Access -->
                <div class="folder-step-group" data-folder-step="7">
                    <div class="folder-step-label"><span class="step-badge" id="folder-badge-7">7</span> Site Access</div>
                    <div class="folder-item pending" id="folder-driveway">
                        <span class="item-icon"></span>
                        <span class="item-name">Driveway Analysis / Turn Lanes</span>
                        <span class="item-status pending">Missing</span>
                    </div>
                </div>

                <!-- Step 8: Signal Warrants -->
                <div class="folder-step-group" data-folder-step="8">
                    <div class="folder-step-label"><span class="step-badge" id="folder-badge-8">8</span> Signal Warrants</div>
                    <div class="folder-item pending" id="folder-warrants">
                        <span class="item-icon"></span>
                        <span class="item-name">Warrant Analysis (MUTCD)</span>
                        <span class="item-status pending">Missing</span>
                    </div>
                </div>

                <!-- Step 9: Report Assembly -->
                <div class="folder-step-group" data-folder-step="9">
                    <div class="folder-step-label"><span class="step-badge" id="folder-badge-9">9</span> Report Assembly</div>
                    <div class="folder-item pending" id="folder-report">
                        <span class="item-icon"></span>
                        <span class="item-name">TIA Report Draft (.docx)</span>
                        <span class="item-status pending">Missing</span>
                    </div>
                    <div class="folder-item pending" id="folder-exhibits">
                        <span class="item-icon"></span>
                        <span class="item-name">Exhibits / Figures</span>
                        <span class="item-status pending">Missing</span>
                    </div>
                </div>

                <!-- Step 10: Final Delivery -->
                <div class="folder-step-group" data-folder-step="10">
                    <div class="folder-step-label"><span class="step-badge" id="folder-badge-10">10</span> Final Delivery</div>
                    <div class="folder-item pending" id="folder-final-pdf">
                        <span class="item-icon"></span>
                        <span class="item-name">Final TIA (.pdf)</span>
                        <span class="item-status pending">Missing</span>
                    </div>
                    <div class="folder-item pending" id="folder-appendix">
                        <span class="item-icon"></span>
                        <span class="item-name">Appendix (counts, capacity reports)</span>
                        <span class="item-status pending">Missing</span>
                    </div>
                </div>
            </div>

            <!-- ==================== STEP INSTRUCTIONS ==================== -->
            <div class="step-instructions" id="step-instructions">
                <div class="step-instructions-title" id="step-title">Step 1: Project Setup</div>
                <div class="step-instructions-content" id="step-content">
                    <strong>Create your TIA project folder structure:</strong>
                    <ol>
                        <li>Click <strong>+ New Project</strong> and enter project details</li>
                        <li>The system will create your folder structure at:<br>
                            <code>G:\My Drive\00 - Trajanus USA\Traffic\[Project Name]\</code></li>
                        <li>Folder structure includes: Traffic Counts, SYNCHRO Outputs, Deliverable</li>
                        <li>Once created, proceed to <strong>Step 2: Gather Input</strong></li>
                    </ol>
                </div>
                <!-- Step Actions -->
                <div class="step-actions" id="step-actions">
                    <button class="action-btn" id="open-folder-btn">Open Project Folder</button>
                    <button class="action-btn" id="next-step-btn">Next Step</button>
                </div>
                <!-- Tools for This Step -->
                <div class="step-tools" id="step-tools">
                    <div class="step-tools-title">Tools for This Step:</div>
                    <div class="step-tools-grid" id="step-tools-grid">
                        <!-- Populated by JavaScript based on current step -->
                    </div>
                </div>
            </div>

            <!-- ==================== REQUIRED DOCUMENTS ==================== -->
            <div class="docs-panel" id="docs-panel">
                <div class="docs-panel-header" id="docs-panel-header">
                    <span class="docs-panel-title">Required Documents Checklist</span>
                    <span class="docs-panel-toggle" id="docs-toggle">&#9660; Collapse</span>
                </div>
                <div class="docs-panel-body" id="docs-panel-body">
                    <!-- Input Documents -->
                    <div class="docs-category">
                        <div class="docs-category-title">Input Documents</div>
                        <div class="doc-item">
                            <input type="checkbox" class="doc-checkbox" id="doc-site-plan">
                            <label class="doc-item-label" for="doc-site-plan">Site Plan (.pdf)</label>
                        </div>
                        <div class="doc-item">
                            <input type="checkbox" class="doc-checkbox" id="doc-ite-calc">
                            <label class="doc-item-label" for="doc-ite-calc">ITE Trip Generation Worksheet (.xlsx)</label>
                        </div>
                        <div class="doc-item">
                            <input type="checkbox" class="doc-checkbox" id="doc-tmc">
                            <label class="doc-item-label" for="doc-tmc">TMC Counts (AM/PM peaks)</label>
                        </div>
                        <div class="doc-item">
                            <input type="checkbox" class="doc-checkbox" id="doc-adt">
                            <label class="doc-item-label" for="doc-adt">ADT Counts (tube counts)</label>
                        </div>
                    </div>

                    <!-- Synchro Models -->
                    <div class="docs-category">
                        <div class="docs-category-title">Synchro Models</div>
                        <div class="doc-item">
                            <input type="checkbox" class="doc-checkbox" id="doc-syn-bg">
                            <label class="doc-item-label" for="doc-syn-bg">Background Conditions (.syn)</label>
                        </div>
                        <div class="doc-item">
                            <input type="checkbox" class="doc-checkbox" id="doc-syn-grown">
                            <label class="doc-item-label" for="doc-syn-grown">Background + Growth (.syn)</label>
                        </div>
                        <div class="doc-item">
                            <input type="checkbox" class="doc-checkbox" id="doc-syn-site">
                            <label class="doc-item-label" for="doc-syn-site">Background + Growth + Site (.syn)</label>
                        </div>
                    </div>

                    <!-- Analysis Outputs -->
                    <div class="docs-category">
                        <div class="docs-category-title">Analysis Outputs</div>
                        <div class="doc-item">
                            <input type="checkbox" class="doc-checkbox" id="doc-los-table">
                            <label class="doc-item-label" for="doc-los-table">LOS Summary Table</label>
                        </div>
                        <div class="doc-item">
                            <input type="checkbox" class="doc-checkbox" id="doc-capacity">
                            <label class="doc-item-label" for="doc-capacity">Capacity Analysis Reports (.pdf)</label>
                        </div>
                        <div class="doc-item">
                            <input type="checkbox" class="doc-checkbox" id="doc-counts-output">
                            <label class="doc-item-label" for="doc-counts-output">Traffic Counts Outputs (.pdf)</label>
                        </div>
                    </div>

                    <!-- Final Deliverables -->
                    <div class="docs-category">
                        <div class="docs-category-title">Final Deliverables</div>
                        <div class="doc-item">
                            <input type="checkbox" class="doc-checkbox" id="doc-tia-report">
                            <label class="doc-item-label" for="doc-tia-report">FINAL Traffic Impact Analysis (.docx/.pdf)</label>
                        </div>
                        <div class="doc-item">
                            <input type="checkbox" class="doc-checkbox" id="doc-exhibits">
                            <label class="doc-item-label" for="doc-exhibits">Exhibits (.pdf)</label>
                        </div>
                        <div class="doc-item">
                            <input type="checkbox" class="doc-checkbox" id="doc-appendix">
                            <label class="doc-item-label" for="doc-appendix">Appendix (counts, capacity reports)</label>
                        </div>
                    </div>
                </div>
            </div>


            <!-- ==================== APPLICATIONS ==================== -->
            <div class="section-divider">
                <span class="section-title">Applications</span>
                <div class="section-line"></div>
            </div>

            <!-- Traffic Tools -->
            <div class="app-category">
                <div class="category-label">Traffic Tools</div>
                <div class="app-grid">
                    <div class="app-card" data-launch="synchro">
                        <span class="app-icon"></span>
                        <span class="app-label">Synchro 12</span>
                    </div>
                    <div class="app-card" data-launch="hcs">
                        <span class="app-icon"></span>
                        <span class="app-label">HCS 7</span>
                    </div>
                    <div class="app-card" data-launch="autocad">
                        <span class="app-icon"></span>
                        <span class="app-label">AutoCAD</span>
                    </div>
                    <a class="app-card" href="https://maps.google.com" target="_blank">
                        <span class="app-icon"></span>
                        <span class="app-label">Google Maps</span>
                    </a>
                    <a class="app-card" href="https://azdot.gov" target="_blank">
                        <span class="app-icon"></span>
                        <span class="app-label">ADOT</span>
                    </a>
                </div>
            </div>

            <!-- MS Office -->
            <div class="app-category">
                <div class="category-label">MS Office Suite</div>
                <div class="app-grid">
                    <div class="app-card" data-launch="word">
                        <span class="app-icon"></span>
                        <span class="app-label">Word</span>
                    </div>
                    <div class="app-card" data-launch="excel">
                        <span class="app-icon"></span>
                        <span class="app-label">Excel</span>
                    </div>
                    <div class="app-card" data-launch="powerpoint">
                        <span class="app-icon"></span>
                        <span class="app-label">PowerPoint</span>
                    </div>
                    <div class="app-card" data-launch="outlook">
                        <span class="app-icon"></span>
                        <span class="app-label">Outlook</span>
                    </div>
                    <div class="app-card" data-launch="onenote">
                        <span class="app-icon"></span>
                        <span class="app-label">OneNote</span>
                    </div>
                </div>
            </div>

            <!-- Browsers & Files -->
            <div class="app-category">
                <div class="category-label">Browsers & Files</div>
                <div class="app-grid">
                    <div class="app-card" data-launch="chrome">
                        <span class="app-icon"></span>
                        <span class="app-label">Chrome</span>
                    </div>
                    <div class="app-card" data-launch="edge">
                        <span class="app-icon"></span>
                        <span class="app-label">Edge</span>
                    </div>
                    <div class="app-card" data-launch="explorer">
                        <span class="app-icon"></span>
                        <span class="app-label">Explorer</span>
                    </div>
                    <div class="app-card" data-launch="terminal">
                        <span class="app-icon"></span>
                        <span class="app-label">Terminal</span>
                    </div>
                </div>
            </div>

            <!-- ==================== TRAJANUS SCRIPTS ==================== -->
            <div class="section-divider">
                <span class="section-title">Trajanus Scripts</span>
                <div class="section-line"></div>
            </div>

            <div class="script-grid">
                <div class="script-card" data-script="trip-generation">
                    <span class="script-icon"></span>
                    <div class="script-info">
                        <div class="script-name">Trip Generation Calculator</div>
                        <div class="script-desc">ITE 11th Edition trip calculations</div>
                    </div>
                </div>
                <div class="script-card" data-script="los-worksheet">
                    <span class="script-icon"></span>
                    <div class="script-info">
                        <div class="script-name">LOS Worksheet</div>
                        <div class="script-desc">Level of service analysis template</div>
                    </div>
                </div>
                <div class="script-card" data-script="signal-timing">
                    <span class="script-icon"></span>
                    <div class="script-info">
                        <div class="script-name">Signal Timing Optimizer</div>
                        <div class="script-desc">Optimize intersection timing</div>
                    </div>
                </div>
                <div class="script-card" data-script="tia-template">
                    <span class="script-icon"></span>
                    <div class="script-info">
                        <div class="script-name">TIA Report Template</div>
                        <div class="script-desc">Traffic impact analysis template</div>
                    </div>
                </div>
            </div>

            <!-- ==================== REFERENCE STANDARDS ==================== -->
            <div class="section-divider">
                <span class="section-title">Reference Standards</span>
                <div class="section-line"></div>
            </div>

            <div class="doc-category">
                <div class="doc-category-header">National Standards</div>
                <div class="doc-grid">
                    <div class="doc-card" data-doc="ite-trip-gen">
                        <span class="doc-icon"></span>
                        <div class="doc-info">
                            <div class="doc-name">ITE Trip Generation (11th Ed)</div>
                            <div class="doc-meta">Trip rates and equations</div>
                        </div>
                    </div>
                    <div class="doc-card" data-doc="hcm">
                        <span class="doc-icon"></span>
                        <div class="doc-info">
                            <div class="doc-name">HCM 7th Edition</div>
                            <div class="doc-meta">Highway Capacity Manual</div>
                        </div>
                    </div>
                    <div class="doc-card" data-doc="mutcd">
                        <span class="doc-icon"></span>
                        <div class="doc-info">
                            <div class="doc-name">MUTCD</div>
                            <div class="doc-meta">Manual on Uniform Traffic Control</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="doc-category">
                <div class="doc-category-header">Arizona Standards</div>
                <div class="doc-grid">
                    <div class="doc-card" data-doc="fdot-los">
                        <span class="doc-icon"></span>
                        <div class="doc-info">
                            <div class="doc-name">ADOT Traffic Engineering Guidelines</div>
                            <div class="doc-meta">Arizona level of service standards</div>
                        </div>
                    </div>
                    <div class="doc-card" data-doc="fdot-design">
                        <span class="doc-icon"></span>
                        <div class="doc-info">
                            <div class="doc-name">ADOT Roadway Design Guidelines</div>
                            <div class="doc-meta">Roadway design criteria</div>
                        </div>
                    </div>
                    <div class="doc-card" data-doc="maricopa-std">
                        <span class="doc-icon"></span>
                        <div class="doc-info">
                            <div class="doc-name">Maricopa County Standards</div>
                            <div class="doc-meta">Local jurisdiction requirements</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ==================== JURISDICTION BROWSER ==================== -->
            <div class="section-divider">
                <span class="section-title">Jurisdiction Requirements</span>
                <div class="section-line"></div>
            </div>

            <div class="jurisdiction-browser" id="jurisdiction-browser">
                <div class="jurisdiction-list">
                    <div class="jurisdiction-search">
                        <input type="text" class="jurisdiction-search-input" placeholder="Search jurisdictions..." id="jurisdiction-search">
                    </div>
                    <div class="jurisdiction-items" id="jurisdiction-items">
                        <!-- Jurisdiction items will be populated by JavaScript -->
                    </div>
                </div>
                <div class="jurisdiction-detail" id="jurisdiction-detail">
                    <div class="jurisdiction-placeholder">
                        <span style="font-size: 48px; margin-bottom: 16px;"></span>
                        <h3>Select a Jurisdiction</h3>
                        <p>Choose a jurisdiction from the list to view requirements, contacts, and submittal procedures.</p>
                    </div>
                </div>
            </div>

            <!-- ==================== PROJECT DATA ==================== -->
            <div class="section-divider">
                <span class="section-title">Project Data</span>
                <div class="section-line"></div>
            </div>

            <div class="doc-category">
                <div class="doc-category-header">Current Project Files</div>
                <div class="doc-grid">
                    <div class="doc-card" data-doc="traffic-counts">
                        <span class="doc-icon"></span>
                        <div class="doc-info">
                            <div class="doc-name">Traffic Counts</div>
                            <div class="doc-meta">TMC intersection counts</div>
                        </div>
                    </div>
                    <div class="doc-card" data-doc="site-plan">
                        <span class="doc-icon"></span>
                        <div class="doc-info">
                            <div class="doc-name">Site Plan</div>
                            <div class="doc-meta">Civil engineering layout</div>
                        </div>
                    </div>
                    <div class="doc-card" data-doc="existing-conditions">
                        <span class="doc-icon"></span>
                        <div class="doc-info">
                            <div class="doc-name">Existing Conditions</div>
                            <div class="doc-meta">Baseline traffic data</div>
                        </div>
                    </div>
                    <div class="doc-card" data-doc="synchro-model">
                        <span class="doc-icon"></span>
                        <div class="doc-info">
                            <div class="doc-name">Synchro Model</div>
                            <div class="doc-meta">.syn analysis file</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ==================== AGENTS ==================== -->
            <div class="section-divider">
                <span class="section-title">Agents</span>
                <div class="section-line"></div>
            </div>

            <div class="agent-grid">
                <div class="agent-card" data-agent="trip-generator">
                    <span class="agent-icon"></span>
                    <div class="agent-info">
                        <div class="agent-name">Trip Generator</div>
                        <div class="agent-desc">ITE trip generation calculations</div>
                    </div>
                    <span class="agent-status">Ready</span>
                </div>
                <div class="agent-card" data-agent="los-analyzer">
                    <span class="agent-icon"></span>
                    <div class="agent-info">
                        <div class="agent-name">LOS Analyzer</div>
                        <div class="agent-desc">Level of service analysis</div>
                    </div>
                    <span class="agent-status">Ready</span>
                </div>
                <div class="agent-card" data-agent="signal-timer">
                    <span class="agent-icon"></span>
                    <div class="agent-info">
                        <div class="agent-name">Signal Timer</div>
                        <div class="agent-desc">Signal timing optimization</div>
                    </div>
                    <span class="agent-status">Ready</span>
                </div>
                <div class="agent-card" data-agent="report-writer">
                    <span class="agent-icon"></span>
                    <div class="agent-info">
                        <div class="agent-name">TIA Report Writer</div>
                        <div class="agent-desc">Generate traffic impact reports</div>
                    </div>
                    <span class="agent-status">Ready</span>
                </div>
            </div>

            <!-- ========================== -->
            <!-- PROJECT PROGRESS SECTION   -->
            <!-- ========================== -->
            <div class="section-divider">
                <span class="section-title">Project Progress</span>
                <div class="section-line"></div>
            </div>

            <div class="progress-section">
                <!-- LEFT PANEL: Living Checklist -->
                <div class="progress-checklist" id="progress-checklist">
                    <div class="checklist-header">
                        <div class="checklist-title">
                            <span>&#9745;</span>
                            TSE Verification Checklist
                        </div>
                        <span class="checklist-count" id="checklist-count">8/8</span>
                    </div>
                    <div class="checklist-items" id="checklist-items">
                        <div class="checklist-item completed" data-task="templates">
                            <div class="checklist-checkbox"></div>
                            <span class="checklist-text">Study templates configured</span>
                            <span class="checklist-badge high">P1</span>
                        </div>
                        <div class="checklist-item completed" data-task="data">
                            <div class="checklist-checkbox"></div>
                            <span class="checklist-text">Data collection tools ready</span>
                            <span class="checklist-badge high">P1</span>
                        </div>
                        <div class="checklist-item completed" data-task="analysis">
                            <div class="checklist-checkbox"></div>
                            <span class="checklist-text">Analysis modules active</span>
                            <span class="checklist-badge medium">P2</span>
                        </div>
                        <div class="checklist-item completed" data-task="reports">
                            <div class="checklist-checkbox"></div>
                            <span class="checklist-text">Report generators ready</span>
                            <span class="checklist-badge high">P2</span>
                        </div>
                        <div class="checklist-item completed" data-task="agents">
                            <div class="checklist-checkbox"></div>
                            <span class="checklist-text">TSE agents integrated</span>
                            <span class="checklist-badge medium">P3</span>
                        </div>
                        <div class="checklist-item completed" data-task="validation">
                            <div class="checklist-checkbox"></div>
                            <span class="checklist-text">Validation workflows tested</span>
                            <span class="checklist-badge critical">P3</span>
                        </div>
                        <div class="checklist-item completed" data-task="ui">
                            <div class="checklist-checkbox"></div>
                            <span class="checklist-text">UI standardization complete</span>
                            <span class="checklist-badge medium">P4</span>
                        </div>
                        <div class="checklist-item completed" data-task="integration">
                            <div class="checklist-checkbox"></div>
                            <span class="checklist-text">Hub integration verified</span>
                            <span class="checklist-badge low">P4</span>
                        </div>
                    </div>
                </div>

                <!-- RIGHT PANEL: Progress Tracker -->
                <div class="progress-tracker" id="progress-tracker">
                    <div class="progress-header">
                        <div class="progress-title">
                            <span class="progress-title-icon">&#128202;</span>
                            TSE Build Progress
                        </div>
                        <div class="progress-overall">
                            <span class="progress-percent" id="overall-percent">100%</span>
                            <span class="progress-label">Complete</span>
                        </div>
                    </div>

                    <div class="progress-phases" id="progress-phases">
                        <div class="progress-phase" data-phase="1">
                            <span class="phase-name">P1: Core Setup</span>
                            <div class="phase-bar-container">
                                <div class="phase-bar complete" style="width: 100%">
                                    <span class="phase-tasks">2/2</span>
                                </div>
                            </div>
                            <span class="phase-percent complete">100%</span>
                        </div>
                        <div class="progress-phase" data-phase="2">
                            <span class="phase-name">P2: Templates</span>
                            <div class="phase-bar-container">
                                <div class="phase-bar complete" style="width: 100%">
                                    <span class="phase-tasks">2/2</span>
                                </div>
                            </div>
                            <span class="phase-percent complete">100%</span>
                        </div>
                        <div class="progress-phase" data-phase="3">
                            <span class="phase-name">P3: Integration</span>
                            <div class="phase-bar-container">
                                <div class="phase-bar complete" style="width: 100%">
                                    <span class="phase-tasks">2/2</span>
                                </div>
                            </div>
                            <span class="phase-percent complete">100%</span>
                        </div>
                        <div class="progress-phase" data-phase="4">
                            <span class="phase-name">P4: Polish</span>
                            <div class="phase-bar-container">
                                <div class="phase-bar complete" style="width: 100%">
                                    <span class="phase-tasks">2/2</span>
                                </div>
                            </div>
                            <span class="phase-percent complete">100%</span>
                        </div>
                    </div>

                    <div class="progress-footer">
                        <div class="progress-stat">
                            <span class="stat-value green" id="stat-complete">8</span>
                            <span class="stat-label">Complete</span>
                        </div>
                        <div class="progress-stat">
                            <span class="stat-value blue" id="stat-progress">0</span>
                            <span class="stat-label">In Progress</span>
                        </div>
                        <div class="progress-stat">
                            <span class="stat-value gray" id="stat-pending">0</span>
                            <span class="stat-label">Pending</span>
                        </div>
                        <div class="progress-stat">
                            <span class="stat-value red" id="stat-blocked">0</span>
                            <span class="stat-label">Blocked</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ==================== OPERATIONS LOG ==================== -->
            <div class="section-divider">
                <span class="section-title">Operations Log</span>
                <div class="section-line"></div>
            </div>

            <div style="background: var(--bg-surface); border: 1px solid var(--blue); border-radius: 8px; margin-bottom: 20px;">
                <div id="terminal-output" style="height: 200px; overflow-y: auto; padding: 16px; font-family: monospace; font-size: 12px; color: var(--text-muted);">
                    Terminal ready. External program output will appear here.
                </div>
            </div>
    </main>
    </div>

    <!-- New Project Modal -->
    <div class="modal-overlay" id="new-project-modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="modal-title">New TIA Project</span>
                <button class="modal-close" id="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Project Name</label>
                    <input type="text" class="form-input" id="project-name" placeholder="e.g., Grace Fellowship Church TIA">
                </div>
                <div class="form-group">
                    <label class="form-label">Client Name</label>
                    <input type="text" class="form-input" id="client-name" placeholder="e.g., Smith Engineering">
                </div>
                <div class="form-group">
                    <label class="form-label">Jurisdiction</label>
                    <select class="form-select" id="jurisdiction">
                        <option value="">-- Select Jurisdiction --</option>
                        <option value="maricopa">Maricopa County</option>
                        <option value="phoenix">City of Phoenix</option>
                        <option value="scottsdale">City of Scottsdale</option>
                        <option value="mesa">City of Mesa</option>
                        <option value="tempe">City of Tempe</option>
                        <option value="chandler">City of Chandler</option>
                        <option value="gilbert">Town of Gilbert</option>
                        <option value="glendale">City of Glendale</option>
                        <option value="pima">Pima County</option>
                        <option value="tucson">City of Tucson</option>
                        <option value="pinal">Pinal County</option>
                        <option value="yavapai">Yavapai County</option>
                        <option value="flagstaff">City of Flagstaff</option>
                        <option value="coconino">Coconino County</option>
                        <option value="yuma">Yuma County</option>
                        <option value="adot">ADOT Statewide</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Study Type</label>
                    <select class="form-select" id="study-type">
                        <option value="tia">Traffic Impact Analysis (TIA)</option>
                        <option value="tis">Traffic Impact Statement (TIS)</option>
                        <option value="methodology">Traffic Methodology Letter</option>
                        <option value="corridor">Corridor Study</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" id="modal-cancel">Cancel</button>
                <button class="btn-primary" id="modal-create">Create Project</button>
            </div>
        </div>
    </div>

    <!-- Step Preview Modal -->
    <div class="modal-overlay" id="step-preview-modal">
        <div class="modal-content" style="max-width:720px;max-height:85vh;display:flex;flex-direction:column;">
            <div class="modal-header" style="display:flex;justify-content:space-between;align-items:center;">
                <span class="modal-title" id="preview-modal-title">Step Preview</span>
                <button class="modal-close" id="preview-modal-close" style="background:none;border:none;color:var(--text-muted);font-size:18px;cursor:pointer;">&#10005;</button>
            </div>
            <div class="modal-body" id="preview-modal-body" style="overflow-y:auto;flex:1;padding:16px 20px;">
                <!-- Populated dynamically by StepPreview -->
            </div>
            <div class="modal-footer" id="preview-modal-footer">
                <button class="btn-secondary" id="preview-modal-close-btn">Close</button>
            </div>
        </div>
    </div>

    <!-- ==================== LAYOUT EDITOR MODAL ==================== -->
    <div class="layout-editor-overlay" id="layout-editor-modal">
        <div class="layout-editor-toolbar">
            <button class="le-btn active" data-tool="select" title="Select">Select</button>
            <button class="le-btn" data-tool="pan" title="Pan">Pan</button>
            <div class="le-sep"></div>
            <button class="le-btn" data-action="addText" title="Add Text">+ Text</button>
            <button class="le-btn" data-action="addArrow" title="Add Arrow">+ Arrow</button>
            <button class="le-btn" data-action="addGrid" title="Add TMC Grid">+ Grid</button>
            <button class="le-btn" data-action="addLabel" title="Add Label">+ Label</button>
            <button class="le-btn" data-action="addCompass" title="Add North Arrow">+ Compass</button>
            <button class="le-btn" data-action="addLegend" title="Add Legend">+ Legend</button>
            <div class="le-sep"></div>
            <button class="le-btn" data-action="loadAerial" title="Load Aerial Background">Load Aerial</button>
            <div class="le-sep"></div>
            <label style="font-size:11px;color:var(--text-muted);display:flex;align-items:center;gap:4px;">
                Snap <input type="checkbox" id="le-snap" checked>
            </label>
            <div class="le-sep"></div>
            <button class="le-btn" data-action="zoomIn">Zoom +</button>
            <button class="le-btn" data-action="zoomOut">Zoom -</button>
            <button class="le-btn" data-action="zoomFit">Fit</button>
            <div class="le-sep"></div>
            <button class="le-btn" data-action="saveLayout" style="border-color:var(--success);color:var(--success);">Save</button>
            <button class="le-btn" data-action="exportPNG">Export PNG</button>
            <button class="le-btn" data-action="deleteObj" style="border-color:var(--error);color:var(--error);">Delete</button>
            <div style="flex:1;"></div>
            <button class="le-btn" data-action="close" style="border-color:var(--error);color:var(--error);">Close</button>
        </div>
        <div class="layout-editor-body">
            <div class="layout-canvas-wrap">
                <canvas id="layout-canvas" width="1280" height="960"></canvas>
            </div>
            <div class="layout-props-panel" id="layout-props">
                <h4>Properties</h4>
                <div id="layout-props-content">
                    <p style="color:var(--text-muted);font-size:12px;">Select an object to edit properties</p>
                </div>
                <h4 style="margin-top:16px;">Layers</h4>
                <div id="layout-layers-list" style="font-size:12px;color:var(--text-muted);">No objects</div>
            </div>
        </div>
        <div class="layout-statusbar">
            <span id="le-exhibit-name"></span>
            <span>Objects: <span id="le-obj-count">0</span></span>
            <span>Zoom: <span id="le-zoom-level">100</span>%</span>
        </div>
    </div>

    <script src="../js/localforage.min.js"></script>
    <script src="../js/fabric.min.js"></script>
    <script src="../js/pptxgenjs.min.js"></script>
    <script>
        // ==================== CONFIGURATION ====================
        const SCRIPTS_PATH = 'G:\\My Drive\\00 - Trajanus USA\\00-Command-Center\\05-Scripts\\';

        // ==================== SAFE TAURI API WRAPPER ====================
        function getInvoke() {
            if (window.__TAURI__ && window.__TAURI__.core && window.__TAURI__.core.invoke) {
                return window.__TAURI__.core.invoke;
            }
            return null;
        }

        // ==================== NOTIFICATION HELPER ====================
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
        }

        function safeParseLS(key) {
            try { return JSON.parse(localStorage.getItem(key)); } catch(e) { return null; }
        }

        // ==================== PROJECT LIFECYCLE CONSTANTS ====================
        const PROJECT_STATUSES = ['draft', 'active', 'in-review', 'approved', 'delivered'];
        const STATUS_LABELS = { 'draft': 'Draft', 'active': 'Active', 'in-review': 'In Review', 'approved': 'Approved', 'delivered': 'Delivered' };
        const STATUS_COLORS = { 'draft': '#888', 'active': '#4a90d9', 'in-review': '#f5a623', 'approved': '#4ade80', 'delivered': '#fbbf24' };
        const STATUS_TRANSITIONS = {
            'draft': ['active'],
            'active': ['in-review'],
            'in-review': ['active', 'approved'],
            'approved': ['active', 'delivered'],
            'delivered': ['active']
        };
        const TRANSITION_LABELS = {
            'draft->active': 'Start Work',
            'active->in-review': 'Submit for Review',
            'in-review->active': 'Send Back for Edits',
            'in-review->approved': 'Approve',
            'approved->active': 'Reject to Active',
            'approved->delivered': 'Deliver & Lock',
            'delivered->active': 'Unlock (Admin)'
        };

        // ==================== PROJECT STORE (IndexedDB via localForage) ====================
        const ProjectStore = {
            _store: null,
            _metaStore: null,

            init() {
                this._store = localforage.createInstance({ name: 'trajanus_tse', storeName: 'projects' });
                this._metaStore = localforage.createInstance({ name: 'trajanus_tse', storeName: 'meta' });
            },

            async createProject(data) {
                const id = 'proj_' + Date.now();
                const project = {
                    id,
                    version: 1,
                    created: new Date().toISOString(),
                    modified: new Date().toISOString(),
                    name: data.name || 'Untitled Project',
                    number: data.number || '',
                    client: data.client || '',
                    address: data.address || '',
                    jurisdiction: data.jurisdiction || '',
                    studyType: data.studyType || 'tia',
                    openingYear: data.openingYear || '',
                    horizonYear: data.horizonYear || '',
                    growthRate: data.growthRate || '',
                    signalWarrantStudy: data.signalWarrantStudy !== false,
                    buildings: data.buildings || [],
                    currentStep: 1,
                    stepsCompleted: data.stepsCompleted || {},
                    folderItems: data.folderItems || {},
                    checklist: data.checklist || {},
                    stepData: { 1: null, 2: null, 3: null, 4: null, 5: null, 6: null, 7: null, 8: null, 9: null, 10: null }
                };
                this.ensureLifecycleFields(project);
                await this._store.setItem(id, project);
                await this.setActiveProjectId(id);
                return project;
            },

            ensureLifecycleFields(project) {
                if (!project) return project;
                if (!project.status) project.status = 'draft';
                if (!project.statusHistory) project.statusHistory = [];
                if (project.lockedAt === undefined) project.lockedAt = null;
                if (project.reviewedBy === undefined) project.reviewedBy = null;
                if (project.approvedAt === undefined) project.approvedAt = null;
                if (project.deliveredAt === undefined) project.deliveredAt = null;
                if (!project.exportHistory) project.exportHistory = [];
                return project;
            },

            async getProject(id) {
                const project = await this._store.getItem(id);
                return this.ensureLifecycleFields(project);
            },

            async saveProject(project) {
                project.modified = new Date().toISOString();
                project.version = (project.version || 0) + 1;
                await this._store.setItem(project.id, project);
                return project;
            },

            async transitionStatus(projectId, newStatus, note = '') {
                const project = await this.getProject(projectId);
                if (!project) throw new Error('Project not found');
                const currentStatus = project.status || 'draft';
                const allowed = STATUS_TRANSITIONS[currentStatus] || [];
                if (!allowed.includes(newStatus)) {
                    throw new Error(`Cannot transition from "${currentStatus}" to "${newStatus}"`);
                }
                project.statusHistory.push({
                    from: currentStatus,
                    to: newStatus,
                    timestamp: new Date().toISOString(),
                    note: note
                });
                project.status = newStatus;
                if (newStatus === 'approved') project.approvedAt = new Date().toISOString();
                if (newStatus === 'delivered') {
                    project.deliveredAt = new Date().toISOString();
                    project.lockedAt = new Date().toISOString();
                }
                if (newStatus === 'active' && currentStatus === 'delivered') {
                    project.lockedAt = null;
                }
                return await this.saveProject(project);
            },

            isLocked(project) {
                return project && project.status === 'delivered';
            },

            async exportProject(projectId) {
                const project = await this.getProject(projectId);
                if (!project) throw new Error('Project not found');
                project.exportHistory.push({ timestamp: new Date().toISOString(), format: 'json' });
                await this.saveProject(project);
                const exportData = { ...project, _exportedAt: new Date().toISOString(), _exportVersion: 1 };
                const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${(project.name || 'project').replace(/[^a-zA-Z0-9-_]/g, '_')}.tse-project.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                return project;
            },

            async importProject(jsonString) {
                const data = JSON.parse(jsonString);
                if (!data.name && !data.stepData) throw new Error('Invalid project file');
                const newId = 'proj_' + Date.now();
                const project = {
                    ...data,
                    id: newId,
                    status: 'draft',
                    statusHistory: data.statusHistory || [],
                    lockedAt: null,
                    created: data.created || new Date().toISOString(),
                    modified: new Date().toISOString(),
                    _importedAt: new Date().toISOString(),
                    _importedFrom: data.id || 'unknown'
                };
                this.ensureLifecycleFields(project);
                project.statusHistory.push({
                    from: data.status || 'unknown',
                    to: 'draft',
                    timestamp: new Date().toISOString(),
                    note: 'Imported as new draft'
                });
                await this._store.setItem(newId, project);
                return project;
            },

            async deleteProject(id) {
                await this._store.removeItem(id);
                await FileStore.deleteAllForProject(id);
                const activeId = await this.getActiveProjectId();
                if (activeId === id) {
                    await this._metaStore.removeItem('activeProjectId');
                }
            },

            async listProjects() {
                const projects = [];
                await this._store.iterate((value) => {
                    projects.push({
                        id: value.id,
                        name: value.name,
                        client: value.client,
                        address: value.address,
                        jurisdiction: value.jurisdiction,
                        currentStep: value.currentStep || 1,
                        stepsCompleted: value.stepsCompleted || {},
                        status: value.status || 'draft',
                        modified: value.modified,
                        created: value.created
                    });
                });
                projects.sort((a, b) => new Date(b.modified) - new Date(a.modified));
                return projects;
            },

            async getActiveProjectId() {
                return await this._metaStore.getItem('activeProjectId');
            },

            async setActiveProjectId(id) {
                await this._metaStore.setItem('activeProjectId', id);
            },

            async saveStepData(projectId, stepNum, data) {
                const project = await this.getProject(projectId);
                if (!project) return;
                if (this.isLocked(project)) {
                    showNotification('This project is locked. Unlock to make changes.', 'warning');
                    return project;
                }
                project.stepData[stepNum] = data;
                return await this.saveProject(project);
            },

            async migrateFromLocalStorage() {
                const existing = await this.listProjects();
                if (existing.length > 0) return;

                const activeRaw = localStorage.getItem('tfe_active_project');
                if (!activeRaw) return;

                try {
                    const active = JSON.parse(activeRaw);
                    const stepData = { 1: null, 2: null, 3: null, 4: null, 5: null, 6: null, 7: null, 8: null, 9: null, 10: null };

                    for (let i = 2; i <= 10; i++) {
                        const raw = localStorage.getItem('tfe_step' + i + '_data');
                        if (raw) {
                            try { stepData[i] = JSON.parse(raw); } catch(e) {}
                        }
                    }
                    stepData[1] = {
                        name: active.name, number: active.number, address: active.address,
                        jurisdiction: active.jurisdiction, openingYear: active.openingYear,
                        horizonYear: active.horizonYear, growthRate: active.growthRate,
                        signalWarrantStudy: active.signalWarrantStudy, buildings: active.buildings
                    };

                    const project = await this.createProject({
                        name: active.name || 'Migrated Project',
                        number: active.number, client: active.client || '',
                        address: active.address, jurisdiction: active.jurisdiction,
                        studyType: active.studyType || 'tia',
                        openingYear: active.openingYear, horizonYear: active.horizonYear,
                        growthRate: active.growthRate,
                        signalWarrantStudy: active.signalWarrantStudy,
                        buildings: active.buildings || [],
                        stepsCompleted: active.stepsCompleted || {},
                        folderItems: active.folderItems || {}
                    });
                    project.stepData = stepData;
                    await this.saveProject(project);
                    console.log('[ProjectStore] Migrated project from localStorage:', project.name);
                } catch(e) {
                    console.error('[ProjectStore] Migration failed:', e);
                }
            }
        };

        // ==================== FILE STORE (IndexedDB via localForage) ====================
        const FileStore = {
            _store: null,

            init() {
                this._store = localforage.createInstance({ name: 'trajanus_tse', storeName: 'files' });
            },

            async saveFile(projectId, fileObj) {
                const id = 'file_' + Date.now() + '_' + Math.random().toString(36).substr(2, 6);
                const record = {
                    id,
                    projectId,
                    name: fileObj.name,
                    type: fileObj.type || 'application/octet-stream',
                    size: fileObj.size || 0,
                    stepTag: fileObj.stepTag || null,
                    data: fileObj.data,
                    created: new Date().toISOString()
                };
                await this._store.setItem(id, record);
                return record;
            },

            async getFile(fileId) {
                return await this._store.getItem(fileId);
            },

            async listFiles(projectId, stepTag) {
                const files = [];
                await this._store.iterate((value) => {
                    if (value.projectId === projectId) {
                        if (!stepTag || value.stepTag === stepTag) {
                            files.push({
                                id: value.id,
                                name: value.name,
                                type: value.type,
                                size: value.size,
                                stepTag: value.stepTag,
                                created: value.created
                            });
                        }
                    }
                });
                files.sort((a, b) => new Date(b.created) - new Date(a.created));
                return files;
            },

            async deleteFile(fileId) {
                await this._store.removeItem(fileId);
            },

            async getFilesForExport(projectId) {
                const files = [];
                await this._store.iterate((value) => {
                    if (value.projectId === projectId) files.push(value);
                });
                return files;
            },

            async deleteAllForProject(projectId) {
                const toDelete = [];
                await this._store.iterate((value, key) => {
                    if (value.projectId === projectId) toDelete.push(key);
                });
                for (const key of toDelete) {
                    await this._store.removeItem(key);
                }
            }
        };

        // ==================== AUTO-SAVE SYSTEM ====================
        const AutoSave = {
            _timer: null,
            _delay: 1500,

            init() {
                const workspace = document.getElementById('workflow-workspace');
                if (workspace) {
                    workspace.addEventListener('input', () => this.trigger());
                    workspace.addEventListener('change', () => this.trigger());
                }
                window.addEventListener('beforeunload', () => this.saveNow());
            },

            trigger() {
                clearTimeout(this._timer);
                this._timer = setTimeout(() => this.saveNow(), this._delay);
            },

            async saveNow() {
                if (!TseWorkflow._activeProjectId || !TseWorkflow._activeProject) return;
                if (ProjectStore.isLocked(TseWorkflow._activeProject)) return;
                this.showIndicator('Saving...');
                try {
                    const stepNum = TseWorkflow.currentStep;
                    const data = TseWorkflow.gatherStepData(stepNum);
                    if (data) {
                        TseWorkflow._activeProject.stepData[stepNum] = data;
                    }
                    await ProjectStore.saveProject(TseWorkflow._activeProject);
                    this.showIndicator('Saved');
                    setTimeout(() => this.showIndicator(''), 2000);
                } catch(e) {
                    this.showIndicator('Save failed');
                    console.error('[AutoSave]', e);
                }
            },

            showIndicator(text) {
                const el = document.getElementById('autosave-indicator');
                if (el) {
                    el.textContent = text;
                    el.style.opacity = text ? '1' : '0';
                }
            }
        };

        // ==================== SUPPLEMENTAL FILES SYSTEM ====================
        const SupplementalFiles = {
            _currentFilter: 'all',
            MAX_SIZE: 10 * 1024 * 1024,

            init() {
                const dropzone = document.getElementById('supp-files-dropzone');
                const input = document.getElementById('supp-files-input');
                const toggle = document.getElementById('supp-files-toggle');

                if (dropzone) {
                    dropzone.addEventListener('click', () => input?.click());
                    dropzone.addEventListener('dragover', (e) => { e.preventDefault(); dropzone.classList.add('dragover'); });
                    dropzone.addEventListener('dragleave', () => dropzone.classList.remove('dragover'));
                    dropzone.addEventListener('drop', (e) => {
                        e.preventDefault();
                        dropzone.classList.remove('dragover');
                        if (e.dataTransfer.files.length) this.addFiles(e.dataTransfer.files);
                    });
                }
                if (input) {
                    input.addEventListener('change', () => {
                        if (input.files.length) this.addFiles(input.files);
                        input.value = '';
                    });
                }
                if (toggle) {
                    toggle.addEventListener('click', () => {
                        document.getElementById('supp-files-body')?.classList.toggle('collapsed');
                    });
                }

                // Filter buttons
                document.getElementById('supp-files-filter')?.addEventListener('click', (e) => {
                    const btn = e.target.closest('button[data-filter]');
                    if (!btn) return;
                    document.querySelectorAll('#supp-files-filter button').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    this._currentFilter = btn.dataset.filter;
                    this.renderList();
                });
            },

            async addFiles(fileList, stepTag) {
                const projectId = TseWorkflow._activeProjectId;
                if (!projectId) { showNotification('No active project', 'warning'); return; }

                const tag = stepTag || (TseWorkflow.currentStep ? 'Step ' + TseWorkflow.currentStep : null);

                for (const file of fileList) {
                    if (file.size > this.MAX_SIZE) {
                        showNotification(file.name + ' exceeds 10MB limit', 'error');
                        continue;
                    }
                    try {
                        const data = await this._readAsBase64(file);
                        await FileStore.saveFile(projectId, {
                            name: file.name,
                            type: file.type,
                            size: file.size,
                            stepTag: tag,
                            data: data
                        });
                    } catch (e) {
                        console.error('[SupplementalFiles] Error saving:', e);
                        showNotification('Error saving ' + file.name, 'error');
                    }
                }
                showNotification(fileList.length + ' file(s) attached', 'success');
                await this.renderList();
            },

            _readAsBase64(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = () => reject(reader.error);
                    reader.readAsDataURL(file);
                });
            },

            async renderList() {
                const projectId = TseWorkflow._activeProjectId;
                const listEl = document.getElementById('supp-files-list');
                const countEl = document.getElementById('supp-files-count');
                if (!listEl) return;

                if (!projectId) {
                    listEl.innerHTML = '<div class="supp-files-empty">No files attached</div>';
                    if (countEl) countEl.textContent = '0';
                    return;
                }

                const files = await FileStore.listFiles(projectId);
                if (countEl) countEl.textContent = files.length;

                const filtered = this._currentFilter === 'all' ? files :
                    this._currentFilter === 'aerial' ? files.filter(f => f.stepTag === 'aerial') :
                    files.filter(f => f.stepTag === 'Step ' + this._currentFilter);

                if (!filtered.length) {
                    listEl.innerHTML = '<div class="supp-files-empty">No files' + (this._currentFilter !== 'all' ? ' for this filter' : ' attached') + '</div>';
                    return;
                }

                listEl.innerHTML = filtered.map(f => {
                    const icon = this._fileIcon(f.type);
                    const size = this._formatSize(f.size);
                    const tag = f.stepTag ? '<span class="supp-file-tag">' + f.stepTag + '</span>' : '';
                    return '<div class="supp-file-card" data-file-id="' + f.id + '">' +
                        '<span class="supp-file-icon">' + icon + '</span>' +
                        '<div class="supp-file-info">' +
                            '<div class="supp-file-name" title="' + f.name + '">' + f.name + '</div>' +
                            '<div class="supp-file-meta"><span>' + size + '</span>' + tag + '</div>' +
                        '</div>' +
                        '<div class="supp-file-actions">' +
                            '<button onclick="SupplementalFiles.downloadFile(\'' + f.id + '\')" title="Download">DL</button>' +
                            '<button onclick="SupplementalFiles.deleteFile(\'' + f.id + '\')" title="Delete">DEL</button>' +
                        '</div>' +
                    '</div>';
                }).join('');
            },

            async downloadFile(fileId) {
                const file = await FileStore.getFile(fileId);
                if (!file) return;
                const a = document.createElement('a');
                a.href = file.data;
                a.download = file.name;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            },

            async deleteFile(fileId) {
                if (!confirm('Delete this file?')) return;
                await FileStore.deleteFile(fileId);
                showNotification('File deleted', 'info');
                await this.renderList();
            },

            setStepFilter(stepNum) {
                if (stepNum === null) {
                    this._currentFilter = 'all';
                } else {
                    this._currentFilter = String(stepNum);
                }
                const btns = document.querySelectorAll('#supp-files-filter button');
                btns.forEach(b => b.classList.toggle('active', b.dataset.filter === this._currentFilter));
                this.renderList();
            },

            _fileIcon(type) {
                if (!type) return '';
                if (type.includes('pdf')) return '';
                if (type.includes('image')) return '';
                if (type.includes('spreadsheet') || type.includes('excel') || type.includes('csv')) return '';
                if (type.includes('word') || type.includes('document')) return '';
                if (type.includes('zip') || type.includes('compressed')) return '';
                return '';
            },

            _formatSize(bytes) {
                if (!bytes) return '0 B';
                if (bytes < 1024) return bytes + ' B';
                if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
                return (bytes / 1048576).toFixed(1) + ' MB';
            }
        };
        window.SupplementalFiles = SupplementalFiles;

        // ==================== AERIAL FETCH SYSTEM ====================
        const AerialFetch = {
            async fetch(lat, lon, zoom, apiKey) {
                const projectId = TseWorkflow._activeProjectId;
                if (!projectId) { showNotification('No active project', 'warning'); return null; }

                const statusEl = document.getElementById('aerial-status');
                const previewEl = document.getElementById('aerial-preview');
                if (statusEl) statusEl.textContent = 'Fetching satellite image...';

                try {
                    const url = 'https://maps.googleapis.com/maps/api/staticmap?' +
                        'center=' + lat + ',' + lon +
                        '&zoom=' + zoom +
                        '&size=1280x1280' +
                        '&maptype=satellite' +
                        '&key=' + apiKey;

                    const resp = await fetch(url);
                    if (!resp.ok) throw new Error('HTTP ' + resp.status);
                    const blob = await resp.blob();
                    if (blob.type && !blob.type.startsWith('image/')) throw new Error('Invalid response  check API key');

                    const data = await new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = () => resolve(reader.result);
                        reader.onerror = () => reject(reader.error);
                        reader.readAsDataURL(blob);
                    });

                    // Save to FileStore
                    const record = await FileStore.saveFile(projectId, {
                        name: 'aerial_' + lat.toFixed(4) + '_' + lon.toFixed(4) + '.png',
                        type: 'image/png',
                        size: blob.size,
                        stepTag: 'aerial',
                        data: data
                    });

                    if (previewEl) previewEl.innerHTML = '<img src="' + data + '" alt="Satellite Aerial">';
                    if (statusEl) statusEl.textContent = 'Aerial saved (' + (blob.size / 1024).toFixed(0) + ' KB)';

                    await SupplementalFiles.renderList();
                    return record;
                } catch (e) {
                    console.error('[AerialFetch]', e);
                    if (statusEl) statusEl.textContent = 'Error: ' + e.message;
                    showNotification('Aerial fetch failed: ' + e.message, 'error');
                    return null;
                }
            },

            async getProjectAerial(projectId) {
                const files = await FileStore.listFiles(projectId, 'aerial');
                if (!files.length) return null;
                return await FileStore.getFile(files[0].id);
            },

            loadFromProject(project) {
                if (!project || !project.stepData || !project.stepData[1]) return;
                const config = project.stepData[1].aerialConfig;
                if (!config) return;
                const fields = { 'aerial-lat': config.lat, 'aerial-lon': config.lon, 'aerial-zoom': config.zoom, 'aerial-api-key': config.apiKey };
                for (const [id, val] of Object.entries(fields)) {
                    const el = document.getElementById(id);
                    if (el && val) el.value = val;
                }
                // Show stored aerial
                this.getProjectAerial(project.id).then(file => {
                    if (file) {
                        const preview = document.getElementById('aerial-preview');
                        if (preview) preview.innerHTML = '<img src="' + file.data + '" alt="Satellite Aerial">';
                        const status = document.getElementById('aerial-status');
                        if (status) status.textContent = 'Aerial loaded from storage';
                    }
                });
            }
        };

        // ==================== LAYOUT EDITOR (Fabric.js) ====================
        const LayoutEditor = {
            _canvas: null,
            _exhibitId: null,
            _exhibitTitle: '',
            _zoom: 1,
            _snap: true,
            _gridSize: 20,

            open(exhibitId, exhibitTitle) {
                this._exhibitId = exhibitId;
                this._exhibitTitle = exhibitTitle || 'Untitled Exhibit';
                const modal = document.getElementById('layout-editor-modal');
                if (!modal) return;
                modal.classList.add('visible');
                document.getElementById('le-exhibit-name').textContent = this._exhibitTitle;
                this.initCanvas();
                this._bindToolbar();
                this._bindKeyboard();

                // Load saved layout if exists
                const layouts = TseWorkflow._activeProject?.stepData?.[9]?.exhibitLayouts;
                if (layouts && layouts[exhibitId]) {
                    this.loadLayout(layouts[exhibitId]);
                }
            },

            close() {
                this.saveLayout();
                this._unbindKeyboard();
                const modal = document.getElementById('layout-editor-modal');
                if (modal) modal.classList.remove('visible');
                if (this._canvas) {
                    this._canvas.dispose();
                    this._canvas = null;
                }
            },

            _undoStack: [],
            _clipboard: null,
            _keyHandler: null,

            _bindKeyboard() {
                this._undoStack = [];
                this._keyHandler = (e) => {
                    if (!this._canvas) return;
                    const modal = document.getElementById('layout-editor-modal');
                    if (!modal || !modal.classList.contains('visible')) return;
                    // Don't capture when typing in an input
                    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') return;

                    // Delete / Backspace  remove selected
                    if (e.key === 'Delete' || e.key === 'Backspace') {
                        e.preventDefault();
                        this._pushUndo();
                        this._deleteSelected();
                    }
                    // Escape  close editor
                    if (e.key === 'Escape') {
                        e.preventDefault();
                        this.close();
                    }
                    // Ctrl+Z  undo
                    if ((e.ctrlKey || e.metaKey) && e.key === 'z') {
                        e.preventDefault();
                        this._popUndo();
                    }
                    // Ctrl+C  copy
                    if ((e.ctrlKey || e.metaKey) && e.key === 'c') {
                        const active = this._canvas.getActiveObject();
                        if (active) {
                            e.preventDefault();
                            this._clipboard = this._canvas.toJSON();
                            this._clipboard._copyTarget = { left: active.left, top: active.top, type: active.type, _leType: active._leType };
                            active.clone().then(cloned => { this._clipboard._cloned = cloned; });
                        }
                    }
                    // Ctrl+V  paste
                    if ((e.ctrlKey || e.metaKey) && e.key === 'v') {
                        if (this._clipboard && this._clipboard._cloned) {
                            e.preventDefault();
                            this._clipboard._cloned.clone().then(cloned => {
                                cloned.set({ left: (cloned.left || 0) + 20, top: (cloned.top || 0) + 20 });
                                this._canvas.add(cloned);
                                this._canvas.setActiveObject(cloned);
                                this._canvas.renderAll();
                                this._updateStatus();
                            });
                        }
                    }
                };
                document.addEventListener('keydown', this._keyHandler);
            },

            _unbindKeyboard() {
                if (this._keyHandler) {
                    document.removeEventListener('keydown', this._keyHandler);
                    this._keyHandler = null;
                }
            },

            _pushUndo() {
                if (!this._canvas) return;
                this._undoStack.push(this._canvas.toJSON());
                if (this._undoStack.length > 30) this._undoStack.shift();
            },

            _popUndo() {
                if (!this._canvas || !this._undoStack.length) return;
                const state = this._undoStack.pop();
                this._canvas.loadFromJSON(state).then(() => {
                    this._canvas.renderAll();
                    this._updateStatus();
                });
            },

            initCanvas() {
                if (this._canvas) this._canvas.dispose();
                const canvasEl = document.getElementById('layout-canvas');
                if (!canvasEl) return;
                canvasEl.width = 1280;
                canvasEl.height = 960;
                if (typeof fabric === 'undefined') {
                    console.warn('[LayoutEditor] fabric.js not loaded');
                    return;
                }
                this._canvas = new fabric.Canvas('layout-canvas', {
                    width: 1280,
                    height: 960,
                    backgroundColor: '#111',
                    selection: true
                });
                this._canvas.on('selection:created', (e) => this.updateProperties(e.selected?.[0]));
                this._canvas.on('selection:updated', (e) => this.updateProperties(e.selected?.[0]));
                this._canvas.on('selection:cleared', () => this.updateProperties(null));
                this._canvas.on('object:modified', () => this._updateStatus());
                this._zoom = 1;
                this._updateStatus();
            },

            _bindToolbar() {
                const toolbar = document.querySelector('.layout-editor-toolbar');
                if (!toolbar || toolbar._bound) return;
                toolbar._bound = true;
                toolbar.addEventListener('click', (e) => {
                    const btn = e.target.closest('.le-btn');
                    if (!btn) return;
                    const tool = btn.dataset.tool;
                    const action = btn.dataset.action;

                    if (tool) {
                        toolbar.querySelectorAll('[data-tool]').forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        this._setToolMode(tool);
                    }
                    if (action) {
                        switch (action) {
                            case 'addText': this.addText('Label'); break;
                            case 'addArrow': this.addArrow('right'); break;
                            case 'addGrid': this.addDataGrid(); break;
                            case 'addLabel': this.addText('Intersection Name', { fontSize: 18, fontWeight: 'bold' }); break;
                            case 'addCompass': this.addCompass(); break;
                            case 'addLegend': this.addLegend(); break;
                            case 'loadAerial': this.loadAerial(); break;
                            case 'zoomIn': this.setZoom(this._zoom * 1.2); break;
                            case 'zoomOut': this.setZoom(this._zoom / 1.2); break;
                            case 'zoomFit': this.setZoom(1); break;
                            case 'saveLayout': this.saveLayout(); showNotification('Layout saved', 'success'); break;
                            case 'exportPNG': this.exportPNG(); break;
                            case 'deleteObj': this._deleteSelected(); break;
                            case 'close': this.close(); break;
                        }
                    }
                });
                document.getElementById('le-snap')?.addEventListener('change', (e) => {
                    this._snap = e.target.checked;
                });
            },

            _activeTool: 'select',
            _isPanning: false,
            _panLastPos: null,

            _setToolMode(tool) {
                this._activeTool = tool;
                if (!this._canvas) return;
                if (tool === 'pan') {
                    this._canvas.selection = false;
                    this._canvas.defaultCursor = 'grab';
                    this._canvas.getObjects().forEach(o => { o._wasSelectable = o.selectable; o.selectable = false; });
                    this._canvas.discardActiveObject();
                    this._canvas.renderAll();
                    if (!this._canvas._panBound) {
                        this._canvas._panBound = true;
                        this._canvas.on('mouse:down', (opt) => {
                            if (this._activeTool !== 'pan') return;
                            this._isPanning = true;
                            this._panLastPos = { x: opt.e.clientX, y: opt.e.clientY };
                            this._canvas.defaultCursor = 'grabbing';
                        });
                        this._canvas.on('mouse:move', (opt) => {
                            if (!this._isPanning || this._activeTool !== 'pan') return;
                            const dx = opt.e.clientX - this._panLastPos.x;
                            const dy = opt.e.clientY - this._panLastPos.y;
                            const vpt = this._canvas.viewportTransform;
                            vpt[4] += dx;
                            vpt[5] += dy;
                            this._canvas.requestRenderAll();
                            this._panLastPos = { x: opt.e.clientX, y: opt.e.clientY };
                        });
                        this._canvas.on('mouse:up', () => {
                            if (this._activeTool !== 'pan') return;
                            this._isPanning = false;
                            this._canvas.defaultCursor = 'grab';
                        });
                    }
                } else {
                    this._canvas.selection = true;
                    this._canvas.defaultCursor = 'default';
                    this._canvas.getObjects().forEach(o => {
                        if (o._wasSelectable !== undefined) { o.selectable = o._wasSelectable; delete o._wasSelectable; }
                    });
                    this._isPanning = false;
                }
            },

            async loadAerial() {
                if (!this._canvas) return;
                const projectId = TseWorkflow._activeProjectId;
                if (!projectId) return;
                const aerial = await AerialFetch.getProjectAerial(projectId);
                if (!aerial) {
                    showNotification('No aerial image found  fetch one in Step 1 first', 'warning');
                    return;
                }
                const img = new Image();
                img.onload = () => {
                    const fImg = new fabric.FabricImage(img, { selectable: false, evented: false });
                    fImg.scaleToWidth(1280);
                    this._canvas.backgroundImage = fImg;
                    this._canvas.renderAll();
                    showNotification('Aerial loaded as background', 'success');
                };
                img.src = aerial.data;
            },

            addText(text, opts) {
                if (!this._canvas) return;
                const t = new fabric.FabricText(text || 'Text', {
                    left: 100 + Math.random() * 200,
                    top: 100 + Math.random() * 200,
                    fontSize: opts?.fontSize || 14,
                    fontWeight: opts?.fontWeight || 'normal',
                    fill: '#ffffff',
                    fontFamily: 'Arial',
                    ...opts
                });
                this._canvas.add(t);
                this._canvas.setActiveObject(t);
                this._updateStatus();
            },

            addArrow(direction) {
                if (!this._canvas) return;
                const dirs = {
                    right: [0, 0, 80, 0], left: [80, 0, 0, 0],
                    up: [0, 80, 0, 0], down: [0, 0, 0, 80],
                    ne: [0, 60, 60, 0], nw: [60, 60, 0, 0],
                    se: [0, 0, 60, 60], sw: [60, 0, 0, 60]
                };
                const [x1, y1, x2, y2] = dirs[direction] || dirs.right;

                const line = new fabric.Line([x1, y1, x2, y2], {
                    stroke: '#00ff00',
                    strokeWidth: 3,
                    selectable: false,
                    evented: false
                });

                const angle = Math.atan2(y2 - y1, x2 - x1) * 180 / Math.PI;
                const triangle = new fabric.Triangle({
                    width: 14, height: 14,
                    fill: '#00ff00',
                    left: x2, top: y2,
                    angle: angle + 90,
                    originX: 'center',
                    originY: 'center',
                    selectable: false,
                    evented: false
                });

                const group = new fabric.Group([line, triangle], {
                    left: 200 + Math.random() * 400,
                    top: 200 + Math.random() * 400
                });
                group._leType = 'arrow';
                this._canvas.add(group);
                this._canvas.setActiveObject(group);
                this._updateStatus();
            },

            addDataGrid(data) {
                if (!this._canvas) return;
                const tmcData = data || this._getDefaultTmcData();
                const group = TmcGridBuilder.build(tmcData);
                group.set({ left: 200, top: 200 });
                this._canvas.add(group);
                this._canvas.setActiveObject(group);
                this._updateStatus();
            },

            _getDefaultTmcData() {
                // Pull from stepData[2] if available
                const sd = TseWorkflow._activeProject?.stepData?.[2];
                if (sd && sd.intersections && sd.intersections.length) {
                    return sd.intersections[0];
                }
                return {
                    name: 'Intersection',
                    approaches: {
                        NB: { L: 0, T: 0, R: 0 },
                        SB: { L: 0, T: 0, R: 0 },
                        EB: { L: 0, T: 0, R: 0 },
                        WB: { L: 0, T: 0, R: 0 }
                    }
                };
            },

            addLegend() {
                if (!this._canvas) return;
                const items = [
                    { color: '#ff0000', label: 'AM Peak' },
                    { color: '#0088ff', label: 'PM Peak' },
                    { color: '#00ff00', label: 'Site Traffic' }
                ];
                const parts = [];
                const bgRect = new fabric.Rect({
                    width: 140, height: 20 + items.length * 22,
                    fill: 'rgba(0,0,0,0.75)', rx: 4, ry: 4,
                    selectable: false, evented: false
                });
                parts.push(bgRect);
                const title = new fabric.FabricText('Legend', {
                    left: 10, top: 6, fontSize: 11, fill: '#ffffff',
                    fontWeight: 'bold', fontFamily: 'Arial',
                    selectable: false, evented: false
                });
                parts.push(title);
                items.forEach((item, i) => {
                    parts.push(new fabric.Rect({
                        left: 10, top: 24 + i * 22, width: 12, height: 12,
                        fill: item.color, selectable: false, evented: false
                    }));
                    parts.push(new fabric.FabricText(item.label, {
                        left: 28, top: 23 + i * 22, fontSize: 11,
                        fill: '#ffffff', fontFamily: 'Arial',
                        selectable: false, evented: false
                    }));
                });
                const group = new fabric.Group(parts, { left: 50, top: 50 });
                group._leType = 'legend';
                this._canvas.add(group);
                this._canvas.setActiveObject(group);
                this._updateStatus();
            },

            addCompass() {
                if (!this._canvas) return;
                const parts = [];
                // Circle background
                parts.push(new fabric.Circle({
                    radius: 20, fill: 'rgba(0,0,0,0.6)',
                    stroke: '#ffffff', strokeWidth: 1,
                    originX: 'center', originY: 'center',
                    selectable: false, evented: false
                }));
                // North arrow
                parts.push(new fabric.Triangle({
                    width: 12, height: 20, fill: '#ff0000',
                    left: 0, top: -16, originX: 'center', originY: 'center',
                    selectable: false, evented: false
                }));
                // N label
                parts.push(new fabric.FabricText('N', {
                    fontSize: 10, fill: '#ffffff', fontWeight: 'bold',
                    fontFamily: 'Arial', originX: 'center', originY: 'center',
                    left: 0, top: -2,
                    selectable: false, evented: false
                }));
                const group = new fabric.Group(parts, { left: 1200, top: 50 });
                group._leType = 'compass';
                this._canvas.add(group);
                this._canvas.setActiveObject(group);
                this._updateStatus();
            },

            saveLayout() {
                if (!this._canvas || !this._exhibitId) return;
                const project = TseWorkflow._activeProject;
                if (!project) return;
                if (!project.stepData[9]) project.stepData[9] = {};
                if (!project.stepData[9].exhibitLayouts) project.stepData[9].exhibitLayouts = {};
                project.stepData[9].exhibitLayouts[this._exhibitId] = this._canvas.toJSON();
                ProjectStore.saveProject(project);
            },

            loadLayout(json) {
                if (!this._canvas || !json) return;
                this._canvas.loadFromJSON(json).then(() => {
                    this._canvas.renderAll();
                    this._updateStatus();
                });
            },

            exportPNG() {
                if (!this._canvas) return;
                const dataUrl = this._canvas.toDataURL({ format: 'png', multiplier: 1 });
                const a = document.createElement('a');
                a.href = dataUrl;
                a.download = (this._exhibitTitle || 'exhibit') + '.png';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            },

            setZoom(level) {
                if (!this._canvas) return;
                this._zoom = Math.min(2, Math.max(0.5, level));
                this._canvas.setZoom(this._zoom);
                this._canvas.setDimensions({
                    width: 1280 * this._zoom,
                    height: 960 * this._zoom
                });
                document.getElementById('le-zoom-level').textContent = Math.round(this._zoom * 100);
            },

            updateProperties(obj) {
                const container = document.getElementById('layout-props-content');
                if (!container) return;
                if (!obj) {
                    container.innerHTML = '<p style="color:var(--text-muted);font-size:12px;">Select an object to edit properties</p>';
                    return;
                }
                const leType = obj._leType || '';
                const typeLabel = leType || obj.type || 'object';
                let html = '';
                html += '<label>Type</label><input type="text" value="' + typeLabel + '" disabled>';
                html += '<label>Left</label><input type="number" data-prop="left" value="' + Math.round(obj.left) + '">';
                html += '<label>Top</label><input type="number" data-prop="top" value="' + Math.round(obj.top) + '">';

                if (obj.type === 'text') {
                    html += '<label>Text</label><input type="text" data-prop="text" value="' + (obj.text || '') + '">';
                    html += '<label>Font Size</label><input type="number" data-prop="fontSize" value="' + (obj.fontSize || 14) + '">';
                    html += '<label>Fill</label><input type="color" data-prop="fill" value="' + (obj.fill || '#ffffff') + '">';
                }

                if (leType === 'arrow') {
                    html += '<label>Direction</label><select data-action="arrowDir">';
                    ['right','left','up','down','ne','nw','se','sw'].forEach(d => { html += '<option value="' + d + '">' + d.toUpperCase() + '</option>'; });
                    html += '</select>';
                    const arrowColor = obj.getObjects?.()[0]?.stroke || '#00ff00';
                    html += '<label>Color</label><input type="color" data-action="arrowColor" value="' + arrowColor + '">';
                    html += '<label>Stroke Width</label><input type="number" data-action="arrowStroke" value="3" min="1" max="10">';
                }

                if (leType === 'legend') {
                    html += '<hr style="border-color:#333;margin:8px 0;">';
                    html += '<label style="color:var(--gold);">Legend Items</label>';
                    const items = obj.getObjects?.() || [];
                    let itemIdx = 0;
                    for (let i = 0; i < items.length; i++) {
                        if (items[i].type === 'rect' && i + 1 < items.length && items[i + 1].type === 'text' && i > 1) {
                            html += '<div style="display:flex;gap:4px;align-items:center;margin-bottom:4px;">';
                            html += '<input type="color" data-action="legendColor" data-idx="' + i + '" value="' + (items[i].fill || '#ff0000') + '" style="width:30px;padding:1px;">';
                            html += '<input type="text" data-action="legendLabel" data-idx="' + (i + 1) + '" value="' + (items[i + 1].text || '') + '" style="flex:1;">';
                            html += '</div>';
                            itemIdx++;
                        }
                    }
                }

                if (leType === 'compass') {
                    html += '<label>Rotation</label><input type="number" data-prop="angle" value="' + Math.round(obj.angle || 0) + '" min="0" max="360" step="5">';
                    html += '<label>Scale</label><input type="range" data-prop="scaleX" min="0.5" max="3" step="0.1" value="' + (obj.scaleX || 1) + '">';
                }

                if (leType === 'tmcGrid') {
                    html += '<label>Scale</label><input type="range" data-prop="scaleX" min="0.5" max="3" step="0.1" value="' + (obj.scaleX || 1) + '">';
                }

                html += '<label>Angle</label><input type="number" data-prop="angle" value="' + Math.round(obj.angle || 0) + '">';
                html += '<label>Opacity</label><input type="range" data-prop="opacity" min="0" max="1" step="0.1" value="' + (obj.opacity || 1) + '">';
                container.innerHTML = html;

                // Standard property inputs
                container.querySelectorAll('input[data-prop], select[data-prop]').forEach(inp => {
                    inp.addEventListener('change', () => {
                        const prop = inp.dataset.prop;
                        let val = inp.value;
                        if (inp.type === 'number' || inp.type === 'range') val = parseFloat(val);
                        obj.set(prop, val);
                        if (prop === 'scaleX') obj.set('scaleY', val);
                        this._canvas.renderAll();
                    });
                });

                // Arrow-specific actions
                container.querySelector('[data-action="arrowDir"]')?.addEventListener('change', (e) => {
                    const pos = { left: obj.left, top: obj.top };
                    this._canvas.remove(obj);
                    this.addArrow(e.target.value);
                    const newest = this._canvas.getObjects().slice(-1)[0];
                    if (newest) newest.set(pos);
                    this._canvas.renderAll();
                });
                container.querySelector('[data-action="arrowColor"]')?.addEventListener('change', (e) => {
                    const color = e.target.value;
                    (obj.getObjects?.() || []).forEach(child => {
                        if (child.stroke) child.set('stroke', color);
                        if (child.fill && child.type === 'triangle') child.set('fill', color);
                    });
                    this._canvas.renderAll();
                });
                container.querySelector('[data-action="arrowStroke"]')?.addEventListener('change', (e) => {
                    (obj.getObjects?.() || []).forEach(child => {
                        if (child.type === 'line') child.set('strokeWidth', parseFloat(e.target.value));
                    });
                    this._canvas.renderAll();
                });

                // Legend-specific actions
                container.querySelectorAll('[data-action="legendColor"]').forEach(inp => {
                    inp.addEventListener('change', () => {
                        const items = obj.getObjects?.() || [];
                        const idx = parseInt(inp.dataset.idx);
                        if (items[idx]) { items[idx].set('fill', inp.value); this._canvas.renderAll(); }
                    });
                });
                container.querySelectorAll('[data-action="legendLabel"]').forEach(inp => {
                    inp.addEventListener('change', () => {
                        const items = obj.getObjects?.() || [];
                        const idx = parseInt(inp.dataset.idx);
                        if (items[idx]) { items[idx].set('text', inp.value); this._canvas.renderAll(); }
                    });
                });

                this._updateLayers();
            },

            _updateLayers() {
                const el = document.getElementById('layout-layers-list');
                if (!el || !this._canvas) return;
                const objs = this._canvas.getObjects();
                if (!objs.length) { el.innerHTML = '<div style="color:var(--text-muted);font-size:11px;">No objects</div>'; return; }
                const active = this._canvas.getActiveObject();
                el.innerHTML = objs.map((o, i) => {
                    const isActive = o === active;
                    const label = o._leType || o.type || 'obj';
                    const hidden = o.visible === false;
                    const locked = !o.selectable;
                    return '<div class="le-layer-row" data-layer-idx="' + i + '" style="display:flex;align-items:center;gap:4px;padding:3px 4px;border-bottom:1px solid #222;cursor:pointer;'
                        + (isActive ? 'background:rgba(0,102,204,0.2);border-left:2px solid var(--blue);' : '')
                        + (hidden ? 'opacity:0.4;' : '') + '">'
                        + '<span style="flex:1;font-size:11px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">' + (i + 1) + '. ' + label + '</span>'
                        + '<button data-layer-action="visibility" data-idx="' + i + '" title="Toggle visibility" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:11px;padding:0 2px;">' + (hidden ? '&#10005;' : '&#9673;') + '</button>'
                        + '<button data-layer-action="lock" data-idx="' + i + '" title="Toggle lock" style="background:none;border:none;color:' + (locked ? 'var(--gold)' : 'var(--text-muted)') + ';cursor:pointer;font-size:11px;padding:0 2px;">' + (locked ? '&#128274;' : '&#128275;') + '</button>'
                        + '<button data-layer-action="up" data-idx="' + i + '" title="Bring forward" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:10px;padding:0 2px;">&#9650;</button>'
                        + '<button data-layer-action="down" data-idx="' + i + '" title="Send back" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:10px;padding:0 2px;">&#9660;</button>'
                        + '</div>';
                }).join('');

                el.querySelectorAll('.le-layer-row').forEach(row => {
                    row.addEventListener('click', (e) => {
                        if (e.target.closest('button')) return;
                        const idx = parseInt(row.dataset.layerIdx);
                        const obj = objs[idx];
                        if (obj && obj.selectable !== false) {
                            this._canvas.setActiveObject(obj);
                            this._canvas.renderAll();
                            this.updateProperties(obj);
                        }
                    });
                });

                el.querySelectorAll('[data-layer-action]').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const idx = parseInt(btn.dataset.idx);
                        const obj = objs[idx];
                        if (!obj) return;
                        switch (btn.dataset.layerAction) {
                            case 'visibility':
                                obj.set('visible', obj.visible === false ? true : false);
                                break;
                            case 'lock':
                                obj.set({ selectable: !obj.selectable, evented: !obj.evented });
                                break;
                            case 'up':
                                this._canvas.bringObjectForward(obj);
                                break;
                            case 'down':
                                this._canvas.sendObjectBackwards(obj);
                                break;
                        }
                        this._canvas.discardActiveObject();
                        this._canvas.renderAll();
                        this._updateLayers();
                    });
                });
            },

            _deleteSelected() {
                if (!this._canvas) return;
                const active = this._canvas.getActiveObjects();
                if (active.length) {
                    active.forEach(obj => this._canvas.remove(obj));
                    this._canvas.discardActiveObject();
                    this._canvas.renderAll();
                    this._updateStatus();
                }
            },

            _updateStatus() {
                if (!this._canvas) return;
                document.getElementById('le-obj-count').textContent = this._canvas.getObjects().length;
                document.getElementById('le-zoom-level').textContent = Math.round(this._zoom * 100);
                this._updateLayers();
            }
        };

        // ==================== TMC DATA GRID BUILDER ====================
        const TmcGridBuilder = {
            build(intersectionData) {
                const approaches = intersectionData?.approaches || {
                    NB: { L: 0, T: 0, R: 0 },
                    SB: { L: 0, T: 0, R: 0 },
                    EB: { L: 0, T: 0, R: 0 },
                    WB: { L: 0, T: 0, R: 0 }
                };
                const cellW = 40, cellH = 18, pad = 4;
                const parts = [];

                // Title
                const title = new fabric.FabricText(intersectionData?.name || 'TMC Grid', {
                    fontSize: 12, fill: '#ffffff', fontWeight: 'bold',
                    fontFamily: 'Arial', left: 0, top: 0,
                    selectable: false, evented: false
                });
                parts.push(title);

                // Header row
                const headers = ['Dir', 'L', 'T', 'R'];
                headers.forEach((h, i) => {
                    parts.push(new fabric.Rect({
                        left: i * cellW, top: 20, width: cellW, height: cellH,
                        fill: '#1a3a5c', stroke: '#4a90d9', strokeWidth: 1,
                        selectable: false, evented: false
                    }));
                    parts.push(new fabric.FabricText(h, {
                        left: i * cellW + pad, top: 22, fontSize: 10,
                        fill: '#ffffff', fontFamily: 'Arial',
                        selectable: false, evented: false
                    }));
                });

                // Data rows
                const dirs = ['NB', 'SB', 'EB', 'WB'];
                dirs.forEach((dir, row) => {
                    const y = 20 + (row + 1) * cellH;
                    const vals = [dir, approaches[dir]?.L || 0, approaches[dir]?.T || 0, approaches[dir]?.R || 0];
                    vals.forEach((v, col) => {
                        parts.push(new fabric.Rect({
                            left: col * cellW, top: y, width: cellW, height: cellH,
                            fill: col === 0 ? '#1a2a3c' : '#0a0a0a',
                            stroke: '#333', strokeWidth: 1,
                            selectable: false, evented: false
                        }));
                        parts.push(new fabric.FabricText(String(v), {
                            left: col * cellW + pad, top: y + 2, fontSize: 10,
                            fill: col === 0 ? '#4a90d9' : '#ffffff',
                            fontFamily: 'Arial',
                            selectable: false, evented: false
                        }));
                    });
                });

                const group = new fabric.Group(parts);
                group._leType = 'tmcGrid';
                return group;
            }
        };

        // ==================== PPTX GENERATOR ====================
        const PptxGenerator = {
            async generateDeck(project) {
                if (typeof PptxGenJS === 'undefined') {
                    showNotification('PptxGenJS library not loaded', 'error');
                    return;
                }
                const pptx = new PptxGenJS();
                pptx.defineLayout({ name: 'WIDE', width: 13.33, height: 7.5 });
                pptx.layout = 'WIDE';

                this.addTitleSlide(pptx, project);
                this.addSummarySlide(pptx, project);

                // Add exhibit slides
                const layouts = project.stepData?.[9]?.exhibitLayouts || {};
                const exhibits = project.stepData?.[9]?.exhibits || [];
                for (const exhibit of exhibits) {
                    const layout = layouts[exhibit.figNum] || layouts[exhibit.title];
                    this.addExhibitSlide(pptx, exhibit, layout);
                }

                await this.downloadDeck(pptx, (project.name || 'TIA_Report') + '.pptx');
            },

            addTitleSlide(pptx, project) {
                const slide = pptx.addSlide();
                slide.background = { color: '0a0a0a' };
                slide.addText('TRAJANUS USA', {
                    x: 0.5, y: 0.5, w: 12, h: 0.6,
                    fontSize: 16, color: 'C0C0C0', bold: true,
                    fontFace: 'Arial'
                });
                slide.addText('Engineered Intelligence', {
                    x: 0.5, y: 1.0, w: 12, h: 0.4,
                    fontSize: 12, color: '4A90D9', italic: true,
                    fontFace: 'Arial'
                });
                slide.addText(project.name || 'Traffic Impact Analysis', {
                    x: 0.5, y: 2.5, w: 12, h: 1,
                    fontSize: 36, color: 'FFFFFF', bold: true,
                    fontFace: 'Arial'
                });
                slide.addText([
                    { text: 'Client: ', options: { color: '888888' } },
                    { text: project.client || '', options: { color: 'FFFFFF' } }
                ], { x: 0.5, y: 4.0, w: 12, h: 0.4, fontSize: 14, fontFace: 'Arial' });
                slide.addText([
                    { text: 'Date: ', options: { color: '888888' } },
                    { text: new Date().toLocaleDateString(), options: { color: 'FFFFFF' } }
                ], { x: 0.5, y: 4.5, w: 12, h: 0.4, fontSize: 14, fontFace: 'Arial' });
                // Blue bottom border
                slide.addShape(pptx.shapes.RECTANGLE, {
                    x: 0, y: 7.2, w: 13.33, h: 0.05, fill: { color: '0066CC' }
                });
            },

            addExhibitSlide(pptx, exhibit, layout) {
                const slide = pptx.addSlide();
                slide.background = { color: '0a0a0a' };
                const exLabel = (exhibit.figNum ? 'Figure ' + exhibit.figNum + ': ' : '') + (exhibit.title || '');
                slide.addText(exLabel, {
                    x: 0.5, y: 0.3, w: 12, h: 0.5,
                    fontSize: 18, color: 'FFFFFF', bold: true,
                    fontFace: 'Arial'
                });

                if (layout && layout.objects) {
                    this.fabricToSlide(pptx, slide, layout);
                } else {
                    slide.addText('No layout data  create in Layout Editor', {
                        x: 2, y: 3, w: 9, h: 1,
                        fontSize: 14, color: '888888', align: 'center',
                        fontFace: 'Arial'
                    });
                }
                // Blue bottom border
                slide.addShape(pptx.shapes.RECTANGLE, {
                    x: 0, y: 7.2, w: 13.33, h: 0.05, fill: { color: '0066CC' }
                });
            },

            addSummarySlide(pptx, project) {
                const slide = pptx.addSlide();
                slide.background = { color: '0a0a0a' };
                slide.addText('Project Summary', {
                    x: 0.5, y: 0.3, w: 12, h: 0.5,
                    fontSize: 24, color: 'FFFFFF', bold: true,
                    fontFace: 'Arial'
                });

                const rows = [
                    ['Project', project.name || ''],
                    ['Address', project.address || ''],
                    ['Jurisdiction', project.jurisdiction || ''],
                    ['Opening Year', project.openingYear || ''],
                    ['Horizon Year', project.horizonYear || ''],
                    ['Growth Rate', (project.growthRate || '') + '%']
                ];

                rows.forEach((row, i) => {
                    slide.addText(row[0] + ':', {
                        x: 1, y: 1.2 + i * 0.5, w: 3, h: 0.4,
                        fontSize: 14, color: '888888', fontFace: 'Arial'
                    });
                    slide.addText(row[1], {
                        x: 4, y: 1.2 + i * 0.5, w: 8, h: 0.4,
                        fontSize: 14, color: 'FFFFFF', fontFace: 'Arial'
                    });
                });

                // Trip generation summary if available
                const tripData = project.stepData?.[3];
                if (tripData && tripData.totalTrips) {
                    slide.addText('Trip Generation: ' + tripData.totalTrips + ' total trips', {
                        x: 1, y: 5, w: 11, h: 0.4,
                        fontSize: 14, color: '4A90D9', fontFace: 'Arial'
                    });
                }

                slide.addShape(pptx.shapes.RECTANGLE, {
                    x: 0, y: 7.2, w: 13.33, h: 0.05, fill: { color: '0066CC' }
                });
            },

            fabricToSlide(pptx, slide, canvasJSON) {
                if (!canvasJSON || !canvasJSON.objects) return;
                // Canvas 1280px = 10 inches, offset by 1.5 for margins
                const scale = 10 / 1280;
                const xOff = 1.5;
                const yOff = 1;

                // If background image exists, add it
                if (canvasJSON.backgroundImage && canvasJSON.backgroundImage.src) {
                    slide.addImage({
                        data: canvasJSON.backgroundImage.src,
                        x: xOff, y: yOff, w: 10, h: 7.5 * (960/1280)
                    });
                }

                canvasJSON.objects.forEach(obj => {
                    const x = (obj.left || 0) * scale + xOff;
                    const y = (obj.top || 0) * scale + yOff;

                    if (obj.type === 'text') {
                        slide.addText(obj.text || '', {
                            x, y, w: 3, h: 0.4,
                            fontSize: Math.round((obj.fontSize || 14) * 0.75),
                            color: (obj.fill || '#ffffff').replace('#', ''),
                            fontFace: obj.fontFamily || 'Arial',
                            bold: obj.fontWeight === 'bold',
                            rotate: obj.angle || 0
                        });
                    } else if (obj.type === 'group') {
                        // Rasterize group to image and embed in slide
                        const w = (obj.width || 100) * (obj.scaleX || 1) * scale;
                        const h = (obj.height || 100) * (obj.scaleY || 1) * scale;
                        try {
                            const tmpCanvas = document.createElement('canvas');
                            const groupW = (obj.width || 100) * (obj.scaleX || 1);
                            const groupH = (obj.height || 100) * (obj.scaleY || 1);
                            tmpCanvas.width = groupW * 2;
                            tmpCanvas.height = groupH * 2;
                            const tmpFabric = new fabric.StaticCanvas(tmpCanvas, {
                                width: groupW * 2, height: groupH * 2, backgroundColor: null
                            });
                            const cloned = fabric.util.object.clone(obj);
                            cloned.set({ left: groupW, top: groupH, originX: 'center', originY: 'center' });
                            tmpFabric.add(cloned);
                            tmpFabric.renderAll();
                            const dataUrl = tmpCanvas.toDataURL('image/png');
                            slide.addImage({
                                data: dataUrl,
                                x, y, w, h,
                                rotate: obj.angle || 0
                            });
                            tmpFabric.dispose();
                        } catch (e) {
                            console.warn('[fabricToSlide] Group rasterize failed:', e);
                            slide.addShape(pptx.shapes.RECTANGLE, {
                                x, y, w, h,
                                fill: { color: '1a1a1a', transparency: 80 },
                                line: { color: '4A90D9', width: 0.5 }
                            });
                        }
                    }
                });
            },

            async downloadDeck(pptx, filename) {
                try {
                    const blob = await pptx.write({ outputType: 'blob' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    showNotification('PPTX downloaded: ' + filename, 'success');
                } catch (e) {
                    console.error('[PptxGenerator]', e);
                    showNotification('PPTX generation failed: ' + e.message, 'error');
                }
            }
        };

        // ==================== INTRODUCTION TOGGLE ====================
        function toggleIntro() {
            const content = document.getElementById('intro-content');
            const toggle = document.getElementById('intro-toggle');
            if (content && toggle) {
                content.classList.toggle('collapsed');
                toggle.classList.toggle('collapsed');
                toggle.textContent = content.classList.contains('collapsed') ? '' : '';
            }
        }

        // ==================== PLATFORM GUIDANCE ====================
        function toggleGuidance() {
            const content = document.getElementById('guidance-content');
            const toggle = document.getElementById('guidance-toggle');
            if (content && toggle) {
                content.classList.toggle('collapsed');
                toggle.classList.toggle('collapsed');
                toggle.textContent = content.classList.contains('collapsed') ? '' : '';
            }
        }

        function scrollToAssistant() {
            const chatSection = document.querySelector('.chat-section');
            if (chatSection) {
                chatSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
                // Focus the input after scrolling
                setTimeout(() => {
                    const chatInput = document.getElementById('chat-input');
                    if (chatInput) chatInput.focus();
                }, 500);
            }
        }

        function launchAgentRunner() {
            // Launch the Agent Runner tool from toolkits
            if (window.__TAURI__) {
                window.__TAURI__.core.invoke('open_path', {
                    path: 'G:\\My Drive\\00 - Trajanus USA\\00-Command-Center\\05-Scripts\\AGENT_RUNNER_TOOL.py'
                }).catch(err => {
                    showNotification('Could not launch Agent Runner: ' + err, 'warning');
                });
            } else {
                // Fallback for browser - show info
                showNotification('Agent Runner available in desktop app', 'info');
            }
        }

        function toggleClaudeEmbed() {
            const container = document.getElementById('claude-embed-container');
            if (container) {
                container.classList.toggle('active');
            }
        }

        function openClaudePrime() {
            window.open('https://claude.ai', '_blank');
        }

        // Decision card click handlers
        document.addEventListener('DOMContentLoaded', function() {
            const decisionCards = document.querySelectorAll('.decision-card');
            decisionCards.forEach(card => {
                card.addEventListener('click', function() {
                    const action = this.dataset.action;
                    decisionCards.forEach(c => c.classList.remove('selected'));
                    this.classList.add('selected');

                    switch(action) {
                        case 'new-study':
                            document.getElementById('new-project-btn')?.click();
                            break;
                        case 'continue-study':
                            document.getElementById('project-select')?.focus();
                            break;
                        case 'research':
                            document.getElementById('chat-input')?.focus();
                            break;
                        case 'templates':
                            const docsSection = document.querySelector('[data-section="documents"]');
                            if (docsSection) docsSection.scrollIntoView({ behavior: 'smooth' });
                            break;
                    }
                });
            });
        });

        // ==================== TRAJANUS WINDOW SYSTEM ====================
        const TrajnausWindow = {
            currentWindow: null,

            open(title, content, options = {}) {
                this.close();
                const overlay = document.createElement('div');
                overlay.className = 'trajanus-window-overlay';
                overlay.onclick = (e) => {
                    if (e.target === overlay) this.close();
                };

                const window = document.createElement('div');
                window.className = 'trajanus-window';
                window.innerHTML = `
                    <div class="trajanus-window-header">
                        <span class="trajanus-window-title">${title}</span>
                        <button class="trajanus-window-close" onclick="TrajnausWindow.close()"></button>
                    </div>
                    <div class="trajanus-window-body">${content}</div>
                `;

                overlay.appendChild(window);
                document.body.appendChild(overlay);
                this.currentWindow = overlay;
                return overlay;
            },

            close() {
                if (this.currentWindow) {
                    this.currentWindow.remove();
                    this.currentWindow = null;
                }
            }
        };

        // ==================== TERMINAL ====================
        const Terminal = {
            output(message, type = 'info') {
                const terminal = document.getElementById('terminal-output');
                const line = document.createElement('div');
                line.className = `terminal-line ${type}`;
                const timestamp = new Date().toLocaleTimeString();
                line.innerHTML = `<span style="color: #606060;">[${timestamp}]</span> ${message}`;
                terminal.appendChild(line);
                terminal.scrollTop = terminal.scrollHeight;
            },

            clear() {
                const terminal = document.getElementById('terminal-output');
                terminal.innerHTML = '<div style="color: #808080;">Terminal cleared.</div>';
            },

            error(message) { this.output(message, 'error'); },
            success(message) { this.output(message, 'success'); },
            warning(message) { this.output(message, 'warning'); },
            info(message) { this.output(message, 'info'); }
        };

        // ==================== APPS MODULE ====================
        const Apps = {
            commands: {
                'synchro': 'C:\\Program Files\\Trafficware\\Synchro\\Synchro.exe',
                'hcs': 'C:\\Program Files\\McTrans\\HCS 7\\HCS.exe',
                'autocad': 'C:\\Program Files\\Autodesk\\AutoCAD 2024\\acad.exe',
                'word': 'winword', 'excel': 'excel', 'powerpoint': 'powerpnt',
                'outlook': 'outlook', 'onenote': 'onenote', 'chrome': 'chrome',
                'edge': 'msedge', 'explorer': 'G:\\My Drive\\00 - Trajanus USA',
                'terminal': 'wt'
            },
            webUrls: {
                'word': 'https://office.live.com/start/word.aspx',
                'excel': 'https://office.live.com/start/excel.aspx',
                'powerpoint': 'https://office.live.com/start/powerpoint.aspx',
                'onenote': 'https://www.onenote.com/notebooks',
                'outlook': 'https://outlook.live.com',
                'chrome': 'https://google.com', 'edge': 'https://bing.com'
            },

            async launch(appKey) {
                Terminal.info(`Launching: ${appKey}`);
                const invoke = getInvoke();

                if (!invoke) {
                    if (this.webUrls[appKey]) {
                        window.open(this.webUrls[appKey], '_blank');
                        Terminal.success(`Opened ${appKey} in browser`);
                        showNotification(`Opening ${appKey} in browser...`, 'info');
                    } else {
                        Terminal.warning(`${appKey} requires the desktop app`);
                        showNotification(`${appKey} requires the desktop app`, 'warning');
                    }
                    return;
                }

                try {
                    await invoke('open_path', { path: this.commands[appKey] });
                    Terminal.success(`Launched ${appKey}`);
                    showNotification(`Launched ${appKey}`, 'success');
                } catch (e) {
                    Terminal.error(`Failed to launch ${appKey}: ${e}`);
                    if (this.webUrls[appKey]) {
                        window.open(this.webUrls[appKey], '_blank');
                        Terminal.info(`Fallback: Opened ${appKey} in browser`);
                    }
                }
            }
        };

        // ==================== SCRIPTS MODULE ====================
        const Scripts = {
            scripts: {
                'trip-generation': { name: 'Trip Generation Calculator', file: 'trip_generation.py' },
                'los-worksheet': { name: 'LOS Worksheet', file: 'los_worksheet.py' },
                'signal-timing': { name: 'Signal Timing Optimizer', file: 'signal_timing.py' },
                'tia-template': { name: 'TIA Report Template', file: 'tia_template.py' }
            },

            async run(scriptId) {
                const script = this.scripts[scriptId] || { name: scriptId, file: scriptId };
                Terminal.info(`Starting: ${script.name}`);
                showNotification(`Running ${script.name}...`, 'info');

                const invoke = getInvoke();
                if (!invoke) {
                    Terminal.warning(`[Browser Mode] Cannot execute ${script.name} - requires desktop app`);
                    Chat.addMessage('assistant', `${script.name} requires the desktop app to run.`);
                    return;
                }

                try {
                    const result = await invoke('run_python_script', {
                        scriptPath: SCRIPTS_PATH + script.file,
                        targetPath: ''
                    });
                    Terminal.success(`Completed: ${script.name}`);
                    if (result) Terminal.output(result);
                } catch (e) {
                    Terminal.error(`Error in ${script.name}: ${e}`);
                }
            }
        };

        // ==================== DOCUMENTS MODULE ====================
        const Documents = {
            docs: {
                'ite-trip-gen': { title: 'ITE Trip Generation Manual', path: 'G:\\My Drive\\00 - Trajanus USA\\Reference\\ITE' },
                'hcm': { title: 'Highway Capacity Manual', path: 'G:\\My Drive\\00 - Trajanus USA\\Reference\\HCM' },
                'mutcd': { title: 'MUTCD', path: 'G:\\My Drive\\00 - Trajanus USA\\Reference\\MUTCD' },
                'fdot-los': { title: 'FDOT Quality/LOS Manual', path: 'G:\\My Drive\\00 - Trajanus USA\\Reference\\FDOT' },
                'fdot-design': { title: 'FDOT Design Manual', path: 'G:\\My Drive\\00 - Trajanus USA\\Reference\\FDOT' },
                'alachua-std': { title: 'Alachua County Standards', path: 'G:\\My Drive\\00 - Trajanus USA\\Reference\\Local' },
                'traffic-counts': { title: 'Traffic Counts', path: 'G:\\My Drive\\00 - Trajanus USA\\Traffic\\Counts' },
                'site-plan': { title: 'Site Plan', path: 'G:\\My Drive\\00 - Trajanus USA\\Traffic\\Plans' },
                'existing-conditions': { title: 'Existing Conditions', path: 'G:\\My Drive\\00 - Trajanus USA\\Traffic\\Existing' },
                'synchro-model': { title: 'Synchro Model', path: 'G:\\My Drive\\00 - Trajanus USA\\Traffic\\Synchro' }
            },

            async open(docId) {
                const doc = this.docs[docId] || { title: docId, path: '' };
                Terminal.info(`Opening document: ${doc.title}`);
                showNotification(`Opening ${doc.title}...`, 'info');

                const invoke = getInvoke();
                if (!invoke) {
                    TrajnausWindow.open(doc.title, `
                        <p style="color: #b0b0b0; margin-bottom: 20px;">Document location:</p>
                        <code style="background: #2d2d2d; padding: 10px; display: block; border-radius: 4px; color: #c0c0c0;">${doc.path}</code>
                        <p style="color: #808080; margin-top: 20px; font-size: 13px;">
                            [Browser Mode] Opening folders requires the desktop app.
                        </p>
                    `);
                    return;
                }

                try {
                    await invoke('open_path', { path: doc.path });
                    Terminal.success(`Opened: ${doc.title}`);
                } catch (e) {
                    Terminal.error(`Failed to open ${doc.title}: ${e}`);
                }
            }
        };

        // ==================== AGENTS MODULE ====================
        const Agents = {
            async activate(agent) {
                Terminal.info(`Activating agent: ${agent}`);
                showNotification(`Activating ${agent}...`, 'success');

                const responses = {
                    'trip-generator': 'Trip Generator agent activated. I can calculate trip generation using ITE 11th Edition rates. Provide your land use type and size, and I\'ll calculate AM/PM peak trips with appropriate adjustments.',
                    'los-analyzer': 'LOS Analyzer agent activated. I can analyze intersection and segment level of service using HCM methodology. Share your traffic data and I\'ll calculate delay and LOS.',
                    'signal-timer': 'Signal Timer agent activated. I can optimize signal timing and analyze coordination. Provide your intersection geometry and volumes.',
                    'report-writer': 'TIA Report Writer agent activated. I can help generate traffic impact analysis reports in jurisdiction-compliant format. What project are we working on?'
                };

                Chat.addMessage('assistant', responses[agent] || `Agent ${agent} is now active.`);
            }
        };

        // ==================== CHAT MODULE ====================
        const Chat = {
            isProcessing: false,

            addMessage(role, content) {
                const messages = document.getElementById('chat-messages') || document.getElementById('terminal-output');
                if (!messages) return;
                const msg = document.createElement('div');
                msg.className = `chat-message ${role}`;
                msg.textContent = content;
                messages.appendChild(msg);
                messages.scrollTop = messages.scrollHeight;
            },

            showTyping() {
                const messages = document.getElementById('chat-messages') || document.getElementById('terminal-output');
                if (!messages) return;
                const typing = document.createElement('div');
                typing.className = 'typing-indicator';
                typing.id = 'typing-indicator';
                typing.innerHTML = '<span></span><span></span><span></span>';
                messages.appendChild(typing);
                messages.scrollTop = messages.scrollHeight;
            },

            hideTyping() {
                document.getElementById('typing-indicator')?.remove();
            },

            async send() {
                const input = document.getElementById('chat-input');
                const message = input.value.trim();

                if (!message || this.isProcessing) return;

                this.addMessage('user', message);
                input.value = '';
                this.isProcessing = true;

                const invoke = getInvoke();
                if (!invoke) {
                    this.showTyping();
                    setTimeout(() => {
                        this.hideTyping();
                        this.addMessage('assistant', 'I\'m running in browser mode. Full AI capabilities require the desktop app. How can I help you with traffic engineering concepts?');
                        this.isProcessing = false;
                    }, 1500);
                    return;
                }

                this.showTyping();

                try {
                    const context = `You are a Traffic Engineering specialist for traffic impact studies in Arizona.
                    You help with traffic impact analyses, level of service calculations, trip generation using ITE methods,
                    signal timing optimization, and safety assessments.
                    You are familiar with Synchro 12, HCS 7, ADOT Traffic Engineering Guidelines, HCM 7th Edition, and local Arizona jurisdiction standards.
                    Keep responses concise and technically accurate.`;

                    const response = await invoke('chat_with_claude', {
                        message: message,
                        context: context
                    });

                    this.hideTyping();
                    this.addMessage('assistant', response);
                } catch (error) {
                    this.hideTyping();
                    this.addMessage('assistant', 'Error connecting to AI service: ' + error);
                } finally {
                    this.isProcessing = false;
                }
            }
        };

        // ==================== AGENT RUNNER MODULE ====================
        const AgentRunner = {
            isRunning: false,

            async run() {
                if (this.isRunning) return;

                const skill = document.getElementById('agent-skill').value;
                const query = document.getElementById('agent-query').value.trim();
                const externalMode = document.getElementById('research-external').checked;
                const internalMode = document.getElementById('research-internal').checked;
                const resultsDiv = document.getElementById('agent-results');

                if (!query) {
                    showNotification('Please enter a query', 'warning');
                    return;
                }

                this.isRunning = true;
                resultsDiv.innerHTML = '<div style="color: var(--gold);">Running agent...</div>';

                const invoke = getInvoke();
                if (!invoke) {
                    // Browser mode - simulate response
                    setTimeout(() => {
                        resultsDiv.innerHTML = `
                            <div style="margin-bottom: 12px;">
                                <strong style="color: var(--gold);">Skill:</strong> ${skill}<br>
                                <strong style="color: var(--gold);">Mode:</strong> ${externalMode ? 'External' : ''} ${internalMode ? 'Internal' : ''}<br>
                                <strong style="color: var(--gold);">Query:</strong> ${query}
                            </div>
                            <div style="color: var(--text-light);">
                                [Browser Mode] Agent Runner requires the desktop app for full functionality.
                                In the desktop app, this would execute the AGENT_RUNNER_TOOL.py script with your query.
                            </div>
                        `;
                        this.isRunning = false;
                        showNotification('Agent completed (browser mode)', 'info');
                    }, 1500);
                    return;
                }

                try {
                    // Build mode string
                    let mode = 'both';
                    if (externalMode && !internalMode) mode = 'external';
                    if (!externalMode && internalMode) mode = 'internal';

                    const scriptPath = 'G:\\My Drive\\00 - Trajanus USA\\00-Command-Center\\05-Scripts\\AGENT_RUNNER_TOOL.py';
                    const args = JSON.stringify({ skill, query, mode });

                    const result = await invoke('run_python_script', {
                        scriptPath: scriptPath,
                        targetPath: args
                    });

                    resultsDiv.innerHTML = `
                        <div style="margin-bottom: 12px;">
                            <strong style="color: var(--gold);">Skill:</strong> ${skill}<br>
                            <strong style="color: var(--gold);">Mode:</strong> ${mode}<br>
                        </div>
                        <div style="color: var(--success);">${result}</div>
                    `;
                    showNotification('Agent completed', 'success');
                } catch (error) {
                    resultsDiv.innerHTML = `<div style="color: var(--error);">Error: ${error}</div>`;
                    showNotification('Agent failed', 'warning');
                } finally {
                    this.isRunning = false;
                }
            },

            clear() {
                document.getElementById('agent-query').value = '';
                document.getElementById('agent-results').innerHTML = 'Results will appear here after running the agent...';
            }
        };

        // ==================== LOCK / UNLOCK FORMS ====================
        function lockAllForms() {
            const container = document.querySelector('.workspace-container');
            if (container) container.classList.add('locked');
            const els = document.querySelectorAll('#workflow-workspace input, #workflow-workspace select, #workflow-workspace textarea');
            els.forEach(el => el.setAttribute('disabled', 'disabled'));
        }

        function unlockAllForms() {
            const container = document.querySelector('.workspace-container');
            if (container) container.classList.remove('locked');
            const els = document.querySelectorAll('#workflow-workspace input[disabled], #workflow-workspace select[disabled], #workflow-workspace textarea[disabled]');
            els.forEach(el => el.removeAttribute('disabled'));
        }

        // ==================== PROJECT LIFECYCLE MODULE ====================
        const ProjectLifecycle = {
            _toolbarContainer: null,

            renderToolbar(project, containerEl) {
                if (!project) return;
                const status = project.status || 'draft';
                const transitions = STATUS_TRANSITIONS[status] || [];
                const statusLabel = STATUS_LABELS[status] || status;

                let html = `<div class="lifecycle-toolbar" id="lifecycle-toolbar">
                    <span class="toolbar-label">Status:</span>
                    <span class="status-badge status-${status}">${statusLabel}</span>
                    <div class="lifecycle-separator"></div>`;

                // Transition buttons
                transitions.forEach(target => {
                    const key = `${status}->${target}`;
                    const label = TRANSITION_LABELS[key] || target;
                    let btnClass = 'transition-btn';
                    if (target === 'delivered') btnClass += ' btn-warn';
                    else if (target === 'approved') btnClass += ' btn-success';
                    else if (target === 'active' && status === 'delivered') btnClass += ' btn-danger';
                    html += `<button class="${btnClass}" onclick="ProjectLifecycle.confirmTransition('${project.id}','${status}','${target}')">${label}</button>`;
                });

                html += `<div class="toolbar-right">`;
                html += `<button class="transition-btn lifecycle-action" onclick="ProjectLifecycle.previewAll('${project.id}')">Preview All</button>`;
                html += `<button class="transition-btn lifecycle-action" onclick="ProjectStore.exportProject('${project.id}')">Export</button>`;
                html += `</div></div>`;

                // Lock banner
                if (ProjectStore.isLocked(project)) {
                    html += `<div class="lock-banner" id="lock-banner">
                        <span class="lock-icon">&#128274;</span>
                        <span>This project is <strong>delivered and locked</strong>. No edits allowed unless unlocked by admin.</span>
                    </div>`;
                }

                if (containerEl) {
                    containerEl.insertAdjacentHTML('afterend', html);
                } else {
                    const existing = document.getElementById('lifecycle-toolbar');
                    if (existing) existing.remove();
                    const banner = document.getElementById('lock-banner');
                    if (banner) banner.remove();
                    const summary = document.getElementById('project-summary-card');
                    if (summary) summary.insertAdjacentHTML('afterend', html);
                }
            },

            confirmTransition(projectId, fromStatus, toStatus) {
                const key = `${fromStatus}->${toStatus}`;
                const label = TRANSITION_LABELS[key] || `${fromStatus}  ${toStatus}`;
                const isLock = toStatus === 'delivered';
                const isUnlock = fromStatus === 'delivered' && toStatus === 'active';

                let warnHtml = '';
                if (isLock) warnHtml = '<p class="warn-text">This will LOCK the project. All forms become read-only. Only an admin unlock can reverse this.</p>';
                if (isUnlock) warnHtml = '<p class="warn-text">This will UNLOCK a delivered project. Use only for emergency corrections.</p>';

                const overlay = document.createElement('div');
                overlay.className = 'transition-modal-overlay';
                overlay.id = 'transition-modal-overlay';
                overlay.innerHTML = `<div class="transition-modal">
                    <h3>${label}</h3>
                    <div class="status-flow">
                        <span class="status-badge status-${fromStatus}">${STATUS_LABELS[fromStatus]}</span>
                        <span class="arrow">&#10140;</span>
                        <span class="status-badge status-${toStatus}">${STATUS_LABELS[toStatus]}</span>
                    </div>
                    ${warnHtml}
                    <label style="font-size:12px;color:var(--text-muted)">Note (optional):</label>
                    <textarea id="transition-note" placeholder="Reason for this change..."></textarea>
                    <div class="modal-actions">
                        <button class="transition-btn" onclick="ProjectLifecycle.cancelTransition()">Cancel</button>
                        <button class="transition-btn ${isLock ? 'btn-warn' : 'btn-success'}" onclick="ProjectLifecycle.executeTransition('${projectId}','${toStatus}')">Confirm</button>
                    </div>
                </div>`;
                document.body.appendChild(overlay);
            },

            cancelTransition() {
                const overlay = document.getElementById('transition-modal-overlay');
                if (overlay) overlay.remove();
            },

            async executeTransition(projectId, toStatus) {
                const note = (document.getElementById('transition-note')?.value || '').trim();
                this.cancelTransition();
                try {
                    const project = await ProjectStore.transitionStatus(projectId, toStatus, note);
                    if (typeof TseWorkflow !== 'undefined' && TseWorkflow._activeProject) {
                        TseWorkflow._activeProject = project;
                    }
                    // Re-render toolbar
                    const existing = document.getElementById('lifecycle-toolbar');
                    if (existing) existing.remove();
                    const banner = document.getElementById('lock-banner');
                    if (banner) banner.remove();
                    this.renderToolbar(project);
                    // Handle lock/unlock
                    if (toStatus === 'delivered') {
                        lockAllForms();
                    } else if (ProjectStore.isLocked(project) === false) {
                        unlockAllForms();
                    }
                    showNotification(`Project status changed to ${STATUS_LABELS[toStatus]}`, 'success');
                } catch (e) {
                    showNotification('Transition failed: ' + e.message, 'error');
                }
            },

            async previewAll(projectId) {
                const project = await ProjectStore.getProject(projectId);
                if (!project) return;
                let stepsHtml = '';
                for (let i = 1; i <= 10; i++) {
                    const title = StepPreview._stepTitles?.[i] || `Step ${i}`;
                    const data = project.stepData?.[i];
                    let content = '<p style="color:var(--text-muted);font-size:12px;">No data entered for this step.</p>';
                    if (data && typeof StepPreview[`renderStep${i}`] === 'function') {
                        content = StepPreview[`renderStep${i}`](data);
                    }
                    stepsHtml += `<div class="preview-step-section"><h3>Step ${i}: ${title}</h3>${content}</div>`;
                }
                const overlay = document.createElement('div');
                overlay.className = 'preview-all-overlay';
                overlay.id = 'preview-all-overlay';
                overlay.innerHTML = `<div class="preview-all-container">
                    <div class="preview-all-header">
                        <h2>${project.name || 'Project'}  Full Preview</h2>
                        <div style="display:flex;gap:8px;">
                            <button class="transition-btn" onclick="window.print()">Print</button>
                            <button class="transition-btn" onclick="document.getElementById('preview-all-overlay').remove()">Close</button>
                        </div>
                    </div>
                    ${stepsHtml}
                </div>`;
                document.body.appendChild(overlay);
            }
        };

        // ==================== STEP PREVIEW MODULE ====================
        const StepPreview = {
            _stepTitles: {
                1: 'Project Setup', 2: 'Data Collection', 3: 'Trip Generation',
                4: 'Trip Distribution', 5: 'Future Volumes', 6: 'Capacity Analysis',
                7: 'Site Access', 8: 'Signal Warrants', 9: 'Report Assembly', 10: 'Final Delivery'
            },

            open(stepNum) {
                const data = TseWorkflow._activeProject?.stepData?.[stepNum];
                const title = document.getElementById('preview-modal-title');
                const body = document.getElementById('preview-modal-body');
                const footer = document.getElementById('preview-modal-footer');

                title.textContent = 'Step ' + stepNum + ': ' + this._stepTitles[stepNum];

                footer.innerHTML = '<button class="btn-secondary" id="preview-modal-close-btn">Close</button>';

                if (!data) {
                    body.innerHTML = '<div style="text-align:center;color:var(--text-muted);padding:32px;">No data submitted for this step yet.</div>';
                } else {
                    const renderer = this['renderStep' + stepNum];
                    if (renderer) {
                        body.innerHTML = renderer.call(this, data, stepNum);
                    } else {
                        body.innerHTML = '<pre style="color:var(--text-muted);font-size:12px;">' + JSON.stringify(data, null, 2) + '</pre>';
                    }
                }

                // Step 9: add Accept button
                if (stepNum === 9 && data && !data._accepted) {
                    const acceptBtn = document.createElement('button');
                    acceptBtn.className = 'btn-primary';
                    acceptBtn.textContent = 'Accept & Save';
                    acceptBtn.style.marginLeft = '8px';
                    acceptBtn.addEventListener('click', async () => {
                        data._accepted = true;
                        data._acceptedAt = new Date().toISOString();
                        await ProjectStore.saveStepData(TseWorkflow._activeProjectId, 9, data);
                        TseWorkflow._activeProject.stepData[9] = data;
                        this.close();
                        showNotification('Report accepted and saved', 'success');
                    });
                    footer.appendChild(acceptBtn);
                }

                document.getElementById('step-preview-modal').classList.add('visible');
                document.getElementById('preview-modal-close-btn').addEventListener('click', () => this.close());
                document.getElementById('preview-modal-close').addEventListener('click', () => this.close());
            },

            close() {
                document.getElementById('step-preview-modal').classList.remove('visible');
            },

            _field(label, value) {
                return '<div class="preview-field"><span class="preview-field-label">' + label + '</span><span class="preview-field-value">' + (value || '\u2014') + '</span></div>';
            },

            renderStep1(data) {
                const proj = TseWorkflow._activeProject;
                let html = '<div class="preview-report"><h4>Project Information</h4>';
                html += this._field('Project Name', proj.name);
                html += this._field('Project Number', proj.number);
                html += this._field('Client', proj.client);
                html += this._field('Address', proj.address || data.address);
                html += this._field('Jurisdiction', proj.jurisdiction || data.jurisdiction);
                html += this._field('Opening Year', proj.openingYear || data.openingYear);
                html += this._field('Horizon Year', proj.horizonYear || data.horizonYear);
                html += this._field('Growth Rate', (proj.growthRate || data.growthRate) ? (proj.growthRate || data.growthRate) + '%' : '\u2014');
                html += this._field('Signal Warrant Study', proj.signalWarrantStudy !== false ? 'Yes' : 'No');

                const buildings = proj.buildings || data.buildings || [];
                if (buildings.length) {
                    html += '<h4>Buildings</h4><table class="preview-table"><tr><th>Name</th><th>Size (SF)</th><th>ITE LUC</th><th>Drive-Thru</th></tr>';
                    buildings.forEach(b => {
                        html += '<tr><td>' + b.name + '</td><td>' + (b.sqft ? Number(b.sqft).toLocaleString() : '\u2014') + '</td><td>' + (b.luc || '\u2014') + '</td><td>' + (b.driveThru ? 'Yes' : 'No') + '</td></tr>';
                    });
                    html += '</table>';
                }
                return html + '</div>';
            },

            renderStep2(data) {
                let html = '<div class="preview-report"><h4>Data Collection</h4>';
                html += this._field('Count Date', data.countDate);
                html += this._field('Day of Week', data.dayOfWeek);
                html += this._field('AM Peak', (data.amStart || '\u2014') + ' \u2013 ' + (data.amEnd || '\u2014'));
                html += this._field('PM Peak', (data.pmStart || '\u2014') + ' \u2013 ' + (data.pmEnd || '\u2014'));
                html += this._field('TMC Data Uploaded', data.tmcUploaded ? 'Yes' : 'No');
                html += this._field('Photos Uploaded', data.photosUploaded ? 'Yes' : 'No');
                return html + '</div>';
            },

            renderStep3(data) {
                let html = '<div class="preview-report"><h4>Trip Generation Summary</h4>';
                if (data.landUses && data.landUses.length) {
                    html += '<table class="preview-table"><tr><th>Land Use</th><th>ITE Code</th><th>Size</th><th>AM In</th><th>AM Out</th><th>PM In</th><th>PM Out</th><th>Daily</th></tr>';
                    data.landUses.forEach(lu => {
                        html += '<tr><td>' + (lu.name || '\u2014') + '</td><td>' + (lu.code || '\u2014') + '</td><td>' + (lu.size || '\u2014') + '</td>';
                        html += '<td>' + (lu.amIn || '\u2014') + '</td><td>' + (lu.amOut || '\u2014') + '</td><td>' + (lu.pmIn || '\u2014') + '</td><td>' + (lu.pmOut || '\u2014') + '</td><td>' + (lu.daily || '\u2014') + '</td></tr>';
                    });
                    html += '</table>';
                }
                html += '<h4>Reductions</h4>';
                html += this._field('Pass-By Reduction', data.passByReduction || '0%');
                html += this._field('Internal Capture', data.internalCapture || '0%');
                html += '<h4>Net Trips</h4>';
                html += this._field('Net AM In', data.netAmIn);
                html += this._field('Net AM Out', data.netAmOut);
                html += this._field('Net PM In', data.netPmIn);
                html += this._field('Net PM Out', data.netPmOut);
                html += this._field('Net Daily', data.netDaily);
                return html + '</div>';
            },

            renderStep4(data) {
                let html = '<div class="preview-report"><h4>Trip Distribution</h4>';
                html += this._field('Distribution Method', data.method);
                html += this._field('Source', data.source);
                if (data.routes && data.routes.length) {
                    html += '<table class="preview-table"><tr><th>Route</th><th>Direction</th><th>Percentage</th></tr>';
                    data.routes.forEach(r => {
                        html += '<tr><td>' + (r.route || r.name || '\u2014') + '</td><td>' + (r.direction || '\u2014') + '</td><td>' + (r.pct || r.percentage || '\u2014') + '%</td></tr>';
                    });
                    html += '</table>';
                }
                if (data.notes) html += '<h4>Notes</h4><p>' + data.notes + '</p>';
                return html + '</div>';
            },

            renderStep5(data) {
                let html = '<div class="preview-report"><h4>Future Volume Projections</h4>';
                html += this._field('Base Year', data.baseYear);
                html += this._field('Opening Year', data.openingYear);
                html += this._field('Horizon Year', data.horizonYear);
                html += this._field('Growth Rate', data.growthRate ? data.growthRate + '%' : '\u2014');
                html += this._field('Opening Year Factor', data.openFactor);
                html += this._field('Horizon Year Factor', data.horizonFactor);
                if (data.existingVolumes && data.existingVolumes.length) {
                    html += '<h4>Existing Volumes</h4><table class="preview-table"><tr><th>Intersection</th><th>AM Peak</th><th>PM Peak</th></tr>';
                    data.existingVolumes.forEach(v => {
                        html += '<tr><td>' + (v.intersection || v.name || '\u2014') + '</td><td>' + (v.amPeak || '\u2014') + '</td><td>' + (v.pmPeak || '\u2014') + '</td></tr>';
                    });
                    html += '</table>';
                }
                return html + '</div>';
            },

            renderStep6(data) {
                let html = '<div class="preview-report"><h4>Capacity Analysis</h4>';
                if (data.synchroModels && data.synchroModels.length) {
                    html += '<table class="preview-table"><tr><th>Model</th><th>Scenario</th><th>Status</th></tr>';
                    data.synchroModels.forEach(m => {
                        html += '<tr><td>' + (m.name || m.intersection || '\u2014') + '</td><td>' + (m.scenario || '\u2014') + '</td><td>' + (m.status || '\u2014') + '</td></tr>';
                    });
                    html += '</table>';
                }
                if (data.losResults && data.losResults.length) {
                    html += '<h4>LOS Results</h4><table class="preview-table"><tr><th>Intersection</th><th>Scenario</th><th>LOS</th><th>Delay (s)</th></tr>';
                    data.losResults.forEach(r => {
                        const grade = (r.los || r.grade || '\u2014').toUpperCase();
                        const gradeClass = grade.length === 1 ? ' los-grade ' + grade.toLowerCase() : '';
                        html += '<tr><td>' + (r.intersection || r.name || '\u2014') + '</td><td>' + (r.scenario || '\u2014') + '</td><td><span class="los-grade' + gradeClass + '">' + grade + '</span></td><td>' + (r.delay || '\u2014') + '</td></tr>';
                    });
                    html += '</table>';
                }
                if (data.mitigationNotes) html += '<h4>Mitigation Notes</h4><p>' + data.mitigationNotes + '</p>';
                return html + '</div>';
            },

            renderStep7(data) {
                let html = '<div class="preview-report"><h4>Site Access Design</h4>';
                if (data.driveways && data.driveways.length) {
                    html += '<h4>Driveways</h4><table class="preview-table"><tr><th>Location</th><th>Type</th><th>Width</th><th>Movements</th></tr>';
                    data.driveways.forEach(d => {
                        html += '<tr><td>' + (d.location || d.name || '\u2014') + '</td><td>' + (d.type || '\u2014') + '</td><td>' + (d.width || '\u2014') + '</td><td>' + (d.movements || '\u2014') + '</td></tr>';
                    });
                    html += '</table>';
                }
                if (data.turnLanes && data.turnLanes.length) {
                    html += '<h4>Turn Lanes</h4><table class="preview-table"><tr><th>Location</th><th>Direction</th><th>Warranted</th></tr>';
                    data.turnLanes.forEach(t => {
                        html += '<tr><td>' + (t.location || t.name || '\u2014') + '</td><td>' + (t.direction || '\u2014') + '</td><td>' + (t.warranted ? 'Yes' : 'No') + '</td></tr>';
                    });
                    html += '</table>';
                }
                if (data.sightDistance && data.sightDistance.length) {
                    html += '<h4>Sight Distance</h4><table class="preview-table"><tr><th>Location</th><th>Required</th><th>Available</th><th>Adequate</th></tr>';
                    data.sightDistance.forEach(s => {
                        html += '<tr><td>' + (s.location || s.name || '\u2014') + '</td><td>' + (s.required || '\u2014') + '</td><td>' + (s.available || '\u2014') + '</td><td>' + (s.adequate ? 'Yes' : 'No') + '</td></tr>';
                    });
                    html += '</table>';
                }
                return html + '</div>';
            },

            renderStep8(data) {
                let html = '<div class="preview-report"><h4>Signal Warrant Analysis</h4>';
                if (data.intersections && data.intersections.length) {
                    html += '<table class="preview-table"><tr><th>Intersection</th><th>Warrants Evaluated</th><th>Result</th></tr>';
                    data.intersections.forEach(i => {
                        const met = i.met || i.result === 'MET';
                        html += '<tr><td>' + (i.name || i.intersection || '\u2014') + '</td><td>' + (i.warrants || data.selectedWarrants?.join(', ') || '\u2014') + '</td>';
                        html += '<td><span class="preview-badge ' + (met ? 'met' : 'not-met') + '">' + (met ? 'MET' : 'NOT MET') + '</span></td></tr>';
                    });
                    html += '</table>';
                }
                if (data.autoResults) {
                    html += '<h4>Automated Warrant Results</h4>';
                    if (typeof data.autoResults === 'object') {
                        for (const [warrant, result] of Object.entries(data.autoResults)) {
                            const met = result === true || result === 'MET';
                            html += this._field(warrant, '<span class="preview-badge ' + (met ? 'met' : 'not-met') + '">' + (met ? 'MET' : 'NOT MET') + '</span>');
                        }
                    }
                }
                if (data.notes) html += '<h4>Notes</h4><p>' + data.notes + '</p>';
                return html + '</div>';
            },

            renderStep9(data) {
                let html = '<div class="preview-report">';
                if (data._accepted) {
                    html += '<div style="background:rgba(74,222,128,0.1);border:1px solid var(--success);padding:10px 16px;border-radius:6px;margin-bottom:16px;font-size:13px;color:var(--success);">Accepted on ' + new Date(data._acceptedAt).toLocaleDateString() + '</div>';
                }
                html += '<h4>Report Sections</h4>';
                if (data.sections && data.sections.length) {
                    html += '<table class="preview-table"><tr><th>Section</th><th>Status</th></tr>';
                    data.sections.forEach(s => {
                        const done = s.complete || s.status === 'complete';
                        html += '<tr><td>' + (s.title || s.name || '\u2014') + '</td><td>' + (done ? '\u2713 Complete' : 'Pending') + '</td></tr>';
                    });
                    html += '</table>';
                }
                if (data.exhibits && data.exhibits.length) {
                    const layouts = data.exhibitLayouts || {};
                    html += '<h4>Exhibits</h4><table class="preview-table"><tr><th>Exhibit</th><th>Description</th><th>Layout</th></tr>';
                    data.exhibits.forEach(e => {
                        const exId = e.figNum || e.number || e.id || '';
                        const hasLayout = !!(layouts[exId] || layouts[e.title]);
                        html += '<tr><td>' + (e.number || e.figNum || e.id || '\u2014') + '</td><td>' + (e.title || e.description || '\u2014') + '</td><td>' + (hasLayout ? '<span style="color:var(--success);">Saved</span>' : '<span style="color:var(--text-muted);">\u2014</span>') + '</td></tr>';
                    });
                    html += '</table>';
                }
                html += this._field('Report Filename', data.reportFilename);
                html += this._field('Version', data.reportVersion);
                html += this._field('Date', data.reportDate);
                return html + '</div>';
            },

            renderStep10(data) {
                let html = '<div class="preview-report"><h4>Final Delivery</h4>';
                if (data.qcChecklist && data.qcChecklist.length) {
                    html += '<h4>QC Checklist</h4><table class="preview-table"><tr><th>Item</th><th>Status</th></tr>';
                    data.qcChecklist.forEach(q => {
                        const checked = q.checked || q.complete;
                        html += '<tr><td>' + (q.label || q.item || q.name || '\u2014') + '</td><td>' + (checked ? '\u2713' : '\u2014') + '</td></tr>';
                    });
                    html += '</table>';
                }
                if (data.deliverables && data.deliverables.length) {
                    html += '<h4>Deliverables</h4><table class="preview-table"><tr><th>Item</th><th>Format</th><th>Status</th></tr>';
                    data.deliverables.forEach(d => {
                        html += '<tr><td>' + (d.name || d.item || '\u2014') + '</td><td>' + (d.format || '\u2014') + '</td><td>' + (d.status || d.complete ? '\u2713' : '\u2014') + '</td></tr>';
                    });
                    html += '</table>';
                }
                html += '<h4>Submission</h4>';
                html += this._field('Submit To', data.submitTo);
                html += this._field('Submit Date', data.submitDate);
                html += this._field('Method', data.submitMethod);
                html += this._field('Contact', data.contactName);
                html += this._field('Email', data.contactEmail);
                html += this._field('Review Status', data.reviewStatus);
                if (data.notes) html += '<h4>Notes</h4><p>' + data.notes + '</p>';
                return html + '</div>';
            }
        };

        // ==================== TSE WORKFLOW MODULE ====================
        const TseWorkflow = {
            currentStep: 1,
            currentProject: null,
            projects: [],
            _activeProjectId: null,
            _activeProject: null,
            _stepsCompleted: {},
            _folderItems: {},

            // Step instructions based on 10-step TIA workflow
            stepInstructions: {
                1: {
                    title: 'Step 1: Project Setup',
                    content: `<strong>Create your TIA project folder structure:</strong>
                    <ol>
                        <li>Click <strong>+ New Project</strong> and enter project details</li>
                        <li>The system will create your folder structure at:<br>
                            <code style="background:#2d2d2d;padding:4px 8px;border-radius:4px;display:inline-block;margin:4px 0;">G:\\My Drive\\00 - Trajanus USA\\Traffic\\[Project Name]\\</code></li>
                        <li>Standard folders: 01-Input, 02-Working, 03-Output, 04-Correspondence, 05-Final</li>
                        <li>Once created, proceed to <strong>Step 2: Data Collection</strong></li>
                    </ol>`
                },
                2: {
                    title: 'Step 2: Data Collection',
                    content: `<strong>Gather all required traffic data:</strong>
                    <ol>
                        <li><strong>TMC Counts</strong> - Turning movement counts at study intersections
                            <ul style="margin-left:20px;margin-top:4px;">
                                <li>AM Peak (7:00-9:00 AM typical)</li>
                                <li>PM Peak (4:00-6:00 PM typical)</li>
                                <li>Save to: 01-Input/Traffic Counts/</li>
                            </ul>
                        </li>
                        <li><strong>ADT Counts</strong> - Tube counts for roadway segments</li>
                        <li><strong>Site Plan (.pdf)</strong> - From client/architect</li>
                        <li><strong>Land Use Details</strong> - ITE code, building size, occupancy</li>
                    </ol>
                    <p style="margin-top:12px;color:var(--info);">Check off each item in the Required Documents checklist as you collect them.</p>`
                },
                3: {
                    title: 'Step 3: Trip Generation',
                    content: `<strong>Calculate site-generated traffic using ITE methodology:</strong>
                    <ol>
                        <li><strong>Identify Land Use Code</strong> - Reference ITE Trip Generation Manual (11th Ed)
                            <ul style="margin-left:20px;margin-top:4px;">
                                <li>Example: 560 (Church), 820 (Shopping Center)</li>
                                <li>Select appropriate independent variable (GFA, units, etc.)</li>
                            </ul>
                        </li>
                        <li><strong>Calculate Peak Hour Trips</strong>
                            <ul style="margin-left:20px;margin-top:4px;">
                                <li>AM Peak trips (in/out)</li>
                                <li>PM Peak trips (in/out)</li>
                                <li>Apply pass-by and diverted trip reductions if applicable</li>
                            </ul>
                        </li>
                        <li><strong>Document in Trip Gen Worksheet</strong> - Save to 02-Working/</li>
                    </ol>`
                },
                4: {
                    title: 'Step 4: Trip Distribution',
                    content: `<strong>Distribute site trips to the roadway network:</strong>
                    <ol>
                        <li><strong>Determine Distribution Percentages</strong>
                            <ul style="margin-left:20px;margin-top:4px;">
                                <li>Based on existing traffic patterns</li>
                                <li>Population/employment gravity model</li>
                                <li>Professional judgment for local conditions</li>
                            </ul>
                        </li>
                        <li><strong>Create Trip Distribution Diagram</strong>
                            <ul style="margin-left:20px;margin-top:4px;">
                                <li>Show percentages to each approach</li>
                                <li>Include turning movements at site driveways</li>
                            </ul>
                        </li>
                        <li><strong>Assign Trips</strong> - Apply percentages to trip generation totals</li>
                    </ol>`
                },
                5: {
                    title: 'Step 5: Future Volumes',
                    content: `<strong>Project future year traffic volumes:</strong>
                    <ol>
                        <li><strong>Determine Horizon Year</strong> - Typically opening year + 5 years</li>
                        <li><strong>Apply Growth Factor</strong>
                            <ul style="margin-left:20px;margin-top:4px;">
                                <li>Use jurisdiction-approved growth rate (typically 1-3% annual)</li>
                                <li>Compound formula: Future = Existing  (1 + rate)^years</li>
                            </ul>
                        </li>
                        <li><strong>Account for Background Development</strong>
                            <ul style="margin-left:20px;margin-top:4px;">
                                <li>Check with jurisdiction for approved projects</li>
                                <li>Add trips from committed developments</li>
                            </ul>
                        </li>
                        <li><strong>Create Volume Scenarios:</strong> Existing, Background, Background+Site</li>
                    </ol>`
                },
                6: {
                    title: 'Step 6: Capacity Analysis',
                    content: `<strong>Analyze intersection operations using Synchro/HCS:</strong>
                    <ol>
                        <li><strong>Build Synchro Models</strong>
                            <ul style="margin-left:20px;margin-top:4px;">
                                <li>Import intersection geometry from field/plans</li>
                                <li>Enter signal timing parameters</li>
                                <li>Input volumes for each scenario</li>
                            </ul>
                        </li>
                        <li><strong>Run HCM Analysis</strong>
                            <ul style="margin-left:20px;margin-top:4px;">
                                <li>Calculate delay and Level of Service</li>
                                <li>Identify critical movements</li>
                            </ul>
                        </li>
                        <li><strong>Compare Scenarios</strong> - Background vs Background+Site</li>
                        <li><strong>Export Reports</strong> - Save to 03-Output/Capacity Analysis/</li>
                    </ol>`
                },
                7: {
                    title: 'Step 7: Site Access',
                    content: `<strong>Design and analyze site access points:</strong>
                    <ol>
                        <li><strong>Driveway Location</strong>
                            <ul style="margin-left:20px;margin-top:4px;">
                                <li>Spacing from intersections per jurisdiction standards</li>
                                <li>Sight distance requirements</li>
                                <li>Access management compliance</li>
                            </ul>
                        </li>
                        <li><strong>Driveway Operations</strong>
                            <ul style="margin-left:20px;margin-top:4px;">
                                <li>Analyze site driveway LOS</li>
                                <li>Queue analysis for drive-thru if applicable</li>
                            </ul>
                        </li>
                        <li><strong>Turn Lane Warrants</strong>
                            <ul style="margin-left:20px;margin-top:4px;">
                                <li>Left-turn deceleration lanes</li>
                                <li>Right-turn deceleration lanes</li>
                            </ul>
                        </li>
                    </ol>`
                },
                8: {
                    title: 'Step 8: Signal Warrants',
                    content: `<strong>Evaluate traffic signal warrants per MUTCD:</strong>
                    <ol>
                        <li><strong>Warrant Analysis</strong> (if required by jurisdiction)
                            <ul style="margin-left:20px;margin-top:4px;">
                                <li>Warrant 1: Eight-Hour Vehicular Volume</li>
                                <li>Warrant 2: Four-Hour Vehicular Volume</li>
                                <li>Warrant 3: Peak Hour</li>
                                <li>Warrant 7: Crash Experience</li>
                            </ul>
                        </li>
                        <li><strong>Document Findings</strong>
                            <ul style="margin-left:20px;margin-top:4px;">
                                <li>Warrant satisfied or not satisfied</li>
                                <li>Supporting data and calculations</li>
                            </ul>
                        </li>
                        <li><strong>Recommendations</strong> - Signal installation or alternatives</li>
                    </ol>`
                },
                9: {
                    title: 'Step 9: Report Assembly',
                    content: `<strong>Assemble the Traffic Impact Analysis document:</strong>
                    <ol>
                        <li><strong>Use TIA Template</strong> - Launch Word with jurisdiction-specific template</li>
                        <li><strong>Required Sections:</strong>
                            <ul style="margin-left:20px;margin-top:4px;">
                                <li>Executive Summary</li>
                                <li>Project Description & Site Plan</li>
                                <li>Study Area & Intersections</li>
                                <li>Existing Conditions</li>
                                <li>Trip Generation (ITE methodology)</li>
                                <li>Trip Distribution & Assignment</li>
                                <li>Future Traffic Analysis</li>
                                <li>Site Access Analysis</li>
                                <li>Level of Service Results</li>
                                <li>Conclusions & Recommendations</li>
                            </ul>
                        </li>
                        <li><strong>Insert Tables & Figures</strong></li>
                    </ol>`
                },
                10: {
                    title: 'Step 10: Final Delivery',
                    content: `<strong>Complete the final deliverable package:</strong>
                    <ol>
                        <li><strong>Create Exhibits</strong>
                            <ul style="margin-left:20px;margin-top:4px;">
                                <li>Location Map</li>
                                <li>Site Plan</li>
                                <li>Study Area Map</li>
                                <li>Trip Distribution Diagram</li>
                                <li>Lane Configuration Diagrams</li>
                            </ul>
                        </li>
                        <li><strong>Compile Appendix</strong>
                            <ul style="margin-left:20px;margin-top:4px;">
                                <li>Traffic Counts</li>
                                <li>Capacity Analysis Reports</li>
                                <li>Trip Generation Worksheet</li>
                            </ul>
                        </li>
                        <li><strong>Export Final PDF</strong> - Convert to PDF, check formatting</li>
                        <li><strong>Submit to Client/Jurisdiction</strong></li>
                    </ol>
                    <p style="margin-top:12px;color:var(--success);font-weight:600;">Project complete! Review checklist to ensure all items are checked.</p>`
                }
            },

            // Tools for each step
            stepTools: {
                1: [], // No tools needed for setup
                2: [
                    { id: 'explorer', icon: '', label: 'File Explorer', action: 'openExplorer' },
                    { id: 'maps', icon: '', label: 'Google Maps', action: 'launchMaps' }
                ],
                3: [
                    { id: 'excel', icon: '', label: 'Excel', action: 'launchExcel' },
                    { id: 'trip-gen', icon: '', label: 'Trip Gen Calculator', action: 'runTripGen' },
                    { id: 'ite', icon: '', label: 'ITE Manual', action: 'openITE' }
                ],
                4: [
                    { id: 'excel', icon: '', label: 'Excel', action: 'launchExcel' },
                    { id: 'autocad', icon: '', label: 'AutoCAD', action: 'launchAutoCAD' }
                ],
                5: [
                    { id: 'excel', icon: '', label: 'Excel', action: 'launchExcel' },
                    { id: 'explorer', icon: '', label: 'Working Folder', action: 'openWorkingFolder' }
                ],
                6: [
                    { id: 'synchro', icon: '', label: 'Synchro 12', action: 'launchSynchro' },
                    { id: 'hcs', icon: '', label: 'HCS', action: 'launchHCS' },
                    { id: 'explorer', icon: '', label: 'Output Folder', action: 'openOutputFolder' }
                ],
                7: [
                    { id: 'autocad', icon: '', label: 'AutoCAD', action: 'launchAutoCAD' },
                    { id: 'synchro', icon: '', label: 'Synchro 12', action: 'launchSynchro' }
                ],
                8: [
                    { id: 'excel', icon: '', label: 'Excel (Warrants)', action: 'launchExcel' },
                    { id: 'mutcd', icon: '', label: 'MUTCD', action: 'openMUTCD' }
                ],
                9: [
                    { id: 'word', icon: '', label: 'Word', action: 'launchWord' },
                    { id: 'tia-template', icon: '', label: 'TIA Template', action: 'runTiaTemplate' },
                    { id: 'explorer', icon: '', label: 'Project Folder', action: 'openProjectFolder' }
                ],
                10: [
                    { id: 'word', icon: '', label: 'Word', action: 'launchWord' },
                    { id: 'acrobat', icon: '', label: 'PDF Export', action: 'launchAcrobat' },
                    { id: 'explorer', icon: '', label: 'Final Folder', action: 'openFinalFolder' }
                ]
            },

            async init() {
                ProjectStore.init();
                FileStore.init();
                await ProjectStore.migrateFromLocalStorage();
                this.bindEvents();
                AutoSave.init();
                SupplementalFiles.init();

                // Load project list for dropdown
                await this.loadProjects();

                // Check if there's an active project to auto-resume
                const activeId = await ProjectStore.getActiveProjectId();
                if (activeId) {
                    const project = await ProjectStore.getProject(activeId);
                    if (project) {
                        await this.openProject(activeId);
                        return;
                    }
                }
                // No active project  show default state
                this.updateStepDisplay();
                this.loadActiveProject();
            },

            // Load persisted project data and render summary/folder  ALWAYS render tracker
            loadActiveProject() {
                const data = this._activeProject || safeParseLS('tfe_active_project');
                if (data) {
                    this.renderProjectSummary(data);
                    this.renderFolderTracker(data);
                } else {
                    this.renderFolderTracker({ stepsCompleted: {}, folderItems: {} });
                    const grid = document.getElementById('project-summary-grid');
                    if (grid) grid.innerHTML = '<div style="color:var(--text-muted);font-size:13px;grid-column:1/-1;text-align:center;padding:12px;">No project submitted yet \u2014 complete Step 1 to populate</div>';
                }
            },

            async openProject(id) {
                const project = await ProjectStore.getProject(id);
                if (!project) {
                    showNotification('Project not found', 'warning');
                    return;
                }
                this._activeProjectId = id;
                this._activeProject = project;
                this._stepsCompleted = project.stepsCompleted || {};
                this._folderItems = project.folderItems || {};
                this.currentStep = project.currentStep || 1;
                await ProjectStore.setActiveProjectId(id);

                // Update project select dropdown  ensure projects loaded, then select active
                if (!this.projects || this.projects.length === 0) {
                    await this.loadProjects();
                } else {
                    this.populateProjectSelect();
                }
                const select = document.getElementById('project-select');
                select.value = id;

                // Render project summary and folder tracker
                this.renderProjectSummary(project);
                this.renderFolderTracker(project);
                this.updateStepDisplay();

                // Restore step 1 form data if available
                if (project.stepData && project.stepData[1]) {
                    this.restoreStepData(1, project.stepData[1]);
                }

                // Load supplemental files and aerial data
                SupplementalFiles.renderList();
                AerialFetch.loadFromProject(project);

                // Apply lock if project is delivered
                if (ProjectStore.isLocked(project)) {
                    lockAllForms();
                } else {
                    unlockAllForms();
                }
            },

            gatherStepData(stepNum) {
                switch(stepNum) {
                    case 1: {
                        const name = document.getElementById('ws-project-name');
                        if (!name || !name.value.trim()) return null;
                        const buildings = [];
                        document.querySelectorAll('#buildings-tbody tr').forEach(row => {
                            const inputs = row.querySelectorAll('input');
                            if (inputs[0] && inputs[0].value.trim()) {
                                buildings.push({
                                    name: inputs[0].value.trim(),
                                    sqft: inputs[1]?.value || '',
                                    luc: inputs[2]?.value || '',
                                    driveThru: inputs[3]?.checked || false
                                });
                            }
                        });
                        return {
                            name: name.value.trim(),
                            number: document.getElementById('ws-project-number')?.value?.trim() || '',
                            address: document.getElementById('ws-site-address')?.value?.trim() || '',
                            jurisdiction: document.getElementById('ws-jurisdiction')?.selectedOptions[0]?.text || '',
                            openingYear: document.getElementById('ws-opening-year')?.value || '',
                            horizonYear: document.getElementById('ws-horizon-year')?.value || '',
                            growthRate: document.getElementById('ws-growth-rate')?.value || '',
                            signalWarrantStudy: document.getElementById('ws-scope-warrants')?.checked !== false,
                            buildings,
                            aerialConfig: {
                                lat: document.getElementById('aerial-lat')?.value || '',
                                lon: document.getElementById('aerial-lon')?.value || '',
                                zoom: document.getElementById('aerial-zoom')?.value || '18',
                                apiKey: document.getElementById('aerial-api-key')?.value || ''
                            }
                        };
                    }
                    case 2: return {
                        countDate: document.getElementById('ws-count-date')?.value || '',
                        dayOfWeek: document.getElementById('ws-day-of-week')?.value || '',
                        amStart: document.getElementById('ws-am-start')?.value || '',
                        amEnd: document.getElementById('ws-am-end')?.value || '',
                        pmStart: document.getElementById('ws-pm-start')?.value || '',
                        pmEnd: document.getElementById('ws-pm-end')?.value || ''
                    };
                    default: return null;
                }
            },

            restoreStepData(stepNum, data) {
                if (!data) return;
                switch(stepNum) {
                    case 1: {
                        const fields = {
                            'ws-project-name': data.name,
                            'ws-project-number': data.number,
                            'ws-site-address': data.address,
                            'ws-opening-year': data.openingYear,
                            'ws-horizon-year': data.horizonYear,
                            'ws-growth-rate': data.growthRate
                        };
                        for (const [id, val] of Object.entries(fields)) {
                            const el = document.getElementById(id);
                            if (el && val) el.value = val;
                        }
                        const warrant = document.getElementById('ws-scope-warrants');
                        if (warrant) warrant.checked = data.signalWarrantStudy !== false;
                        const jSelect = document.getElementById('ws-jurisdiction');
                        if (jSelect && data.jurisdiction) {
                            for (const opt of jSelect.options) {
                                if (opt.text === data.jurisdiction) { jSelect.value = opt.value; break; }
                            }
                        }
                        // Restore aerial config
                        if (data.aerialConfig) {
                            const ac = data.aerialConfig;
                            if (ac.lat) document.getElementById('aerial-lat').value = ac.lat;
                            if (ac.lon) document.getElementById('aerial-lon').value = ac.lon;
                            if (ac.zoom) document.getElementById('aerial-zoom').value = ac.zoom;
                            if (ac.apiKey) document.getElementById('aerial-api-key').value = ac.apiKey;
                        }
                        break;
                    }
                    case 2: {
                        const fields = {
                            'ws-count-date': data.countDate,
                            'ws-day-of-week': data.dayOfWeek,
                            'ws-am-start': data.amStart,
                            'ws-am-end': data.amEnd,
                            'ws-pm-start': data.pmStart,
                            'ws-pm-end': data.pmEnd
                        };
                        for (const [id, val] of Object.entries(fields)) {
                            const el = document.getElementById(id);
                            if (el && val) el.value = val;
                        }
                        break;
                    }
                }
            },

            isWarrantStudyEnabled() {
                if (this._activeProject) {
                    return this._activeProject.signalWarrantStudy !== false;
                }
                return true;
            },

            // Render the project summary card
            renderProjectSummary(data) {
                if (!data) return;
                const card = document.getElementById('project-summary-card');
                const grid = document.getElementById('project-summary-grid');
                const buildingsDiv = document.getElementById('project-summary-buildings');

                const fields = [
                    { label: 'Project Name', value: data.name },
                    { label: 'Project Number', value: data.number || '' },
                    { label: 'Jurisdiction', value: data.jurisdiction || '' },
                    { label: 'Site Address', value: data.address || '' },
                    { label: 'Opening Year', value: data.openingYear || '' },
                    { label: 'Horizon Year', value: data.horizonYear || '' },
                    { label: 'Growth Rate', value: data.growthRate ? data.growthRate + '%' : '' },
                ];

                grid.innerHTML = fields.map(f =>
                    '<div class="project-summary-field"><div class="field-label">' + f.label + '</div><div class="field-value">' + f.value + '</div></div>'
                ).join('');

                if (data.buildings && data.buildings.length) {
                    buildingsDiv.innerHTML = '<div style="font-size:11px;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:8px;">Buildings</div>' +
                        data.buildings.map(b =>
                            '<span class="building-tag"> ' + b.name + (b.sqft ? '  ' + Number(b.sqft).toLocaleString() + ' SF' : '') + (b.luc ? ' (LUC ' + b.luc + ')' : '') + (b.driveThru ? ' ' : '') + '</span>'
                        ).join('');
                }

                card.classList.add('visible');

                // Render lifecycle toolbar below summary
                const existing = document.getElementById('lifecycle-toolbar');
                if (existing) existing.remove();
                const banner = document.getElementById('lock-banner');
                if (banner) banner.remove();
                ProjectLifecycle.renderToolbar(data);
            },

            // Render the project folder tracker
            renderFolderTracker(data) {
                if (!data) return;
                const tracker = document.getElementById('project-folder-tracker');
                tracker.classList.add('visible');

                const completed = data.stepsCompleted || {};
                const folderItems = data.folderItems || {};

                // Dependency map: which steps need output from prior steps
                const dependencies = {
                    3: { needs: 'TMC data from Step 2', check: ['folder-tmc-counts'] },
                    4: { needs: 'Trip generation from Step 3', check: ['folder-trip-calcs'] },
                    5: { needs: 'Distribution from Step 4', check: ['folder-distribution'] },
                    6: { needs: 'Volume scenarios from Step 5', check: ['folder-volumes'] },
                    7: { needs: 'Capacity results from Step 6', check: ['folder-synchro'] },
                    8: { needs: 'Capacity results from Step 6', check: ['folder-synchro'] },
                    9: { needs: 'All analysis steps (3-8)', check: ['folder-trip-calcs','folder-synchro'] },
                    10: { needs: 'Report draft from Step 9', check: ['folder-report'] }
                };

                // Update step groups
                document.querySelectorAll('.folder-step-group').forEach(group => {
                    const stepNum = parseInt(group.dataset.folderStep);
                    const badge = document.getElementById('folder-badge-' + stepNum);
                    const items = group.querySelectorAll('.folder-item');
                    let doneInStep = 0;
                    let totalInStep = items.length;

                    items.forEach(item => {
                        const statusEl = item.querySelector('.item-status');
                        if (folderItems[item.id]) {
                            item.classList.remove('pending');
                            if (statusEl) {
                                statusEl.textContent = 'Done';
                                statusEl.className = 'item-status done';
                            }
                            doneInStep++;
                        } else {
                            item.classList.add('pending');
                            if (statusEl) {
                                statusEl.textContent = 'Missing';
                                statusEl.className = 'item-status pending';
                            }
                        }
                    });

                    // Update badge: done / partial / pending
                    if (badge) {
                        badge.classList.remove('done', 'partial');
                        if (completed[stepNum] || doneInStep === totalInStep) {
                            badge.classList.add('done');
                            badge.textContent = '';
                        } else if (doneInStep > 0) {
                            badge.classList.add('partial');
                            badge.textContent = doneInStep + '/' + totalInStep;
                        } else {
                            badge.textContent = stepNum;
                        }
                    }

                    // Add/update dependency note
                    let depNote = group.querySelector('.folder-dep-note');
                    const dep = dependencies[stepNum];
                    if (dep) {
                        const depMet = dep.check.every(id => folderItems[id]);
                        if (!depMet) {
                            if (!depNote) {
                                depNote = document.createElement('div');
                                depNote.className = 'folder-dep-note';
                                group.appendChild(depNote);
                            }
                            depNote.innerHTML = '<span style="color:#fbbf24;font-size:11px;"> Requires: ' + dep.needs + '</span>';
                            depNote.style.display = 'block';
                        } else if (depNote) {
                            depNote.style.display = 'none';
                        }
                    }
                });

                // Update progress  count steps with ALL items done
                let fullyDone = 0;
                let partialDone = 0;
                document.querySelectorAll('.folder-step-group').forEach(group => {
                    const items = group.querySelectorAll('.folder-item');
                    const done = Array.from(items).filter(i => folderItems[i.id]).length;
                    if (done === items.length) fullyDone++;
                    else if (done > 0) partialDone++;
                });
                const progressText = fullyDone + ' complete' + (partialDone > 0 ? ', ' + partialDone + ' in progress' : '') + ' / 10 steps';
                document.getElementById('folder-tracker-progress').textContent = progressText;
            },

            // Save folder item as complete
            async markFolderItem(itemId) {
                if (this._activeProject) {
                    if (!this._activeProject.folderItems) this._activeProject.folderItems = {};
                    this._activeProject.folderItems[itemId] = true;
                    this._folderItems[itemId] = true;
                    await ProjectStore.saveProject(this._activeProject);
                    this.renderFolderTracker(this._activeProject);
                }
            },

            // Mark a step as complete in the folder
            async markStepComplete(stepNum) {
                if (this._activeProject) {
                    if (!this._activeProject.stepsCompleted) this._activeProject.stepsCompleted = {};
                    this._activeProject.stepsCompleted[stepNum] = true;
                    this._stepsCompleted[stepNum] = true;
                    await ProjectStore.saveProject(this._activeProject);
                    this.renderFolderTracker(this._activeProject);
                    await this.animateStepComplete(stepNum);
                }
            },

            bindEvents() {
                // Modal controls
                document.getElementById('new-project-btn').addEventListener('click', () => this.openModal());
                document.getElementById('modal-close').addEventListener('click', () => this.closeModal());
                document.getElementById('modal-cancel').addEventListener('click', () => this.closeModal());
                document.getElementById('modal-create').addEventListener('click', () => this.createProject());

                // Import project
                document.getElementById('import-project-btn').addEventListener('click', () => {
                    document.getElementById('import-project-file').click();
                });
                document.getElementById('import-project-file').addEventListener('change', async (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    try {
                        const text = await file.text();
                        const project = await ProjectStore.importProject(text);
                        showNotification('Imported: ' + project.name, 'success');
                        await this.openProject(project.id);
                        await this.loadProjects();
                    } catch (err) {
                        showNotification('Import failed: ' + err.message, 'error');
                    }
                    e.target.value = '';
                });

                // Status filter
                document.getElementById('project-status-filter').addEventListener('change', () => this.populateProjectSelect());

                // Project selection
                document.getElementById('project-select').addEventListener('change', (e) => this.selectProject(e.target.value));

                // Workflow step clicks
                document.querySelectorAll('.workflow-step').forEach(step => {
                    step.addEventListener('click', (e) => {
                        if (e.target.classList.contains('step-preview-btn')) return;
                        this.goToStep(parseInt(step.dataset.step));
                    });
                });

                // Preview buttons
                document.querySelectorAll('.step-preview-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        StepPreview.open(parseInt(btn.dataset.preview));
                    });
                });

                // Preview modal close
                document.getElementById('step-preview-modal')?.addEventListener('click', (e) => {
                    if (e.target === e.currentTarget) StepPreview.close();
                });

                // Documents panel toggle
                document.getElementById('docs-panel-header').addEventListener('click', () => this.toggleDocsPanel());

                // Document checkbox changes (now disabled - system controlled)
                document.querySelectorAll('.doc-checkbox').forEach(cb => {
                    cb.disabled = true; // System controls this
                });

                // Action buttons
                document.getElementById('open-folder-btn').addEventListener('click', () => this.openProjectFolder());
                document.getElementById('next-step-btn').addEventListener('click', () => this.advanceStep());

                // Workspace: Add Building button
                document.getElementById('add-building-btn').addEventListener('click', () => {
                    const tbody = document.getElementById('buildings-tbody');
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td><input type="text" placeholder="e.g., Outparcel"></td>
                        <td><input type="number" placeholder="5,000"></td>
                        <td><input type="text" placeholder="e.g., 934"></td>
                        <td style="text-align:center"><input type="checkbox"></td>
                        <td><button class="remove-building-btn" onclick="this.closest('tr').remove()"></button></td>
                    `;
                    tbody.appendChild(row);
                });

                // Workspace: Drop zone
                const dropZone = document.getElementById('ws-drop-zone');
                if (dropZone) {
                    dropZone.addEventListener('dragover', (e) => {
                        e.preventDefault();
                        dropZone.classList.add('dragover');
                    });
                    dropZone.addEventListener('dragleave', () => {
                        dropZone.classList.remove('dragover');
                    });
                    dropZone.addEventListener('drop', (e) => {
                        e.preventDefault();
                        dropZone.classList.remove('dragover');
                        const files = e.dataTransfer.files;
                        if (files.length) {
                            dropZone.innerHTML = '<div class="ws-drop-icon"></div><div class="ws-drop-text">' + files.length + ' file(s) attached</div><div class="ws-drop-subtext">' + Array.from(files).map(f => f.name).join(', ') + '</div>';
                        }
                    });
                    dropZone.addEventListener('click', () => {
                        const input = document.createElement('input');
                        input.type = 'file';
                        input.accept = '.pdf,.png,.jpg,.jpeg';
                        input.multiple = true;
                        input.onchange = () => {
                            if (input.files.length) {
                                dropZone.innerHTML = '<div class="ws-drop-icon"></div><div class="ws-drop-text">' + input.files.length + ' file(s) attached</div><div class="ws-drop-subtext">' + Array.from(input.files).map(f => f.name).join(', ') + '</div>';
                            }
                        };
                        input.click();
                    });
                }

                // Workspace: Browse Files (Native Dialog via PowerShell)
                document.getElementById('ws-browse-files').addEventListener('click', async () => {
                    const attachDiv = document.getElementById('ws-attached-files');
                    try {
                        const invoke = getInvoke();
                        if (invoke) {
                            // Use PowerShell to open native file dialog
                            const result = await invoke('open_terminal_output', {
                                command: 'powershell',
                                args: ['-WindowStyle', 'Hidden', '-Command', `
                                    Add-Type -AssemblyName System.Windows.Forms
                                    $dlg = New-Object System.Windows.Forms.OpenFileDialog
                                    $dlg.Title = 'Select Site Documents'
                                    $dlg.InitialDirectory = 'G:\\My Drive\\00 - Trajanus USA'
                                    $dlg.Filter = 'Documents (*.pdf;*.png;*.jpg;*.jpeg)|*.pdf;*.png;*.jpg;*.jpeg|All files (*.*)|*.*'
                                    $dlg.Multiselect = $true
                                    if ($dlg.ShowDialog() -eq 'OK') { $dlg.FileNames -join '|' } else { '' }
                                `]
                            });
                            if (result && result.trim()) {
                                const files = result.trim().split('|');
                                attachDiv.innerHTML = files.map(f =>
                                    '<div style="display:flex;align-items:center;gap:8px;padding:8px 12px;background:var(--bg-base);border:1px solid var(--blue);border-radius:6px;margin-bottom:6px;font-size:13px;color:var(--text-light);"> ' + f.split('\\').pop() + '<span style="color:var(--text-muted);font-size:11px;margin-left:auto;">' + f + '</span></div>'
                                ).join('');
                            }
                        } else {
                            showNotification('Native file dialog requires Tauri desktop app', 'warning');
                        }
                    } catch(e) {
                        // Fallback: try run_powershell_script or show error
                        showNotification('File dialog: ' + e, 'warning');
                    }
                });

                // Workspace: Browse Local (HTML file input)
                document.getElementById('ws-browse-local').addEventListener('click', () => {
                    const input = document.createElement('input');
                    input.type = 'file';
                    input.accept = '.pdf,.png,.jpg,.jpeg';
                    input.multiple = true;
                    input.onchange = () => {
                        if (input.files.length) {
                            const attachDiv = document.getElementById('ws-attached-files');
                            attachDiv.innerHTML = Array.from(input.files).map(f =>
                                '<div style="display:flex;align-items:center;gap:8px;padding:8px 12px;background:var(--bg-base);border:1px solid var(--blue);border-radius:6px;margin-bottom:6px;font-size:13px;color:var(--text-light);"> ' + f.name + '<span style="color:var(--text-muted);font-size:11px;margin-left:auto;">' + (f.size / 1024).toFixed(1) + ' KB</span></div>'
                            ).join('');
                        }
                    };
                    input.click();
                });

                // Aerial fetch button
                const aerialBtn = document.getElementById('aerial-fetch-btn');
                if (aerialBtn) {
                    aerialBtn.addEventListener('click', async () => {
                        const lat = parseFloat(document.getElementById('aerial-lat')?.value);
                        const lon = parseFloat(document.getElementById('aerial-lon')?.value);
                        const zoom = parseInt(document.getElementById('aerial-zoom')?.value) || 18;
                        const apiKey = document.getElementById('aerial-api-key')?.value?.trim();
                        if (!lat || !lon) { showNotification('Enter latitude and longitude', 'warning'); return; }
                        if (!apiKey) { showNotification('Enter Google Maps API key', 'warning'); return; }
                        aerialBtn.disabled = true;
                        aerialBtn.textContent = 'Fetching...';
                        await AerialFetch.fetch(lat, lon, zoom, apiKey);
                        aerialBtn.disabled = false;
                        aerialBtn.textContent = 'Fetch';
                    });
                }

                // ==================== STEP 2 VALIDATION ENGINE ====================

                // Helper: render a validation item
                function valItem(pass, label, detail) {
                    const icon = pass === true ? 'pass' : (pass === false ? 'fail' : 'warn');
                    const sym = pass === true ? '' : (pass === false ? '' : '!');
                    return '<div class="ws-val-item"><span class="ws-val-icon ' + icon + '">' + sym + '</span><span>' + label + '</span>' + (detail ? '<span class="ws-val-detail">' + detail + '</span>' : '') + '</div>';
                }

                // Helper: update a section badge
                function setBadge(id, state) {
                    const badge = document.getElementById(id);
                    if (!badge) return;
                    badge.className = 'ws-section-badge ' + state;
                    badge.textContent = state === 'valid' ? 'Complete' : (state === 'warning' ? 'Issues' : 'Incomplete');
                }

                // --- TMC COUNT INFO: live validation on change ---
                function validateTmcInfo() {
                    const panel = document.getElementById('val-tmc-info');
                    const items = document.getElementById('val-tmc-info-items');
                    const countDate = document.getElementById('ws-count-date')?.value;
                    const dayOfWeek = document.getElementById('ws-day-of-week')?.value;
                    const amStart = document.getElementById('ws-am-start')?.value;
                    const amEnd = document.getElementById('ws-am-end')?.value;
                    const pmStart = document.getElementById('ws-pm-start')?.value;
                    const pmEnd = document.getElementById('ws-pm-end')?.value;

                    // Only show panel once user starts filling fields
                    if (!countDate && !dayOfWeek) { panel.classList.remove('visible'); setBadge('badge-tmc-info', 'incomplete'); return; }

                    let html = '';
                    let allPass = true;
                    let hasWarning = false;

                    // Count date provided
                    html += valItem(!!countDate, 'Count date selected', countDate || 'Required');
                    if (!countDate) allPass = false;

                    // Day of week selected
                    html += valItem(!!dayOfWeek, 'Day of week selected', dayOfWeek ? dayOfWeek.charAt(0).toUpperCase() + dayOfWeek.slice(1) : 'Required');
                    if (!dayOfWeek) allPass = false;

                    // Preferred day check (Tue/Wed/Thu)
                    if (dayOfWeek) {
                        const preferred = ['tuesday','wednesday','thursday'].includes(dayOfWeek);
                        if (!preferred) {
                            html += valItem(null, 'Non-standard count day', 'Tue-Thu preferred per ADOT guidelines');
                            hasWarning = true;
                        } else {
                            html += valItem(true, 'Standard count day (Tue-Thu)', 'ADOT compliant');
                        }
                    }

                    // Date matches day-of-week
                    if (countDate && dayOfWeek) {
                        const d = new Date(countDate + 'T12:00:00');
                        const days = ['sunday','monday','tuesday','wednesday','thursday','friday','saturday'];
                        const actualDay = days[d.getDay()];
                        const match = actualDay === dayOfWeek;
                        html += valItem(match, 'Date matches day of week', match ? actualDay : 'Date is ' + actualDay + ', selected ' + dayOfWeek);
                        if (!match) { allPass = false; }
                    }

                    // AM window check
                    if (amStart && amEnd) {
                        const amOk = amStart <= '07:00' && amEnd >= '09:00';
                        html += valItem(amOk ? true : null, 'AM window covers peak (7:00-9:00)', amStart + ' - ' + amEnd);
                        if (!amOk) hasWarning = true;
                    }

                    // PM window check
                    if (pmStart && pmEnd) {
                        const pmOk = pmStart <= '16:00' && pmEnd >= '18:00';
                        html += valItem(pmOk ? true : null, 'PM window covers peak (4:00-6:00)', pmStart + ' - ' + pmEnd);
                        if (!pmOk) hasWarning = true;
                    }

                    items.innerHTML = html;
                    panel.classList.add('visible');
                    setBadge('badge-tmc-info', allPass ? (hasWarning ? 'warning' : 'valid') : 'warning');
                }

                // Bind live validation to TMC info fields
                ['ws-count-date','ws-day-of-week','ws-am-start','ws-am-end','ws-pm-start','ws-pm-end'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.addEventListener('change', validateTmcInfo);
                });

                // Auto-fill day-of-week from date
                const countDateEl = document.getElementById('ws-count-date');
                const dayOfWeekEl = document.getElementById('ws-day-of-week');
                if (countDateEl && dayOfWeekEl) {
                    countDateEl.addEventListener('change', () => {
                        if (countDateEl.value) {
                            const d = new Date(countDateEl.value + 'T12:00:00');
                            const days = ['','monday','tuesday','wednesday','thursday','friday',''];
                            const day = days[d.getDay()] || '';
                            if (day) { dayOfWeekEl.value = day; }
                        }
                    });
                }

                // --- TMC SPREADSHEET: upload + validate file ---
                const tmcDropZone = document.getElementById('ws-drop-zone-tmc');
                const tmcFileInfo = document.getElementById('ws-tmc-file-info');
                const parseTmcBtn = document.getElementById('ws-parse-tmc-btn');
                let tmcFileRef = null;

                function validateTmcFile(file) {
                    tmcFileRef = file;
                    const ext = file.name.split('.').pop().toLowerCase();
                    const sizeKB = file.size / 1024;
                    const sizeMB = sizeKB / 1024;

                    // Show file info
                    tmcFileInfo.innerHTML = '<div style="display:flex;align-items:center;gap:8px;padding:10px 14px;background:var(--bg-base);border:1px solid var(--success);border-radius:6px;font-size:13px;color:var(--text-light);"> ' + file.name + '<span style="ws-val-detail" style="color:var(--text-muted);font-size:11px;margin-left:auto;">' + (sizeKB < 1024 ? sizeKB.toFixed(1) + ' KB' : sizeMB.toFixed(2) + ' MB') + '</span></div>';

                    // Validate
                    const panel = document.getElementById('val-tmc-upload');
                    const items = document.getElementById('val-tmc-upload-items');
                    let html = '';
                    let allPass = true;

                    // File type
                    const validExt = ['xlsx','csv','xls'].includes(ext);
                    html += valItem(validExt, 'Valid file format', '.' + ext);
                    if (!validExt) allPass = false;

                    // File size
                    const sizeOk = file.size > 1024 && file.size < 52428800;
                    html += valItem(sizeOk, 'File size acceptable', sizeKB < 1024 ? sizeKB.toFixed(0) + ' KB' : sizeMB.toFixed(1) + ' MB');
                    if (!sizeOk) { allPass = false; html += valItem(false, file.size <= 1024 ? 'File too small  may be empty' : 'File too large (>50MB)', 'Check file'); }

                    // Filename check  should contain TMC or turning or count
                    const nameHint = /tmc|turning|count|movement/i.test(file.name);
                    html += valItem(nameHint ? true : null, 'Filename suggests TMC data', nameHint ? 'Detected' : 'No TMC keywords found  verify correct file');

                    // CSV-specific: try to read headers
                    if (ext === 'csv') {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            const firstLine = e.target.result.split('\n')[0];
                            const cols = firstLine.split(',').map(c => c.trim().replace(/"/g,''));
                            const rowCount = e.target.result.split('\n').filter(r => r.trim()).length - 1;

                            let csvHtml = '';
                            csvHtml += valItem(true, 'CSV readable', cols.length + ' columns, ' + rowCount + ' data rows');

                            // Check for expected TMC columns
                            const expectedCols = ['intersection','northbound','southbound','eastbound','westbound','left','through','right','time','period','am','pm'];
                            const foundCols = cols.filter(c => expectedCols.some(ec => c.toLowerCase().includes(ec)));
                            csvHtml += valItem(foundCols.length >= 2, 'TMC column headers detected', foundCols.length + ' of expected columns found');
                            if (foundCols.length < 2) {
                                csvHtml += valItem(null, 'Expected columns: Intersection, NB/SB/EB/WB, Left/Through/Right, Time/Period', 'Review spreadsheet format');
                            }

                            // Row count check
                            csvHtml += valItem(rowCount >= 4, 'Sufficient data rows', rowCount + ' rows');
                            if (rowCount < 4) csvHtml += valItem(false, 'Too few rows  TMC data typically has 12+ rows per intersection', 'Check data completeness');

                            items.innerHTML += csvHtml;
                        };
                        reader.readAsText(file.slice(0, 8192)); // Read first 8KB for headers
                    }

                    items.innerHTML = html;
                    panel.classList.add('visible');
                    parseTmcBtn.style.display = 'block';
                    setBadge('badge-tmc-upload', allPass ? 'valid' : 'warning');
                }

                if (tmcDropZone) {
                    tmcDropZone.addEventListener('click', () => {
                        const input = document.createElement('input');
                        input.type = 'file';
                        input.accept = '.xlsx,.csv,.xls';
                        input.onchange = () => { if (input.files.length) validateTmcFile(input.files[0]); };
                        input.click();
                    });
                    tmcDropZone.addEventListener('dragover', (e) => { e.preventDefault(); tmcDropZone.classList.add('dragover'); });
                    tmcDropZone.addEventListener('dragleave', () => { tmcDropZone.classList.remove('dragover'); });
                    tmcDropZone.addEventListener('drop', (e) => {
                        e.preventDefault();
                        tmcDropZone.classList.remove('dragover');
                        if (e.dataTransfer.files.length) validateTmcFile(e.dataTransfer.files[0]);
                    });
                }

                // Parse TMC button  deeper analysis
                if (parseTmcBtn) {
                    parseTmcBtn.addEventListener('click', () => {
                        parseTmcBtn.textContent = 'Parsing...';
                        parseTmcBtn.style.opacity = '0.7';

                        const parsedPanel = document.getElementById('val-tmc-parsed');
                        const parsedItems = document.getElementById('val-tmc-parsed-items');

                        setTimeout(() => {
                            let html = '';

                            if (tmcFileRef && tmcFileRef.name.endsWith('.csv')) {
                                const reader = new FileReader();
                                reader.onload = function(e) {
                                    const lines = e.target.result.split('\n').filter(r => r.trim());
                                    const headers = lines[0].split(',').map(c => c.trim().replace(/"/g,''));
                                    const dataRows = lines.length - 1;

                                    html += valItem(true, 'File parsed successfully', dataRows + ' records');
                                    html += valItem(true, 'Columns: ' + headers.slice(0,5).join(', ') + (headers.length > 5 ? '...' : ''), headers.length + ' total');

                                    // Check for zero/empty values
                                    let emptyCount = 0;
                                    for (let i = 1; i < Math.min(lines.length, 20); i++) {
                                        const vals = lines[i].split(',');
                                        vals.forEach(v => { if (!v.trim() || v.trim() === '0') emptyCount++; });
                                    }
                                    const emptyPct = ((emptyCount / (Math.min(dataRows, 19) * headers.length)) * 100).toFixed(0);
                                    html += valItem(emptyPct < 30, 'Data completeness', (100 - emptyPct) + '% cells populated');
                                    if (emptyPct >= 30) html += valItem(null, 'High percentage of empty/zero values', 'Review for missing count data');

                                    html += valItem(true, 'Ready for analysis', 'Proceed to Step 3: Trip Generation');

                                    parsedItems.innerHTML = html;
                                    parsedPanel.classList.add('visible');
                                };
                                reader.readAsText(tmcFileRef);
                            } else {
                                // XLSX  can't parse in browser without library, show guidance
                                html += valItem(true, 'XLSX file accepted', tmcFileRef ? tmcFileRef.name : '');
                                html += valItem(null, 'Full column analysis requires CSV format', 'Convert to CSV for detailed validation');
                                html += valItem(true, 'File staged for processing', 'Will be parsed during Step 3');
                                parsedItems.innerHTML = html;
                                parsedPanel.classList.add('visible');
                            }

                            parseTmcBtn.textContent = ' TMC Data Parsed';
                            parseTmcBtn.style.background = 'var(--success)';
                            parseTmcBtn.style.opacity = '1';
                            this.markFolderItem('folder-tmc-counts');
                        }, 800);
                    });
                }

                // --- INTERSECTION PHOTOS: upload + validate ---
                const photosDropZone = document.getElementById('ws-drop-zone-photos');
                const photosInfo = document.getElementById('ws-photos-info');

                function validatePhotos(files) {
                    const validExts = ['jpg','jpeg','png','heic','heif','webp'];
                    const fileArr = Array.from(files);

                    // Show file list
                    photosInfo.innerHTML = fileArr.map(f =>
                        '<div style="display:flex;align-items:center;gap:8px;padding:8px 12px;background:var(--bg-base);border:1px solid var(--blue);border-radius:6px;margin-bottom:6px;font-size:13px;color:var(--text-light);"> ' + f.name + '<span style="color:var(--text-muted);font-size:11px;margin-left:auto;">' + (f.size / 1024).toFixed(1) + ' KB</span></div>'
                    ).join('');

                    // Validate
                    const panel = document.getElementById('val-photos');
                    const items = document.getElementById('val-photos-items');
                    let html = '';
                    let allPass = true;

                    // File count
                    html += valItem(fileArr.length >= 1, 'Photos uploaded', fileArr.length + ' file(s)');

                    // Check each file type
                    const invalidFiles = fileArr.filter(f => !validExts.includes(f.name.split('.').pop().toLowerCase()));
                    if (invalidFiles.length > 0) {
                        html += valItem(false, 'Invalid file type(s)', invalidFiles.map(f => f.name).join(', '));
                        allPass = false;
                    } else {
                        html += valItem(true, 'All files are valid image formats', validExts.slice(0,4).join(', '));
                    }

                    // Size check  flag very small (<10KB, probably thumbnail) or very large (>20MB)
                    const tooSmall = fileArr.filter(f => f.size < 10240);
                    const tooLarge = fileArr.filter(f => f.size > 20971520);
                    if (tooSmall.length) {
                        html += valItem(null, tooSmall.length + ' file(s) under 10KB', 'May be thumbnails  verify image quality');
                    }
                    if (tooLarge.length) {
                        html += valItem(null, tooLarge.length + ' file(s) over 20MB', 'Consider compressing before submission');
                    }
                    if (!tooSmall.length && !tooLarge.length) {
                        html += valItem(true, 'File sizes within normal range', '');
                    }

                    // Check against Step 1 project data for intersection count
                    const proj = TseWorkflow._activeProject;
                    if (proj) {
                        const buildingCount = proj.buildings ? proj.buildings.length : 0;
                        const expectedPhotos = Math.max(buildingCount, 1);
                        html += valItem(fileArr.length >= expectedPhotos, 'Coverage check', fileArr.length + ' photos for ' + expectedPhotos + ' site location(s)');
                        if (fileArr.length < expectedPhotos) {
                            html += valItem(null, 'Recommend at least 1 photo per intersection/access point', 'Add more photos for complete documentation');
                        }
                    }

                    items.innerHTML = html;
                    panel.classList.add('visible');
                    setBadge('badge-photos', allPass ? 'valid' : 'warning');
                }

                if (photosDropZone) {
                    photosDropZone.addEventListener('click', () => {
                        const input = document.createElement('input');
                        input.type = 'file';
                        input.accept = '.jpg,.jpeg,.png,.heic,.heif,.webp';
                        input.multiple = true;
                        input.onchange = () => { if (input.files.length) validatePhotos(input.files); };
                        input.click();
                    });
                    photosDropZone.addEventListener('dragover', (e) => { e.preventDefault(); photosDropZone.classList.add('dragover'); });
                    photosDropZone.addEventListener('dragleave', () => { photosDropZone.classList.remove('dragover'); });
                    photosDropZone.addEventListener('drop', (e) => {
                        e.preventDefault();
                        photosDropZone.classList.remove('dragover');
                        if (e.dataTransfer.files.length) validatePhotos(e.dataTransfer.files);
                    });
                }

                // --- STEP 2 SUBMIT: final validation gate ---
                const submitStep2 = document.getElementById('ws-submit-step2');
                if (submitStep2) {
                    submitStep2.addEventListener('click', async () => {
                        // Run TMC info validation to make sure panel is showing
                        validateTmcInfo();

                        // Check if minimum requirements are met
                        const countDate = document.getElementById('ws-count-date')?.value;
                        const dayOfWeek = document.getElementById('ws-day-of-week')?.value;
                        if (!countDate || !dayOfWeek) {
                            submitStep2.textContent = 'Fill Required Fields Above';
                            submitStep2.style.background = '#ef4444';
                            setTimeout(() => { submitStep2.textContent = 'Submit Data Collection'; submitStep2.style.background = 'var(--gold)'; }, 2000);
                            return;
                        }

                        const step2Data = {
                            countDate,
                            dayOfWeek,
                            amStart: document.getElementById('ws-am-start')?.value,
                            amEnd: document.getElementById('ws-am-end')?.value,
                            pmStart: document.getElementById('ws-pm-start')?.value,
                            pmEnd: document.getElementById('ws-pm-end')?.value,
                            tmcUploaded: !!tmcFileInfo.innerHTML,
                            photosUploaded: !!photosInfo.innerHTML
                        };
                        await ProjectStore.saveStepData(this._activeProjectId, 2, step2Data);
                        if (this._activeProject) this._activeProject.stepData[2] = step2Data;

                        await this.markStepComplete(2);
                        if (tmcFileInfo.innerHTML) await this.markFolderItem('folder-tmc-counts');
                        if (photosInfo.innerHTML) await this.markFolderItem('folder-intersections');

                        submitStep2.textContent = ' Data Collection Saved';
                        submitStep2.style.background = 'var(--success)';
                        setTimeout(() => { submitStep2.textContent = 'Submit Data Collection'; submitStep2.style.background = 'var(--gold)'; }, 2000);
                    });
                }

                // ==================== STEP 3: TRIP GENERATION ====================

                // ITE Trip Rates reference (common Arizona land uses)
                const iteRates = {
                    '110': { name: 'Light Industrial', unit: 'KSF', amIn: 0.52, amOut: 0.09, pmIn: 0.09, pmOut: 0.51, daily: 4.96 },
                    '140': { name: 'Manufacturing', unit: 'KSF', amIn: 0.52, amOut: 0.07, pmIn: 0.07, pmOut: 0.50, daily: 3.82 },
                    '210': { name: 'Single-Family Housing', unit: 'DU', amIn: 0.19, amOut: 0.56, pmIn: 0.63, pmOut: 0.37, daily: 9.44 },
                    '220': { name: 'Multifamily Housing (Low-Rise)', unit: 'DU', amIn: 0.10, amOut: 0.41, pmIn: 0.40, pmOut: 0.22, daily: 6.74 },
                    '240': { name: 'Mobile Home Park', unit: 'DU', amIn: 0.10, amOut: 0.37, pmIn: 0.33, pmOut: 0.18, daily: 4.99 },
                    '310': { name: 'Hotel', unit: 'Room', amIn: 0.26, amOut: 0.33, pmIn: 0.31, pmOut: 0.22, daily: 8.36 },
                    '520': { name: 'Elementary School', unit: 'Student', amIn: 0.43, amOut: 0.28, pmIn: 0.15, pmOut: 0.34, daily: 1.29 },
                    '530': { name: 'High School', unit: 'Student', amIn: 0.38, amOut: 0.18, pmIn: 0.13, pmOut: 0.28, daily: 1.71 },
                    '560': { name: 'Church', unit: 'KSF', amIn: 0.31, amOut: 0.28, pmIn: 0.29, pmOut: 0.30, daily: 9.11 },
                    '565': { name: 'Day Care Center', unit: 'KSF', amIn: 5.36, amOut: 3.72, pmIn: 3.52, pmOut: 5.29, daily: 47.62 },
                    '610': { name: 'Hospital', unit: 'KSF', amIn: 0.70, amOut: 0.39, pmIn: 0.47, pmOut: 0.68, daily: 10.72 },
                    '710': { name: 'General Office', unit: 'KSF', amIn: 1.16, amOut: 0.20, pmIn: 0.25, pmOut: 1.07, daily: 9.74 },
                    '720': { name: 'Medical Office', unit: 'KSF', amIn: 2.04, amOut: 0.64, pmIn: 0.88, pmOut: 2.05, daily: 34.80 },
                    '820': { name: 'Shopping Center', unit: 'KSF', amIn: 0.62, amOut: 0.40, pmIn: 1.83, pmOut: 1.96, daily: 37.75 },
                    '850': { name: 'Supermarket', unit: 'KSF', amIn: 1.60, amOut: 1.49, pmIn: 4.67, pmOut: 4.57, daily: 106.78 },
                    '932': { name: 'Restaurant (Sit-Down)', unit: 'KSF', amIn: 0.65, amOut: 0.58, pmIn: 3.72, pmOut: 2.62, daily: 83.84 },
                    '934': { name: 'Fast-Food Restaurant', unit: 'KSF', amIn: 8.46, amOut: 7.70, pmIn: 16.74, pmOut: 15.82, daily: 470.95 },
                    '936': { name: 'Coffee/Donut Shop', unit: 'KSF', amIn: 42.33, amOut: 39.61, pmIn: 12.83, pmOut: 12.53, daily: 820.00 },
                    '944': { name: 'Gas Station w/ Convenience', unit: 'Pump', amIn: 7.32, amOut: 6.80, pmIn: 7.72, pmOut: 7.48, daily: 142.11 },
                    '945': { name: 'Gas Station w/ Convenience (GFA)', unit: 'KSF', amIn: 20.63, amOut: 19.31, pmIn: 21.14, pmOut: 21.47, daily: 548.54 }
                };

                // Build a trip gen row
                function buildTripRow(bldg) {
                    const code = bldg.luc || '';
                    const rate = iteRates[code];
                    const size = parseFloat(bldg.sqft) || 0;
                    const unit = rate ? rate.unit : 'KSF';
                    const divisor = unit === 'KSF' ? 1000 : 1;
                    const qty = unit === 'KSF' ? size / divisor : size;
                    const inputStyle = 'background:var(--bg-base);border:1px solid var(--blue);border-radius:4px;padding:6px;color:var(--text-light);font-size:12px;width:100%;box-sizing:border-box;text-align:center;';

                    const amIn = rate ? Math.round(rate.amIn * qty) : 0;
                    const amOut = rate ? Math.round(rate.amOut * qty) : 0;
                    const pmIn = rate ? Math.round(rate.pmIn * qty) : 0;
                    const pmOut = rate ? Math.round(rate.pmOut * qty) : 0;
                    const daily = rate ? Math.round(rate.daily * qty) : 0;

                    const row = document.createElement('tr');
                    row.innerHTML =
                        '<td style="font-size:12px;">' + (bldg.name || 'New Land Use') + '</td>' +
                        '<td><input type="text" class="trip-luc" value="' + code + '" placeholder="LUC" style="' + inputStyle + '"></td>' +
                        '<td><input type="number" class="trip-size" value="' + (bldg.sqft || '') + '" placeholder="Size" style="' + inputStyle + '"></td>' +
                        '<td style="font-size:11px;color:var(--text-muted);text-align:center;">' + unit + '</td>' +
                        '<td><input type="number" class="trip-am-in" value="' + amIn + '" style="' + inputStyle + '"></td>' +
                        '<td><input type="number" class="trip-am-out" value="' + amOut + '" style="' + inputStyle + '"></td>' +
                        '<td><input type="number" class="trip-pm-in" value="' + pmIn + '" style="' + inputStyle + '"></td>' +
                        '<td><input type="number" class="trip-pm-out" value="' + pmOut + '" style="' + inputStyle + '"></td>' +
                        '<td><input type="number" class="trip-daily" value="' + daily + '" style="' + inputStyle + '"></td>' +
                        '<td style="font-size:10px;color:var(--text-muted);text-align:center;">' + (rate ? 'ITE 11th' : 'Manual') + '</td>' +
                        '<td><button class="remove-building-btn" onclick="this.closest(\'tr\').remove(); recalcTrips();"></button></td>';

                    // Auto-recalc when ITE code or size changes
                    const lucInput = row.querySelector('.trip-luc');
                    const sizeInput = row.querySelector('.trip-size');
                    [lucInput, sizeInput].forEach(inp => {
                        inp.addEventListener('change', () => {
                            const newCode = lucInput.value.trim();
                            const newRate = iteRates[newCode];
                            const newSize = parseFloat(sizeInput.value) || 0;
                            const newUnit = newRate ? newRate.unit : 'KSF';
                            const newQty = newUnit === 'KSF' ? newSize / 1000 : newSize;

                            row.querySelector('td:nth-child(4)').textContent = newUnit;
                            row.querySelector('td:nth-child(10)').textContent = newRate ? 'ITE 11th' : 'Manual';

                            if (newRate) {
                                row.querySelector('.trip-am-in').value = Math.round(newRate.amIn * newQty);
                                row.querySelector('.trip-am-out').value = Math.round(newRate.amOut * newQty);
                                row.querySelector('.trip-pm-in').value = Math.round(newRate.pmIn * newQty);
                                row.querySelector('.trip-pm-out').value = Math.round(newRate.pmOut * newQty);
                                row.querySelector('.trip-daily').value = Math.round(newRate.daily * newQty);
                            }
                            recalcTrips();
                        });
                    });

                    // Recalc on manual trip edits
                    row.querySelectorAll('.trip-am-in,.trip-am-out,.trip-pm-in,.trip-pm-out,.trip-daily').forEach(inp => {
                        inp.addEventListener('change', recalcTrips);
                    });

                    return row;
                }

                // Recalculate totals and net trips
                function recalcTrips() {
                    let totals = { amIn: 0, amOut: 0, pmIn: 0, pmOut: 0, daily: 0 };
                    document.querySelectorAll('#trip-gen-tbody tr').forEach(row => {
                        totals.amIn += parseInt(row.querySelector('.trip-am-in')?.value) || 0;
                        totals.amOut += parseInt(row.querySelector('.trip-am-out')?.value) || 0;
                        totals.pmIn += parseInt(row.querySelector('.trip-pm-in')?.value) || 0;
                        totals.pmOut += parseInt(row.querySelector('.trip-pm-out')?.value) || 0;
                        totals.daily += parseInt(row.querySelector('.trip-daily')?.value) || 0;
                    });

                    document.getElementById('trip-total-am-in').textContent = totals.amIn;
                    document.getElementById('trip-total-am-out').textContent = totals.amOut;
                    document.getElementById('trip-total-pm-in').textContent = totals.pmIn;
                    document.getElementById('trip-total-pm-out').textContent = totals.pmOut;
                    document.getElementById('trip-total-daily').textContent = totals.daily;

                    // Apply reductions
                    const passby = parseFloat(document.getElementById('ws-passby-pct')?.value) || 0;
                    const internal = parseFloat(document.getElementById('ws-internal-pct')?.value) || 0;
                    const factor = (100 - passby) / 100 * (100 - internal) / 100;

                    document.getElementById('net-am-in').textContent = Math.round(totals.amIn * factor);
                    document.getElementById('net-am-out').textContent = Math.round(totals.amOut * factor);
                    document.getElementById('net-pm-in').textContent = Math.round(totals.pmIn * factor);
                    document.getElementById('net-pm-out').textContent = Math.round(totals.pmOut * factor);
                    document.getElementById('net-daily').textContent = Math.round(totals.daily * factor);

                    // Update badge
                    const hasTrips = totals.daily > 0;
                    setBadge('badge-trip-gen', hasTrips ? 'valid' : 'incomplete');

                    // Validate
                    const valPanel = document.getElementById('val-trip-gen');
                    const valItems = document.getElementById('val-trip-gen-items');
                    let html = '';

                    const rowCount = document.querySelectorAll('#trip-gen-tbody tr').length;
                    html += valItem(rowCount > 0, 'Land uses defined', rowCount + ' land use(s)');

                    // Check for zero-trip rows
                    let zeroRows = 0;
                    document.querySelectorAll('#trip-gen-tbody tr').forEach(row => {
                        const d = parseInt(row.querySelector('.trip-daily')?.value) || 0;
                        if (d === 0) zeroRows++;
                    });
                    if (zeroRows > 0) html += valItem(null, zeroRows + ' land use(s) with zero daily trips', 'Enter ITE code or manual trips');

                    html += valItem(totals.daily > 0, 'Total daily trips > 0', totals.daily + ' gross trips');

                    if (passby > 0 || internal > 0) {
                        html += valItem(true, 'Reductions applied', 'Pass-by: ' + passby + '%, Internal: ' + internal + '%');
                        const netDaily = Math.round(totals.daily * factor);
                        html += valItem(true, 'Net new daily trips', netDaily + ' trips');
                    }

                    const totalPeakAM = totals.amIn + totals.amOut;
                    const totalPeakPM = totals.pmIn + totals.pmOut;
                    if (totalPeakPM > 100) {
                        html += valItem(null, 'PM peak > 100 trips  TIA likely required by jurisdiction', totalPeakPM + ' PM peak trips');
                    }

                    valItems.innerHTML = html;
                    valPanel.classList.add('visible');
                }

                // Make functions globally accessible
                window.recalcTrips = recalcTrips;
                window.populateStep3 = populateStep3;

                // Populate Step 3 when panel opens
                function populateStep3() {
                    const tbody = document.getElementById('trip-gen-tbody');
                    const depPanel = document.getElementById('val-step3-dep');
                    const depItems = document.getElementById('val-step3-dep-items');

                    // Check dependency on Step 1
                    const proj = TseWorkflow._activeProject;
                    if (!proj) {
                        depItems.innerHTML = valItem(false, 'No project data found', 'Complete Step 1 first');
                        depPanel.style.borderColor = '#ef4444';
                        return;
                    }
                    const hasBldgs = proj.buildings && proj.buildings.length > 0;
                    let depHtml = '';
                    depHtml += valItem(true, 'Project loaded', proj.name);
                    depHtml += valItem(hasBldgs, 'Buildings/land uses from Step 1', hasBldgs ? proj.buildings.length + ' land use(s)' : 'No buildings defined  add manually below');

                    const hasTmc = proj.folderItems && proj.folderItems['folder-tmc-counts'];
                    depHtml += valItem(hasTmc ? true : null, 'TMC data from Step 2', hasTmc ? 'Available' : 'Not yet uploaded  can proceed without');

                    depItems.innerHTML = depHtml;
                    depPanel.style.borderColor = hasBldgs ? 'var(--success)' : '#fbbf24';

                    // Only populate if tbody is empty (don't overwrite manual edits)
                    if (tbody.children.length === 0 && hasBldgs) {
                        proj.buildings.forEach(bldg => {
                            tbody.appendChild(buildTripRow(bldg));
                        });
                        recalcTrips();
                    }
                }

                // Bind: reduction inputs recalc
                ['ws-passby-pct', 'ws-internal-pct'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.addEventListener('input', recalcTrips);
                });

                // Bind: add trip row button
                const addTripRowBtn = document.getElementById('add-trip-row-btn');
                if (addTripRowBtn) {
                    addTripRowBtn.addEventListener('click', () => {
                        const tbody = document.getElementById('trip-gen-tbody');
                        tbody.appendChild(buildTripRow({ name: 'New Land Use', luc: '', sqft: '' }));
                    });
                }

                // Bind: Submit Step 3
                const submitStep3 = document.getElementById('ws-submit-step3');
                if (submitStep3) {
                    submitStep3.addEventListener('click', async () => {
                        const rows = document.querySelectorAll('#trip-gen-tbody tr');
                        if (rows.length === 0) {
                            submitStep3.textContent = 'Add Land Uses First';
                            submitStep3.style.background = '#ef4444';
                            setTimeout(() => { submitStep3.textContent = 'Submit Trip Generation'; submitStep3.style.background = 'var(--gold)'; }, 2000);
                            return;
                        }

                        // Save trip data
                        const tripData = [];
                        rows.forEach(row => {
                            tripData.push({
                                name: row.querySelector('td:first-child')?.textContent,
                                luc: row.querySelector('.trip-luc')?.value,
                                size: row.querySelector('.trip-size')?.value,
                                amIn: row.querySelector('.trip-am-in')?.value,
                                amOut: row.querySelector('.trip-am-out')?.value,
                                pmIn: row.querySelector('.trip-pm-in')?.value,
                                pmOut: row.querySelector('.trip-pm-out')?.value,
                                daily: row.querySelector('.trip-daily')?.value
                            });
                        });

                        const step3Data = {
                            trips: tripData,
                            passby: document.getElementById('ws-passby-pct')?.value,
                            internal: document.getElementById('ws-internal-pct')?.value,
                            notes: document.getElementById('ws-reduction-notes')?.value,
                            netAmIn: document.getElementById('net-am-in')?.textContent,
                            netAmOut: document.getElementById('net-am-out')?.textContent,
                            netPmIn: document.getElementById('net-pm-in')?.textContent,
                            netPmOut: document.getElementById('net-pm-out')?.textContent,
                            netDaily: document.getElementById('net-daily')?.textContent
                        };
                        await ProjectStore.saveStepData(this._activeProjectId, 3, step3Data);
                        if (this._activeProject) this._activeProject.stepData[3] = step3Data;

                        await this.markStepComplete(3);
                        await this.markFolderItem('folder-trip-calcs');
                        await this.markFolderItem('folder-trip-worksheet');

                        submitStep3.textContent = ' Trip Generation Saved';
                        submitStep3.style.background = 'var(--success)';
                        setTimeout(() => { submitStep3.textContent = 'Submit Trip Generation'; submitStep3.style.background = 'var(--gold)'; }, 2000);
                    });
                }

                // ==================== STEP 4: TRIP DISTRIBUTION ====================

                const distInputStyle = 'background:var(--bg-base);border:1px solid var(--blue);border-radius:4px;padding:6px;color:var(--text-light);font-size:12px;width:100%;box-sizing:border-box;text-align:center;';

                function buildDistRow(routeName, direction) {
                    const row = document.createElement('tr');
                    row.innerHTML =
                        '<td><input type="text" class="dist-route" value="' + (routeName || '') + '" placeholder="e.g., Oracle Rd" style="' + distInputStyle + 'text-align:left;"></td>' +
                        '<td><select class="dist-dir" style="' + distInputStyle + '">' +
                            '<option value="NB"' + (direction === 'NB' ? ' selected' : '') + '>NB</option>' +
                            '<option value="SB"' + (direction === 'SB' ? ' selected' : '') + '>SB</option>' +
                            '<option value="EB"' + (direction === 'EB' ? ' selected' : '') + '>EB</option>' +
                            '<option value="WB"' + (direction === 'WB' ? ' selected' : '') + '>WB</option>' +
                        '</select></td>' +
                        '<td><input type="number" class="dist-am-pct" value="0" min="0" max="100" step="1" style="' + distInputStyle + '"></td>' +
                        '<td><input type="number" class="dist-pm-pct" value="0" min="0" max="100" step="1" style="' + distInputStyle + '"></td>' +
                        '<td class="dist-am-trips" style="text-align:center;font-size:12px;color:var(--text-light);">0</td>' +
                        '<td class="dist-pm-trips" style="text-align:center;font-size:12px;color:var(--text-light);">0</td>' +
                        '<td><button class="remove-building-btn" onclick="this.closest(\'tr\').remove(); recalcDist();"></button></td>';

                    row.querySelectorAll('.dist-am-pct,.dist-pm-pct').forEach(inp => {
                        inp.addEventListener('input', recalcDist);
                    });
                    return row;
                }

                function recalcDist() {
                    // Get net trips from Step 3
                    const d = TseWorkflow._activeProject?.stepData?.[3];
                    let netAM = 0, netPM = 0;
                    if (d) {
                        netAM = (parseInt(d.netAmIn) || 0) + (parseInt(d.netAmOut) || 0);
                        netPM = (parseInt(d.netPmIn) || 0) + (parseInt(d.netPmOut) || 0);
                    }

                    let totalAmPct = 0, totalPmPct = 0, totalAmTrips = 0, totalPmTrips = 0;

                    document.querySelectorAll('#dist-tbody tr').forEach(row => {
                        const amPct = parseFloat(row.querySelector('.dist-am-pct')?.value) || 0;
                        const pmPct = parseFloat(row.querySelector('.dist-pm-pct')?.value) || 0;
                        const amTrips = Math.round(netAM * amPct / 100);
                        const pmTrips = Math.round(netPM * pmPct / 100);

                        row.querySelector('.dist-am-trips').textContent = amTrips;
                        row.querySelector('.dist-pm-trips').textContent = pmTrips;

                        totalAmPct += amPct;
                        totalPmPct += pmPct;
                        totalAmTrips += amTrips;
                        totalPmTrips += pmTrips;
                    });

                    document.getElementById('dist-total-am-pct').textContent = totalAmPct + '%';
                    document.getElementById('dist-total-pm-pct').textContent = totalPmPct + '%';
                    document.getElementById('dist-total-am-trips').textContent = totalAmTrips;
                    document.getElementById('dist-total-pm-trips').textContent = totalPmTrips;

                    // Badge
                    const hasRows = document.querySelectorAll('#dist-tbody tr').length > 0;
                    const pctValid = Math.abs(totalAmPct - 100) <= 1 && Math.abs(totalPmPct - 100) <= 1;
                    setBadge('badge-dist-split', hasRows && pctValid ? 'valid' : (hasRows ? 'warning' : 'incomplete'));

                    // Validation panel
                    const valPanel = document.getElementById('val-dist');
                    const valItems = document.getElementById('val-dist-items');
                    let html = '';

                    html += valItem(hasRows, 'Distribution routes defined', document.querySelectorAll('#dist-tbody tr').length + ' route(s)');
                    html += valItem(Math.abs(totalAmPct - 100) <= 1, 'AM percentages sum to 100%', totalAmPct + '%');
                    html += valItem(Math.abs(totalPmPct - 100) <= 1, 'PM percentages sum to 100%', totalPmPct + '%');

                    if (Math.abs(totalAmPct - 100) > 1) html += valItem(false, 'AM distribution does not equal 100%', 'Adjust percentages (' + (100 - totalAmPct) + '% remaining)');
                    if (Math.abs(totalPmPct - 100) > 1) html += valItem(false, 'PM distribution does not equal 100%', 'Adjust percentages (' + (100 - totalPmPct) + '% remaining)');

                    if (netAM > 0) {
                        html += valItem(true, 'Net AM peak trips from Step 3', netAM + ' trips');
                        html += valItem(true, 'Net PM peak trips from Step 3', netPM + ' trips');
                    } else {
                        html += valItem(null, 'No trip data from Step 3', 'Complete Step 3 for trip calculations');
                    }

                    valItems.innerHTML = html;
                    valPanel.classList.add('visible');
                }

                window.recalcDist = recalcDist;

                function populateStep4() {
                    const depPanel = document.getElementById('val-step4-dep');
                    const depItems = document.getElementById('val-step4-dep-items');
                    const tbody = document.getElementById('dist-tbody');

                    // Dependency check
                    const step3 = TseWorkflow._activeProject?.stepData?.[3];
                    const proj = TseWorkflow._activeProject;
                    let depHtml = '';

                    if (proj) {
                        depHtml += valItem(true, 'Project loaded', proj.name);
                    } else {
                        depHtml += valItem(false, 'No project data', 'Complete Step 1 first');
                    }

                    if (step3) {
                        const netAM = (parseInt(step3.netAmIn) || 0) + (parseInt(step3.netAmOut) || 0);
                        const netPM = (parseInt(step3.netPmIn) || 0) + (parseInt(step3.netPmOut) || 0);
                        depHtml += valItem(true, 'Trip generation data available', netAM + ' AM / ' + netPM + ' PM net trips');
                        depPanel.style.borderColor = 'var(--success)';
                    } else {
                        depHtml += valItem(null, 'No trip generation data', 'Complete Step 3  trips will show as 0 until then');
                        depPanel.style.borderColor = '#fbbf24';
                    }

                    depItems.innerHTML = depHtml;

                    // Populate default 4 rows if empty
                    if (tbody.children.length === 0) {
                        tbody.appendChild(buildDistRow('', 'NB'));
                        tbody.appendChild(buildDistRow('', 'SB'));
                        tbody.appendChild(buildDistRow('', 'EB'));
                        tbody.appendChild(buildDistRow('', 'WB'));
                        recalcDist();
                    }
                }

                window.populateStep4 = populateStep4;

                // Bind: method select updates badge
                const distMethodEl = document.getElementById('ws-dist-method');
                if (distMethodEl) {
                    distMethodEl.addEventListener('change', () => {
                        setBadge('badge-dist-method', distMethodEl.value ? 'valid' : 'incomplete');
                    });
                }

                // Bind: add route row
                const addDistRowBtn = document.getElementById('add-dist-row-btn');
                if (addDistRowBtn) {
                    addDistRowBtn.addEventListener('click', () => {
                        document.getElementById('dist-tbody').appendChild(buildDistRow('', 'NB'));
                    });
                }

                // Bind: Submit Step 4
                const submitStep4 = document.getElementById('ws-submit-step4');
                if (submitStep4) {
                    submitStep4.addEventListener('click', async () => {
                        const rows = document.querySelectorAll('#dist-tbody tr');
                        if (rows.length === 0) {
                            submitStep4.textContent = 'Add Routes First';
                            submitStep4.style.background = '#ef4444';
                            setTimeout(() => { submitStep4.textContent = 'Submit Trip Distribution'; submitStep4.style.background = 'var(--gold)'; }, 2000);
                            return;
                        }

                        // Save distribution data
                        const distData = [];
                        rows.forEach(row => {
                            distData.push({
                                route: row.querySelector('.dist-route')?.value,
                                direction: row.querySelector('.dist-dir')?.value,
                                amPct: row.querySelector('.dist-am-pct')?.value,
                                pmPct: row.querySelector('.dist-pm-pct')?.value,
                                amTrips: row.querySelector('.dist-am-trips')?.textContent,
                                pmTrips: row.querySelector('.dist-pm-trips')?.textContent
                            });
                        });

                        const step4Data = {
                            method: document.getElementById('ws-dist-method')?.value,
                            source: document.getElementById('ws-dist-source')?.value,
                            notes: document.getElementById('ws-dist-notes')?.value,
                            routes: distData
                        };
                        await ProjectStore.saveStepData(this._activeProjectId, 4, step4Data);
                        if (this._activeProject) this._activeProject.stepData[4] = step4Data;

                        await this.markStepComplete(4);
                        await this.markFolderItem('folder-distribution');

                        submitStep4.textContent = ' Trip Distribution Saved';
                        submitStep4.style.background = 'var(--success)';
                        setTimeout(() => { submitStep4.textContent = 'Submit Trip Distribution'; submitStep4.style.background = 'var(--gold)'; }, 2000);
                    });
                }

                // ==================== STEP 5: FUTURE VOLUMES JS ====================

                function buildExistingVolRow(location = '', direction = 'NB') {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td><input type="text" class="ws-input evol-location" value="${location}" placeholder="e.g. Main St & 1st Ave" style="width:100%;"></td>
                        <td><select class="ws-input evol-dir" style="width:70px;">
                            <option value="NB" ${direction==='NB'?'selected':''}>NB</option>
                            <option value="SB" ${direction==='SB'?'selected':''}>SB</option>
                            <option value="EB" ${direction==='EB'?'selected':''}>EB</option>
                            <option value="WB" ${direction==='WB'?'selected':''}>WB</option>
                        </select></td>
                        <td><input type="number" class="ws-input evol-am" min="0" value="0" style="width:70px;"></td>
                        <td><input type="number" class="ws-input evol-pm" min="0" value="0" style="width:70px;"></td>
                        <td><input type="number" class="ws-input evol-daily" min="0" value="0" style="width:80px;"></td>
                    `;
                    tr.querySelectorAll('input, select').forEach(el => el.addEventListener('change', recalcVolumes));
                    return tr;
                }

                function recalcVolumes() {
                    const baseYear = parseInt(document.getElementById('ws-vol-base-year')?.value) || 0;
                    const openYear = parseInt(document.getElementById('ws-vol-open-year')?.value) || 0;
                    const horizonYear = parseInt(document.getElementById('ws-vol-horizon-year')?.value) || 0;
                    const growthRate = parseFloat(document.getElementById('ws-vol-growth-rate')?.value) || 0;

                    // Calculate growth factors
                    const yearsToOpen = openYear - baseYear;
                    const yearsToHorizon = horizonYear - baseYear;
                    const openFactor = yearsToOpen > 0 ? Math.pow(1 + growthRate / 100, yearsToOpen) : 1;
                    const horizonFactor = yearsToHorizon > 0 ? Math.pow(1 + growthRate / 100, yearsToHorizon) : 1;

                    document.getElementById('vol-open-factor').textContent = openFactor.toFixed(3);
                    document.getElementById('vol-horizon-factor').textContent = horizonFactor.toFixed(3);
                    document.getElementById('vol-years-open').textContent = yearsToOpen > 0 ? yearsToOpen : '';
                    document.getElementById('vol-years-horizon').textContent = yearsToHorizon > 0 ? yearsToHorizon : '';

                    // Get site trips from Step 3 + Step 4
                    const step3 = TseWorkflow._activeProject?.stepData?.[3] || {};
                    const step4 = TseWorkflow._activeProject?.stepData?.[4] || {};

                    const siteAmIn = parseInt(step3.netAmIn) || 0;
                    const siteAmOut = parseInt(step3.netAmOut) || 0;
                    const sitePmIn = parseInt(step3.netPmIn) || 0;
                    const sitePmOut = parseInt(step3.netPmOut) || 0;

                    document.getElementById('vol-site-am-in').textContent = siteAmIn || '';
                    document.getElementById('vol-site-am-out').textContent = siteAmOut || '';
                    document.getElementById('vol-site-pm-in').textContent = sitePmIn || '';
                    document.getElementById('vol-site-pm-out').textContent = sitePmOut || '';

                    // Build scenario rows from existing volumes
                    const scenarioTbody = document.getElementById('vol-scenarios-tbody');
                    scenarioTbody.innerHTML = '';
                    const existingRows = document.querySelectorAll('#existing-vol-tbody tr');
                    let hasData = false;

                    existingRows.forEach(row => {
                        const loc = row.querySelector('.evol-location')?.value || '';
                        const dir = row.querySelector('.evol-dir')?.value || '';
                        const exAM = parseInt(row.querySelector('.evol-am')?.value) || 0;
                        const exPM = parseInt(row.querySelector('.evol-pm')?.value) || 0;

                        if (!loc && exAM === 0 && exPM === 0) return;
                        hasData = true;

                        // Background = existing * growth factor
                        const bgOpenAM = Math.round(exAM * openFactor);
                        const bgOpenPM = Math.round(exPM * openFactor);
                        const bgHorzAM = Math.round(exAM * horizonFactor);
                        const bgHorzPM = Math.round(exPM * horizonFactor);

                        // Site trips per direction from Step 4 distribution
                        let siteDirAM = 0, siteDirPM = 0;
                        if (step4.routes) {
                            step4.routes.forEach(r => {
                                if (r.direction === dir) {
                                    siteDirAM += parseInt(r.amTrips) || 0;
                                    siteDirPM += parseInt(r.pmTrips) || 0;
                                }
                            });
                        }

                        // Total future = background + site
                        const totalOpenAM = bgOpenAM + siteDirAM;
                        const totalOpenPM = bgOpenPM + siteDirPM;
                        const totalHorzAM = bgHorzAM + siteDirAM;
                        const totalHorzPM = bgHorzPM + siteDirPM;

                        const sr = document.createElement('tr');
                        sr.innerHTML = `
                            <td>${loc}</td>
                            <td>${dir}</td>
                            <td>${exAM}</td><td>${exPM}</td>
                            <td>${bgOpenAM}</td><td>${bgOpenPM}</td>
                            <td>${bgHorzAM}</td><td>${bgHorzPM}</td>
                            <td style="color: var(--gold);">${siteDirAM}</td><td style="color: var(--gold);">${siteDirPM}</td>
                            <td style="font-weight:600; color: var(--success);">${totalOpenAM}</td><td style="font-weight:600; color: var(--success);">${totalOpenPM}</td>
                            <td style="font-weight:600; color: var(--success);">${totalHorzAM}</td><td style="font-weight:600; color: var(--success);">${totalHorzPM}</td>
                        `;
                        scenarioTbody.appendChild(sr);
                    });

                    // Update badges
                    setBadge('badge-growth-params', (baseYear > 0 && openYear > 0 && growthRate > 0) ? 'valid' : 'incomplete');
                    setBadge('badge-existing-vol', hasData ? 'valid' : 'incomplete');
                    setBadge('badge-vol-scenarios', hasData ? 'valid' : 'incomplete');

                    // Validation
                    const valItems = document.getElementById('val-volumes-items');
                    const valPanel = document.getElementById('val-volumes');
                    if (valItems) {
                        let html = '';
                        html += valItem(baseYear > 2000, 'Base year set', baseYear > 2000 ? `${baseYear}` : 'Enter base year');
                        html += valItem(openYear > 0 && horizonYear > 0, 'Project years from Step 1', (openYear > 0) ? `Opening: ${openYear}, Horizon: ${horizonYear}` : 'Complete Step 1 first');
                        html += valItem(growthRate > 0, 'Growth rate defined', growthRate > 0 ? `${growthRate}% annually` : 'Set in Step 1');
                        html += valItem(hasData, 'Existing volumes entered', hasData ? `${existingRows.length} locations` : 'Add at least one location');
                        html += valItem(siteAmIn > 0 || siteAmOut > 0, 'Site trips from Step 3', (siteAmIn > 0 || siteAmOut > 0) ? 'Available' : 'Complete Step 3 first');
                        valItems.innerHTML = html;
                        valPanel.classList.add('visible');
                    }
                }

                function populateStep5() {
                    // Dependency check
                    const step3 = TseWorkflow._activeProject?.stepData?.[3];
                    const step4 = TseWorkflow._activeProject?.stepData?.[4];
                    const proj = TseWorkflow._activeProject || {};
                    let depHtml = '';

                    depHtml += valItem(!!step3, 'Step 3  Trip Generation', step3 ? 'Complete' : 'Not submitted  net trips needed');
                    depHtml += valItem(!!step4, 'Step 4  Trip Distribution', step4 ? 'Complete' : 'Not submitted  directional splits needed');
                    depHtml += valItem(!!proj.openingYear, 'Step 1  Opening/Horizon Years', proj.openingYear ? 'Available' : 'Not set  complete Step 1');

                    const depItems = document.getElementById('dep-check-step5-items');
                    if (depItems) depItems.innerHTML = depHtml;

                    // Auto-fill from Step 1 project data
                    if (proj.openingYear) {
                        document.getElementById('ws-vol-open-year').value = proj.openingYear;
                    }
                    if (proj.horizonYear) {
                        document.getElementById('ws-vol-horizon-year').value = proj.horizonYear;
                    }
                    if (proj.growthRate) {
                        document.getElementById('ws-vol-growth-rate').value = proj.growthRate;
                    }

                    // Seed existing volume rows if empty
                    const tbody = document.getElementById('existing-vol-tbody');
                    if (tbody && tbody.rows.length === 0) {
                        // If Step 4 has routes, seed from those
                        if (step4) {
                            if (step4.routes && step4.routes.length > 0) {
                                step4.routes.forEach(r => {
                                    tbody.appendChild(buildExistingVolRow(r.route || '', r.direction || 'NB'));
                                });
                            } else {
                                // Default 4 cardinal directions
                                ['NB','SB','EB','WB'].forEach(d => tbody.appendChild(buildExistingVolRow('', d)));
                            }
                        } else {
                            ['NB','SB','EB','WB'].forEach(d => tbody.appendChild(buildExistingVolRow('', d)));
                        }
                    }

                    recalcVolumes();
                }
                window.recalcVolumes = recalcVolumes;
                window.populateStep5 = populateStep5;

                // Bind: add existing volume row
                const addExistVolBtn = document.getElementById('add-existing-vol-btn');
                if (addExistVolBtn) {
                    addExistVolBtn.addEventListener('click', () => {
                        document.getElementById('existing-vol-tbody').appendChild(buildExistingVolRow('', 'NB'));
                    });
                }

                // Bind: base year change triggers recalc
                const baseYearEl = document.getElementById('ws-vol-base-year');
                if (baseYearEl) {
                    baseYearEl.addEventListener('change', recalcVolumes);
                }

                // Bind: Submit Step 5
                const submitStep5 = document.getElementById('ws-submit-step5');
                if (submitStep5) {
                    submitStep5.addEventListener('click', async () => {
                        const rows = document.querySelectorAll('#existing-vol-tbody tr');
                        if (rows.length === 0) {
                            submitStep5.textContent = 'Add Volumes First';
                            submitStep5.style.background = '#ef4444';
                            setTimeout(() => { submitStep5.textContent = 'Submit Future Volumes'; submitStep5.style.background = 'var(--gold)'; }, 2000);
                            return;
                        }

                        const existingVolumes = [];
                        rows.forEach(row => {
                            existingVolumes.push({
                                location: row.querySelector('.evol-location')?.value,
                                direction: row.querySelector('.evol-dir')?.value,
                                amPeak: row.querySelector('.evol-am')?.value,
                                pmPeak: row.querySelector('.evol-pm')?.value,
                                daily: row.querySelector('.evol-daily')?.value
                            });
                        });

                        const step5Data = {
                            baseYear: document.getElementById('ws-vol-base-year')?.value,
                            openYear: document.getElementById('ws-vol-open-year')?.value,
                            horizonYear: document.getElementById('ws-vol-horizon-year')?.value,
                            growthRate: document.getElementById('ws-vol-growth-rate')?.value,
                            openFactor: document.getElementById('vol-open-factor')?.textContent,
                            horizonFactor: document.getElementById('vol-horizon-factor')?.textContent,
                            existingVolumes: existingVolumes
                        };
                        await ProjectStore.saveStepData(this._activeProjectId, 5, step5Data);
                        if (this._activeProject) this._activeProject.stepData[5] = step5Data;

                        await this.markStepComplete(5);
                        await this.markFolderItem('folder-volumes');

                        submitStep5.textContent = ' Future Volumes Saved';
                        submitStep5.style.background = 'var(--success)';
                        setTimeout(() => { submitStep5.textContent = 'Submit Future Volumes'; submitStep5.style.background = 'var(--gold)'; }, 2000);
                    });
                }

                // ==================== STEP 6: CAPACITY ANALYSIS JS ====================

                function buildLosRow(intersection = '', control = 'Signal') {
                    const tr = document.createElement('tr');
                    const losOpts = ['','A','B','C','D','E','F'].map(g => `<option value="${g}">${g}</option>`).join('');
                    tr.innerHTML = `
                        <td><input type="text" class="ws-input los-intersection" value="${intersection}" placeholder="e.g. Main St & 1st Ave" style="width:100%;"></td>
                        <td><select class="ws-input los-control" style="width:90px;">
                            <option value="Signal" ${control==='Signal'?'selected':''}>Signal</option>
                            <option value="TWSC" ${control==='TWSC'?'selected':''}>TWSC</option>
                            <option value="AWSC" ${control==='AWSC'?'selected':''}>AWSC</option>
                            <option value="Roundabout" ${control==='Roundabout'?'selected':''}>Roundabout</option>
                            <option value="Unsig" ${control==='Unsig'?'selected':''}>Unsig</option>
                        </select></td>
                        <td><select class="ws-input los-peak" style="width:60px;">
                            <option value="AM">AM</option>
                            <option value="PM">PM</option>
                        </select></td>
                        <td><select class="ws-input los-ex-grade" style="width:50px;">${losOpts}</select></td>
                        <td><input type="number" class="ws-input los-ex-delay" min="0" step="0.1" value="" placeholder="" style="width:60px;"></td>
                        <td><select class="ws-input los-bg-grade" style="width:50px;">${losOpts}</select></td>
                        <td><input type="number" class="ws-input los-bg-delay" min="0" step="0.1" value="" placeholder="" style="width:60px;"></td>
                        <td><select class="ws-input los-tf-grade" style="width:50px;">${losOpts}</select></td>
                        <td><input type="number" class="ws-input los-tf-delay" min="0" step="0.1" value="" placeholder="" style="width:60px;"></td>
                        <td><select class="ws-input los-mitigation" style="width:70px;">
                            <option value="No">No</option>
                            <option value="Yes">Yes</option>
                        </select></td>
                    `;
                    tr.querySelectorAll('input, select').forEach(el => el.addEventListener('change', validateCapacity));
                    return tr;
                }

                function validateCapacity() {
                    const synchroRows = document.querySelectorAll('#synchro-tbody tr');
                    let filesCount = 0;
                    synchroRows.forEach(row => {
                        if (row.querySelector('.cap-filename')?.value.trim()) filesCount++;
                    });

                    const losRows = document.querySelectorAll('#los-tbody tr');
                    let losCount = 0;
                    let mitigationNeeded = false;
                    losRows.forEach(row => {
                        const grade = row.querySelector('.los-tf-grade')?.value;
                        if (grade && grade !== '') losCount++;
                        if (row.querySelector('.los-mitigation')?.value === 'Yes') mitigationNeeded = true;
                    });

                    const mitigationNotes = document.getElementById('ws-mitigation-notes')?.value.trim();

                    setBadge('badge-synchro-files', filesCount > 0 ? 'valid' : 'incomplete');
                    setBadge('badge-los-table', losCount > 0 ? 'valid' : 'incomplete');

                    // Validation panel
                    const valItems = document.getElementById('val-capacity-items');
                    const valPanel = document.getElementById('val-capacity');
                    if (valItems) {
                        let html = '';
                        html += valItem(filesCount > 0, 'Model files referenced', filesCount > 0 ? `${filesCount} scenario(s) documented` : 'Enter at least one filename');
                        html += valItem(losCount > 0, 'LOS results entered', losCount > 0 ? `${losCount} intersection result(s)` : 'Add intersection LOS data');
                        html += valItem(!mitigationNeeded || mitigationNotes.length > 0, 'Mitigation documented', mitigationNeeded ? (mitigationNotes ? 'Notes provided' : 'Mitigation flagged  add notes') : 'No mitigation needed');
                        const allGradesOk = Array.from(losRows).every(r => {
                            const g = r.querySelector('.los-tf-grade')?.value;
                            return !g || g === '' || ['A','B','C','D'].includes(g);
                        });
                        html += valItem(allGradesOk, 'Acceptable LOS (A-D)', allGradesOk ? 'All intersections pass' : 'One or more intersections at LOS E/F');
                        valItems.innerHTML = html;
                        valPanel.classList.add('visible');
                    }
                }

                function populateStep6() {
                    // Dependency check
                    const step5 = TseWorkflow._activeProject?.stepData?.[5];
                    const step3 = TseWorkflow._activeProject?.stepData?.[3];
                    let depHtml = '';
                    depHtml += valItem(!!step5, 'Step 5  Future Volumes', step5 ? 'Complete' : 'Not submitted  volume scenarios needed');
                    depHtml += valItem(!!step3, 'Step 3  Trip Generation', step3 ? 'Complete' : 'Not submitted');
                    const depItems = document.getElementById('dep-check-step6-items');
                    if (depItems) depItems.innerHTML = depHtml;

                    // Seed LOS rows from Step 5 existing volumes if empty
                    const losTbody = document.getElementById('los-tbody');
                    if (losTbody && losTbody.rows.length === 0) {
                        if (step5) {
                            if (step5.existingVolumes && step5.existingVolumes.length > 0) {
                                // Group by unique locations
                                const locations = [...new Set(step5.existingVolumes.map(v => v.location).filter(Boolean))];
                                locations.forEach(loc => {
                                    // AM row
                                    losTbody.appendChild(buildLosRow(loc, 'Signal'));
                                    // PM row
                                    const pmRow = buildLosRow(loc, 'Signal');
                                    pmRow.querySelector('.los-peak').value = 'PM';
                                    losTbody.appendChild(pmRow);
                                });
                            }
                        }
                        if (losTbody.rows.length === 0) {
                            // Default: two rows
                            losTbody.appendChild(buildLosRow('', 'Signal'));
                            const pmRow = buildLosRow('', 'Signal');
                            pmRow.querySelector('.los-peak').value = 'PM';
                            losTbody.appendChild(pmRow);
                        }
                    }
                    validateCapacity();
                }
                window.validateCapacity = validateCapacity;
                window.populateStep6 = populateStep6;

                // Bind: add LOS row
                const addLosRowBtn = document.getElementById('add-los-row-btn');
                if (addLosRowBtn) {
                    addLosRowBtn.addEventListener('click', () => {
                        document.getElementById('los-tbody').appendChild(buildLosRow('', 'Signal'));
                    });
                }

                // Bind: synchro file changes trigger validation
                document.querySelectorAll('#synchro-tbody input').forEach(el => el.addEventListener('change', validateCapacity));

                // Bind: Submit Step 6
                const submitStep6 = document.getElementById('ws-submit-step6');
                if (submitStep6) {
                    submitStep6.addEventListener('click', async () => {
                        // Save synchro models
                        const synchroData = [];
                        document.querySelectorAll('#synchro-tbody tr').forEach(row => {
                            synchroData.push({
                                scenario: row.querySelector('td:first-child')?.textContent.trim(),
                                software: row.querySelector('.cap-software')?.value,
                                filename: row.querySelector('.cap-filename')?.value,
                                notes: row.querySelector('.cap-file-notes')?.value
                            });
                        });

                        // Save LOS results
                        const losData = [];
                        document.querySelectorAll('#los-tbody tr').forEach(row => {
                            losData.push({
                                intersection: row.querySelector('.los-intersection')?.value,
                                control: row.querySelector('.los-control')?.value,
                                peak: row.querySelector('.los-peak')?.value,
                                exGrade: row.querySelector('.los-ex-grade')?.value,
                                exDelay: row.querySelector('.los-ex-delay')?.value,
                                bgGrade: row.querySelector('.los-bg-grade')?.value,
                                bgDelay: row.querySelector('.los-bg-delay')?.value,
                                tfGrade: row.querySelector('.los-tf-grade')?.value,
                                tfDelay: row.querySelector('.los-tf-delay')?.value,
                                mitigation: row.querySelector('.los-mitigation')?.value
                            });
                        });

                        const step6Data = {
                            synchroModels: synchroData,
                            losResults: losData,
                            mitigationNotes: document.getElementById('ws-mitigation-notes')?.value
                        };
                        await ProjectStore.saveStepData(this._activeProjectId, 6, step6Data);
                        if (this._activeProject) this._activeProject.stepData[6] = step6Data;

                        await this.markStepComplete(6);
                        await this.markFolderItem('folder-synchro');
                        await this.markFolderItem('folder-los');

                        submitStep6.textContent = ' Capacity Analysis Saved';
                        submitStep6.style.background = 'var(--success)';
                        setTimeout(() => { submitStep6.textContent = 'Submit Capacity Analysis'; submitStep6.style.background = 'var(--gold)'; }, 2000);
                    });
                }

                // ==================== STEP 7: SITE ACCESS JS ====================

                function buildDrivewayRow(name = '') {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td><input type="text" class="ws-input dw-name" value="${name}" placeholder="e.g. Driveway 1" style="width:100%;"></td>
                        <td><input type="text" class="ws-input dw-road" placeholder="e.g. Main St" style="width:100%;"></td>
                        <td><select class="ws-input dw-type" style="width:100px;">
                            <option value="Full">Full Access</option>
                            <option value="Right-In/Right-Out">Right-In/Out</option>
                            <option value="Right-In Only">Right-In Only</option>
                            <option value="Right-Out Only">Right-Out Only</option>
                            <option value="Left-In/Left-Out">Left-In/Out</option>
                            <option value="3/4">3/4 Movement</option>
                        </select></td>
                        <td><select class="ws-input dw-movements" style="width:80px;">
                            <option value="All">All</option>
                            <option value="Right Only">Right Only</option>
                            <option value="Limited">Limited</option>
                        </select></td>
                        <td><input type="number" class="ws-input dw-lanes-in" min="1" max="4" value="1" style="width:50px;"></td>
                        <td><input type="number" class="ws-input dw-lanes-out" min="1" max="4" value="1" style="width:50px;"></td>
                        <td><select class="ws-input dw-control" style="width:80px;">
                            <option value="None">None</option>
                            <option value="Stop">Stop</option>
                            <option value="Signal">Signal</option>
                            <option value="Yield">Yield</option>
                        </select></td>
                        <td><input type="number" class="ws-input dw-spacing" min="0" value="" placeholder="" style="width:70px;"></td>
                    `;
                    tr.querySelectorAll('input, select').forEach(el => el.addEventListener('change', validateAccess));
                    return tr;
                }

                function buildTurnLaneRow(location = '') {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td><input type="text" class="ws-input tl-location" value="${location}" placeholder="e.g. Driveway 1" style="width:100%;"></td>
                        <td><select class="ws-input tl-movement" style="width:80px;">
                            <option value="Left">Left</option>
                            <option value="Right">Right</option>
                        </select></td>
                        <td><input type="number" class="ws-input tl-volume" min="0" value="" placeholder="" style="width:70px;"></td>
                        <td><select class="ws-input tl-method" style="width:120px;">
                            <option value="FDOT">FDOT Index</option>
                            <option value="NCHRP 745">NCHRP 745</option>
                            <option value="AASHTO">AASHTO</option>
                            <option value="Jurisdiction">Jurisdiction Std</option>
                        </select></td>
                        <td><select class="ws-input tl-warranted" style="width:60px;">
                            <option value=""></option>
                            <option value="Yes">Yes</option>
                            <option value="No">No</option>
                        </select></td>
                        <td><select class="ws-input tl-recommended" style="width:60px;">
                            <option value=""></option>
                            <option value="Yes">Yes</option>
                            <option value="No">No</option>
                        </select></td>
                        <td><input type="number" class="ws-input tl-storage" min="0" value="" placeholder="" style="width:70px;"></td>
                    `;
                    tr.querySelectorAll('input, select').forEach(el => el.addEventListener('change', validateAccess));
                    return tr;
                }

                function buildSightRow(driveway = '') {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td><input type="text" class="ws-input sd-driveway" value="${driveway}" placeholder="e.g. Driveway 1" style="width:100%;"></td>
                        <td><select class="ws-input sd-direction" style="width:70px;">
                            <option value="Left">Left</option>
                            <option value="Right">Right</option>
                        </select></td>
                        <td><input type="number" class="ws-input sd-speed" min="15" max="70" value="" placeholder="" style="width:70px;"></td>
                        <td><input type="number" class="ws-input sd-required" min="0" value="" placeholder="" style="width:80px;"></td>
                        <td><input type="number" class="ws-input sd-available" min="0" value="" placeholder="" style="width:80px;"></td>
                        <td class="sd-adequate" style="font-weight:600;"></td>
                    `;
                    // Auto-check adequate on change
                    const inputs = tr.querySelectorAll('input');
                    inputs.forEach(el => el.addEventListener('change', () => {
                        const req = parseInt(tr.querySelector('.sd-required')?.value) || 0;
                        const avail = parseInt(tr.querySelector('.sd-available')?.value) || 0;
                        const cell = tr.querySelector('.sd-adequate');
                        if (req > 0 && avail > 0) {
                            cell.textContent = avail >= req ? 'Yes' : 'No';
                            cell.style.color = avail >= req ? 'var(--success)' : '#ef4444';
                        } else {
                            cell.textContent = '';
                            cell.style.color = 'var(--text-muted)';
                        }
                        validateAccess();
                    }));
                    return tr;
                }

                function validateAccess() {
                    const dwRows = document.querySelectorAll('#driveway-tbody tr');
                    let dwCount = 0;
                    dwRows.forEach(r => { if (r.querySelector('.dw-name')?.value.trim()) dwCount++; });

                    const tlRows = document.querySelectorAll('#turnlane-tbody tr');
                    let tlCount = 0;
                    tlRows.forEach(r => { if (r.querySelector('.tl-warranted')?.value !== '') tlCount++; });

                    const sdRows = document.querySelectorAll('#sight-tbody tr');
                    let sdCount = 0;
                    let sdFail = false;
                    sdRows.forEach(r => {
                        const req = parseInt(r.querySelector('.sd-required')?.value) || 0;
                        const avail = parseInt(r.querySelector('.sd-available')?.value) || 0;
                        if (req > 0) { sdCount++; if (avail < req) sdFail = true; }
                    });

                    setBadge('badge-driveways', dwCount > 0 ? 'valid' : 'incomplete');
                    setBadge('badge-turn-lanes', tlCount > 0 ? 'valid' : 'incomplete');
                    setBadge('badge-sight-dist', sdCount > 0 ? (sdFail ? 'warning' : 'valid') : 'incomplete');

                    const valItems = document.getElementById('val-access-items');
                    const valPanel = document.getElementById('val-access');
                    if (valItems) {
                        let html = '';
                        html += valItem(dwCount > 0, 'Driveways documented', dwCount > 0 ? `${dwCount} access point(s)` : 'Add at least one driveway');
                        html += valItem(tlCount > 0, 'Turn lane analysis complete', tlCount > 0 ? `${tlCount} movement(s) evaluated` : 'Evaluate turn lane warrants');
                        html += valItem(sdCount > 0, 'Sight distance checked', sdCount > 0 ? `${sdCount} check(s)` : 'Add sight distance evaluations');
                        html += valItem(!sdFail, 'All sight distances adequate', sdFail ? 'One or more locations deficient' : (sdCount > 0 ? 'All adequate' : 'Pending evaluation'));
                        valItems.innerHTML = html;
                        valPanel.classList.add('visible');
                    }
                }

                function populateStep7() {
                    // Dependency check
                    const step6 = TseWorkflow._activeProject?.stepData?.[6];
                    const step5 = TseWorkflow._activeProject?.stepData?.[5];
                    let depHtml = '';
                    depHtml += valItem(!!step6, 'Step 6  Capacity Analysis', step6 ? 'Complete' : 'Not submitted  capacity results needed');
                    depHtml += valItem(!!step5, 'Step 5  Future Volumes', step5 ? 'Complete' : 'Not submitted');
                    const depItems = document.getElementById('dep-check-step7-items');
                    if (depItems) depItems.innerHTML = depHtml;

                    // Seed driveways if empty
                    const dwTbody = document.getElementById('driveway-tbody');
                    if (dwTbody && dwTbody.rows.length === 0) {
                        dwTbody.appendChild(buildDrivewayRow('Driveway 1'));
                        dwTbody.appendChild(buildDrivewayRow('Driveway 2'));
                    }

                    // Seed turn lane rows if empty
                    const tlTbody = document.getElementById('turnlane-tbody');
                    if (tlTbody && tlTbody.rows.length === 0) {
                        tlTbody.appendChild(buildTurnLaneRow('Driveway 1'));
                        tlTbody.appendChild(buildTurnLaneRow('Driveway 1'));
                    }

                    // Seed sight distance if empty
                    const sdTbody = document.getElementById('sight-tbody');
                    if (sdTbody && sdTbody.rows.length === 0) {
                        sdTbody.appendChild(buildSightRow('Driveway 1'));
                        sdTbody.appendChild(buildSightRow('Driveway 1'));
                    }

                    validateAccess();
                }
                window.validateAccess = validateAccess;
                window.populateStep7 = populateStep7;

                // Bind: add buttons
                const addDwBtn = document.getElementById('add-driveway-btn');
                if (addDwBtn) addDwBtn.addEventListener('click', () => document.getElementById('driveway-tbody').appendChild(buildDrivewayRow('')));

                const addTlBtn = document.getElementById('add-turnlane-btn');
                if (addTlBtn) addTlBtn.addEventListener('click', () => document.getElementById('turnlane-tbody').appendChild(buildTurnLaneRow('')));

                const addSdBtn = document.getElementById('add-sight-btn');
                if (addSdBtn) addSdBtn.addEventListener('click', () => document.getElementById('sight-tbody').appendChild(buildSightRow('')));

                // Bind: Submit Step 7
                const submitStep7 = document.getElementById('ws-submit-step7');
                if (submitStep7) {
                    submitStep7.addEventListener('click', async () => {
                        const driveways = [];
                        document.querySelectorAll('#driveway-tbody tr').forEach(row => {
                            driveways.push({
                                name: row.querySelector('.dw-name')?.value,
                                road: row.querySelector('.dw-road')?.value,
                                type: row.querySelector('.dw-type')?.value,
                                movements: row.querySelector('.dw-movements')?.value,
                                lanesIn: row.querySelector('.dw-lanes-in')?.value,
                                lanesOut: row.querySelector('.dw-lanes-out')?.value,
                                control: row.querySelector('.dw-control')?.value,
                                spacing: row.querySelector('.dw-spacing')?.value
                            });
                        });

                        const turnLanes = [];
                        document.querySelectorAll('#turnlane-tbody tr').forEach(row => {
                            turnLanes.push({
                                location: row.querySelector('.tl-location')?.value,
                                movement: row.querySelector('.tl-movement')?.value,
                                volume: row.querySelector('.tl-volume')?.value,
                                method: row.querySelector('.tl-method')?.value,
                                warranted: row.querySelector('.tl-warranted')?.value,
                                recommended: row.querySelector('.tl-recommended')?.value,
                                storage: row.querySelector('.tl-storage')?.value
                            });
                        });

                        const sightDist = [];
                        document.querySelectorAll('#sight-tbody tr').forEach(row => {
                            sightDist.push({
                                driveway: row.querySelector('.sd-driveway')?.value,
                                direction: row.querySelector('.sd-direction')?.value,
                                speed: row.querySelector('.sd-speed')?.value,
                                required: row.querySelector('.sd-required')?.value,
                                available: row.querySelector('.sd-available')?.value,
                                adequate: row.querySelector('.sd-adequate')?.textContent
                            });
                        });

                        const step7Data = {
                            driveways: driveways,
                            turnLanes: turnLanes,
                            sightDistance: sightDist,
                            accessNotes: document.getElementById('ws-access-notes')?.value
                        };
                        await ProjectStore.saveStepData(this._activeProjectId, 7, step7Data);
                        if (this._activeProject) this._activeProject.stepData[7] = step7Data;

                        await this.markStepComplete(7);
                        await this.markFolderItem('folder-driveway');

                        submitStep7.textContent = ' Site Access Saved';
                        submitStep7.style.background = 'var(--success)';
                        setTimeout(() => { submitStep7.textContent = 'Submit Site Access'; submitStep7.style.background = 'var(--gold)'; }, 2000);
                    });
                }

                // ==================== STEP 8: SIGNAL WARRANTS JS ====================

                function buildWarrantIntRow(intersection = '') {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td><input type="text" class="ws-input wi-intersection" value="${intersection}" placeholder="e.g. Main St & Site Dr" style="width:100%;"></td>
                        <td><select class="ws-input wi-control" style="width:100px;">
                            <option value="TWSC">TWSC</option>
                            <option value="AWSC">AWSC</option>
                            <option value="Unsignalized">Unsignalized</option>
                            <option value="Roundabout">Roundabout</option>
                        </select></td>
                        <td><input type="number" class="ws-input wi-major-vol" min="0" value="" placeholder="" style="width:80px;"></td>
                        <td><input type="number" class="ws-input wi-minor-vol" min="0" value="" placeholder="" style="width:80px;"></td>
                        <td><select class="ws-input wi-scenario" style="width:120px;">
                            <option value="Existing">Existing</option>
                            <option value="Background">Background</option>
                            <option value="Total Future" selected>Total Future</option>
                        </select></td>
                    `;
                    tr.querySelectorAll('input, select').forEach(el => el.addEventListener('change', validateWarrants));
                    return tr;
                }

                function buildWarrantResultRow(intersection = '') {
                    const tr = document.createElement('tr');
                    const metOpts = '<option value=""></option><option value="Met">Met</option><option value="Not Met">Not</option><option value="N/A">N/A</option>';
                    tr.innerHTML = `
                        <td><input type="text" class="ws-input wr-intersection" value="${intersection}" placeholder="Intersection" style="width:100%;"></td>
                        <td><select class="ws-input wr-w1" style="width:52px;">${metOpts}</select></td>
                        <td><select class="ws-input wr-w2" style="width:52px;">${metOpts}</select></td>
                        <td><select class="ws-input wr-w3" style="width:52px;">${metOpts}</select></td>
                        <td><select class="ws-input wr-w4" style="width:52px;">${metOpts}</select></td>
                        <td><select class="ws-input wr-w5" style="width:52px;">${metOpts}</select></td>
                        <td><select class="ws-input wr-w6" style="width:52px;">${metOpts}</select></td>
                        <td><select class="ws-input wr-w7" style="width:52px;">${metOpts}</select></td>
                        <td><select class="ws-input wr-w8" style="width:52px;">${metOpts}</select></td>
                        <td><select class="ws-input wr-w9" style="width:52px;">${metOpts}</select></td>
                        <td class="wr-met-count" style="text-align:center; font-weight:600;">0</td>
                        <td><select class="ws-input wr-recommendation" style="width:110px;">
                            <option value="No Signal">No Signal</option>
                            <option value="Signal Recommended">Signal Rec.</option>
                            <option value="Signal Required">Signal Req.</option>
                            <option value="Monitor">Monitor</option>
                            <option value="Roundabout">Roundabout</option>
                        </select></td>
                    `;
                    // Auto-count warrants met on change
                    tr.querySelectorAll('select').forEach(el => el.addEventListener('change', () => {
                        let count = 0;
                        for (let i = 1; i <= 9; i++) {
                            if (tr.querySelector(`.wr-w${i}`)?.value === 'Met') count++;
                        }
                        const cell = tr.querySelector('.wr-met-count');
                        cell.textContent = count;
                        cell.style.color = count > 0 ? 'var(--gold)' : 'var(--text-muted)';
                        validateWarrants();
                    }));
                    return tr;
                }

                function validateWarrants() {
                    const intRows = document.querySelectorAll('#warrant-int-tbody tr');
                    let intCount = 0;
                    intRows.forEach(r => { if (r.querySelector('.wi-intersection')?.value.trim()) intCount++; });

                    const resRows = document.querySelectorAll('#warrant-results-tbody tr');
                    let resCount = 0;
                    let anyMet = false;
                    resRows.forEach(r => {
                        const intersection = r.querySelector('.wr-intersection')?.value.trim();
                        if (intersection) resCount++;
                        const metCount = parseInt(r.querySelector('.wr-met-count')?.textContent) || 0;
                        if (metCount > 0) anyMet = true;
                    });

                    const notes = document.getElementById('ws-warrant-notes')?.value.trim();

                    setBadge('badge-warrant-ints', intCount > 0 ? 'valid' : 'incomplete');
                    setBadge('badge-warrant-results', resCount > 0 ? 'valid' : 'incomplete');

                    const valItems = document.getElementById('val-warrant-items');
                    const valPanel = document.getElementById('val-warrants');
                    if (valItems) {
                        let html = '';
                        html += valItem(intCount > 0, 'Intersections identified', intCount > 0 ? `${intCount} intersection(s)` : 'Add intersections for evaluation');
                        html += valItem(resCount > 0, 'Warrant results documented', resCount > 0 ? `${resCount} analysis complete` : 'Complete warrant evaluation');
                        html += valItem(!anyMet || notes.length > 0, 'Recommendations documented', anyMet ? (notes ? 'Notes provided' : 'Warrants met  add recommendation notes') : 'No warrants met');
                        valItems.innerHTML = html;
                        valPanel.classList.add('visible');
                    }
                }

                function populateStep8() {
                    // Dependency check
                    const step6 = TseWorkflow._activeProject?.stepData?.[6];
                    const step5 = TseWorkflow._activeProject?.stepData?.[5];
                    let depHtml = '';
                    depHtml += valItem(!!step6, 'Step 6  Capacity Analysis', step6 ? 'Complete' : 'Not submitted  capacity results needed');
                    depHtml += valItem(!!step5, 'Step 5  Future Volumes', step5 ? 'Complete' : 'Not submitted  volume data needed');
                    const depItems = document.getElementById('dep-check-step8-items');
                    if (depItems) depItems.innerHTML = depHtml;

                    // Seed intersection rows from Step 7 driveways if available
                    const intTbody = document.getElementById('warrant-int-tbody');
                    const resTbody = document.getElementById('warrant-results-tbody');
                    if (intTbody && intTbody.rows.length === 0) {
                        const step7 = TseWorkflow._activeProject?.stepData?.[7];
                        if (step7) {
                            if (step7.driveways && step7.driveways.length > 0) {
                                step7.driveways.forEach(dw => {
                                    const name = (dw.road ? dw.road + ' & ' : '') + (dw.name || 'Site Access');
                                    intTbody.appendChild(buildWarrantIntRow(name));
                                    if (resTbody && resTbody.rows.length < step7.driveways.length) {
                                        resTbody.appendChild(buildWarrantResultRow(name));
                                    }
                                });
                            }
                        }
                        if (intTbody.rows.length === 0) {
                            intTbody.appendChild(buildWarrantIntRow(''));
                            resTbody.appendChild(buildWarrantResultRow(''));
                        }
                    }
                    validateWarrants();
                }
                window.validateWarrants = validateWarrants;
                window.populateStep8 = populateStep8;

                // Bind: add buttons
                const addWarrantIntBtn = document.getElementById('add-warrant-int-btn');
                if (addWarrantIntBtn) addWarrantIntBtn.addEventListener('click', () => document.getElementById('warrant-int-tbody').appendChild(buildWarrantIntRow('')));

                const addWarrantResBtn = document.getElementById('add-warrant-result-btn');
                if (addWarrantResBtn) addWarrantResBtn.addEventListener('click', () => document.getElementById('warrant-results-tbody').appendChild(buildWarrantResultRow('')));

                // Bind: Submit Step 8
                const submitStep8 = document.getElementById('ws-submit-step8');
                if (submitStep8) {
                    submitStep8.addEventListener('click', async () => {
                        const intersections = [];
                        document.querySelectorAll('#warrant-int-tbody tr').forEach(row => {
                            intersections.push({
                                intersection: row.querySelector('.wi-intersection')?.value,
                                control: row.querySelector('.wi-control')?.value,
                                majorVol: row.querySelector('.wi-major-vol')?.value,
                                minorVol: row.querySelector('.wi-minor-vol')?.value,
                                scenario: row.querySelector('.wi-scenario')?.value
                            });
                        });

                        const warrantResults = [];
                        document.querySelectorAll('#warrant-results-tbody tr').forEach(row => {
                            const result = {
                                intersection: row.querySelector('.wr-intersection')?.value,
                                recommendation: row.querySelector('.wr-recommendation')?.value,
                                warrantsMet: parseInt(row.querySelector('.wr-met-count')?.textContent) || 0
                            };
                            for (let i = 1; i <= 9; i++) {
                                result['w' + i] = row.querySelector(`.wr-w${i}`)?.value;
                            }
                            warrantResults.push(result);
                        });

                        const step8Data = {
                            intersections: intersections,
                            warrantResults: warrantResults,
                            notes: document.getElementById('ws-warrant-notes')?.value
                        };
                        await ProjectStore.saveStepData(this._activeProjectId, 8, step8Data);
                        if (this._activeProject) this._activeProject.stepData[8] = step8Data;

                        await this.markStepComplete(8);
                        await this.markFolderItem('folder-warrants');

                        submitStep8.textContent = ' Signal Warrants Saved';
                        submitStep8.style.background = 'var(--success)';
                        setTimeout(() => { submitStep8.textContent = 'Submit Signal Warrants'; submitStep8.style.background = 'var(--gold)'; }, 2000);
                    });
                }

                // ==================== STEP 9: REPORT ASSEMBLY JS ====================

                function buildExhibitRow(figNum = '', title = '') {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td><input type="text" class="ws-input ex-fig-num" value="${figNum}" placeholder="e.g. 1" style="width:60px;"></td>
                        <td><input type="text" class="ws-input ex-title" value="${title}" placeholder="e.g. Site Location Map" style="width:100%;"></td>
                        <td><select class="ws-input ex-type" style="width:100px;">
                            <option value="Figure">Figure</option>
                            <option value="Table">Table</option>
                            <option value="Map">Map</option>
                            <option value="Photo">Photo</option>
                            <option value="Diagram">Diagram</option>
                        </select></td>
                        <td><select class="ws-input ex-source" style="width:80px;">
                            <option value="Step 1">Step 1</option>
                            <option value="Step 2">Step 2</option>
                            <option value="Step 3">Step 3</option>
                            <option value="Step 4">Step 4</option>
                            <option value="Step 5">Step 5</option>
                            <option value="Step 6">Step 6</option>
                            <option value="Step 7">Step 7</option>
                            <option value="Step 8">Step 8</option>
                            <option value="External">External</option>
                        </select></td>
                        <td><select class="ws-input ex-status" style="width:90px;">
                            <option value="Pending">Pending</option>
                            <option value="Draft">Draft</option>
                            <option value="Final">Final</option>
                        </select></td>
                        <td><button class="action-btn ex-layout-btn" style="padding:4px 10px;font-size:11px;cursor:pointer;" title="Edit Layout">Layout</button></td>
                    `;
                    tr.querySelectorAll('input, select').forEach(el => el.addEventListener('change', validateReport));
                    // Bind layout button
                    tr.querySelector('.ex-layout-btn')?.addEventListener('click', () => {
                        const fn = tr.querySelector('.ex-fig-num')?.value || '';
                        const t = tr.querySelector('.ex-title')?.value || 'Exhibit';
                        const exId = fn || t || 'exhibit_' + Date.now();
                        LayoutEditor.open(exId, (fn ? 'Figure ' + fn + ': ' : '') + t);
                    });
                    return tr;
                }

                function validateReport() {
                    // Count checked sections
                    const checks = document.querySelectorAll('.rpt-section-check');
                    let checkedCount = 0;
                    checks.forEach(c => { if (c.checked) checkedCount++; });
                    document.getElementById('rpt-sections-count').textContent = `${checkedCount} / 9`;

                    // Count data steps complete
                    let dataComplete = 0;
                    const sd = TseWorkflow._activeProject?.stepData || {};
                    [1,2,3,4,5,6,7,8].forEach(n => { if (sd[n]) dataComplete++; });
                    document.getElementById('rpt-data-steps').textContent = `${dataComplete} / 8`;

                    // Count exhibits
                    const exRows = document.querySelectorAll('#exhibits-tbody tr');
                    let exCount = 0;
                    let exFinal = 0;
                    exRows.forEach(r => {
                        if (r.querySelector('.ex-title')?.value.trim()) exCount++;
                        if (r.querySelector('.ex-status')?.value === 'Final') exFinal++;
                    });
                    document.getElementById('rpt-exhibits-count').textContent = exCount;

                    const reportFile = document.getElementById('ws-report-filename')?.value.trim();

                    setBadge('badge-report-sections', checkedCount >= 9 ? 'valid' : (checkedCount > 0 ? 'warning' : 'incomplete'));
                    setBadge('badge-exhibits', exCount > 0 ? 'valid' : 'incomplete');

                    const valItems = document.getElementById('val-report-items');
                    const valPanel = document.getElementById('val-report');
                    if (valItems) {
                        let html = '';
                        html += valItem(checkedCount >= 9, 'All report sections drafted', `${checkedCount}/9 sections checked`);
                        html += valItem(dataComplete >= 6, 'Source data available', `${dataComplete}/8 analysis steps complete`);
                        html += valItem(exCount > 0, 'Exhibits listed', exCount > 0 ? `${exCount} exhibit(s), ${exFinal} finalized` : 'Add report exhibits');
                        html += valItem(!!reportFile, 'Report file referenced', reportFile || 'Enter report filename');
                        valItems.innerHTML = html;
                        valPanel.classList.add('visible');
                    }
                }

                const defaultExhibits = [
                    { num: '1', title: 'Site Location Map' },
                    { num: '2', title: 'Site Plan' },
                    { num: '3', title: 'Existing Lane Geometry' },
                    { num: '4', title: 'Existing Traffic Volumes' },
                    { num: '5', title: 'Trip Generation Summary' },
                    { num: '6', title: 'Trip Distribution' },
                    { num: '7', title: 'Background Traffic Volumes' },
                    { num: '8', title: 'Total Future Traffic Volumes' },
                    { num: '9', title: 'LOS Summary' }
                ];

                function populateStep9() {
                    // Dependency check  all analysis steps
                    const stepChecks = [
                        { stepNum: null, label: 'Step 1  Project Setup' },
                        { stepNum: 2, label: 'Step 2  Data Collection' },
                        { stepNum: 3, label: 'Step 3  Trip Generation' },
                        { stepNum: 4, label: 'Step 4  Trip Distribution' },
                        { stepNum: 5, label: 'Step 5  Future Volumes' },
                        { stepNum: 6, label: 'Step 6  Capacity Analysis' },
                        { stepNum: 7, label: 'Step 7  Site Access' },
                        { stepNum: 8, label: 'Step 8  Signal Warrants' }
                    ];
                    let depHtml = '';
                    stepChecks.forEach(s => {
                        const exists = s.stepNum === null ? !!TseWorkflow._activeProject : !!TseWorkflow._activeProject?.stepData?.[s.stepNum];
                        depHtml += valItem(exists, s.label, exists ? 'Complete' : 'Not submitted');
                    });
                    const depItems = document.getElementById('dep-check-step9-items');
                    if (depItems) depItems.innerHTML = depHtml;

                    // Seed exhibits if empty
                    const exTbody = document.getElementById('exhibits-tbody');
                    if (exTbody && exTbody.rows.length === 0) {
                        defaultExhibits.forEach(ex => exTbody.appendChild(buildExhibitRow(ex.num, ex.title)));
                    }

                    // Auto-fill report date
                    const dateEl = document.getElementById('ws-report-date');
                    if (dateEl && !dateEl.value) {
                        dateEl.value = new Date().toISOString().split('T')[0];
                    }

                    // Bind section checkboxes
                    document.querySelectorAll('.rpt-section-check').forEach(cb => {
                        cb.removeEventListener('change', validateReport);
                        cb.addEventListener('change', validateReport);
                    });

                    // Enable PPTX button if layouts exist
                    const pptxBtn = document.getElementById('generate-pptx-step9');
                    if (pptxBtn) {
                        const hasLayouts = Object.keys(TseWorkflow._activeProject?.stepData?.[9]?.exhibitLayouts || {}).length > 0;
                        pptxBtn.disabled = !hasLayouts;
                    }

                    validateReport();
                }
                window.validateReport = validateReport;
                window.populateStep9 = populateStep9;

                // Bind: add exhibit
                const addExhibitBtn = document.getElementById('add-exhibit-btn');
                if (addExhibitBtn) addExhibitBtn.addEventListener('click', () => document.getElementById('exhibits-tbody').appendChild(buildExhibitRow('', '')));

                // Bind: report filename/version/notes trigger validation
                ['ws-report-filename','ws-report-version','ws-report-date'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.addEventListener('change', validateReport);
                });

                // Bind: Submit Step 9
                const submitStep9 = document.getElementById('ws-submit-step9');
                if (submitStep9) {
                    submitStep9.addEventListener('click', async () => {
                        const sections = {};
                        document.querySelectorAll('.rpt-section-check').forEach(cb => {
                            sections[cb.dataset.section] = cb.checked;
                        });

                        const exhibits = [];
                        document.querySelectorAll('#exhibits-tbody tr').forEach(row => {
                            exhibits.push({
                                figNum: row.querySelector('.ex-fig-num')?.value,
                                title: row.querySelector('.ex-title')?.value,
                                type: row.querySelector('.ex-type')?.value,
                                source: row.querySelector('.ex-source')?.value,
                                status: row.querySelector('.ex-status')?.value
                            });
                        });

                        // Preserve existing exhibit layouts
                        const existingLayouts = this._activeProject?.stepData?.[9]?.exhibitLayouts || {};

                        const step9Data = {
                            sections: sections,
                            exhibits: exhibits,
                            exhibitLayouts: existingLayouts,
                            reportFilename: document.getElementById('ws-report-filename')?.value,
                            reportVersion: document.getElementById('ws-report-version')?.value,
                            reportDate: document.getElementById('ws-report-date')?.value,
                            notes: document.getElementById('ws-report-notes')?.value
                        };
                        await ProjectStore.saveStepData(this._activeProjectId, 9, step9Data);
                        if (this._activeProject) this._activeProject.stepData[9] = step9Data;

                        await this.markStepComplete(9);
                        await this.markFolderItem('folder-report');
                        await this.markFolderItem('folder-exhibits');

                        submitStep9.textContent = ' Report Assembly Saved';
                        submitStep9.style.background = 'var(--success)';
                        setTimeout(() => { submitStep9.textContent = 'Submit Report Assembly'; submitStep9.style.background = 'var(--gold)'; }, 2000);

                        // Enable PPTX button if exhibits exist
                        const pptxBtn9 = document.getElementById('generate-pptx-step9');
                        if (pptxBtn9) {
                            const hasLayouts = Object.keys(this._activeProject?.stepData?.[9]?.exhibitLayouts || {}).length > 0;
                            pptxBtn9.disabled = !hasLayouts;
                        }
                    });
                }

                // Bind: Generate PPTX (Step 9)
                const pptxBtn9 = document.getElementById('generate-pptx-step9');
                if (pptxBtn9) {
                    pptxBtn9.addEventListener('click', async () => {
                        if (!this._activeProject) return;
                        pptxBtn9.textContent = 'Generating...';
                        pptxBtn9.disabled = true;
                        await PptxGenerator.generateDeck(this._activeProject);
                        pptxBtn9.textContent = 'Generate PPTX Report Deck';
                        pptxBtn9.disabled = false;
                    });
                }

                // ==================== STEP 10: FINAL DELIVERY JS ====================

                function buildDeliverableRow(filename = '', type = 'PDF', desc = '') {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td><input type="text" class="ws-input del-filename" value="${filename}" placeholder="e.g. TIA_Report_Final.pdf" style="width:100%;"></td>
                        <td><select class="ws-input del-type" style="width:90px;">
                            <option value="PDF" ${type==='PDF'?'selected':''}>PDF</option>
                            <option value="DOCX" ${type==='DOCX'?'selected':''}>DOCX</option>
                            <option value="SYN" ${type==='SYN'?'selected':''}>SYN</option>
                            <option value="XLSX" ${type==='XLSX'?'selected':''}>XLSX</option>
                            <option value="CSV" ${type==='CSV'?'selected':''}>CSV</option>
                            <option value="DWG" ${type==='DWG'?'selected':''}>DWG</option>
                            <option value="ZIP" ${type==='ZIP'?'selected':''}>ZIP</option>
                            <option value="Other" ${type==='Other'?'selected':''}>Other</option>
                        </select></td>
                        <td><input type="text" class="ws-input del-desc" value="${desc}" placeholder="Description" style="width:100%;"></td>
                        <td><select class="ws-input del-status" style="width:80px;">
                            <option value="Pending">Pending</option>
                            <option value="Ready">Ready</option>
                            <option value="Sent">Sent</option>
                        </select></td>
                    `;
                    tr.querySelectorAll('input, select').forEach(el => el.addEventListener('change', validateDelivery));
                    return tr;
                }

                const defaultDeliverables = [
                    { name: '', type: 'PDF', desc: 'Final TIA Report (sealed)' },
                    { name: '', type: 'PDF', desc: 'Appendix  TMC Count Data' },
                    { name: '', type: 'PDF', desc: 'Appendix  Synchro Reports' },
                    { name: '', type: 'SYN', desc: 'Synchro Model Files' },
                    { name: '', type: 'XLSX', desc: 'Trip Generation Worksheets' }
                ];

                function validateDelivery() {
                    // QC checklist
                    const qcChecks = document.querySelectorAll('.qc-check');
                    let qcCount = 0;
                    qcChecks.forEach(c => { if (c.checked) qcCount++; });
                    document.getElementById('final-qc-count').textContent = `${qcCount} / ${qcChecks.length}`;

                    // Deliverables
                    const delRows = document.querySelectorAll('#deliverables-tbody tr');
                    let delCount = 0;
                    let delReady = 0;
                    delRows.forEach(r => {
                        if (r.querySelector('.del-filename')?.value.trim() || r.querySelector('.del-desc')?.value.trim()) delCount++;
                        if (r.querySelector('.del-status')?.value === 'Ready' || r.querySelector('.del-status')?.value === 'Sent') delReady++;
                    });
                    document.getElementById('final-deliverables-count').textContent = delCount;

                    // Steps complete
                    const proj = TseWorkflow._activeProject || {};
                    const completed = proj.stepsCompleted || {};
                    let stepsCount = Object.keys(completed).filter(k => completed[k]).length;
                    document.getElementById('final-steps-complete').textContent = `${stepsCount} / 10`;

                    // Submission
                    const submitTo = document.getElementById('ws-submit-to')?.value.trim();
                    const submitDate = document.getElementById('ws-submit-date')?.value;
                    const submitMethod = document.getElementById('ws-submit-method')?.value;
                    const reviewStatus = document.getElementById('ws-review-status')?.value;
                    document.getElementById('final-review-status').textContent = reviewStatus || '';

                    setBadge('badge-qc-checklist', qcCount >= qcChecks.length ? 'valid' : (qcCount > 0 ? 'warning' : 'incomplete'));
                    setBadge('badge-deliverables', delReady > 0 ? 'valid' : (delCount > 0 ? 'warning' : 'incomplete'));
                    setBadge('badge-submission', submitTo && submitMethod ? 'valid' : 'incomplete');

                    const valItems = document.getElementById('val-delivery-items');
                    const valPanel = document.getElementById('val-delivery');
                    if (valItems) {
                        let html = '';
                        html += valItem(qcCount >= qcChecks.length, 'QC checklist complete', `${qcCount}/${qcChecks.length} items checked`);
                        html += valItem(delCount > 0, 'Deliverables listed', delCount > 0 ? `${delCount} file(s), ${delReady} ready` : 'Add deliverable files');
                        html += valItem(!!submitTo, 'Recipient identified', submitTo || 'Enter submission recipient');
                        html += valItem(!!submitMethod, 'Submission method set', submitMethod || 'Select delivery method');
                        html += valItem(stepsCount >= 9, 'All prior steps complete', stepsCount >= 9 ? `${stepsCount}/9 analysis steps done` : `Only ${stepsCount}/9  complete remaining steps`);
                        valItems.innerHTML = html;
                        valPanel.classList.add('visible');
                    }
                }

                function populateStep10() {
                    // Dependency check
                    const step9 = TseWorkflow._activeProject?.stepData?.[9];
                    let depHtml = '';
                    depHtml += valItem(!!step9, 'Step 9  Report Assembly', step9 ? 'Complete' : 'Not submitted  report draft needed');

                    // Also check all prior steps
                    const allStepNums = [
                        { stepNum: null, label: 'Step 1' },
                        { stepNum: 3, label: 'Step 3' },
                        { stepNum: 4, label: 'Step 4' },
                        { stepNum: 5, label: 'Step 5' },
                        { stepNum: 6, label: 'Step 6' },
                        { stepNum: 7, label: 'Step 7' },
                        { stepNum: 8, label: 'Step 8' }
                    ];
                    let allDone = !!step9;
                    allStepNums.forEach(s => {
                        const exists = s.stepNum === null ? !!TseWorkflow._activeProject : !!TseWorkflow._activeProject?.stepData?.[s.stepNum];
                        if (!exists) allDone = false;
                    });
                    depHtml += valItem(allDone, 'All analysis steps (1-9)', allDone ? 'All complete' : 'Some steps incomplete  review folder tracker');

                    const depItems = document.getElementById('dep-check-step10-items');
                    if (depItems) depItems.innerHTML = depHtml;

                    // Seed deliverables if empty
                    const delTbody = document.getElementById('deliverables-tbody');
                    if (delTbody && delTbody.rows.length === 0) {
                        defaultDeliverables.forEach(d => delTbody.appendChild(buildDeliverableRow(d.name, d.type, d.desc)));
                    }

                    // Bind QC checkboxes
                    document.querySelectorAll('.qc-check').forEach(cb => {
                        cb.removeEventListener('change', validateDelivery);
                        cb.addEventListener('change', validateDelivery);
                    });

                    // Bind submission fields
                    ['ws-submit-to','ws-submit-date','ws-submit-method','ws-submit-contact','ws-submit-email','ws-review-status'].forEach(id => {
                        const el = document.getElementById(id);
                        if (el) {
                            el.removeEventListener('change', validateDelivery);
                            el.addEventListener('change', validateDelivery);
                        }
                    });

                    validateDelivery();
                }
                window.validateDelivery = validateDelivery;
                window.populateStep10 = populateStep10;

                // Bind: add deliverable
                const addDelBtn = document.getElementById('add-deliverable-btn');
                if (addDelBtn) addDelBtn.addEventListener('click', () => document.getElementById('deliverables-tbody').appendChild(buildDeliverableRow('', 'PDF', '')));

                // Bind: Submit Step 10
                const submitStep10 = document.getElementById('ws-submit-step10');
                if (submitStep10) {
                    submitStep10.addEventListener('click', async () => {
                        const qcItems = {};
                        document.querySelectorAll('.qc-check').forEach(cb => {
                            qcItems[cb.dataset.qc] = cb.checked;
                        });

                        const deliverables = [];
                        document.querySelectorAll('#deliverables-tbody tr').forEach(row => {
                            deliverables.push({
                                filename: row.querySelector('.del-filename')?.value,
                                type: row.querySelector('.del-type')?.value,
                                description: row.querySelector('.del-desc')?.value,
                                status: row.querySelector('.del-status')?.value
                            });
                        });

                        const step10Data = {
                            qcChecklist: qcItems,
                            deliverables: deliverables,
                            submitTo: document.getElementById('ws-submit-to')?.value,
                            submitDate: document.getElementById('ws-submit-date')?.value,
                            submitMethod: document.getElementById('ws-submit-method')?.value,
                            contactName: document.getElementById('ws-submit-contact')?.value,
                            contactEmail: document.getElementById('ws-submit-email')?.value,
                            reviewStatus: document.getElementById('ws-review-status')?.value,
                            notes: document.getElementById('ws-submit-notes')?.value
                        };
                        await ProjectStore.saveStepData(this._activeProjectId, 10, step10Data);
                        if (this._activeProject) this._activeProject.stepData[10] = step10Data;

                        await this.markStepComplete(10);
                        await this.markFolderItem('folder-final-pdf');
                        await this.markFolderItem('folder-appendix');

                        submitStep10.textContent = ' Project Complete!';
                        submitStep10.style.background = 'var(--success)';
                        setTimeout(() => { submitStep10.textContent = 'Complete Project  Final Delivery'; submitStep10.style.background = 'linear-gradient(135deg, var(--gold), var(--success))'; }, 3000);
                    });
                }

                // Bind: Generate PPTX (Step 10)
                const pptxBtn10 = document.getElementById('generate-pptx-step10');
                if (pptxBtn10) {
                    pptxBtn10.addEventListener('click', async () => {
                        if (!this._activeProject) return;
                        pptxBtn10.textContent = 'Generating...';
                        pptxBtn10.disabled = true;
                        await PptxGenerator.generateDeck(this._activeProject);
                        pptxBtn10.textContent = 'Generate PPTX Report Deck';
                        pptxBtn10.disabled = false;
                    });
                }

                // Workspace: Submit button  Step 1
                const submitBtn = document.getElementById('ws-submit-step1');
                if (submitBtn) {
                    submitBtn.addEventListener('click', async () => {
                        const name = document.getElementById('ws-project-name').value.trim();
                        if (!name) {
                            alert('Please enter a Project Name.');
                            return;
                        }

                        // Gather step data using gatherStepData
                        const stepData = this.gatherStepData(1);

                        // Update the active project with step 1 data
                        if (this._activeProject) {
                            Object.assign(this._activeProject, {
                                name: stepData.name,
                                number: stepData.number,
                                address: stepData.address,
                                jurisdiction: stepData.jurisdiction,
                                openingYear: stepData.openingYear,
                                horizonYear: stepData.horizonYear,
                                growthRate: stepData.growthRate,
                                signalWarrantStudy: stepData.signalWarrantStudy,
                                buildings: stepData.buildings
                            });
                            await ProjectStore.saveStepData(this._activeProjectId, 1, stepData);
                            await this.markStepComplete(1);
                            await this.markFolderItem('folder-project-info');
                        }

                        // Show summary card
                        if (this._activeProject) {
                            this.renderProjectSummary(this._activeProject);
                            this.renderFolderTracker(this._activeProject);
                        }
                        this.updateStepDisplay();

                        submitBtn.textContent = ' Project Setup Saved';
                        submitBtn.style.background = 'var(--success)';
                        setTimeout(() => {
                            submitBtn.textContent = 'Submit Project Setup';
                            submitBtn.style.background = 'var(--gold)';
                        }, 2000);
                    });
                }
            },

            async loadProjects() {
                const projects = await ProjectStore.listProjects();
                this.projects = projects;
                this.populateProjectSelect();
            },

            populateProjectSelect(statusFilter) {
                const filter = statusFilter || document.getElementById('project-status-filter')?.value || 'all';
                const select = document.getElementById('project-select');
                select.innerHTML = '<option value="">-- Select Project --</option>';
                this.projects.forEach((proj) => {
                    const status = proj.status || 'draft';
                    if (filter !== 'all' && status !== filter) return;
                    const opt = document.createElement('option');
                    opt.value = proj.id;
                    const badge = STATUS_LABELS[status] || status;
                    opt.textContent = `[${badge}] ${proj.name}`;
                    select.appendChild(opt);
                });
            },

            openModal() {
                document.getElementById('new-project-modal').classList.add('visible');
            },

            closeModal() {
                document.getElementById('new-project-modal').classList.remove('visible');
                // Clear form
                document.getElementById('project-name').value = '';
                document.getElementById('client-name').value = '';
                document.getElementById('jurisdiction').value = '';
                document.getElementById('study-type').value = 'tia';
            },

            async createProject() {
                const name = document.getElementById('project-name').value.trim();
                const client = document.getElementById('client-name').value.trim();
                const jurisdiction = document.getElementById('jurisdiction').value;
                const studyType = document.getElementById('study-type').value;

                if (!name) {
                    showNotification('Please enter a project name', 'warning');
                    return;
                }

                const project = await ProjectStore.createProject({
                    name, client, jurisdiction, studyType
                });

                this._activeProjectId = project.id;
                this._activeProject = project;
                this._stepsCompleted = {};
                this._folderItems = {};

                this.closeModal();
                showNotification('Project created: ' + name, 'success');

                // Try to create folder structure if Tauri is available
                const invoke = getInvoke();
                if (invoke) {
                    const basePath = 'G:\\My Drive\\00 - Trajanus USA\\Traffic\\' + name;
                    try {
                        await invoke('write_file', { path: basePath + '\\Traffic Counts\\.gitkeep', content: '' });
                        await invoke('write_file', { path: basePath + '\\SYNCHRO Outputs\\Background\\.gitkeep', content: '' });
                        await invoke('write_file', { path: basePath + '\\SYNCHRO Outputs\\Background Grown\\.gitkeep', content: '' });
                        await invoke('write_file', { path: basePath + '\\SYNCHRO Outputs\\Background + Site\\.gitkeep', content: '' });
                        await invoke('write_file', { path: basePath + '\\Deliverable\\.gitkeep', content: '' });
                        Terminal.success('Created folder structure at: ' + basePath);
                    } catch (e) {
                        Terminal.warning('Could not create folders: ' + e);
                    }
                }

                await this.openProject(project.id);
            },

            async selectProject(id) {
                if (!id) {
                    this._activeProject = null;
                    this.currentStep = 1;
                    this.updateStepDisplay();
                    return;
                }
                await this.openProject(id);
            },

            goToStep(step) {
                if (step < 1 || step > 10) return;

                // Skip Step 8 if warrant study is disabled
                if (step === 8 && !this.isWarrantStudyEnabled()) {
                    return;
                }

                // Toggle workspace: if clicking the already-active step, close panel
                const workspace = document.getElementById('workflow-workspace');
                if (step === this.currentStep && workspace.classList.contains('open')) {
                    workspace.classList.remove('open');
                    return;
                }

                this.currentStep = step;
                if (this._activeProject) {
                    this._activeProject.currentStep = step;
                    ProjectStore.saveProject(this._activeProject);
                }
                this.updateStepDisplay();

                // Show workspace panel for the step (if one exists)
                const allPanels = workspace.querySelectorAll('.workspace-panel');
                allPanels.forEach(p => p.classList.remove('active'));
                const targetPanel = document.getElementById('ws-panel-' + step);
                if (targetPanel) {
                    targetPanel.classList.add('active');
                    workspace.classList.add('open');
                    // Trigger step-specific population
                    if (step === 1) {
                        const scopeCb = document.getElementById('ws-scope-warrants');
                        if (scopeCb) scopeCb.checked = this.isWarrantStudyEnabled();
                    }
                    if (step === 3) populateStep3();
                    if (step === 4) populateStep4();
                    if (step === 5) populateStep5();
                    if (step === 6) populateStep6();
                    if (step === 7) populateStep7();
                    if (step === 8) populateStep8();
                    if (step === 9) populateStep9();
                    if (step === 10) populateStep10();

                    // Filter supplemental files to current step
                    SupplementalFiles.setStepFilter(step);
                } else {
                    workspace.classList.remove('open');
                }
            },

            advanceStep() {
                if (this.currentStep < 10) {
                    this.goToStep(this.currentStep + 1);
                }
            },

            updateStepDisplay() {
                // Update progress text
                document.getElementById('workflow-progress').textContent = 'Step ' + this.currentStep + ' of 10';

                // Update step indicators  based on actual completion
                const completedSteps = this._stepsCompleted || {};

                const warrantEnabled = this.isWarrantStudyEnabled();
                document.querySelectorAll('.workflow-step').forEach(step => {
                    const stepNum = parseInt(step.dataset.step);
                    step.classList.remove('active', 'completed');
                    if (stepNum === this.currentStep) {
                        step.classList.add('active');
                    }
                    if (completedSteps[stepNum]) {
                        step.classList.add('completed');
                    }
                    // Dim Step 8 when warrant study is disabled
                    if (stepNum === 8) {
                        step.style.opacity = warrantEnabled ? '1' : '0.35';
                        step.style.pointerEvents = warrantEnabled ? '' : 'none';
                        step.title = warrantEnabled ? '' : 'Signal Warrant Study not included in scope';
                    }
                });

                // Dim folder tracker Step 8 group when warrant study is disabled
                const folderStep8 = document.querySelector('.folder-step-group[data-folder-step="8"]');
                if (folderStep8) {
                    folderStep8.style.opacity = warrantEnabled ? '1' : '0.35';
                    if (!warrantEnabled) {
                        const badge = folderStep8.querySelector('.step-badge');
                        if (badge) badge.title = 'Skipped \u2014 not in study scope';
                    }
                }

                // Update instructions
                const instructions = this.stepInstructions[this.currentStep];
                document.getElementById('step-title').textContent = instructions.title;
                document.getElementById('step-content').innerHTML = instructions.content;

                // Update step tools
                this.updateStepTools();
                this.updatePipeline();

                // Send assistant message about current step
                if (this._activeProject) {
                    this.assistantGuide();
                }
            },

            updatePipeline() {
                const completed = Object.keys(this._stepsCompleted || {}).length;
                const warrantEnabled = this.isWarrantStudyEnabled();
                const total = warrantEnabled ? 10 : 9;
                const pct = Math.round((completed / total) * 100);

                const fill = document.getElementById('pipeline-fill');
                const label = document.getElementById('pipeline-label');
                const percent = document.getElementById('pipeline-percent');
                if (fill) fill.style.width = pct + '%';
                if (label) label.textContent = completed + ' / ' + total + ' steps complete';
                if (percent) percent.textContent = pct + '%';
            },

            async animateStepComplete(stepNum) {
                const stepEl = document.querySelector('.workflow-step[data-step="' + stepNum + '"]');
                if (!stepEl) return;

                stepEl.classList.add('calculating');
                await new Promise(r => setTimeout(r, 400));

                stepEl.classList.remove('calculating');
                stepEl.classList.add('completing');
                await new Promise(r => setTimeout(r, 600));

                stepEl.classList.remove('completing');
                stepEl.classList.add('completed');

                this.updatePipeline();
            },

            updateStepTools() {
                const toolsGrid = document.getElementById('step-tools-grid');
                const tools = this.stepTools[this.currentStep] || [];

                if (tools.length === 0) {
                    toolsGrid.innerHTML = '<span style="color:var(--text-muted);">No tools needed for this step</span>';
                    return;
                }

                toolsGrid.innerHTML = tools.map(tool => `
                    <button class="step-tool-btn" data-action="${tool.action}">
                        <span class="step-tool-icon">${tool.icon}</span>
                        <span>${tool.label}</span>
                    </button>
                `).join('');

                // Bind click events
                toolsGrid.querySelectorAll('.step-tool-btn').forEach(btn => {
                    btn.addEventListener('click', () => this.executeTool(btn.dataset.action));
                });
            },

            async executeTool(action) {
                const invoke = getInvoke();

                switch(action) {
                    case 'openExplorer':
                    case 'openProjectFolder':
                        await this.openProjectFolder();
                        break;
                    case 'openSynchroFolder':
                        await this.openFolder('SYNCHRO Outputs');
                        break;
                    case 'openDeliverableFolder':
                        await this.openFolder('Deliverable');
                        break;
                    case 'launchSynchro':
                        Apps.launch('synchro');
                        break;
                    case 'launchExcel':
                        Apps.launch('excel');
                        break;
                    case 'launchWord':
                        Apps.launch('word');
                        break;
                    case 'launchAcrobat':
                        Apps.launch('acrobat');
                        break;
                    case 'runTripGen':
                        Scripts.run('trip-gen');
                        break;
                    case 'runTiaTemplate':
                        Scripts.run('tia-template');
                        break;
                    default:
                        showNotification('Tool action not found: ' + action, 'warning');
                }
            },

            async openProjectFolder() {
                if (!this._activeProject) {
                    showNotification('Please select or create a project first', 'warning');
                    return;
                }

                const basePath = 'G:\\My Drive\\00 - Trajanus USA\\Traffic\\' + this._activeProject.name;
                const invoke = getInvoke();

                if (invoke) {
                    try {
                        await invoke('open_path', { path: basePath });
                        Terminal.success('Opened project folder: ' + basePath);
                        showNotification('Opened project folder', 'success');
                    } catch (e) {
                        Terminal.error('Could not open folder: ' + e);
                        showNotification('Could not open folder', 'warning');
                    }
                } else {
                    showNotification('Folder: ' + basePath, 'info');
                }
            },

            async openFolder(subfolder) {
                if (!this._activeProject) {
                    showNotification('Please select or create a project first', 'warning');
                    return;
                }

                const basePath = 'G:\\My Drive\\00 - Trajanus USA\\Traffic\\' + this._activeProject.name + '\\' + subfolder;
                const invoke = getInvoke();

                if (invoke) {
                    try {
                        await invoke('open_path', { path: basePath });
                        Terminal.success('Opened folder: ' + basePath);
                        showNotification('Opened ' + subfolder, 'success');
                    } catch (e) {
                        Terminal.error('Could not open folder: ' + e);
                    }
                } else {
                    showNotification('Folder: ' + basePath, 'info');
                }
            },

            assistantGuide() {
                const stepMessages = {
                    1: 'Project setup complete. Click "+ New Project" to create your TIA project folder structure.',
                    2: 'Time to gather input documents. Click "Open Project Folder" to add your Site Plan, ITE Trip Generation worksheet, and traffic counts to the project folder.',
                    3: 'Now build your Synchro models. Click "Synchro 12" to start. Create Background, Background+Growth, and Background+Site scenarios.',
                    4: 'Run your analysis. Generate LOS tables and export capacity reports from Synchro. Save outputs to the Deliverable folder.',
                    5: 'Write your TIA report. Click "TIA Template" to start with the standard template. Reference your analysis outputs.',
                    6: 'Finalize the deliverable. Create exhibits, compile appendix, and export final PDF. All files go in the Deliverable folder.'
                };

                const msg = stepMessages[this.currentStep];
                if (msg) {
                    Chat.addMessage('assistant', msg);
                }
            },

            toggleDocsPanel() {
                const body = document.getElementById('docs-panel-body');
                const toggle = document.getElementById('docs-toggle');
                if (body.classList.contains('collapsed')) {
                    body.classList.remove('collapsed');
                    toggle.innerHTML = '&#9660; Collapse';
                } else {
                    body.classList.add('collapsed');
                    toggle.innerHTML = '&#9658; Expand';
                }
            },

            toggleDocItem(checkbox) {
                const item = checkbox.closest('.doc-item');
                if (checkbox.checked) {
                    item.classList.add('checked');
                } else {
                    item.classList.remove('checked');
                }

                // Save to project
                if (this._activeProject) {
                    this._activeProject.checklist[checkbox.id] = checkbox.checked;
                    ProjectStore.saveProject(this._activeProject);
                }
            },

            restoreChecklist() {
                if (!this._activeProject || !this._activeProject.checklist) return;

                document.querySelectorAll('.doc-checkbox').forEach(cb => {
                    cb.checked = this._activeProject.checklist[cb.id] || false;
                    const item = cb.closest('.doc-item');
                    if (cb.checked) {
                        item.classList.add('checked');
                    } else {
                        item.classList.remove('checked');
                    }
                });
            }
        };

        // ==================== EVENT LISTENERS (CSP COMPLIANT) ====================
        document.addEventListener('DOMContentLoaded', () => {
            // App launchers
            document.querySelectorAll('[data-launch]').forEach(el => {
                el.addEventListener('click', () => Apps.launch(el.dataset.launch));
            });

            // Script cards
            document.querySelectorAll('[data-script]').forEach(el => {
                el.addEventListener('click', () => Scripts.run(el.dataset.script));
            });

            // Document cards
            document.querySelectorAll('[data-doc]').forEach(el => {
                el.addEventListener('click', () => Documents.open(el.dataset.doc));
            });

            // Agent buttons
            document.querySelectorAll('[data-agent]').forEach(el => {
                el.addEventListener('click', () => Agents.activate(el.dataset.agent));
            });

            // Agent Runner and Chat UI removed during TFE restructure
            // Their event bindings are no longer needed

            // Initialize TSE Workflow
            TseWorkflow.init();

            console.log('Traffic Studies workspace initialized with TSE workflow');

            // ==================== CHECKLIST PERSISTENCE ====================
            // Load saved checklist state
            const savedChecklist = localStorage.getItem('traffic-checklist-state');
            if (savedChecklist) {
                try {
                    const state = JSON.parse(savedChecklist);
                    document.querySelectorAll('.checklist-item').forEach(item => {
                        const task = item.dataset.task;
                        if (task && state.hasOwnProperty(task)) {
                            if (state[task]) {
                                item.classList.add('completed');
                            } else {
                                item.classList.remove('completed');
                            }
                        }
                    });
                } catch (e) {
                    console.error('Error loading checklist state:', e);
                }
            }

            // Update checklist count display
            function updateChecklistCount() {
                const items = document.querySelectorAll('.checklist-item');
                const completed = document.querySelectorAll('.checklist-item.completed').length;
                const countEl = document.getElementById('checklist-count');
                if (countEl) {
                    countEl.textContent = `${completed}/${items.length}`;
                }
            }
            updateChecklistCount();

            // Save checklist state to localStorage
            function saveChecklistState() {
                const state = {};
                document.querySelectorAll('.checklist-item').forEach(item => {
                    const task = item.dataset.task;
                    if (task) {
                        state[task] = item.classList.contains('completed');
                    }
                });
                localStorage.setItem('traffic-checklist-state', JSON.stringify(state));
            }

            // Add click handlers with persistence
            document.querySelectorAll('.checklist-item').forEach(item => {
                item.addEventListener('click', () => {
                    item.classList.toggle('completed');
                    updateChecklistCount();
                    saveChecklistState();
                });
            });
        });
    </script>

    <!-- KB Browser Component -->
    <script src="../js/kb-browser.js"></script>
    <script>
        // Initialize KB Browser for Traffic platform
        document.addEventListener('DOMContentLoaded', () => {
            kbBrowsers['traffic'] = new KBBrowserComponent('kb-browser-traffic', {
                platformName: 'traffic',
                sectionTitle: 'REFERENCE MATERIALS',
                officeTabLabel: 'Office Videos',
                claudeTabLabel: 'Claude Tutorials'
            });
        });
    </script>

    <!-- Jurisdiction Browser Component -->
    <script>
        // Jurisdiction Browser for TSE Workspace
        const JurisdictionBrowser = {
            data: null,
            selectedId: null,

            async init() {
                try {
                    const response = await fetch('../data/jurisdiction-templates.json');
                    this.data = await response.json();
                    this.renderList();
                    this.bindEvents();
                    console.log('[TSE] Jurisdiction Browser initialized with', this.data.jurisdictions.length, 'jurisdictions');
                } catch (error) {
                    console.error('[TSE] Failed to load jurisdiction templates:', error);
                    document.getElementById('jurisdiction-items').innerHTML =
                        '<div class="jurisdiction-error">Failed to load jurisdictions</div>';
                }
            },

            renderList() {
                const container = document.getElementById('jurisdiction-items');
                if (!this.data || !this.data.jurisdictions) return;

                container.innerHTML = this.data.jurisdictions.map(j => `
                    <div class="jurisdiction-item" data-id="${j.id}">
                        <span class="jurisdiction-icon">${this.getIcon(j.type)}</span>
                        <div class="jurisdiction-item-info">
                            <div class="jurisdiction-item-name">${j.name}</div>
                            <div class="jurisdiction-item-meta">${j.type}  Pop. ${this.formatPopulation(j.population)}</div>
                        </div>
                    </div>
                `).join('');
            },

            getIcon(type) {
                const icons = {
                    'city': '',
                    'town': '',
                    'municipality': ''
                };
                return icons[type?.toLowerCase()] || '';
            },

            formatPopulation(pop) {
                if (pop >= 1000000) return (pop / 1000000).toFixed(1) + 'M';
                if (pop >= 1000) return (pop / 1000).toFixed(0) + 'K';
                return pop.toString();
            },

            bindEvents() {
                // Search filter
                document.getElementById('jurisdiction-search').addEventListener('input', (e) => {
                    const query = e.target.value.toLowerCase();
                    document.querySelectorAll('.jurisdiction-item').forEach(item => {
                        const name = item.querySelector('.jurisdiction-item-name').textContent.toLowerCase();
                        item.style.display = name.includes(query) ? 'flex' : 'none';
                    });
                });

                // Item selection
                document.getElementById('jurisdiction-items').addEventListener('click', (e) => {
                    const item = e.target.closest('.jurisdiction-item');
                    if (item) {
                        document.querySelectorAll('.jurisdiction-item').forEach(i => i.classList.remove('active'));
                        item.classList.add('active');
                        this.selectedId = item.dataset.id;
                        this.renderDetail(this.selectedId);
                    }
                });
            },

            renderDetail(id) {
                const j = this.data.jurisdictions.find(j => j.id === id);
                if (!j) return;

                const container = document.getElementById('jurisdiction-detail');
                container.innerHTML = `
                    <div class="jurisdiction-header">
                        <h2>${j.name}</h2>
                        <span class="jurisdiction-type">${j.type}  ${j.county} County</span>
                    </div>

                    <div class="jurisdiction-section">
                        <h3> TIS Requirements</h3>
                        ${this.renderRequirements(j.requirements)}
                    </div>

                    <div class="jurisdiction-section">
                        <h3> Contacts</h3>
                        ${this.renderContacts(j.contacts)}
                    </div>

                    <div class="jurisdiction-section">
                        <h3> Submittal Procedure</h3>
                        ${this.renderProcedure(j.submittalProcedure)}
                    </div>

                    <div class="jurisdiction-section">
                        <h3> Approval Process</h3>
                        ${this.renderApproval(j.approvalProcess)}
                    </div>

                    <div class="jurisdiction-section">
                        <h3> Common Issues</h3>
                        ${this.renderIssues(j.commonIssues)}
                    </div>
                `;
            },

            renderRequirements(req) {
                const software = Array.isArray(req.softwareApproved) ? req.softwareApproved.join(', ') : (req.softwareApproved || 'N/A');
                const additional = req.additionalRequirements ?
                    `<div class="jurisdiction-field"><span class="field-label">Additional:</span><ul style="margin: 4px 0 0 20px; padding: 0;">${req.additionalRequirements.map(r => `<li>${r}</li>`).join('')}</ul></div>` : '';
                return `
                    <div class="jurisdiction-field"><span class="field-label">Study Threshold:</span> ${req.trafficStudyThreshold || 'N/A'}</div>
                    <div class="jurisdiction-field"><span class="field-label">LOS Standard:</span> ${req.levelOfService || 'N/A'}</div>
                    <div class="jurisdiction-field"><span class="field-label">Approved Software:</span> ${software}</div>
                    <div class="jurisdiction-field"><span class="field-label">Trip Generation:</span> ${req.tripGeneration || 'ITE Manual'}</div>
                    <div class="jurisdiction-field"><span class="field-label">Study Area:</span> ${req.studyArea || 'N/A'}</div>
                    <div class="jurisdiction-field"><span class="field-label">Horizon Year:</span> ${req.horizonYear || 'N/A'}</div>
                    <div class="jurisdiction-field"><span class="field-label">Peak Hours:</span> ${req.peakHours || 'N/A'}</div>
                    ${additional}
                `;
            },

            renderContacts(contacts) {
                return `
                    <div class="jurisdiction-contact-card">
                        <div class="contact-title">${contacts.department || 'Traffic Engineering'}</div>
                        <div class="contact-field">${contacts.trafficEngineering?.name || ''}</div>
                        <div class="contact-field"> ${contacts.trafficEngineering?.phone || 'N/A'}</div>
                        <div class="contact-field"> ${contacts.trafficEngineering?.email || 'N/A'}</div>
                        ${contacts.trafficEngineering?.address ? `<div class="contact-field"> ${contacts.trafficEngineering.address}</div>` : ''}
                    </div>
                    <div class="jurisdiction-contact-card">
                        <div class="contact-title">Plan Review / Development Services</div>
                        <div class="contact-field">${contacts.planReview?.name || ''}</div>
                        <div class="contact-field"> ${contacts.planReview?.phone || 'N/A'}</div>
                        <div class="contact-field"> ${contacts.planReview?.email || 'N/A'}</div>
                        ${contacts.planReview?.website ? `<div class="contact-field"> <a href="${contacts.planReview.website}" target="_blank">${contacts.planReview.website}</a></div>` : ''}
                    </div>
                `;
            },

            renderProcedure(proc) {
                return `
                    <div class="jurisdiction-field"><span class="field-label">Format:</span> ${proc.format || 'PDF'}</div>
                    <div class="jurisdiction-field"><span class="field-label">Copies:</span> ${proc.copies || 'N/A'}</div>
                    <div class="jurisdiction-field"><span class="field-label">Review Time:</span> ${proc.reviewTime || 'N/A'}</div>
                    <div class="jurisdiction-field"><span class="field-label">Resubmittal:</span> ${proc.resubmittalTime || 'N/A'}</div>
                    <div class="jurisdiction-field"><span class="field-label">Fee:</span> ${proc.fees || 'Contact for estimate'}</div>
                    ${proc.preSubmittalMeeting ? `<div class="jurisdiction-field"><span class="field-label">Pre-submittal:</span> ${proc.preSubmittalMeeting}</div>` : ''}
                    ${proc.steps && proc.steps.length ? `
                    <div class="jurisdiction-steps">
                        <div class="steps-title">Submittal Steps:</div>
                        <ol>
                            ${proc.steps.map(step => `<li>${step.replace(/^\d+\.\s*/, '')}</li>`).join('')}
                        </ol>
                    </div>` : ''}
                `;
            },

            renderApproval(approval) {
                const conditions = approval.conditionsCommon ?
                    `<div class="jurisdiction-field"><span class="field-label">Common Conditions:</span><ul style="margin: 4px 0 0 20px; padding: 0;">${approval.conditionsCommon.map(c => `<li>${c}</li>`).join('')}</ul></div>` : '';
                return `
                    <div class="jurisdiction-field"><span class="field-label">Review Authority:</span> ${approval.reviewAuthority || 'N/A'}</div>
                    <div class="jurisdiction-field"><span class="field-label">Appeal Process:</span> ${approval.appealProcess || 'N/A'}</div>
                    <div class="jurisdiction-field"><span class="field-label">Validity Period:</span> ${approval.validityPeriod || 'N/A'}</div>
                    ${conditions}
                `;
            },

            renderIssues(issues) {
                if (!issues || !issues.length) return '<p>No common issues documented.</p>';
                return `<ul class="issues-list" style="margin: 0; padding: 0 0 0 20px;">
                    ${issues.map(issue => `<li style="margin-bottom: 8px; color: #FFD700;">${issue}</li>`).join('')}
                </ul>`;
            }
        };

        // Initialize Jurisdiction Browser
        document.addEventListener('DOMContentLoaded', () => {
            JurisdictionBrowser.init();
            window.JurisdictionBrowser = JurisdictionBrowser;
        });
    </script>
</body>
</html>
