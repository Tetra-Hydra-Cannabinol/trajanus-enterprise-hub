<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Traffic Studies - Trajanus Enterprise Hub</title>
    <style>
        /* ==================== CSS VARIABLES ==================== */
        :root {
            /* TRAJANUS BLACK/SILVER PALETTE - ALL SILVER ON BLACK */
            --bg-base: #0a0a0a;
            --bg-surface: #0a0a0a;
            --bg-card: #0a0a0a;
            --bg-elevated: #1a1a1a;
            --bg-hover: #2a2a2a;
            --border-subtle: #c0c0c0;
            --border-accent: #c0c0c0;
            --text-light: #c0c0c0;
            --text-primary: #c0c0c0;
            --text-secondary: #c0c0c0;
            --text-muted: #c0c0c0;
            --accent: #c0c0c0;
            --accent-silver: #c0c0c0;
            --silver: #c0c0c0;
            --silver-light: #e0e0e0;
            --silver-dark: #a0a0a0;
            --gold: #00AAFF;
            --gold-light: #33BBFF;
            --gold-dark: #0088CC;
            --blue: #4a90d9;
            --blue-light: #6ab0f9;
            --blue-dark: #3a70b9;
            --success: #4ade80;
            --info: #60a5fa;
            --warning: #fbbf24;
            --error: #f87171;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: var(--bg-base);
            color: var(--text-light);
            line-height: 1.5;
            border: 2px solid #0066CC;
        }

        /* ==================== STICKY HERO SECTION ==================== */
        .hero-section {
            position: sticky;
            top: 0;
            z-index: 1000;
            background: var(--bg-base);
            border-bottom: 1px solid var(--gold);
            padding: 16px 32px;
        }

        .hero-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .hero-brand {
            display: flex;
            flex-direction: column;
            gap: 4px;
            align-items: center;
            text-align: center;
            flex: 1;
        }

        .hero-company {
            font-size: 12px;
            font-weight: 500;
            color: var(--gold);
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .hero-company .tm {
            font-size: 8px;
            vertical-align: super;
        }

        .hero-toolkit {
            font-family: Tahoma, sans-serif;
            font-size: 24px;
            font-weight: 700;
            color: var(--gold);
            letter-spacing: 1px;
        }

        .hero-description {
            font-size: 13px;
            color: var(--text-light);
            max-width: 400px;
            line-height: 1.4;
            margin-top: 4px;
        }

        .hero-nav {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .hero-home-btn {
            width: 130px;
            height: 36px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.75rem;
            font-weight: 600;
            transition: all 0.15s ease;
            border: 1px solid #00AAFF;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            color: #00AAFF;
            background: transparent;
            text-decoration: none;
        }

        .hero-home-btn:hover {
            background: rgba(0, 170, 255, 0.15);
            color: #33BBFF;
            border-color: #33BBFF;
        }

        /* ==================== INTRODUCTION SECTION ==================== */
        .intro-section {
            padding: 24px 32px;
            background: var(--bg-base);
            border-bottom: 1px solid var(--border-subtle);
        }

        .intro-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            cursor: pointer;
        }

        .intro-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--gold);
            text-transform: uppercase;
            letter-spacing: 1.5px;
        }

        .intro-toggle {
            font-size: 14px;
            color: var(--text-muted);
            transition: transform 0.3s;
        }

        .intro-toggle.collapsed {
            transform: rotate(180deg);
        }

        .intro-content {
            display: grid;
            gap: 24px;
            transition: all 0.3s ease;
        }

        .intro-content.collapsed {
            display: none;
        }

        /* Decision Tree */
        .intro-decision {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
        }

        .decision-card {
            padding: 16px;
            background: var(--bg-base);
            border: 1px solid var(--blue);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .decision-card:hover {
            background: var(--bg-hover);
            border-color: var(--gold);
            transform: translateY(-2px);
        }

        .decision-card.selected {
            border-color: var(--gold);
            background: var(--bg-elevated);
        }

        .decision-icon {
            font-size: 28px;
            margin-bottom: 8px;
        }

        .decision-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-light);
            margin-bottom: 4px;
        }

        .decision-desc {
            font-size: 11px;
            color: var(--text-muted);
        }

        /* Tools Grid */
        .intro-tools-section {
            margin-top: 8px;
        }

        .intro-section-label {
            font-size: 11px;
            font-weight: 600;
            color: var(--gold);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 12px;
        }

        .intro-tools-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 12px;
        }

        .intro-tool-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            padding: 12px 8px;
            background: var(--bg-base);
            border: 1px solid var(--blue);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .intro-tool-card:hover {
            background: var(--bg-hover);
            border-color: var(--gold);
        }

        .intro-tool-icon {
            font-size: 24px;
        }

        .intro-tool-name {
            font-size: 11px;
            color: var(--text-light);
            text-align: center;
        }

        /* Workflow Overview */
        .intro-workflow {
            margin-top: 8px;
        }

        .intro-workflow-steps {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .intro-workflow-step {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 12px;
            background: var(--bg-base);
            border: 1px solid var(--border-subtle);
            border-radius: 4px;
            font-size: 11px;
            color: var(--text-light);
        }

        .intro-workflow-step .step-num {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 18px;
            height: 18px;
            background: var(--gold);
            color: var(--bg-base);
            border-radius: 50%;
            font-size: 10px;
            font-weight: 700;
        }

        .intro-workflow-connector {
            color: var(--text-muted);
            font-size: 12px;
        }

        /* Folders Reference */
        .intro-folders {
            margin-top: 8px;
        }

        .intro-folders-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
        }

        .intro-folder {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 12px;
            background: var(--bg-base);
            border: 1px solid var(--border-subtle);
            border-radius: 4px;
            font-size: 11px;
            color: var(--text-light);
        }

        .intro-folder-icon {
            font-size: 16px;
        }

        /* Tips Section */
        .intro-tips {
            margin-top: 8px;
        }

        .intro-tips-list {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
        }

        .intro-tip {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding: 12px;
            background: var(--bg-base);
            border: 1px solid var(--border-subtle);
            border-radius: 6px;
        }

        .intro-tip-icon {
            font-size: 18px;
            flex-shrink: 0;
        }

        .intro-tip-text {
            font-size: 11px;
            color: var(--text-muted);
            line-height: 1.4;
        }

        /* ==================== WORKSPACE CONTAINER ==================== */
        .workspace-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* ==================== HEADER ==================== */
        .workspace-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 32px;
            background: var(--bg-base);
            border-bottom: 1px solid var(--border-subtle);
        }

        .header-title h1 {
            color: var(--accent-silver);
            font-size: 22px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .header-title p {
            color: var(--text-muted);
            font-size: 13px;
        }

        .home-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            background: transparent;
            border: 1px solid var(--accent-silver);
            color: var(--accent-silver);
            font-size: 14px;
            border-radius: 6px;
            cursor: pointer;
            text-decoration: none;
            transition: all 0.2s;
        }

        .home-btn:hover {
            background: var(--accent-silver);
            color: var(--bg-base);
        }

        /* ==================== MAIN CONTENT ==================== */
        .main-content {
            flex: 1;
            padding: 24px 32px;
            overflow-y: auto;
        }

        /* ==================== SECTION DIVIDERS ==================== */
        .section-divider {
            display: flex;
            align-items: center;
            gap: 16px;
            margin: 32px 0 20px 0;
        }

        .section-divider:first-child {
            margin-top: 0;
        }

        .section-title {
            font-size: 14px;
            font-weight: 600;
            color: #00AAFF;
            text-transform: uppercase;
            letter-spacing: 2px;
            white-space: nowrap;
        }

        .section-line {
            flex: 1;
            height: 2px;
            background: linear-gradient(90deg, #00AAFF 0%, #0066CC 50%, transparent 100%);
        }

        .section-description {
            color: var(--text-secondary);
            font-size: 14px;
            margin-top: 4px;
            max-width: 800px;
        }

        /* ==================== APP GRID ==================== */
        .app-category {
            margin-bottom: 20px;
        }

        .category-label {
            font-size: 11px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }

        .app-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 12px;
        }

        .app-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            padding: 16px 12px;
            background: var(--bg-base);
            border: 1px solid var(--blue);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
        }

        .app-card:hover {
            background: var(--bg-hover);
            border-color: var(--blue-light);
            transform: translateY(-2px);
        }

        .app-icon {
            font-size: 28px;
            color: var(--accent-silver);
        }

        .app-label {
            font-size: 12px;
            color: var(--text-light);
            text-align: center;
        }

        /* ==================== SCRIPT CARDS ==================== */
        .script-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 12px;
        }

        .script-card {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 14px 16px;
            background: var(--bg-base);
            border: 1px solid var(--blue);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .script-card:hover {
            background: var(--bg-hover);
            border-color: var(--blue-light);
        }

        .script-icon {
            font-size: 22px;
            color: var(--accent-silver);
        }

        .script-info {
            flex: 1;
        }

        .script-name {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-light);
            margin-bottom: 2px;
        }

        .script-desc {
            font-size: 12px;
            color: var(--text-muted);
        }

        /* ==================== DOCUMENT SECTIONS ==================== */
        .doc-category {
            margin-bottom: 20px;
        }

        .doc-category-header {
            font-size: 12px;
            font-weight: 500;
            color: var(--accent-silver);
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .doc-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
            gap: 10px;
        }

        .doc-card {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 14px;
            background: var(--bg-base);
            border: 1px solid var(--blue);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .doc-card:hover {
            background: var(--bg-hover);
            border-color: var(--blue-light);
        }

        .doc-icon {
            font-size: 20px;
            color: var(--accent-silver);
        }

        .doc-info {
            flex: 1;
        }

        .doc-name {
            font-size: 13px;
            color: var(--text-light);
        }

        .doc-meta {
            font-size: 11px;
            color: var(--text-muted);
        }

        /* ==================== AGENT CARDS ==================== */
        .agent-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 12px;
        }

        .agent-card {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 16px;
            background: var(--bg-base);
            border: 1px solid var(--blue);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .agent-card:hover {
            background: var(--bg-hover);
            border-color: var(--blue-light);
        }

        .agent-icon {
            font-size: 24px;
            color: var(--accent-silver);
        }

        .agent-info {
            flex: 1;
        }

        .agent-name {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-light);
            margin-bottom: 2px;
        }

        .agent-desc {
            font-size: 12px;
            color: var(--text-muted);
        }

        .agent-status {
            font-size: 10px;
            padding: 3px 8px;
            border-radius: 4px;
            background: rgba(169, 180, 192, 0.1);
            color: var(--accent-silver);
        }

        /* ==================== CHAT SECTION ==================== */
        .chat-section {
            background: var(--bg-base);
            border: 1px solid var(--blue);
            border-radius: 8px;
            overflow: hidden;
        }

        .chat-header {
            padding: 14px 18px;
            background: var(--bg-surface);
            border-bottom: 1px solid var(--blue);
        }

        .chat-header-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--gold);
        }

        .chat-header-subtitle {
            font-size: 12px;
            color: var(--text-muted);
        }

        /* Chat Messages Area - Brain Waves Background */
        .chat-messages {
            height: 500px;
            overflow-y: auto;
            padding: 16px;
            position: relative;
            background-image: url('../assets/ai-generated-8909412_1280.jpg');
            background-size: contain;
            background-position: center;
            background-repeat: no-repeat;
        }

        .chat-messages::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(10, 10, 10, 0.88);
            pointer-events: none;
        }

        .chat-messages > * {
            position: relative;
            z-index: 1;
        }

        .chat-message {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 10px;
            font-size: 14px;
            line-height: 1.5;
        }

        .chat-message.assistant {
            background: rgba(0, 170, 255, 0.1);
            border-left: 3px solid #00AAFF;
            color: #00AAFF;
            font-family: Tahoma, sans-serif;
            margin-right: 15%;
        }

        .chat-message.user {
            background: rgba(46, 204, 113, 0.15);
            border: 1px solid rgba(46, 204, 113, 0.3);
            color: #2ECC71;
            font-family: Arial, sans-serif;
            margin-left: 15%;
        }

        .chat-input-area {
            display: flex;
            gap: 10px;
            padding: 16px;
            border-top: 1px solid var(--blue);
        }

        .chat-input {
            flex: 1;
            padding: 12px 14px;
            background: var(--bg-base);
            border: 1px solid var(--blue);
            border-radius: 6px;
            color: var(--text-light);
            font-size: 14px;
            font-family: inherit;
            resize: none;
        }

        .chat-input:focus {
            outline: none;
            border-color: var(--blue-light);
        }

        .chat-input::placeholder {
            color: var(--text-muted);
        }

        .chat-send-btn {
            padding: 12px 24px;
            background: var(--blue);
            color: var(--bg-base);
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .chat-send-btn:hover {
            background: var(--blue-light);
        }

        /* ==================== TYPING INDICATOR ==================== */
        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 12px 16px;
            background: var(--bg-surface);
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
            margin-right: 15%;
            width: fit-content;
        }

        .typing-indicator span {
            width: 6px;
            height: 6px;
            background: var(--accent-silver);
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out;
        }

        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); opacity: 0.4; }
            30% { transform: translateY(-4px); opacity: 1; }
        }

        /* ==================== NOTIFICATION ==================== */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 8px;
            z-index: 9999;
            animation: slideIn 0.3s ease;
        }

        .notification.info {
            background: var(--bg-surface);
            border: 1px solid var(--accent-silver);
            color: var(--text-light);
        }

        .notification.warning {
            background: #2d2a00;
            border: 1px solid var(--accent-gold);
            color: var(--accent-gold);
        }

        .notification.success {
            background: #1a3a1a;
            border: 1px solid var(--success);
            color: var(--success);
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* ==================== TRAJANUS WINDOW SYSTEM ==================== */
        .trajanus-window-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.2s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .trajanus-window {
            background: #1a1a1a;
            border: 2px solid #c0c0c0;
            border-radius: 8px;
            min-width: 500px;
            max-width: 800px;
            max-height: 80vh;
            box-shadow: 0 0 30px rgba(192, 192, 192, 0.2), 0 0 60px rgba(0, 0, 0, 0.5);
            animation: windowSlide 0.2s ease;
        }

        @keyframes windowSlide {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .trajanus-window-header {
            background: linear-gradient(180deg, #2d2d2d 0%, #1a1a1a 100%);
            border-bottom: 1px solid #c0c0c0;
            padding: 14px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 6px 6px 0 0;
        }

        .trajanus-window-title {
            color: #c0c0c0;
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 3px;
        }

        .trajanus-window-close {
            background: transparent;
            border: 1px solid #4a4a4a;
            color: #c0c0c0;
            width: 28px;
            height: 28px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .trajanus-window-close:hover {
            border-color: #c0c0c0;
            background: #2d2d2d;
        }

        .trajanus-window-body {
            padding: 24px;
            color: #ffffff;
            max-height: 60vh;
            overflow-y: auto;
        }

        /* Terminal styling */
        .terminal-output {
            background: #0a0a0a;
            border: 1px solid #4a4a4a;
            font-family: 'Consolas', 'Monaco', monospace;
        }

        .terminal-line {
            padding: 2px 0;
            line-height: 1.4;
        }

        .terminal-line.success { color: #4ade80; }
        .terminal-line.error { color: #f87171; }
        .terminal-line.info { color: #60a5fa; }
        .terminal-line.warning { color: #fbbf24; }

        /* ==================== TSE WORKFLOW ADDITIONS ==================== */

        /* Project Bar */
        .project-bar {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 12px 32px;
            background: var(--bg-surface);
            border-bottom: 1px solid var(--blue);
        }

        .project-bar-label {
            font-size: 12px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .project-select {
            flex: 1;
            max-width: 400px;
            padding: 8px 12px;
            background: var(--bg-base);
            border: 1px solid var(--blue);
            border-radius: 6px;
            color: var(--text-light);
            font-size: 14px;
        }

        .project-select:focus {
            outline: none;
            border-color: var(--blue-light);
        }

        .new-project-btn {
            padding: 8px 16px;
            background: transparent;
            border: 1px solid var(--blue);
            color: var(--text-light);
            font-size: 13px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .new-project-btn:hover {
            background: var(--blue);
            color: var(--bg-base);
        }

        /* Workflow Tracker */
        .workflow-tracker {
            background: var(--bg-surface);
            border: 1px solid var(--blue);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 24px;
        }

        .workflow-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .workflow-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--gold);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .workflow-progress {
            font-size: 12px;
            color: var(--text-muted);
        }

        .workflow-steps {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .workflow-step {
            flex: 1 1 calc(20% - 8px);
            min-width: 100px;
            max-width: calc(20% - 8px);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            padding: 12px 8px;
            background: var(--bg-base);
            border: 1px solid var(--blue);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            box-sizing: border-box;
        }

        .workflow-step:hover {
            border-color: var(--blue-light);
        }

        .workflow-step.active {
            border-color: var(--gold);
            background: var(--bg-elevated);
        }

        .workflow-step.completed {
            border-color: var(--success);
        }

        .workflow-step-number {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background: var(--bg-surface);
            border: 1px solid var(--blue);
            font-size: 11px;
            font-weight: 600;
            color: var(--text-muted);
        }

        .workflow-step.active .workflow-step-number {
            background: var(--gold);
            border-color: var(--gold);
            color: var(--bg-base);
        }

        .workflow-step.completed .workflow-step-number {
            background: var(--success);
            border-color: var(--success);
            color: var(--bg-base);
        }

        .workflow-step-name {
            font-size: 11px;
            color: var(--text-secondary);
            text-align: center;
        }

        .workflow-step.active .workflow-step-name {
            color: var(--text-light);
        }

        /* ==================== WORKFLOW WORKSPACE PANELS ==================== */
        .workflow-workspace {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease, opacity 0.3s ease;
            opacity: 0;
            margin-bottom: 0;
        }

        .workflow-workspace.open {
            max-height: 2000px;
            opacity: 1;
            margin-bottom: 24px;
        }

        .workspace-panel {
            background: var(--bg-surface);
            border: 1px solid var(--blue);
            border-radius: 8px;
            padding: 24px;
            display: none;
        }

        .workspace-panel.active {
            display: block;
        }

        .workspace-panel h3 {
            font-size: 16px;
            font-weight: 600;
            color: var(--gold);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin: 0 0 20px 0;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--blue);
        }

        .ws-form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 24px;
        }

        .ws-form-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .ws-form-group.full-width {
            grid-column: 1 / -1;
        }

        .ws-form-group label {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .ws-form-group input,
        .ws-form-group select {
            background: var(--bg-base);
            border: 1px solid var(--blue);
            border-radius: 6px;
            padding: 10px 12px;
            color: var(--text-light);
            font-size: 14px;
            font-family: inherit;
            transition: border-color 0.2s;
        }

        .ws-form-group input:focus,
        .ws-form-group select:focus {
            outline: none;
            border-color: var(--gold);
        }

        .ws-form-group input::placeholder {
            color: #555;
        }

        .ws-section-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--gold);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin: 24px 0 12px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .ws-section-title::after {
            content: '';
            flex: 1;
            height: 1px;
            background: var(--blue);
        }

        /* Buildings Table */
        .buildings-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-bottom: 12px;
        }

        .buildings-table th {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 8px 10px;
            text-align: left;
            border-bottom: 1px solid var(--blue);
        }

        .buildings-table td {
            padding: 6px 4px;
        }

        .buildings-table input[type="text"],
        .buildings-table input[type="number"] {
            background: var(--bg-base);
            border: 1px solid var(--blue);
            border-radius: 4px;
            padding: 8px 10px;
            color: var(--text-light);
            font-size: 13px;
            font-family: inherit;
            width: 100%;
            box-sizing: border-box;
        }

        .buildings-table input:focus {
            outline: none;
            border-color: var(--gold);
        }

        .buildings-table input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: var(--gold);
        }

        .buildings-table .remove-building-btn {
            background: transparent;
            border: 1px solid #ff4444;
            color: #ff4444;
            border-radius: 4px;
            padding: 6px 10px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }

        .buildings-table .remove-building-btn:hover {
            background: #ff4444;
            color: #fff;
        }

        .add-building-btn {
            background: transparent;
            border: 1px dashed var(--blue);
            color: var(--blue-light);
            border-radius: 6px;
            padding: 10px 20px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.2s;
            margin-bottom: 24px;
        }

        .add-building-btn:hover {
            border-color: var(--gold);
            color: var(--gold);
            background: var(--bg-elevated);
        }

        /* File Drop Zone */
        .ws-drop-zone {
            border: 2px dashed var(--blue);
            border-radius: 8px;
            padding: 32px;
            text-align: center;
            color: var(--text-muted);
            font-size: 14px;
            transition: all 0.2s;
            cursor: pointer;
            margin-bottom: 24px;
        }

        .ws-drop-zone:hover {
            border-color: var(--gold);
            background: var(--bg-elevated);
        }

        .ws-drop-zone.dragover {
            border-color: var(--gold);
            background: var(--bg-elevated);
            color: var(--gold);
        }

        .ws-drop-icon {
            font-size: 32px;
            margin-bottom: 8px;
        }

        .ws-drop-text {
            font-size: 14px;
            margin-bottom: 4px;
        }

        .ws-drop-subtext {
            font-size: 11px;
            color: #555;
        }

        /* Submit Button */
        .ws-submit-btn {
            background: var(--gold);
            color: var(--bg-base);
            border: none;
            border-radius: 6px;
            padding: 14px 32px;
            font-size: 14px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.2s;
            width: 100%;
        }

        .ws-submit-btn:hover {
            filter: brightness(1.15);
        }

        /* ==================== VALIDATION UI ==================== */
        .ws-section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }
        .ws-section-header .ws-section-title {
            margin-bottom: 0;
        }
        .ws-section-badge {
            font-size: 11px;
            font-weight: 600;
            padding: 3px 10px;
            border-radius: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .ws-section-badge.incomplete {
            background: rgba(255,255,255,0.06);
            color: var(--text-muted);
            border: 1px solid #333;
        }
        .ws-section-badge.valid {
            background: rgba(74,222,128,0.12);
            color: var(--success);
            border: 1px solid var(--success);
        }
        .ws-section-badge.warning {
            background: rgba(251,191,36,0.12);
            color: #fbbf24;
            border: 1px solid #fbbf24;
        }
        .ws-validation-panel {
            background: var(--bg-base);
            border: 1px solid #222;
            border-radius: 8px;
            padding: 14px 16px;
            margin-bottom: 20px;
            display: none;
        }
        .ws-validation-panel.visible {
            display: block;
        }
        .ws-validation-panel h4 {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-muted);
            margin: 0 0 10px 0;
        }
        .ws-val-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 0;
            font-size: 13px;
            color: var(--text-light);
            border-bottom: 1px solid #1a1a1a;
        }
        .ws-val-item:last-child {
            border-bottom: none;
        }
        .ws-val-icon {
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            flex-shrink: 0;
        }
        .ws-val-icon.pass { color: var(--success); }
        .ws-val-icon.fail { color: #ef4444; }
        .ws-val-icon.warn { color: #fbbf24; }
        .ws-val-detail {
            color: var(--text-muted);
            font-size: 11px;
            margin-left: auto;
            flex-shrink: 0;
        }

        /* ==================== PROJECT SUMMARY CARD ==================== */
        .project-summary-card {
            background: var(--bg-surface);
            border: 1px solid var(--gold);
            border-radius: 8px;
            padding: 24px;
            margin-bottom: 24px;
        }

        .project-summary-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--blue);
        }

        .project-summary-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--gold);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .project-summary-status {
            font-size: 12px;
            padding: 4px 12px;
            border-radius: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .project-summary-status.active {
            background: rgba(74, 222, 128, 0.15);
            color: var(--success);
            border: 1px solid var(--success);
        }

        .project-summary-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 12px;
            margin-bottom: 16px;
        }

        .project-summary-field {
            background: var(--bg-base);
            border: 1px solid var(--blue);
            border-radius: 6px;
            padding: 10px 12px;
        }

        .project-summary-field .field-label {
            font-size: 10px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }

        .project-summary-field .field-value {
            font-size: 14px;
            color: var(--text-light);
            font-weight: 500;
        }

        .project-summary-buildings {
            margin-top: 12px;
        }

        .project-summary-buildings .building-tag {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: var(--bg-base);
            border: 1px solid var(--blue);
            border-radius: 4px;
            padding: 6px 12px;
            font-size: 12px;
            color: var(--text-light);
            margin: 0 6px 6px 0;
        }

        /* ==================== PROJECT FOLDER TRACKER ==================== */
        .project-folder-tracker {
            background: var(--bg-surface);
            border: 1px solid var(--blue);
            border-radius: 8px;
            padding: 24px;
            margin-bottom: 24px;
        }

        .folder-tracker-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--blue);
        }

        .folder-tracker-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--gold);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .folder-tracker-progress {
            font-size: 12px;
            color: var(--text-muted);
        }

        .folder-step-group {
            margin-bottom: 16px;
        }

        .folder-step-label {
            font-size: 11px;
            font-weight: 600;
            color: var(--gold);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .folder-step-label .step-badge {
            background: var(--bg-base);
            border: 1px solid var(--blue);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            color: var(--text-muted);
        }

        .folder-step-label .step-badge.done {
            background: var(--success);
            border-color: var(--success);
            color: var(--bg-base);
        }

        .folder-step-label .step-badge.partial {
            background: rgba(251,191,36,0.15);
            border-color: #fbbf24;
            color: #fbbf24;
            border-radius: 10px;
            width: auto;
            padding: 0 6px;
            font-size: 9px;
        }

        .folder-dep-note {
            padding: 6px 12px 6px 42px;
            margin-bottom: 4px;
        }

        .item-status.pending {
            color: var(--text-muted);
            font-size: 11px;
        }

        .item-status.done {
            color: var(--success);
            font-size: 11px;
        }

        .folder-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            background: var(--bg-base);
            border: 1px solid var(--blue);
            border-radius: 4px;
            margin-bottom: 4px;
            font-size: 13px;
            color: var(--text-light);
        }

        .folder-item.pending {
            opacity: 0.5;
            border-style: dashed;
        }

        .folder-item .item-icon {
            font-size: 14px;
            flex-shrink: 0;
        }

        .folder-item .item-name {
            flex: 1;
        }

        .folder-item .item-status {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .folder-item .item-status.done {
            color: var(--success);
        }

        .folder-item .item-status.pending {
            color: var(--text-muted);
        }

        /* Required Documents Panel */
        .docs-panel {
            background: var(--bg-surface);
            border: 1px solid var(--blue);
            border-radius: 8px;
            margin-bottom: 24px;
        }

        .docs-panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            cursor: pointer;
            border-bottom: 1px solid var(--blue);
        }

        .docs-panel-header:hover {
            background: var(--bg-elevated);
        }

        .docs-panel-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--gold);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .docs-panel-toggle {
            font-size: 12px;
            color: var(--text-muted);
        }

        .docs-panel-body {
            padding: 16px 20px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }

        .docs-panel-body.collapsed {
            display: none;
        }

        .docs-category-title {
            font-size: 11px;
            font-weight: 600;
            color: var(--gold);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 10px;
            padding-bottom: 6px;
            border-bottom: 1px solid var(--blue);
        }

        .doc-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 0;
        }

        .doc-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: var(--success);
        }

        .doc-item-label {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .doc-item.checked .doc-item-label {
            color: var(--success);
            text-decoration: line-through;
        }

        /* Step Instructions Panel */
        .step-instructions {
            background: var(--bg-surface);
            border: 1px solid var(--blue);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 24px;
        }

        .step-instructions-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--gold);
            margin-bottom: 12px;
        }

        .step-instructions-content {
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.7;
        }

        .step-instructions-content ol {
            margin-left: 20px;
            margin-top: 8px;
        }

        .step-instructions-content li {
            margin-bottom: 8px;
        }

        .step-instructions-content strong {
            color: var(--text-light);
        }

        /* Step Actions */
        .step-actions {
            display: flex;
            gap: 12px;
            margin-top: 20px;
            padding-top: 16px;
            border-top: 1px solid var(--blue);
        }

        .action-btn {
            padding: 12px 24px;
            background: linear-gradient(145deg, #00BBFF, #0088CC);
            border: 1px solid #00CCFF;
            color: #ffffff;
            font-size: 14px;
            font-weight: 600;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.15s ease;
            box-shadow: 0 3px 0 #005588, 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        .action-btn:hover {
            background: linear-gradient(145deg, #33CCFF, #00AAFF);
            color: #ffffff;
            box-shadow: 0 2px 0 #005588, 0 3px 6px rgba(0, 0, 0, 0.3);
            transform: translateY(1px);
        }

        .action-btn:active {
            transform: translateY(3px);
            box-shadow: 0 0 0 #005588, 0 1px 3px rgba(0, 0, 0, 0.3);
        }

        /* Step Tools */
        .step-tools {
            margin-top: 20px;
            padding-top: 16px;
            border-top: 1px solid var(--blue);
        }

        .step-tools-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--gold);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 12px;
        }

        .step-tools-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .step-tool-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            background: transparent;
            border: 1px solid var(--blue);
            color: var(--accent-silver);
            font-size: 13px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .step-tool-btn:hover {
            background: var(--blue);
            color: var(--bg-base);
        }

        .step-tool-icon {
            font-size: 18px;
        }

        /* New Project Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10000;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.visible {
            display: flex;
        }

        .modal-content {
            background: var(--bg-surface);
            border: 2px solid var(--blue);
            border-radius: 8px;
            width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid var(--blue);
        }

        .modal-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--gold);
        }

        .modal-close {
            background: transparent;
            border: 1px solid var(--blue);
            color: var(--text-muted);
            width: 28px;
            height: 28px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 18px;
        }

        .modal-close:hover {
            border-color: var(--blue-light);
            color: var(--text-light);
        }

        .modal-body {
            padding: 20px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            font-size: 12px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
        }

        .form-input, .form-select {
            width: 100%;
            padding: 10px 12px;
            background: var(--bg-base);
            border: 1px solid var(--blue);
            border-radius: 6px;
            color: var(--text-light);
            font-size: 14px;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: var(--blue-light);
        }

        .modal-footer {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            padding: 16px 20px;
            border-top: 1px solid var(--blue);
        }

        .btn-secondary {
            padding: 10px 20px;
            background: transparent;
            border: 1px solid var(--blue);
            color: var(--text-secondary);
            font-size: 14px;
            border-radius: 6px;
            cursor: pointer;
        }

        .btn-secondary:hover {
            border-color: var(--blue-light);
            color: var(--text-light);
        }

        .btn-primary {
            padding: 10px 20px;
            background: var(--blue);
            border: 1px solid var(--blue);
            color: var(--bg-base);
            font-size: 14px;
            font-weight: 600;
            border-radius: 6px;
            cursor: pointer;
        }

        .btn-primary:hover {
            background: var(--blue-light);
        }

        /* ==================== PLATFORM GUIDANCE SECTION ==================== */
        /* BLACK/SILVER/GOLD Color Scheme */
        .guidance-section {
            padding: 24px 32px;
            background: #0a0a0a;
            border-bottom: 1px solid #00AAFF;
        }

        .guidance-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            cursor: pointer;
        }

        .guidance-title {
            font-size: 16px;
            font-weight: 600;
            color: #00AAFF;
            text-transform: uppercase;
            letter-spacing: 1.5px;
        }

        .guidance-toggle {
            font-size: 14px;
            color: #c0c0c0;
            transition: transform 0.3s;
        }

        .guidance-toggle.collapsed {
            transform: rotate(180deg);
        }

        .guidance-content {
            display: grid;
            gap: 24px;
            transition: all 0.3s ease;
        }

        .guidance-content.collapsed {
            display: none;
        }

        .guidance-description {
            font-size: 14px;
            color: #c0c0c0;
            line-height: 1.6;
            margin-bottom: 8px;
            padding: 16px;
            background: #1a1a1a;
            border-left: 3px solid #00AAFF;
            border-radius: 0 6px 6px 0;
        }

        .guidance-tools-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
        }

        @media (max-width: 900px) {
            .guidance-tools-grid {
                grid-template-columns: 1fr;
            }
        }

        .guidance-tool-card {
            background: #0a0a0a;
            border: 1px solid #c0c0c0;
            border-radius: 10px;
            padding: 20px;
            transition: all 0.2s;
        }

        .guidance-tool-card:hover {
            border-color: #00AAFF;
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(212, 175, 55, 0.2);
        }

        .guidance-tool-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .guidance-tool-icon {
            font-size: 28px;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #1a1a1a;
            border-radius: 8px;
            border: 1px solid #c0c0c0;
        }

        .guidance-tool-name {
            font-size: 15px;
            font-weight: 600;
            color: #00AAFF;
        }

        .guidance-tool-status {
            font-size: 10px;
            padding: 3px 8px;
            border-radius: 4px;
            margin-left: auto;
        }

        .guidance-tool-status.active {
            background: rgba(74, 222, 128, 0.2);
            color: #4ade80;
            border: 1px solid #4ade80;
        }

        .guidance-tool-status.available {
            background: rgba(192, 192, 192, 0.1);
            color: #c0c0c0;
            border: 1px solid #c0c0c0;
        }

        .guidance-tool-status.embed {
            background: rgba(212, 175, 55, 0.2);
            color: #00AAFF;
            border: 1px solid #00AAFF;
        }

        .guidance-tool-desc {
            font-size: 13px;
            color: #c0c0c0;
            line-height: 1.5;
            margin-bottom: 16px;
        }

        .guidance-tool-uses {
            font-size: 11px;
            color: #808080;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .guidance-use-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .guidance-use-list li {
            font-size: 12px;
            color: #c0c0c0;
            padding: 6px 0;
            padding-left: 16px;
            position: relative;
            border-bottom: 1px solid rgba(192, 192, 192, 0.1);
        }

        .guidance-use-list li:last-child {
            border-bottom: none;
        }

        .guidance-use-list li::before {
            content: "";
            position: absolute;
            left: 0;
            color: #00AAFF;
        }

        .guidance-tool-action {
            margin-top: 16px;
            padding-top: 12px;
            border-top: 1px solid rgba(192, 192, 192, 0.2);
        }

        .guidance-action-btn {
            width: 100%;
            padding: 10px 16px;
            background: linear-gradient(145deg, #5a5a5a, #3a3a3a);
            border: 1px solid #6a6a6a;
            border-radius: 6px;
            color: #C0C0C0;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: 0 2px 0 #2a2a2a, 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .guidance-action-btn:hover {
            background: linear-gradient(145deg, #6a6a6a, #4a4a4a);
            color: #ffffff;
            box-shadow: 0 1px 0 #2a2a2a, 0 1px 3px rgba(0, 0, 0, 0.3);
            transform: translateY(1px);
        }

        .guidance-action-btn:active {
            transform: translateY(2px);
            box-shadow: 0 0 0 #2a2a2a, 0 1px 2px rgba(0, 0, 0, 0.3);
        }

        .guidance-action-btn.primary {
            background: linear-gradient(145deg, #00BBFF, #0088CC);
            color: #ffffff;
            border: 1px solid #00CCFF;
            box-shadow: 0 2px 0 #005588, 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .guidance-action-btn.primary:hover {
            background: linear-gradient(145deg, #33CCFF, #00AAFF);
            box-shadow: 0 1px 0 #005588, 0 1px 3px rgba(0, 0, 0, 0.3);
        }

        /* Claude Prime Embed Container */
        .claude-embed-container {
            margin-top: 24px;
            padding: 20px;
            background: #1a1a1a;
            border: 1px solid #00AAFF;
            border-radius: 10px;
            display: none;
        }

        .claude-embed-container.active {
            display: block;
        }

        .claude-embed-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .claude-embed-title {
            font-size: 14px;
            font-weight: 600;
            color: #00AAFF;
        }

        .claude-embed-close {
            background: transparent;
            border: 1px solid #808080;
            color: #808080;
            padding: 4px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .claude-embed-close:hover {
            border-color: #c0c0c0;
            color: #c0c0c0;
        }

        .claude-embed-frame {
            width: 100%;
            height: 500px;
            border: 1px solid #c0c0c0;
            border-radius: 6px;
            background: #0a0a0a;
        }

        .claude-embed-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 200px;
            background: #0a0a0a;
            border: 1px dashed #00AAFF;
            border-radius: 6px;
            color: #808080;
            text-align: center;
        }

        .claude-embed-placeholder span {
            font-size: 32px;
            margin-bottom: 12px;
        }

        .claude-embed-placeholder p {
            font-size: 13px;
            max-width: 300px;
        }

        /* ============================================
           EXTERNAL PROGRAM BUTTONS - FIXED 120x44px
           ============================================ */

        .ext-btn {
            width: 120px;
            height: 44px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 600;
            color: #C0C0C0;
            background: #0d0d0d;
            position: relative;
            transition: all 0.2s ease;
            box-shadow:
                0 0 0 1px rgba(0, 170, 255, 0.5),
                0 0 0 3px #0a0a0a,
                0 0 15px rgba(0, 170, 255, 0.15),
                inset 0 0 20px rgba(0, 170, 255, 0.03);
            text-shadow: 0 0 8px rgba(0, 170, 255, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .ext-btn::before {
            content: '';
            position: absolute;
            top: -1px;
            left: 10%;
            right: 10%;
            height: 2px;
            background: linear-gradient(90deg, transparent, #00AAFF, transparent);
            border-radius: 2px;
        }

        .ext-btn:hover {
            box-shadow:
                0 0 0 1px rgba(0, 170, 255, 0.8),
                0 0 0 3px #0a0a0a,
                0 0 25px rgba(0, 170, 255, 0.3),
                inset 0 0 30px rgba(0, 170, 255, 0.05);
            text-shadow: 0 0 12px rgba(0, 170, 255, 0.8);
            transform: translateY(-1px);
        }

        .ext-btn:active {
            box-shadow:
                0 0 0 1px rgba(255, 140, 0, 0.8),
                0 0 0 3px #0a0a0a,
                0 0 20px rgba(255, 140, 0, 0.3),
                inset 0 0 25px rgba(255, 140, 0, 0.05);
            text-shadow: 0 0 10px rgba(255, 140, 0, 0.6);
            transform: translateY(1px);
        }

        .ext-btn-icon {
            width: 32px;
            height: 32px;
            filter: drop-shadow(0 0 4px rgba(0, 170, 255, 0.5));
        }

        /* ============================================
           TRAJANUS SCRIPT BUTTONS - V2 SYNAPSE STYLE
           Neural glow with double-ring border effect
           ============================================ */

        .script-btn {
            width: 160px;
            height: 50px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-family: 'Segoe UI', sans-serif;
            font-size: 13px;
            font-weight: 600;
            letter-spacing: 0.8px;
            color: #00AAFF;
            background: #0a0a0a;
            box-shadow:
                0 0 0 1px rgba(0, 170, 255, 0.5),
                0 0 0 3px #0a0a0a,
                0 0 0 4px rgba(0, 170, 255, 0.3),
                0 0 15px rgba(0, 170, 255, 0.2),
                inset 0 0 30px rgba(0, 170, 255, 0.03);
            text-shadow: 0 0 8px rgba(0, 170, 255, 0.5);
            transition: all 0.25s ease;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .script-btn::before {
            content: '';
            position: absolute;
            top: -1px;
            left: 10%;
            right: 10%;
            height: 2px;
            background: linear-gradient(90deg, transparent, #00AAFF, transparent);
            border-radius: 2px;
        }

        .script-btn:hover {
            transform: translateY(-2px);
            color: #fff;
            box-shadow:
                0 0 0 1px rgba(0, 170, 255, 0.8),
                0 0 0 3px #0a0a0a,
                0 0 0 4px rgba(0, 170, 255, 0.5),
                0 0 25px rgba(0, 170, 255, 0.4),
                0 0 50px rgba(0, 170, 255, 0.15),
                inset 0 0 40px rgba(0, 170, 255, 0.05);
            text-shadow: 0 0 15px rgba(0, 170, 255, 0.9);
        }

        .script-btn:active {
            transform: translateY(1px);
            color: #FFB347;
            box-shadow:
                0 0 0 1px rgba(255, 149, 0, 0.8),
                0 0 0 3px #0a0a0a,
                0 0 0 4px rgba(255, 149, 0, 0.4),
                0 0 20px rgba(255, 149, 0, 0.3),
                inset 0 0 30px rgba(255, 149, 0, 0.05);
            text-shadow: 0 0 10px rgba(255, 149, 0, 0.7);
        }

        /* Script Button Brain Icon */
        .script-btn-icon {
            width: 26px;
            height: 26px;
            border-radius: 4px;
            object-fit: cover;
            filter: drop-shadow(0 0 4px rgba(0, 170, 255, 0.5));
        }

        /* ============================================
           NAV BUTTON - Return to Hub - 140x44px
           ============================================ */

        .nav-btn {
            width: 140px;
            height: 44px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 600;
            transition: all 0.15s ease;
            border: 1px solid #6a6a6a;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            color: #C0C0C0;
            background: linear-gradient(145deg, #5a5a5a, #3a3a3a);
            box-shadow: 0 3px 0 #2a2a2a, 0 4px 8px rgba(0,0,0,0.3);
        }

        .nav-btn:hover {
            transform: translateY(-2px);
            color: #ffffff;
            filter: brightness(1.15);
        }

        /* Brand colors removed - ext-btn uses V2 Synapse glow style from main.css */

        /* ============================================ */
        /* PROJECT PROGRESS - TWO PANEL LAYOUT         */
        /* ============================================ */
        .progress-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
            align-items: stretch;
        }

        .progress-section > * {
            min-height: 100%;
        }

        .progress-checklist {
            background: var(--bg-base);
            border: 2px solid #00AAFF;
            border-radius: 12px;
            padding: 20px;
            overflow-y: auto;
        }

        .checklist-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid rgba(192, 192, 192, 0.2);
        }

        .checklist-title {
            font-size: 14px;
            font-weight: 600;
            color: #00AAFF;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .checklist-count {
            font-size: 12px;
            color: var(--text-muted);
            font-family: var(--font-mono);
        }

        .checklist-items {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .checklist-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            background: var(--bg-elevated);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .checklist-item:hover {
            background: var(--bg-hover);
        }

        .checklist-item.completed {
            opacity: 0.6;
        }

        .checklist-checkbox {
            width: 18px;
            height: 18px;
            border: 2px solid #00AAFF;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: all 0.2s ease;
        }

        .checklist-item.completed .checklist-checkbox {
            background: #4ade80;
            border-color: #4ade80;
        }

        .checklist-checkbox::after {
            content: '';
            width: 6px;
            height: 10px;
            border: solid white;
            border-width: 0 2px 2px 0;
            transform: rotate(45deg) scale(0);
            transition: transform 0.2s ease;
        }

        .checklist-item.completed .checklist-checkbox::after {
            transform: rotate(45deg) scale(1);
        }

        .checklist-text {
            font-size: 13px;
            color: var(--text-primary);
            flex: 1;
        }

        .checklist-item.completed .checklist-text {
            text-decoration: line-through;
            color: var(--text-muted);
        }

        .checklist-badge {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .checklist-badge.critical { background: rgba(248, 113, 113, 0.2); color: #f87171; }
        .checklist-badge.high { background: rgba(251, 191, 36, 0.2); color: #fbbf24; }
        .checklist-badge.medium { background: rgba(0, 170, 255, 0.2); color: #00AAFF; }
        .checklist-badge.low { background: rgba(192, 192, 192, 0.2); color: #c0c0c0; }

        .progress-tracker {
            background: var(--bg-base);
            border: 2px solid #00AAFF;
            border-radius: 12px;
            padding: 20px;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .progress-title {
            font-size: 16px;
            font-weight: 600;
            color: #00AAFF;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .progress-title-icon {
            font-size: 20px;
        }

        .progress-overall {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .progress-percent {
            font-size: 28px;
            font-weight: 700;
            color: #00AAFF;
            font-family: var(--font-mono);
        }

        .progress-label {
            font-size: 12px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .progress-phases {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .progress-phase {
            display: grid;
            grid-template-columns: 120px 1fr 60px;
            align-items: center;
            gap: 16px;
        }

        .phase-name {
            font-size: 13px;
            color: var(--text-primary);
            font-weight: 500;
        }

        .phase-bar-container {
            height: 24px;
            background: var(--bg-elevated);
            border-radius: 12px;
            overflow: hidden;
            position: relative;
            border: 1px solid rgba(192, 192, 192, 0.2);
        }

        .phase-bar {
            height: 100%;
            border-radius: 12px;
            position: relative;
            transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .phase-bar.complete {
            background: linear-gradient(90deg, #22c55e 0%, #4ade80 50%, #22c55e 100%);
            box-shadow: 0 0 12px rgba(74, 222, 128, 0.4);
        }

        .phase-bar.in-progress {
            background: linear-gradient(90deg, #0088CC 0%, #00AAFF 50%, #0088CC 100%);
            box-shadow: 0 0 12px rgba(0, 170, 255, 0.4);
            animation: progressPulse 2s ease-in-out infinite;
        }

        .phase-bar.pending {
            background: linear-gradient(90deg, #4a4a4a 0%, #6a6a6a 50%, #4a4a4a 100%);
        }

        .phase-bar.blocked {
            background: linear-gradient(90deg, #dc2626 0%, #f87171 50%, #dc2626 100%);
            box-shadow: 0 0 12px rgba(248, 113, 113, 0.4);
        }

        .phase-bar.in-progress::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        @keyframes progressPulse {
            0%, 100% { box-shadow: 0 0 12px rgba(0, 170, 255, 0.4); }
            50% { box-shadow: 0 0 20px rgba(0, 170, 255, 0.7); }
        }

        .phase-percent {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
            font-family: var(--font-mono);
            text-align: right;
        }

        .phase-percent.complete { color: #4ade80; }
        .phase-percent.in-progress { color: #00AAFF; }
        .phase-percent.blocked { color: #f87171; }

        .phase-tasks {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 11px;
            color: rgba(255,255,255,0.9);
            font-weight: 600;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
        }

        .progress-footer {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
            padding-top: 16px;
            border-top: 1px solid rgba(192, 192, 192, 0.2);
        }

        .progress-stat {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .stat-value {
            font-size: 20px;
            font-weight: 700;
            font-family: var(--font-mono);
        }

        .stat-value.green { color: #4ade80; }
        .stat-value.blue { color: #00AAFF; }
        .stat-value.gray { color: #6a6a6a; }
        .stat-value.red { color: #f87171; }

        .stat-label {
            font-size: 11px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* ============================================ */
        /* JURISDICTION BROWSER STYLES                 */
        /* ============================================ */
        .jurisdiction-browser {
            display: grid;
            grid-template-columns: 280px 1fr;
            gap: 20px;
            margin: 20px 0;
        }

        .jurisdiction-list {
            background: var(--bg-elevated);
            border: 2px solid #00AAFF;
            border-radius: 12px;
            padding: 16px;
            max-height: 600px;
            overflow-y: auto;
        }

        .jurisdiction-list-header {
            font-size: 12px;
            font-weight: 600;
            color: #00AAFF;
            text-transform: uppercase;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(192, 192, 192, 0.2);
        }

        .jurisdiction-search {
            width: 100%;
            padding: 8px 12px;
            background: var(--bg-base);
            border: 1px solid var(--border-subtle);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 13px;
            margin-bottom: 12px;
        }

        .jurisdiction-search:focus {
            outline: none;
            border-color: #00AAFF;
        }

        .jurisdiction-items {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .jurisdiction-item {
            padding: 10px 12px;
            background: var(--bg-base);
            border: 1px solid transparent;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .jurisdiction-item:hover {
            border-color: var(--border-subtle);
            background: var(--bg-hover);
        }

        .jurisdiction-item.active {
            border-color: #00AAFF;
            background: rgba(0, 170, 255, 0.1);
        }

        .jurisdiction-item-name {
            font-size: 13px;
            font-weight: 500;
            color: var(--text-primary);
        }

        .jurisdiction-item-type {
            font-size: 11px;
            color: var(--text-muted);
            text-transform: capitalize;
        }

        .jurisdiction-detail {
            background: var(--bg-elevated);
            border: 2px solid #00AAFF;
            border-radius: 12px;
            padding: 20px;
            max-height: 600px;
            overflow-y: auto;
        }

        .jurisdiction-detail-empty {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--text-muted);
            text-align: center;
        }

        .jurisdiction-detail-empty-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .jurisdiction-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid rgba(192, 192, 192, 0.2);
        }

        .jurisdiction-title {
            font-size: 18px;
            font-weight: 700;
            color: #00AAFF;
            margin-bottom: 4px;
        }

        .jurisdiction-subtitle {
            font-size: 12px;
            color: var(--text-muted);
        }

        .jurisdiction-population {
            text-align: right;
        }

        .jurisdiction-population-value {
            font-size: 20px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .jurisdiction-population-label {
            font-size: 10px;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .jurisdiction-section {
            margin-bottom: 20px;
        }

        .jurisdiction-section-title {
            font-size: 12px;
            font-weight: 600;
            color: #00AAFF;
            text-transform: uppercase;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(192, 192, 192, 0.2);
        }

        .jurisdiction-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .jurisdiction-field {
            background: var(--bg-base);
            padding: 10px 12px;
            border-radius: 6px;
        }

        .jurisdiction-field-label {
            font-size: 10px;
            color: var(--text-muted);
            text-transform: uppercase;
            margin-bottom: 4px;
        }

        .jurisdiction-field-value {
            font-size: 13px;
            color: var(--text-primary);
        }

        .jurisdiction-list-items {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .jurisdiction-list-item {
            font-size: 13px;
            color: var(--text-primary);
            padding: 6px 0;
            padding-left: 16px;
            position: relative;
        }

        .jurisdiction-list-item::before {
            content: "";
            position: absolute;
            left: 0;
            color: #00AAFF;
        }

        .jurisdiction-contact-card {
            background: var(--bg-base);
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 12px;
        }

        .jurisdiction-contact-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .jurisdiction-contact-item {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        .jurisdiction-contact-link {
            color: #00AAFF;
            text-decoration: none;
        }

        .jurisdiction-contact-link:hover {
            text-decoration: underline;
        }

        .jurisdiction-steps {
            counter-reset: step;
        }

        .jurisdiction-step {
            font-size: 13px;
            color: var(--text-primary);
            padding: 8px 0 8px 28px;
            position: relative;
        }

        .jurisdiction-step::before {
            counter-increment: step;
            content: counter(step);
            position: absolute;
            left: 0;
            width: 20px;
            height: 20px;
            background: #00AAFF;
            color: var(--bg-base);
            border-radius: 50%;
            font-size: 11px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .jurisdiction-issue {
            background: rgba(248, 113, 113, 0.1);
            border-left: 3px solid #f87171;
            padding: 8px 12px;
            margin-bottom: 8px;
            border-radius: 0 6px 6px 0;
            font-size: 13px;
            color: var(--text-primary);
        }

    </style>
</head>
<body>
    <!-- Sticky Hero Section with Logo -->
    <section class="hero-section">
        <div class="hero-content">
            <div class="hero-brand">
                <!-- Neural Grid Logo (2026-01-16) -->
                <style>
                    .toolkit-logo-lockup {
                        display: flex;
                        align-items: center;
                        position: relative;
                    }
                    .toolkit-hero-logo {
                        width: 70px;
                        height: 70px;
                        object-fit: contain;
                        filter: drop-shadow(0 0 6px rgba(255, 255, 255, 0.15));
                    }
                    .toolkit-brand-text {
                        display: flex;
                        flex-direction: column;
                        justify-content: center;
                        margin-left: -18px;
                        height: 70px;
                    }
                    .toolkit-brand-title {
                        color: #00AAFF;
                        font-family: Tahoma, sans-serif;
                        font-size: 28px;
                        font-weight: 300;
                        letter-spacing: 6px;
                        margin: 0;
                    }
                    .toolkit-brand-tagline {
                        color: #C0C0C0;
                        font-size: 8px;
                        letter-spacing: 2.5px;
                        margin: 2px 0 0 0;
                    }
                    .toolkit-brand-tagline .tm {
                        font-size: 6px;
                        vertical-align: super;
                        margin-left: 1px;
                        opacity: 0.7;
                    }
                </style>
                <div class="toolkit-logo-lockup">
                    <img src="../assets/trajanus-logo-white-grid.png" alt="Trajanus Logo" class="toolkit-hero-logo">
                    <div class="toolkit-brand-text">
                        <h1 class="toolkit-brand-title">TRAJANUS</h1>
                        <p class="toolkit-brand-tagline">ENGINEERED INTELLIGENCE<span class="tm"></span></p>
                    </div>
                </div>
                <div class="hero-toolkit">TRAFFIC STUDIES TOOLKIT</div>
            </div>
            <div class="hero-nav">
                <a href="../index.html" class="hero-home-btn" id="home-btn"> Return to Hub</a>
            </div>
        </div>
    </section>

    <!-- Introduction Section (Collapsible) -->
    <section class="intro-section" id="intro-section">
        <div class="intro-header" onclick="toggleIntro()">
            <span class="intro-title"> Platform Introduction</span>
            <span class="intro-toggle" id="intro-toggle"></span>
        </div>
        <div class="intro-content" id="intro-content">
            <!-- Decision Tree -->
            <div class="intro-decision">
                <div class="decision-card" data-action="new-study">
                    <div class="decision-icon"></div>
                    <div class="decision-title">New Study</div>
                    <div class="decision-desc">Start fresh TIA from scratch</div>
                </div>
                <div class="decision-card" data-action="continue-study">
                    <div class="decision-icon"></div>
                    <div class="decision-title">Continue Existing</div>
                    <div class="decision-desc">Resume work on active project</div>
                </div>
                <div class="decision-card" data-action="research">
                    <div class="decision-icon"></div>
                    <div class="decision-title">Research Only</div>
                    <div class="decision-desc">Traffic data lookup, counts, LOS</div>
                </div>
                <div class="decision-card" data-action="templates">
                    <div class="decision-icon"></div>
                    <div class="decision-title">Review Templates</div>
                    <div class="decision-desc">Access report templates & standards</div>
                </div>
            </div>

            <!-- Tools Grid -->
            <div class="intro-tools-section">
                <div class="intro-section-label">Core Tools</div>
                <div class="intro-tools-grid">
                    <div class="intro-tool-card" title="Traffic signal timing & simulation">
                        <span class="intro-tool-icon"></span>
                        <span class="intro-tool-name">Synchro</span>
                    </div>
                    <div class="intro-tool-card" title="Highway Capacity Software">
                        <span class="intro-tool-icon"></span>
                        <span class="intro-tool-name">HCS</span>
                    </div>
                    <div class="intro-tool-card" title="ITE Trip Generation Manual">
                        <span class="intro-tool-icon"></span>
                        <span class="intro-tool-name">Trip Gen</span>
                    </div>
                    <div class="intro-tool-card" title="AutoCAD for site plans">
                        <span class="intro-tool-icon"></span>
                        <span class="intro-tool-name">AutoCAD</span>
                    </div>
                    <div class="intro-tool-card" title="Google Maps for site location">
                        <span class="intro-tool-icon"></span>
                        <span class="intro-tool-name">Maps</span>
                    </div>
                    <div class="intro-tool-card" title="Microsoft Word for reports">
                        <span class="intro-tool-icon"></span>
                        <span class="intro-tool-name">Word</span>
                    </div>
                </div>
            </div>

            <!-- 10-Step Workflow Overview -->
            <div class="intro-workflow">
                <div class="intro-section-label">10-Step TIA Workflow</div>
                <div class="intro-workflow-steps">
                    <div class="intro-workflow-step"><span class="step-num">1</span> Setup</div>
                    <span class="intro-workflow-connector"></span>
                    <div class="intro-workflow-step"><span class="step-num">2</span> Data Collection</div>
                    <span class="intro-workflow-connector"></span>
                    <div class="intro-workflow-step"><span class="step-num">3</span> Trip Generation</div>
                    <span class="intro-workflow-connector"></span>
                    <div class="intro-workflow-step"><span class="step-num">4</span> Distribution</div>
                    <span class="intro-workflow-connector"></span>
                    <div class="intro-workflow-step"><span class="step-num">5</span> Future Volumes</div>
                    <span class="intro-workflow-connector"></span>
                    <div class="intro-workflow-step"><span class="step-num">6</span> Capacity Analysis</div>
                    <span class="intro-workflow-connector"></span>
                    <div class="intro-workflow-step"><span class="step-num">7</span> Site Access</div>
                    <span class="intro-workflow-connector"></span>
                    <div class="intro-workflow-step"><span class="step-num">8</span> Signal Warrants</div>
                    <span class="intro-workflow-connector"></span>
                    <div class="intro-workflow-step"><span class="step-num">9</span> Report Assembly</div>
                    <span class="intro-workflow-connector"></span>
                    <div class="intro-workflow-step"><span class="step-num">10</span> Final Delivery</div>
                </div>
            </div>

            <!-- Folder Structure -->
            <div class="intro-folders">
                <div class="intro-section-label">Project Folder Structure</div>
                <div class="intro-folders-grid">
                    <div class="intro-folder"><span class="intro-folder-icon"></span> 01-Input</div>
                    <div class="intro-folder"><span class="intro-folder-icon"></span> 02-Working</div>
                    <div class="intro-folder"><span class="intro-folder-icon"></span> 03-Output</div>
                    <div class="intro-folder"><span class="intro-folder-icon"></span> 04-Correspondence</div>
                    <div class="intro-folder"><span class="intro-folder-icon"></span> 05-Final</div>
                </div>
            </div>

            <!-- Quick Tips -->
            <div class="intro-tips">
                <div class="intro-section-label">Quick Tips</div>
                <div class="intro-tips-list">
                    <div class="intro-tip">
                        <span class="intro-tip-icon"></span>
                        <span class="intro-tip-text">Select your project from the dropdown or create a new one to get started with the workflow tracker.</span>
                    </div>
                    <div class="intro-tip">
                        <span class="intro-tip-icon"></span>
                        <span class="intro-tip-text">Use the AI Assistant (Trajanus) for guidance on methodology, calculations, and jurisdiction requirements.</span>
                    </div>
                    <div class="intro-tip">
                        <span class="intro-tip-icon"></span>
                        <span class="intro-tip-text">The workflow steps update as you progress. Each step provides relevant tools and documentation links.</span>
                    </div>
                </div>
            </div>
        </div>
    </section>


    <div class="workspace-container">

        <!-- Project Bar -->
        <div class="project-bar">
            <span class="project-bar-label">Project:</span>
            <select class="project-select" id="project-select">
                <option value="">-- Select Project --</option>
            </select>
            <button class="new-project-btn" id="new-project-btn">+ New Project</button>
        </div>

        <!-- Main Scrollable Content -->
        <main class="main-content">
            <!-- ==================== WORKFLOW TRACKER ==================== -->
            <div class="workflow-tracker" id="workflow-tracker">
                <div class="workflow-header">
                    <span class="workflow-title">TIA Workflow</span>
                    <span class="workflow-progress" id="workflow-progress">Step 0 of 10</span>
                </div>
                <div class="workflow-steps">
                    <div class="workflow-step active" data-step="1">
                        <span class="workflow-step-number">1</span>
                        <span class="workflow-step-name">Setup</span>
                    </div>
                    <div class="workflow-step" data-step="2">
                        <span class="workflow-step-number">2</span>
                        <span class="workflow-step-name">Data Collection</span>
                    </div>
                    <div class="workflow-step" data-step="3">
                        <span class="workflow-step-number">3</span>
                        <span class="workflow-step-name">Trip Gen</span>
                    </div>
                    <div class="workflow-step" data-step="4">
                        <span class="workflow-step-number">4</span>
                        <span class="workflow-step-name">Distribution</span>
                    </div>
                    <div class="workflow-step" data-step="5">
                        <span class="workflow-step-number">5</span>
                        <span class="workflow-step-name">Future Vol</span>
                    </div>
                    <div class="workflow-step" data-step="6">
                        <span class="workflow-step-number">6</span>
                        <span class="workflow-step-name">Capacity</span>
                    </div>
                    <div class="workflow-step" data-step="7">
                        <span class="workflow-step-number">7</span>
                        <span class="workflow-step-name">Site Access</span>
                    </div>
                    <div class="workflow-step" data-step="8">
                        <span class="workflow-step-number">8</span>
                        <span class="workflow-step-name">Warrants</span>
                    </div>
                    <div class="workflow-step" data-step="9">
                        <span class="workflow-step-number">9</span>
                        <span class="workflow-step-name">Report</span>
                    </div>
                    <div class="workflow-step" data-step="10">
                        <span class="workflow-step-number">10</span>
                        <span class="workflow-step-name">Final</span>
                    </div>
                </div>
            </div>

            <!-- ==================== WORKFLOW WORKSPACE ==================== -->
            <div class="workflow-workspace" id="workflow-workspace">

                <!-- STEP 1: PROJECT SETUP -->
                <div class="workspace-panel active" id="ws-panel-1" data-step="1">
                    <h3>Step 1  Project Setup</h3>

                    <div class="ws-form-grid">
                        <div class="ws-form-group">
                            <label for="ws-project-name">Project Name</label>
                            <input type="text" id="ws-project-name" placeholder="e.g., Grace Fellowship Church TIS">
                        </div>
                        <div class="ws-form-group">
                            <label for="ws-project-number">Project Number</label>
                            <input type="text" id="ws-project-number" placeholder="e.g., TRA-2026-001">
                        </div>
                        <div class="ws-form-group full-width">
                            <label for="ws-site-address">Site Address</label>
                            <input type="text" id="ws-site-address" placeholder="e.g., 12345 N Oracle Rd, Tucson, AZ 85737">
                        </div>
                        <div class="ws-form-group">
                            <label for="ws-jurisdiction">Jurisdiction</label>
                            <select id="ws-jurisdiction">
                                <option value="">-- Select Jurisdiction --</option>
                                <option value="pima">Pima County</option>
                                <option value="marana">Town of Marana</option>
                                <option value="tucson">City of Tucson</option>
                                <option value="oro-valley">Town of Oro Valley</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="ws-form-group">
                            <label for="ws-opening-year">Opening Year</label>
                            <input type="number" id="ws-opening-year" placeholder="2027" min="2025" max="2050">
                        </div>
                        <div class="ws-form-group">
                            <label for="ws-horizon-year">Horizon Year</label>
                            <input type="number" id="ws-horizon-year" placeholder="2032" min="2025" max="2060">
                        </div>
                        <div class="ws-form-group">
                            <label for="ws-growth-rate">Annual Growth Rate %</label>
                            <input type="number" id="ws-growth-rate" placeholder="2.0" step="0.1" min="0" max="20">
                        </div>
                    </div>

                    <div class="ws-section-title">Buildings</div>
                    <table class="buildings-table" id="buildings-table">
                        <thead>
                            <tr>
                                <th style="width:28%">Building Name</th>
                                <th style="width:18%">Square Footage</th>
                                <th style="width:22%">ITE LUC Code</th>
                                <th style="width:12%">Drive-Thru</th>
                                <th style="width:10%"></th>
                            </tr>
                        </thead>
                        <tbody id="buildings-tbody">
                            <tr>
                                <td><input type="text" placeholder="e.g., Main Building"></td>
                                <td><input type="number" placeholder="10,000"></td>
                                <td><input type="text" placeholder="e.g., 560"></td>
                                <td style="text-align:center"><input type="checkbox"></td>
                                <td><button class="remove-building-btn" onclick="this.closest('tr').remove()"></button></td>
                            </tr>
                        </tbody>
                    </table>
                    <button class="add-building-btn" id="add-building-btn">+ Add Building</button>

                    <div class="ws-section-title">Site Documents</div>
                    <div class="ws-drop-zone" id="ws-drop-zone">
                        <div class="ws-drop-icon"></div>
                        <div class="ws-drop-text">Drop site plan, plat, or aerial here</div>
                        <div class="ws-drop-subtext">PDF, PNG, JPG</div>
                    </div>
                    <div style="display:flex;gap:12px;margin-bottom:24px;">
                        <button class="action-btn" id="ws-browse-files" style="flex:1;padding:12px;font-size:13px;cursor:pointer;"> Browse Files (Native Dialog)</button>
                        <button class="action-btn" id="ws-browse-local" style="flex:1;padding:12px;font-size:13px;cursor:pointer;"> Browse Local (HTML)</button>
                    </div>
                    <div id="ws-attached-files" style="margin-bottom:16px;"></div>

                    <button class="ws-submit-btn" id="ws-submit-step1">Submit Project Setup</button>
                </div>

                <!-- STEP 2: DATA COLLECTION -->
                <div class="workspace-panel" id="ws-panel-2" data-step="2">
                    <h3>Step 2  Data Collection</h3>

                    <!-- SECTION 1: TMC COUNT INFO -->
                    <div class="ws-section-header">
                        <div class="ws-section-title">TMC Count Info</div>
                        <span class="ws-section-badge incomplete" id="badge-tmc-info">Incomplete</span>
                    </div>
                    <div class="ws-form-grid">
                        <div class="ws-form-group">
                            <label for="ws-count-date">Count Date</label>
                            <input type="date" id="ws-count-date" style="background:var(--bg-base);border:1px solid var(--blue);border-radius:6px;padding:10px;color:var(--text-light);font-size:14px;">
                        </div>
                        <div class="ws-form-group">
                            <label for="ws-day-of-week">Day of Week</label>
                            <select id="ws-day-of-week" style="background:var(--bg-base);border:1px solid var(--blue);border-radius:6px;padding:10px;color:var(--text-light);font-size:14px;">
                                <option value="">-- Select --</option>
                                <option value="tuesday">Tuesday</option>
                                <option value="wednesday">Wednesday</option>
                                <option value="thursday">Thursday</option>
                                <option value="monday">Monday</option>
                                <option value="friday">Friday</option>
                            </select>
                        </div>
                        <div class="ws-form-group">
                            <label>AM Window</label>
                            <div style="display:flex;gap:8px;align-items:center;">
                                <input type="time" id="ws-am-start" value="06:00" style="background:var(--bg-base);border:1px solid var(--blue);border-radius:6px;padding:10px;color:var(--text-light);font-size:14px;flex:1;">
                                <span style="color:var(--text-muted);">to</span>
                                <input type="time" id="ws-am-end" value="09:00" style="background:var(--bg-base);border:1px solid var(--blue);border-radius:6px;padding:10px;color:var(--text-light);font-size:14px;flex:1;">
                            </div>
                        </div>
                        <div class="ws-form-group">
                            <label>PM Window</label>
                            <div style="display:flex;gap:8px;align-items:center;">
                                <input type="time" id="ws-pm-start" value="15:00" style="background:var(--bg-base);border:1px solid var(--blue);border-radius:6px;padding:10px;color:var(--text-light);font-size:14px;flex:1;">
                                <span style="color:var(--text-muted);">to</span>
                                <input type="time" id="ws-pm-end" value="18:00" style="background:var(--bg-base);border:1px solid var(--blue);border-radius:6px;padding:10px;color:var(--text-light);font-size:14px;flex:1;">
                            </div>
                        </div>
                    </div>
                    <div class="ws-validation-panel" id="val-tmc-info">
                        <h4>Requirements Check</h4>
                        <div id="val-tmc-info-items"></div>
                    </div>

                    <!-- SECTION 2: TMC SPREADSHEET UPLOAD -->
                    <div class="ws-section-header">
                        <div class="ws-section-title">TMC Spreadsheet Upload</div>
                        <span class="ws-section-badge incomplete" id="badge-tmc-upload">Incomplete</span>
                    </div>
                    <div class="ws-drop-zone" id="ws-drop-zone-tmc" style="min-height:140px;cursor:pointer;">
                        <div class="ws-drop-icon" style="font-size:36px;"></div>
                        <div class="ws-drop-text" style="font-size:15px;">Drop TMC spreadsheet here</div>
                        <div class="ws-drop-subtext">.xlsx, .csv  or click to browse</div>
                    </div>
                    <div id="ws-tmc-file-info" style="margin-bottom:16px;"></div>
                    <div class="ws-validation-panel" id="val-tmc-upload">
                        <h4>File Validation</h4>
                        <div id="val-tmc-upload-items"></div>
                    </div>
                    <button class="ws-submit-btn" id="ws-parse-tmc-btn" style="display:none;background:var(--blue);margin-bottom:24px;">Parse TMC Data</button>
                    <div class="ws-validation-panel" id="val-tmc-parsed">
                        <h4>TMC Data Analysis</h4>
                        <div id="val-tmc-parsed-items"></div>
                    </div>

                    <!-- SECTION 3: INTERSECTION PHOTOS -->
                    <div class="ws-section-header">
                        <div class="ws-section-title">Intersection Photos</div>
                        <span class="ws-section-badge incomplete" id="badge-photos">Incomplete</span>
                    </div>
                    <div class="ws-drop-zone" id="ws-drop-zone-photos" style="min-height:90px;cursor:pointer;">
                        <div class="ws-drop-icon"></div>
                        <div class="ws-drop-text">Drop intersection photos here</div>
                        <div class="ws-drop-subtext">.jpg, .png, .heic  or click to browse</div>
                    </div>
                    <div id="ws-photos-info" style="margin-bottom:8px;"></div>
                    <div class="ws-validation-panel" id="val-photos">
                        <h4>Photo Validation</h4>
                        <div id="val-photos-items"></div>
                    </div>

                    <!-- SUBMIT -->
                    <button class="ws-submit-btn" id="ws-submit-step2">Submit Data Collection</button>
                </div>

            </div>

            <!-- ==================== PROJECT SUMMARY CARD ==================== -->
            <div class="project-summary-card" id="project-summary-card">
                <div class="project-summary-header">
                    <span class="project-summary-title">Project Summary</span>
                    <span class="project-summary-status active" id="project-summary-status">Active</span>
                </div>
                <div class="project-summary-grid" id="project-summary-grid">
                    <!-- Populated by JS on Step 1 submit -->
                </div>
                <div class="project-summary-buildings" id="project-summary-buildings">
                    <!-- Building tags populated by JS -->
                </div>
            </div>

            <!-- ==================== PROJECT FOLDER TRACKER ==================== -->
            <div class="project-folder-tracker" id="project-folder-tracker">
                <div class="folder-tracker-header">
                    <span class="folder-tracker-title">Project Folder</span>
                    <span class="folder-tracker-progress" id="folder-tracker-progress">0 / 10 steps complete</span>
                </div>

                <!-- Step 1: Setup -->
                <div class="folder-step-group" data-folder-step="1">
                    <div class="folder-step-label"><span class="step-badge" id="folder-badge-1">1</span> Project Setup</div>
                    <div class="folder-item pending" id="folder-project-info">
                        <span class="item-icon"></span>
                        <span class="item-name">Project Information</span>
                        <span class="item-status pending">Missing</span>
                    </div>
                    <div class="folder-item pending" id="folder-site-docs">
                        <span class="item-icon"></span>
                        <span class="item-name">Site Plan / Plat / Aerial</span>
                        <span class="item-status pending">Missing</span>
                    </div>
                </div>

                <!-- Step 2: Data Collection -->
                <div class="folder-step-group" data-folder-step="2">
                    <div class="folder-step-label"><span class="step-badge" id="folder-badge-2">2</span> Data Collection</div>
                    <div class="folder-item pending" id="folder-intersections">
                        <span class="item-icon"></span>
                        <span class="item-name">Study Intersections</span>
                        <span class="item-status pending">Missing</span>
                    </div>
                    <div class="folder-item pending" id="folder-tmc-counts">
                        <span class="item-icon"></span>
                        <span class="item-name">TMC Counts (AM/PM)</span>
                        <span class="item-status pending">Missing</span>
                    </div>
                    <div class="folder-item pending" id="folder-adt-counts">
                        <span class="item-icon"></span>
                        <span class="item-name">ADT / Tube Counts</span>
                        <span class="item-status pending">Missing</span>
                    </div>
                </div>

                <!-- Step 3: Trip Generation -->
                <div class="folder-step-group" data-folder-step="3">
                    <div class="folder-step-label"><span class="step-badge" id="folder-badge-3">3</span> Trip Generation</div>
                    <div class="folder-item pending" id="folder-trip-calcs">
                        <span class="item-icon"></span>
                        <span class="item-name">ITE Trip Calculations</span>
                        <span class="item-status pending">Missing</span>
                    </div>
                    <div class="folder-item pending" id="folder-trip-worksheet">
                        <span class="item-icon"></span>
                        <span class="item-name">Trip Generation Worksheet</span>
                        <span class="item-status pending">Missing</span>
                    </div>
                </div>

                <!-- Step 4: Distribution -->
                <div class="folder-step-group" data-folder-step="4">
                    <div class="folder-step-label"><span class="step-badge" id="folder-badge-4">4</span> Trip Distribution</div>
                    <div class="folder-item pending" id="folder-distribution">
                        <span class="item-icon"></span>
                        <span class="item-name">Distribution Percentages</span>
                        <span class="item-status pending">Missing</span>
                    </div>
                </div>

                <!-- Step 5: Future Volumes -->
                <div class="folder-step-group" data-folder-step="5">
                    <div class="folder-step-label"><span class="step-badge" id="folder-badge-5">5</span> Future Volumes</div>
                    <div class="folder-item pending" id="folder-volumes">
                        <span class="item-icon"></span>
                        <span class="item-name">Volume Scenarios (Existing / Background / Site)</span>
                        <span class="item-status pending">Missing</span>
                    </div>
                </div>

                <!-- Step 6: Capacity Analysis -->
                <div class="folder-step-group" data-folder-step="6">
                    <div class="folder-step-label"><span class="step-badge" id="folder-badge-6">6</span> Capacity Analysis</div>
                    <div class="folder-item pending" id="folder-synchro">
                        <span class="item-icon"></span>
                        <span class="item-name">Synchro Models (.syn)</span>
                        <span class="item-status pending">Missing</span>
                    </div>
                    <div class="folder-item pending" id="folder-los">
                        <span class="item-icon"></span>
                        <span class="item-name">LOS Summary Table</span>
                        <span class="item-status pending">Missing</span>
                    </div>
                </div>

                <!-- Step 7: Site Access -->
                <div class="folder-step-group" data-folder-step="7">
                    <div class="folder-step-label"><span class="step-badge" id="folder-badge-7">7</span> Site Access</div>
                    <div class="folder-item pending" id="folder-driveway">
                        <span class="item-icon"></span>
                        <span class="item-name">Driveway Analysis / Turn Lanes</span>
                        <span class="item-status pending">Missing</span>
                    </div>
                </div>

                <!-- Step 8: Signal Warrants -->
                <div class="folder-step-group" data-folder-step="8">
                    <div class="folder-step-label"><span class="step-badge" id="folder-badge-8">8</span> Signal Warrants</div>
                    <div class="folder-item pending" id="folder-warrants">
                        <span class="item-icon"></span>
                        <span class="item-name">Warrant Analysis (MUTCD)</span>
                        <span class="item-status pending">Missing</span>
                    </div>
                </div>

                <!-- Step 9: Report Assembly -->
                <div class="folder-step-group" data-folder-step="9">
                    <div class="folder-step-label"><span class="step-badge" id="folder-badge-9">9</span> Report Assembly</div>
                    <div class="folder-item pending" id="folder-report">
                        <span class="item-icon"></span>
                        <span class="item-name">TIA Report Draft (.docx)</span>
                        <span class="item-status pending">Missing</span>
                    </div>
                    <div class="folder-item pending" id="folder-exhibits">
                        <span class="item-icon"></span>
                        <span class="item-name">Exhibits / Figures</span>
                        <span class="item-status pending">Missing</span>
                    </div>
                </div>

                <!-- Step 10: Final Delivery -->
                <div class="folder-step-group" data-folder-step="10">
                    <div class="folder-step-label"><span class="step-badge" id="folder-badge-10">10</span> Final Delivery</div>
                    <div class="folder-item pending" id="folder-final-pdf">
                        <span class="item-icon"></span>
                        <span class="item-name">Final TIA (.pdf)</span>
                        <span class="item-status pending">Missing</span>
                    </div>
                    <div class="folder-item pending" id="folder-appendix">
                        <span class="item-icon"></span>
                        <span class="item-name">Appendix (counts, capacity reports)</span>
                        <span class="item-status pending">Missing</span>
                    </div>
                </div>
            </div>

            <!-- ==================== STEP INSTRUCTIONS ==================== -->
            <div class="step-instructions" id="step-instructions">
                <div class="step-instructions-title" id="step-title">Step 1: Project Setup</div>
                <div class="step-instructions-content" id="step-content">
                    <strong>Create your TIA project folder structure:</strong>
                    <ol>
                        <li>Click <strong>+ New Project</strong> and enter project details</li>
                        <li>The system will create your folder structure at:<br>
                            <code>G:\My Drive\00 - Trajanus USA\Traffic\[Project Name]\</code></li>
                        <li>Folder structure includes: Traffic Counts, SYNCHRO Outputs, Deliverable</li>
                        <li>Once created, proceed to <strong>Step 2: Gather Input</strong></li>
                    </ol>
                </div>
                <!-- Step Actions -->
                <div class="step-actions" id="step-actions">
                    <button class="action-btn" id="open-folder-btn">Open Project Folder</button>
                    <button class="action-btn" id="next-step-btn">Next Step</button>
                </div>
                <!-- Tools for This Step -->
                <div class="step-tools" id="step-tools">
                    <div class="step-tools-title">Tools for This Step:</div>
                    <div class="step-tools-grid" id="step-tools-grid">
                        <!-- Populated by JavaScript based on current step -->
                    </div>
                </div>
            </div>

            <!-- ==================== REQUIRED DOCUMENTS ==================== -->
            <div class="docs-panel" id="docs-panel">
                <div class="docs-panel-header" id="docs-panel-header">
                    <span class="docs-panel-title">Required Documents Checklist</span>
                    <span class="docs-panel-toggle" id="docs-toggle">&#9660; Collapse</span>
                </div>
                <div class="docs-panel-body" id="docs-panel-body">
                    <!-- Input Documents -->
                    <div class="docs-category">
                        <div class="docs-category-title">Input Documents</div>
                        <div class="doc-item">
                            <input type="checkbox" class="doc-checkbox" id="doc-site-plan">
                            <label class="doc-item-label" for="doc-site-plan">Site Plan (.pdf)</label>
                        </div>
                        <div class="doc-item">
                            <input type="checkbox" class="doc-checkbox" id="doc-ite-calc">
                            <label class="doc-item-label" for="doc-ite-calc">ITE Trip Generation Worksheet (.xlsx)</label>
                        </div>
                        <div class="doc-item">
                            <input type="checkbox" class="doc-checkbox" id="doc-tmc">
                            <label class="doc-item-label" for="doc-tmc">TMC Counts (AM/PM peaks)</label>
                        </div>
                        <div class="doc-item">
                            <input type="checkbox" class="doc-checkbox" id="doc-adt">
                            <label class="doc-item-label" for="doc-adt">ADT Counts (tube counts)</label>
                        </div>
                    </div>

                    <!-- Synchro Models -->
                    <div class="docs-category">
                        <div class="docs-category-title">Synchro Models</div>
                        <div class="doc-item">
                            <input type="checkbox" class="doc-checkbox" id="doc-syn-bg">
                            <label class="doc-item-label" for="doc-syn-bg">Background Conditions (.syn)</label>
                        </div>
                        <div class="doc-item">
                            <input type="checkbox" class="doc-checkbox" id="doc-syn-grown">
                            <label class="doc-item-label" for="doc-syn-grown">Background + Growth (.syn)</label>
                        </div>
                        <div class="doc-item">
                            <input type="checkbox" class="doc-checkbox" id="doc-syn-site">
                            <label class="doc-item-label" for="doc-syn-site">Background + Growth + Site (.syn)</label>
                        </div>
                    </div>

                    <!-- Analysis Outputs -->
                    <div class="docs-category">
                        <div class="docs-category-title">Analysis Outputs</div>
                        <div class="doc-item">
                            <input type="checkbox" class="doc-checkbox" id="doc-los-table">
                            <label class="doc-item-label" for="doc-los-table">LOS Summary Table</label>
                        </div>
                        <div class="doc-item">
                            <input type="checkbox" class="doc-checkbox" id="doc-capacity">
                            <label class="doc-item-label" for="doc-capacity">Capacity Analysis Reports (.pdf)</label>
                        </div>
                        <div class="doc-item">
                            <input type="checkbox" class="doc-checkbox" id="doc-counts-output">
                            <label class="doc-item-label" for="doc-counts-output">Traffic Counts Outputs (.pdf)</label>
                        </div>
                    </div>

                    <!-- Final Deliverables -->
                    <div class="docs-category">
                        <div class="docs-category-title">Final Deliverables</div>
                        <div class="doc-item">
                            <input type="checkbox" class="doc-checkbox" id="doc-tia-report">
                            <label class="doc-item-label" for="doc-tia-report">FINAL Traffic Impact Analysis (.docx/.pdf)</label>
                        </div>
                        <div class="doc-item">
                            <input type="checkbox" class="doc-checkbox" id="doc-exhibits">
                            <label class="doc-item-label" for="doc-exhibits">Exhibits (.pdf)</label>
                        </div>
                        <div class="doc-item">
                            <input type="checkbox" class="doc-checkbox" id="doc-appendix">
                            <label class="doc-item-label" for="doc-appendix">Appendix (counts, capacity reports)</label>
                        </div>
                    </div>
                </div>
            </div>


            <!-- ==================== APPLICATIONS ==================== -->
            <div class="section-divider">
                <span class="section-title">Applications</span>
                <div class="section-line"></div>
            </div>

            <!-- Traffic Tools -->
            <div class="app-category">
                <div class="category-label">Traffic Tools</div>
                <div class="app-grid">
                    <div class="app-card" data-launch="synchro">
                        <span class="app-icon"></span>
                        <span class="app-label">Synchro 12</span>
                    </div>
                    <div class="app-card" data-launch="hcs">
                        <span class="app-icon"></span>
                        <span class="app-label">HCS 7</span>
                    </div>
                    <div class="app-card" data-launch="autocad">
                        <span class="app-icon"></span>
                        <span class="app-label">AutoCAD</span>
                    </div>
                    <a class="app-card" href="https://maps.google.com" target="_blank">
                        <span class="app-icon"></span>
                        <span class="app-label">Google Maps</span>
                    </a>
                    <a class="app-card" href="https://azdot.gov" target="_blank">
                        <span class="app-icon"></span>
                        <span class="app-label">ADOT</span>
                    </a>
                </div>
            </div>

            <!-- MS Office -->
            <div class="app-category">
                <div class="category-label">MS Office Suite</div>
                <div class="app-grid">
                    <div class="app-card" data-launch="word">
                        <span class="app-icon"></span>
                        <span class="app-label">Word</span>
                    </div>
                    <div class="app-card" data-launch="excel">
                        <span class="app-icon"></span>
                        <span class="app-label">Excel</span>
                    </div>
                    <div class="app-card" data-launch="powerpoint">
                        <span class="app-icon"></span>
                        <span class="app-label">PowerPoint</span>
                    </div>
                    <div class="app-card" data-launch="outlook">
                        <span class="app-icon"></span>
                        <span class="app-label">Outlook</span>
                    </div>
                    <div class="app-card" data-launch="onenote">
                        <span class="app-icon"></span>
                        <span class="app-label">OneNote</span>
                    </div>
                </div>
            </div>

            <!-- Browsers & Files -->
            <div class="app-category">
                <div class="category-label">Browsers & Files</div>
                <div class="app-grid">
                    <div class="app-card" data-launch="chrome">
                        <span class="app-icon"></span>
                        <span class="app-label">Chrome</span>
                    </div>
                    <div class="app-card" data-launch="edge">
                        <span class="app-icon"></span>
                        <span class="app-label">Edge</span>
                    </div>
                    <div class="app-card" data-launch="explorer">
                        <span class="app-icon"></span>
                        <span class="app-label">Explorer</span>
                    </div>
                    <div class="app-card" data-launch="terminal">
                        <span class="app-icon"></span>
                        <span class="app-label">Terminal</span>
                    </div>
                </div>
            </div>

            <!-- ==================== TRAJANUS SCRIPTS ==================== -->
            <div class="section-divider">
                <span class="section-title">Trajanus Scripts</span>
                <div class="section-line"></div>
            </div>

            <div class="script-grid">
                <div class="script-card" data-script="trip-generation">
                    <span class="script-icon"></span>
                    <div class="script-info">
                        <div class="script-name">Trip Generation Calculator</div>
                        <div class="script-desc">ITE 11th Edition trip calculations</div>
                    </div>
                </div>
                <div class="script-card" data-script="los-worksheet">
                    <span class="script-icon"></span>
                    <div class="script-info">
                        <div class="script-name">LOS Worksheet</div>
                        <div class="script-desc">Level of service analysis template</div>
                    </div>
                </div>
                <div class="script-card" data-script="signal-timing">
                    <span class="script-icon"></span>
                    <div class="script-info">
                        <div class="script-name">Signal Timing Optimizer</div>
                        <div class="script-desc">Optimize intersection timing</div>
                    </div>
                </div>
                <div class="script-card" data-script="tia-template">
                    <span class="script-icon"></span>
                    <div class="script-info">
                        <div class="script-name">TIA Report Template</div>
                        <div class="script-desc">Traffic impact analysis template</div>
                    </div>
                </div>
            </div>

            <!-- ==================== REFERENCE STANDARDS ==================== -->
            <div class="section-divider">
                <span class="section-title">Reference Standards</span>
                <div class="section-line"></div>
            </div>

            <div class="doc-category">
                <div class="doc-category-header">National Standards</div>
                <div class="doc-grid">
                    <div class="doc-card" data-doc="ite-trip-gen">
                        <span class="doc-icon"></span>
                        <div class="doc-info">
                            <div class="doc-name">ITE Trip Generation (11th Ed)</div>
                            <div class="doc-meta">Trip rates and equations</div>
                        </div>
                    </div>
                    <div class="doc-card" data-doc="hcm">
                        <span class="doc-icon"></span>
                        <div class="doc-info">
                            <div class="doc-name">HCM 7th Edition</div>
                            <div class="doc-meta">Highway Capacity Manual</div>
                        </div>
                    </div>
                    <div class="doc-card" data-doc="mutcd">
                        <span class="doc-icon"></span>
                        <div class="doc-info">
                            <div class="doc-name">MUTCD</div>
                            <div class="doc-meta">Manual on Uniform Traffic Control</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="doc-category">
                <div class="doc-category-header">Arizona Standards</div>
                <div class="doc-grid">
                    <div class="doc-card" data-doc="fdot-los">
                        <span class="doc-icon"></span>
                        <div class="doc-info">
                            <div class="doc-name">ADOT Traffic Engineering Guidelines</div>
                            <div class="doc-meta">Arizona level of service standards</div>
                        </div>
                    </div>
                    <div class="doc-card" data-doc="fdot-design">
                        <span class="doc-icon"></span>
                        <div class="doc-info">
                            <div class="doc-name">ADOT Roadway Design Guidelines</div>
                            <div class="doc-meta">Roadway design criteria</div>
                        </div>
                    </div>
                    <div class="doc-card" data-doc="maricopa-std">
                        <span class="doc-icon"></span>
                        <div class="doc-info">
                            <div class="doc-name">Maricopa County Standards</div>
                            <div class="doc-meta">Local jurisdiction requirements</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ==================== JURISDICTION BROWSER ==================== -->
            <div class="section-divider">
                <span class="section-title">Jurisdiction Requirements</span>
                <div class="section-line"></div>
            </div>

            <div class="jurisdiction-browser" id="jurisdiction-browser">
                <div class="jurisdiction-list">
                    <div class="jurisdiction-search">
                        <input type="text" class="jurisdiction-search-input" placeholder="Search jurisdictions..." id="jurisdiction-search">
                    </div>
                    <div class="jurisdiction-items" id="jurisdiction-items">
                        <!-- Jurisdiction items will be populated by JavaScript -->
                    </div>
                </div>
                <div class="jurisdiction-detail" id="jurisdiction-detail">
                    <div class="jurisdiction-placeholder">
                        <span style="font-size: 48px; margin-bottom: 16px;"></span>
                        <h3>Select a Jurisdiction</h3>
                        <p>Choose a jurisdiction from the list to view requirements, contacts, and submittal procedures.</p>
                    </div>
                </div>
            </div>

            <!-- ==================== PROJECT DATA ==================== -->
            <div class="section-divider">
                <span class="section-title">Project Data</span>
                <div class="section-line"></div>
            </div>

            <div class="doc-category">
                <div class="doc-category-header">Current Project Files</div>
                <div class="doc-grid">
                    <div class="doc-card" data-doc="traffic-counts">
                        <span class="doc-icon"></span>
                        <div class="doc-info">
                            <div class="doc-name">Traffic Counts</div>
                            <div class="doc-meta">TMC intersection counts</div>
                        </div>
                    </div>
                    <div class="doc-card" data-doc="site-plan">
                        <span class="doc-icon"></span>
                        <div class="doc-info">
                            <div class="doc-name">Site Plan</div>
                            <div class="doc-meta">Civil engineering layout</div>
                        </div>
                    </div>
                    <div class="doc-card" data-doc="existing-conditions">
                        <span class="doc-icon"></span>
                        <div class="doc-info">
                            <div class="doc-name">Existing Conditions</div>
                            <div class="doc-meta">Baseline traffic data</div>
                        </div>
                    </div>
                    <div class="doc-card" data-doc="synchro-model">
                        <span class="doc-icon"></span>
                        <div class="doc-info">
                            <div class="doc-name">Synchro Model</div>
                            <div class="doc-meta">.syn analysis file</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ==================== AGENTS ==================== -->
            <div class="section-divider">
                <span class="section-title">Agents</span>
                <div class="section-line"></div>
            </div>

            <div class="agent-grid">
                <div class="agent-card" data-agent="trip-generator">
                    <span class="agent-icon"></span>
                    <div class="agent-info">
                        <div class="agent-name">Trip Generator</div>
                        <div class="agent-desc">ITE trip generation calculations</div>
                    </div>
                    <span class="agent-status">Ready</span>
                </div>
                <div class="agent-card" data-agent="los-analyzer">
                    <span class="agent-icon"></span>
                    <div class="agent-info">
                        <div class="agent-name">LOS Analyzer</div>
                        <div class="agent-desc">Level of service analysis</div>
                    </div>
                    <span class="agent-status">Ready</span>
                </div>
                <div class="agent-card" data-agent="signal-timer">
                    <span class="agent-icon"></span>
                    <div class="agent-info">
                        <div class="agent-name">Signal Timer</div>
                        <div class="agent-desc">Signal timing optimization</div>
                    </div>
                    <span class="agent-status">Ready</span>
                </div>
                <div class="agent-card" data-agent="report-writer">
                    <span class="agent-icon"></span>
                    <div class="agent-info">
                        <div class="agent-name">TIA Report Writer</div>
                        <div class="agent-desc">Generate traffic impact reports</div>
                    </div>
                    <span class="agent-status">Ready</span>
                </div>
            </div>

            <!-- ========================== -->
            <!-- PROJECT PROGRESS SECTION   -->
            <!-- ========================== -->
            <div class="section-divider">
                <span class="section-title">Project Progress</span>
                <div class="section-line"></div>
            </div>

            <div class="progress-section">
                <!-- LEFT PANEL: Living Checklist -->
                <div class="progress-checklist" id="progress-checklist">
                    <div class="checklist-header">
                        <div class="checklist-title">
                            <span>&#9745;</span>
                            TSE Verification Checklist
                        </div>
                        <span class="checklist-count" id="checklist-count">8/8</span>
                    </div>
                    <div class="checklist-items" id="checklist-items">
                        <div class="checklist-item completed" data-task="templates">
                            <div class="checklist-checkbox"></div>
                            <span class="checklist-text">Study templates configured</span>
                            <span class="checklist-badge high">P1</span>
                        </div>
                        <div class="checklist-item completed" data-task="data">
                            <div class="checklist-checkbox"></div>
                            <span class="checklist-text">Data collection tools ready</span>
                            <span class="checklist-badge high">P1</span>
                        </div>
                        <div class="checklist-item completed" data-task="analysis">
                            <div class="checklist-checkbox"></div>
                            <span class="checklist-text">Analysis modules active</span>
                            <span class="checklist-badge medium">P2</span>
                        </div>
                        <div class="checklist-item completed" data-task="reports">
                            <div class="checklist-checkbox"></div>
                            <span class="checklist-text">Report generators ready</span>
                            <span class="checklist-badge high">P2</span>
                        </div>
                        <div class="checklist-item completed" data-task="agents">
                            <div class="checklist-checkbox"></div>
                            <span class="checklist-text">TSE agents integrated</span>
                            <span class="checklist-badge medium">P3</span>
                        </div>
                        <div class="checklist-item completed" data-task="validation">
                            <div class="checklist-checkbox"></div>
                            <span class="checklist-text">Validation workflows tested</span>
                            <span class="checklist-badge critical">P3</span>
                        </div>
                        <div class="checklist-item completed" data-task="ui">
                            <div class="checklist-checkbox"></div>
                            <span class="checklist-text">UI standardization complete</span>
                            <span class="checklist-badge medium">P4</span>
                        </div>
                        <div class="checklist-item completed" data-task="integration">
                            <div class="checklist-checkbox"></div>
                            <span class="checklist-text">Hub integration verified</span>
                            <span class="checklist-badge low">P4</span>
                        </div>
                    </div>
                </div>

                <!-- RIGHT PANEL: Progress Tracker -->
                <div class="progress-tracker" id="progress-tracker">
                    <div class="progress-header">
                        <div class="progress-title">
                            <span class="progress-title-icon">&#128202;</span>
                            TSE Build Progress
                        </div>
                        <div class="progress-overall">
                            <span class="progress-percent" id="overall-percent">100%</span>
                            <span class="progress-label">Complete</span>
                        </div>
                    </div>

                    <div class="progress-phases" id="progress-phases">
                        <div class="progress-phase" data-phase="1">
                            <span class="phase-name">P1: Core Setup</span>
                            <div class="phase-bar-container">
                                <div class="phase-bar complete" style="width: 100%">
                                    <span class="phase-tasks">2/2</span>
                                </div>
                            </div>
                            <span class="phase-percent complete">100%</span>
                        </div>
                        <div class="progress-phase" data-phase="2">
                            <span class="phase-name">P2: Templates</span>
                            <div class="phase-bar-container">
                                <div class="phase-bar complete" style="width: 100%">
                                    <span class="phase-tasks">2/2</span>
                                </div>
                            </div>
                            <span class="phase-percent complete">100%</span>
                        </div>
                        <div class="progress-phase" data-phase="3">
                            <span class="phase-name">P3: Integration</span>
                            <div class="phase-bar-container">
                                <div class="phase-bar complete" style="width: 100%">
                                    <span class="phase-tasks">2/2</span>
                                </div>
                            </div>
                            <span class="phase-percent complete">100%</span>
                        </div>
                        <div class="progress-phase" data-phase="4">
                            <span class="phase-name">P4: Polish</span>
                            <div class="phase-bar-container">
                                <div class="phase-bar complete" style="width: 100%">
                                    <span class="phase-tasks">2/2</span>
                                </div>
                            </div>
                            <span class="phase-percent complete">100%</span>
                        </div>
                    </div>

                    <div class="progress-footer">
                        <div class="progress-stat">
                            <span class="stat-value green" id="stat-complete">8</span>
                            <span class="stat-label">Complete</span>
                        </div>
                        <div class="progress-stat">
                            <span class="stat-value blue" id="stat-progress">0</span>
                            <span class="stat-label">In Progress</span>
                        </div>
                        <div class="progress-stat">
                            <span class="stat-value gray" id="stat-pending">0</span>
                            <span class="stat-label">Pending</span>
                        </div>
                        <div class="progress-stat">
                            <span class="stat-value red" id="stat-blocked">0</span>
                            <span class="stat-label">Blocked</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ==================== OPERATIONS LOG ==================== -->
            <div class="section-divider">
                <span class="section-title">Operations Log</span>
                <div class="section-line"></div>
            </div>

            <div style="background: var(--bg-surface); border: 1px solid var(--blue); border-radius: 8px; margin-bottom: 20px;">
                <div id="terminal-output" style="height: 200px; overflow-y: auto; padding: 16px; font-family: monospace; font-size: 12px; color: var(--text-muted);">
                    Terminal ready. External program output will appear here.
                </div>
            </div>
    </main>
    </div>

    <!-- New Project Modal -->
    <div class="modal-overlay" id="new-project-modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="modal-title">New TIA Project</span>
                <button class="modal-close" id="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Project Name</label>
                    <input type="text" class="form-input" id="project-name" placeholder="e.g., Grace Fellowship Church TIA">
                </div>
                <div class="form-group">
                    <label class="form-label">Client Name</label>
                    <input type="text" class="form-input" id="client-name" placeholder="e.g., Smith Engineering">
                </div>
                <div class="form-group">
                    <label class="form-label">Jurisdiction</label>
                    <select class="form-select" id="jurisdiction">
                        <option value="">-- Select Jurisdiction --</option>
                        <option value="maricopa">Maricopa County</option>
                        <option value="phoenix">City of Phoenix</option>
                        <option value="scottsdale">City of Scottsdale</option>
                        <option value="mesa">City of Mesa</option>
                        <option value="tempe">City of Tempe</option>
                        <option value="chandler">City of Chandler</option>
                        <option value="gilbert">Town of Gilbert</option>
                        <option value="glendale">City of Glendale</option>
                        <option value="pima">Pima County</option>
                        <option value="tucson">City of Tucson</option>
                        <option value="pinal">Pinal County</option>
                        <option value="yavapai">Yavapai County</option>
                        <option value="flagstaff">City of Flagstaff</option>
                        <option value="coconino">Coconino County</option>
                        <option value="yuma">Yuma County</option>
                        <option value="adot">ADOT Statewide</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Study Type</label>
                    <select class="form-select" id="study-type">
                        <option value="tia">Traffic Impact Analysis (TIA)</option>
                        <option value="tis">Traffic Impact Statement (TIS)</option>
                        <option value="methodology">Traffic Methodology Letter</option>
                        <option value="corridor">Corridor Study</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" id="modal-cancel">Cancel</button>
                <button class="btn-primary" id="modal-create">Create Project</button>
            </div>
        </div>
    </div>

    <script>
        // ==================== CONFIGURATION ====================
        const SCRIPTS_PATH = 'G:\\My Drive\\00 - Trajanus USA\\00-Command-Center\\05-Scripts\\';

        // ==================== SAFE TAURI API WRAPPER ====================
        function getInvoke() {
            if (window.__TAURI__ && window.__TAURI__.core && window.__TAURI__.core.invoke) {
                return window.__TAURI__.core.invoke;
            }
            return null;
        }

        // ==================== NOTIFICATION HELPER ====================
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
        }

        // ==================== INTRODUCTION TOGGLE ====================
        function toggleIntro() {
            const content = document.getElementById('intro-content');
            const toggle = document.getElementById('intro-toggle');
            if (content && toggle) {
                content.classList.toggle('collapsed');
                toggle.classList.toggle('collapsed');
                toggle.textContent = content.classList.contains('collapsed') ? '' : '';
            }
        }

        // ==================== PLATFORM GUIDANCE ====================
        function toggleGuidance() {
            const content = document.getElementById('guidance-content');
            const toggle = document.getElementById('guidance-toggle');
            if (content && toggle) {
                content.classList.toggle('collapsed');
                toggle.classList.toggle('collapsed');
                toggle.textContent = content.classList.contains('collapsed') ? '' : '';
            }
        }

        function scrollToAssistant() {
            const chatSection = document.querySelector('.chat-section');
            if (chatSection) {
                chatSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
                // Focus the input after scrolling
                setTimeout(() => {
                    const chatInput = document.getElementById('chat-input');
                    if (chatInput) chatInput.focus();
                }, 500);
            }
        }

        function launchAgentRunner() {
            // Launch the Agent Runner tool from toolkits
            if (window.__TAURI__) {
                window.__TAURI__.core.invoke('open_path', {
                    path: 'G:\\My Drive\\00 - Trajanus USA\\00-Command-Center\\05-Scripts\\AGENT_RUNNER_TOOL.py'
                }).catch(err => {
                    showNotification('Could not launch Agent Runner: ' + err, 'warning');
                });
            } else {
                // Fallback for browser - show info
                showNotification('Agent Runner available in desktop app', 'info');
            }
        }

        function toggleClaudeEmbed() {
            const container = document.getElementById('claude-embed-container');
            if (container) {
                container.classList.toggle('active');
            }
        }

        function openClaudePrime() {
            window.open('https://claude.ai', '_blank');
        }

        // Decision card click handlers
        document.addEventListener('DOMContentLoaded', function() {
            const decisionCards = document.querySelectorAll('.decision-card');
            decisionCards.forEach(card => {
                card.addEventListener('click', function() {
                    const action = this.dataset.action;
                    decisionCards.forEach(c => c.classList.remove('selected'));
                    this.classList.add('selected');

                    switch(action) {
                        case 'new-study':
                            document.getElementById('new-project-btn')?.click();
                            break;
                        case 'continue-study':
                            document.getElementById('project-select')?.focus();
                            break;
                        case 'research':
                            document.getElementById('chat-input')?.focus();
                            break;
                        case 'templates':
                            const docsSection = document.querySelector('[data-section="documents"]');
                            if (docsSection) docsSection.scrollIntoView({ behavior: 'smooth' });
                            break;
                    }
                });
            });
        });

        // ==================== TRAJANUS WINDOW SYSTEM ====================
        const TrajnausWindow = {
            currentWindow: null,

            open(title, content, options = {}) {
                this.close();
                const overlay = document.createElement('div');
                overlay.className = 'trajanus-window-overlay';
                overlay.onclick = (e) => {
                    if (e.target === overlay) this.close();
                };

                const window = document.createElement('div');
                window.className = 'trajanus-window';
                window.innerHTML = `
                    <div class="trajanus-window-header">
                        <span class="trajanus-window-title">${title}</span>
                        <button class="trajanus-window-close" onclick="TrajnausWindow.close()"></button>
                    </div>
                    <div class="trajanus-window-body">${content}</div>
                `;

                overlay.appendChild(window);
                document.body.appendChild(overlay);
                this.currentWindow = overlay;
                return overlay;
            },

            close() {
                if (this.currentWindow) {
                    this.currentWindow.remove();
                    this.currentWindow = null;
                }
            }
        };

        // ==================== TERMINAL ====================
        const Terminal = {
            output(message, type = 'info') {
                const terminal = document.getElementById('terminal-output');
                const line = document.createElement('div');
                line.className = `terminal-line ${type}`;
                const timestamp = new Date().toLocaleTimeString();
                line.innerHTML = `<span style="color: #606060;">[${timestamp}]</span> ${message}`;
                terminal.appendChild(line);
                terminal.scrollTop = terminal.scrollHeight;
            },

            clear() {
                const terminal = document.getElementById('terminal-output');
                terminal.innerHTML = '<div style="color: #808080;">Terminal cleared.</div>';
            },

            error(message) { this.output(message, 'error'); },
            success(message) { this.output(message, 'success'); },
            warning(message) { this.output(message, 'warning'); },
            info(message) { this.output(message, 'info'); }
        };

        // ==================== APPS MODULE ====================
        const Apps = {
            commands: {
                'synchro': 'C:\\Program Files\\Trafficware\\Synchro\\Synchro.exe',
                'hcs': 'C:\\Program Files\\McTrans\\HCS 7\\HCS.exe',
                'autocad': 'C:\\Program Files\\Autodesk\\AutoCAD 2024\\acad.exe',
                'word': 'winword', 'excel': 'excel', 'powerpoint': 'powerpnt',
                'outlook': 'outlook', 'onenote': 'onenote', 'chrome': 'chrome',
                'edge': 'msedge', 'explorer': 'G:\\My Drive\\00 - Trajanus USA',
                'terminal': 'wt'
            },
            webUrls: {
                'word': 'https://office.live.com/start/word.aspx',
                'excel': 'https://office.live.com/start/excel.aspx',
                'powerpoint': 'https://office.live.com/start/powerpoint.aspx',
                'onenote': 'https://www.onenote.com/notebooks',
                'outlook': 'https://outlook.live.com',
                'chrome': 'https://google.com', 'edge': 'https://bing.com'
            },

            async launch(appKey) {
                Terminal.info(`Launching: ${appKey}`);
                const invoke = getInvoke();

                if (!invoke) {
                    if (this.webUrls[appKey]) {
                        window.open(this.webUrls[appKey], '_blank');
                        Terminal.success(`Opened ${appKey} in browser`);
                        showNotification(`Opening ${appKey} in browser...`, 'info');
                    } else {
                        Terminal.warning(`${appKey} requires the desktop app`);
                        showNotification(`${appKey} requires the desktop app`, 'warning');
                    }
                    return;
                }

                try {
                    await invoke('open_path', { path: this.commands[appKey] });
                    Terminal.success(`Launched ${appKey}`);
                    showNotification(`Launched ${appKey}`, 'success');
                } catch (e) {
                    Terminal.error(`Failed to launch ${appKey}: ${e}`);
                    if (this.webUrls[appKey]) {
                        window.open(this.webUrls[appKey], '_blank');
                        Terminal.info(`Fallback: Opened ${appKey} in browser`);
                    }
                }
            }
        };

        // ==================== SCRIPTS MODULE ====================
        const Scripts = {
            scripts: {
                'trip-generation': { name: 'Trip Generation Calculator', file: 'trip_generation.py' },
                'los-worksheet': { name: 'LOS Worksheet', file: 'los_worksheet.py' },
                'signal-timing': { name: 'Signal Timing Optimizer', file: 'signal_timing.py' },
                'tia-template': { name: 'TIA Report Template', file: 'tia_template.py' }
            },

            async run(scriptId) {
                const script = this.scripts[scriptId] || { name: scriptId, file: scriptId };
                Terminal.info(`Starting: ${script.name}`);
                showNotification(`Running ${script.name}...`, 'info');

                const invoke = getInvoke();
                if (!invoke) {
                    Terminal.warning(`[Browser Mode] Cannot execute ${script.name} - requires desktop app`);
                    Chat.addMessage('assistant', `${script.name} requires the desktop app to run.`);
                    return;
                }

                try {
                    const result = await invoke('run_python_script', {
                        scriptPath: SCRIPTS_PATH + script.file,
                        targetPath: ''
                    });
                    Terminal.success(`Completed: ${script.name}`);
                    if (result) Terminal.output(result);
                } catch (e) {
                    Terminal.error(`Error in ${script.name}: ${e}`);
                }
            }
        };

        // ==================== DOCUMENTS MODULE ====================
        const Documents = {
            docs: {
                'ite-trip-gen': { title: 'ITE Trip Generation Manual', path: 'G:\\My Drive\\00 - Trajanus USA\\Reference\\ITE' },
                'hcm': { title: 'Highway Capacity Manual', path: 'G:\\My Drive\\00 - Trajanus USA\\Reference\\HCM' },
                'mutcd': { title: 'MUTCD', path: 'G:\\My Drive\\00 - Trajanus USA\\Reference\\MUTCD' },
                'fdot-los': { title: 'FDOT Quality/LOS Manual', path: 'G:\\My Drive\\00 - Trajanus USA\\Reference\\FDOT' },
                'fdot-design': { title: 'FDOT Design Manual', path: 'G:\\My Drive\\00 - Trajanus USA\\Reference\\FDOT' },
                'alachua-std': { title: 'Alachua County Standards', path: 'G:\\My Drive\\00 - Trajanus USA\\Reference\\Local' },
                'traffic-counts': { title: 'Traffic Counts', path: 'G:\\My Drive\\00 - Trajanus USA\\Traffic\\Counts' },
                'site-plan': { title: 'Site Plan', path: 'G:\\My Drive\\00 - Trajanus USA\\Traffic\\Plans' },
                'existing-conditions': { title: 'Existing Conditions', path: 'G:\\My Drive\\00 - Trajanus USA\\Traffic\\Existing' },
                'synchro-model': { title: 'Synchro Model', path: 'G:\\My Drive\\00 - Trajanus USA\\Traffic\\Synchro' }
            },

            async open(docId) {
                const doc = this.docs[docId] || { title: docId, path: '' };
                Terminal.info(`Opening document: ${doc.title}`);
                showNotification(`Opening ${doc.title}...`, 'info');

                const invoke = getInvoke();
                if (!invoke) {
                    TrajnausWindow.open(doc.title, `
                        <p style="color: #b0b0b0; margin-bottom: 20px;">Document location:</p>
                        <code style="background: #2d2d2d; padding: 10px; display: block; border-radius: 4px; color: #c0c0c0;">${doc.path}</code>
                        <p style="color: #808080; margin-top: 20px; font-size: 13px;">
                            [Browser Mode] Opening folders requires the desktop app.
                        </p>
                    `);
                    return;
                }

                try {
                    await invoke('open_path', { path: doc.path });
                    Terminal.success(`Opened: ${doc.title}`);
                } catch (e) {
                    Terminal.error(`Failed to open ${doc.title}: ${e}`);
                }
            }
        };

        // ==================== AGENTS MODULE ====================
        const Agents = {
            async activate(agent) {
                Terminal.info(`Activating agent: ${agent}`);
                showNotification(`Activating ${agent}...`, 'success');

                const responses = {
                    'trip-generator': 'Trip Generator agent activated. I can calculate trip generation using ITE 11th Edition rates. Provide your land use type and size, and I\'ll calculate AM/PM peak trips with appropriate adjustments.',
                    'los-analyzer': 'LOS Analyzer agent activated. I can analyze intersection and segment level of service using HCM methodology. Share your traffic data and I\'ll calculate delay and LOS.',
                    'signal-timer': 'Signal Timer agent activated. I can optimize signal timing and analyze coordination. Provide your intersection geometry and volumes.',
                    'report-writer': 'TIA Report Writer agent activated. I can help generate traffic impact analysis reports in jurisdiction-compliant format. What project are we working on?'
                };

                Chat.addMessage('assistant', responses[agent] || `Agent ${agent} is now active.`);
            }
        };

        // ==================== CHAT MODULE ====================
        const Chat = {
            isProcessing: false,

            addMessage(role, content) {
                const messages = document.getElementById('chat-messages');
                const msg = document.createElement('div');
                msg.className = `chat-message ${role}`;
                msg.textContent = content;
                messages.appendChild(msg);
                messages.scrollTop = messages.scrollHeight;
            },

            showTyping() {
                const messages = document.getElementById('chat-messages');
                const typing = document.createElement('div');
                typing.className = 'typing-indicator';
                typing.id = 'typing-indicator';
                typing.innerHTML = '<span></span><span></span><span></span>';
                messages.appendChild(typing);
                messages.scrollTop = messages.scrollHeight;
            },

            hideTyping() {
                document.getElementById('typing-indicator')?.remove();
            },

            async send() {
                const input = document.getElementById('chat-input');
                const message = input.value.trim();

                if (!message || this.isProcessing) return;

                this.addMessage('user', message);
                input.value = '';
                this.isProcessing = true;

                const invoke = getInvoke();
                if (!invoke) {
                    this.showTyping();
                    setTimeout(() => {
                        this.hideTyping();
                        this.addMessage('assistant', 'I\'m running in browser mode. Full AI capabilities require the desktop app. How can I help you with traffic engineering concepts?');
                        this.isProcessing = false;
                    }, 1500);
                    return;
                }

                this.showTyping();

                try {
                    const context = `You are a Traffic Engineering specialist for traffic impact studies in Arizona.
                    You help with traffic impact analyses, level of service calculations, trip generation using ITE methods,
                    signal timing optimization, and safety assessments.
                    You are familiar with Synchro 12, HCS 7, ADOT Traffic Engineering Guidelines, HCM 7th Edition, and local Arizona jurisdiction standards.
                    Keep responses concise and technically accurate.`;

                    const response = await invoke('chat_with_claude', {
                        message: message,
                        context: context
                    });

                    this.hideTyping();
                    this.addMessage('assistant', response);
                } catch (error) {
                    this.hideTyping();
                    this.addMessage('assistant', 'Error connecting to AI service: ' + error);
                } finally {
                    this.isProcessing = false;
                }
            }
        };

        // ==================== AGENT RUNNER MODULE ====================
        const AgentRunner = {
            isRunning: false,

            async run() {
                if (this.isRunning) return;

                const skill = document.getElementById('agent-skill').value;
                const query = document.getElementById('agent-query').value.trim();
                const externalMode = document.getElementById('research-external').checked;
                const internalMode = document.getElementById('research-internal').checked;
                const resultsDiv = document.getElementById('agent-results');

                if (!query) {
                    showNotification('Please enter a query', 'warning');
                    return;
                }

                this.isRunning = true;
                resultsDiv.innerHTML = '<div style="color: var(--gold);">Running agent...</div>';

                const invoke = getInvoke();
                if (!invoke) {
                    // Browser mode - simulate response
                    setTimeout(() => {
                        resultsDiv.innerHTML = `
                            <div style="margin-bottom: 12px;">
                                <strong style="color: var(--gold);">Skill:</strong> ${skill}<br>
                                <strong style="color: var(--gold);">Mode:</strong> ${externalMode ? 'External' : ''} ${internalMode ? 'Internal' : ''}<br>
                                <strong style="color: var(--gold);">Query:</strong> ${query}
                            </div>
                            <div style="color: var(--text-light);">
                                [Browser Mode] Agent Runner requires the desktop app for full functionality.
                                In the desktop app, this would execute the AGENT_RUNNER_TOOL.py script with your query.
                            </div>
                        `;
                        this.isRunning = false;
                        showNotification('Agent completed (browser mode)', 'info');
                    }, 1500);
                    return;
                }

                try {
                    // Build mode string
                    let mode = 'both';
                    if (externalMode && !internalMode) mode = 'external';
                    if (!externalMode && internalMode) mode = 'internal';

                    const scriptPath = 'G:\\My Drive\\00 - Trajanus USA\\00-Command-Center\\05-Scripts\\AGENT_RUNNER_TOOL.py';
                    const args = JSON.stringify({ skill, query, mode });

                    const result = await invoke('run_python_script', {
                        scriptPath: scriptPath,
                        targetPath: args
                    });

                    resultsDiv.innerHTML = `
                        <div style="margin-bottom: 12px;">
                            <strong style="color: var(--gold);">Skill:</strong> ${skill}<br>
                            <strong style="color: var(--gold);">Mode:</strong> ${mode}<br>
                        </div>
                        <div style="color: var(--success);">${result}</div>
                    `;
                    showNotification('Agent completed', 'success');
                } catch (error) {
                    resultsDiv.innerHTML = `<div style="color: var(--error);">Error: ${error}</div>`;
                    showNotification('Agent failed', 'warning');
                } finally {
                    this.isRunning = false;
                }
            },

            clear() {
                document.getElementById('agent-query').value = '';
                document.getElementById('agent-results').innerHTML = 'Results will appear here after running the agent...';
            }
        };

        // ==================== TSE WORKFLOW MODULE ====================
        const TseWorkflow = {
            currentStep: 1,
            currentProject: null,
            projects: [],

            // Step instructions based on 10-step TIA workflow
            stepInstructions: {
                1: {
                    title: 'Step 1: Project Setup',
                    content: `<strong>Create your TIA project folder structure:</strong>
                    <ol>
                        <li>Click <strong>+ New Project</strong> and enter project details</li>
                        <li>The system will create your folder structure at:<br>
                            <code style="background:#2d2d2d;padding:4px 8px;border-radius:4px;display:inline-block;margin:4px 0;">G:\\My Drive\\00 - Trajanus USA\\Traffic\\[Project Name]\\</code></li>
                        <li>Standard folders: 01-Input, 02-Working, 03-Output, 04-Correspondence, 05-Final</li>
                        <li>Once created, proceed to <strong>Step 2: Data Collection</strong></li>
                    </ol>`
                },
                2: {
                    title: 'Step 2: Data Collection',
                    content: `<strong>Gather all required traffic data:</strong>
                    <ol>
                        <li><strong>TMC Counts</strong> - Turning movement counts at study intersections
                            <ul style="margin-left:20px;margin-top:4px;">
                                <li>AM Peak (7:00-9:00 AM typical)</li>
                                <li>PM Peak (4:00-6:00 PM typical)</li>
                                <li>Save to: 01-Input/Traffic Counts/</li>
                            </ul>
                        </li>
                        <li><strong>ADT Counts</strong> - Tube counts for roadway segments</li>
                        <li><strong>Site Plan (.pdf)</strong> - From client/architect</li>
                        <li><strong>Land Use Details</strong> - ITE code, building size, occupancy</li>
                    </ol>
                    <p style="margin-top:12px;color:var(--info);">Check off each item in the Required Documents checklist as you collect them.</p>`
                },
                3: {
                    title: 'Step 3: Trip Generation',
                    content: `<strong>Calculate site-generated traffic using ITE methodology:</strong>
                    <ol>
                        <li><strong>Identify Land Use Code</strong> - Reference ITE Trip Generation Manual (11th Ed)
                            <ul style="margin-left:20px;margin-top:4px;">
                                <li>Example: 560 (Church), 820 (Shopping Center)</li>
                                <li>Select appropriate independent variable (GFA, units, etc.)</li>
                            </ul>
                        </li>
                        <li><strong>Calculate Peak Hour Trips</strong>
                            <ul style="margin-left:20px;margin-top:4px;">
                                <li>AM Peak trips (in/out)</li>
                                <li>PM Peak trips (in/out)</li>
                                <li>Apply pass-by and diverted trip reductions if applicable</li>
                            </ul>
                        </li>
                        <li><strong>Document in Trip Gen Worksheet</strong> - Save to 02-Working/</li>
                    </ol>`
                },
                4: {
                    title: 'Step 4: Trip Distribution',
                    content: `<strong>Distribute site trips to the roadway network:</strong>
                    <ol>
                        <li><strong>Determine Distribution Percentages</strong>
                            <ul style="margin-left:20px;margin-top:4px;">
                                <li>Based on existing traffic patterns</li>
                                <li>Population/employment gravity model</li>
                                <li>Professional judgment for local conditions</li>
                            </ul>
                        </li>
                        <li><strong>Create Trip Distribution Diagram</strong>
                            <ul style="margin-left:20px;margin-top:4px;">
                                <li>Show percentages to each approach</li>
                                <li>Include turning movements at site driveways</li>
                            </ul>
                        </li>
                        <li><strong>Assign Trips</strong> - Apply percentages to trip generation totals</li>
                    </ol>`
                },
                5: {
                    title: 'Step 5: Future Volumes',
                    content: `<strong>Project future year traffic volumes:</strong>
                    <ol>
                        <li><strong>Determine Horizon Year</strong> - Typically opening year + 5 years</li>
                        <li><strong>Apply Growth Factor</strong>
                            <ul style="margin-left:20px;margin-top:4px;">
                                <li>Use jurisdiction-approved growth rate (typically 1-3% annual)</li>
                                <li>Compound formula: Future = Existing  (1 + rate)^years</li>
                            </ul>
                        </li>
                        <li><strong>Account for Background Development</strong>
                            <ul style="margin-left:20px;margin-top:4px;">
                                <li>Check with jurisdiction for approved projects</li>
                                <li>Add trips from committed developments</li>
                            </ul>
                        </li>
                        <li><strong>Create Volume Scenarios:</strong> Existing, Background, Background+Site</li>
                    </ol>`
                },
                6: {
                    title: 'Step 6: Capacity Analysis',
                    content: `<strong>Analyze intersection operations using Synchro/HCS:</strong>
                    <ol>
                        <li><strong>Build Synchro Models</strong>
                            <ul style="margin-left:20px;margin-top:4px;">
                                <li>Import intersection geometry from field/plans</li>
                                <li>Enter signal timing parameters</li>
                                <li>Input volumes for each scenario</li>
                            </ul>
                        </li>
                        <li><strong>Run HCM Analysis</strong>
                            <ul style="margin-left:20px;margin-top:4px;">
                                <li>Calculate delay and Level of Service</li>
                                <li>Identify critical movements</li>
                            </ul>
                        </li>
                        <li><strong>Compare Scenarios</strong> - Background vs Background+Site</li>
                        <li><strong>Export Reports</strong> - Save to 03-Output/Capacity Analysis/</li>
                    </ol>`
                },
                7: {
                    title: 'Step 7: Site Access',
                    content: `<strong>Design and analyze site access points:</strong>
                    <ol>
                        <li><strong>Driveway Location</strong>
                            <ul style="margin-left:20px;margin-top:4px;">
                                <li>Spacing from intersections per jurisdiction standards</li>
                                <li>Sight distance requirements</li>
                                <li>Access management compliance</li>
                            </ul>
                        </li>
                        <li><strong>Driveway Operations</strong>
                            <ul style="margin-left:20px;margin-top:4px;">
                                <li>Analyze site driveway LOS</li>
                                <li>Queue analysis for drive-thru if applicable</li>
                            </ul>
                        </li>
                        <li><strong>Turn Lane Warrants</strong>
                            <ul style="margin-left:20px;margin-top:4px;">
                                <li>Left-turn deceleration lanes</li>
                                <li>Right-turn deceleration lanes</li>
                            </ul>
                        </li>
                    </ol>`
                },
                8: {
                    title: 'Step 8: Signal Warrants',
                    content: `<strong>Evaluate traffic signal warrants per MUTCD:</strong>
                    <ol>
                        <li><strong>Warrant Analysis</strong> (if required by jurisdiction)
                            <ul style="margin-left:20px;margin-top:4px;">
                                <li>Warrant 1: Eight-Hour Vehicular Volume</li>
                                <li>Warrant 2: Four-Hour Vehicular Volume</li>
                                <li>Warrant 3: Peak Hour</li>
                                <li>Warrant 7: Crash Experience</li>
                            </ul>
                        </li>
                        <li><strong>Document Findings</strong>
                            <ul style="margin-left:20px;margin-top:4px;">
                                <li>Warrant satisfied or not satisfied</li>
                                <li>Supporting data and calculations</li>
                            </ul>
                        </li>
                        <li><strong>Recommendations</strong> - Signal installation or alternatives</li>
                    </ol>`
                },
                9: {
                    title: 'Step 9: Report Assembly',
                    content: `<strong>Assemble the Traffic Impact Analysis document:</strong>
                    <ol>
                        <li><strong>Use TIA Template</strong> - Launch Word with jurisdiction-specific template</li>
                        <li><strong>Required Sections:</strong>
                            <ul style="margin-left:20px;margin-top:4px;">
                                <li>Executive Summary</li>
                                <li>Project Description & Site Plan</li>
                                <li>Study Area & Intersections</li>
                                <li>Existing Conditions</li>
                                <li>Trip Generation (ITE methodology)</li>
                                <li>Trip Distribution & Assignment</li>
                                <li>Future Traffic Analysis</li>
                                <li>Site Access Analysis</li>
                                <li>Level of Service Results</li>
                                <li>Conclusions & Recommendations</li>
                            </ul>
                        </li>
                        <li><strong>Insert Tables & Figures</strong></li>
                    </ol>`
                },
                10: {
                    title: 'Step 10: Final Delivery',
                    content: `<strong>Complete the final deliverable package:</strong>
                    <ol>
                        <li><strong>Create Exhibits</strong>
                            <ul style="margin-left:20px;margin-top:4px;">
                                <li>Location Map</li>
                                <li>Site Plan</li>
                                <li>Study Area Map</li>
                                <li>Trip Distribution Diagram</li>
                                <li>Lane Configuration Diagrams</li>
                            </ul>
                        </li>
                        <li><strong>Compile Appendix</strong>
                            <ul style="margin-left:20px;margin-top:4px;">
                                <li>Traffic Counts</li>
                                <li>Capacity Analysis Reports</li>
                                <li>Trip Generation Worksheet</li>
                            </ul>
                        </li>
                        <li><strong>Export Final PDF</strong> - Convert to PDF, check formatting</li>
                        <li><strong>Submit to Client/Jurisdiction</strong></li>
                    </ol>
                    <p style="margin-top:12px;color:var(--success);font-weight:600;">Project complete! Review checklist to ensure all items are checked.</p>`
                }
            },

            // Tools for each step
            stepTools: {
                1: [], // No tools needed for setup
                2: [
                    { id: 'explorer', icon: '', label: 'File Explorer', action: 'openExplorer' },
                    { id: 'maps', icon: '', label: 'Google Maps', action: 'launchMaps' }
                ],
                3: [
                    { id: 'excel', icon: '', label: 'Excel', action: 'launchExcel' },
                    { id: 'trip-gen', icon: '', label: 'Trip Gen Calculator', action: 'runTripGen' },
                    { id: 'ite', icon: '', label: 'ITE Manual', action: 'openITE' }
                ],
                4: [
                    { id: 'excel', icon: '', label: 'Excel', action: 'launchExcel' },
                    { id: 'autocad', icon: '', label: 'AutoCAD', action: 'launchAutoCAD' }
                ],
                5: [
                    { id: 'excel', icon: '', label: 'Excel', action: 'launchExcel' },
                    { id: 'explorer', icon: '', label: 'Working Folder', action: 'openWorkingFolder' }
                ],
                6: [
                    { id: 'synchro', icon: '', label: 'Synchro 12', action: 'launchSynchro' },
                    { id: 'hcs', icon: '', label: 'HCS', action: 'launchHCS' },
                    { id: 'explorer', icon: '', label: 'Output Folder', action: 'openOutputFolder' }
                ],
                7: [
                    { id: 'autocad', icon: '', label: 'AutoCAD', action: 'launchAutoCAD' },
                    { id: 'synchro', icon: '', label: 'Synchro 12', action: 'launchSynchro' }
                ],
                8: [
                    { id: 'excel', icon: '', label: 'Excel (Warrants)', action: 'launchExcel' },
                    { id: 'mutcd', icon: '', label: 'MUTCD', action: 'openMUTCD' }
                ],
                9: [
                    { id: 'word', icon: '', label: 'Word', action: 'launchWord' },
                    { id: 'tia-template', icon: '', label: 'TIA Template', action: 'runTiaTemplate' },
                    { id: 'explorer', icon: '', label: 'Project Folder', action: 'openProjectFolder' }
                ],
                10: [
                    { id: 'word', icon: '', label: 'Word', action: 'launchWord' },
                    { id: 'acrobat', icon: '', label: 'PDF Export', action: 'launchAcrobat' },
                    { id: 'explorer', icon: '', label: 'Final Folder', action: 'openFinalFolder' }
                ]
            },

            init() {
                this.loadProjects();
                this.updateStepDisplay();
                this.bindEvents();
                this.loadActiveProject();
            },

            // Load persisted project data and render summary/folder  ALWAYS render tracker
            loadActiveProject() {
                const saved = localStorage.getItem('tfe_active_project');
                if (saved) {
                    try {
                        const data = JSON.parse(saved);
                        this.renderProjectSummary(data);
                        this.renderFolderTracker(data);
                    } catch(e) {
                        this.renderFolderTracker({ stepsCompleted: {}, folderItems: {} });
                    }
                } else {
                    // No project yet  show tracker with everything missing, summary placeholder
                    this.renderFolderTracker({ stepsCompleted: {}, folderItems: {} });
                    const grid = document.getElementById('project-summary-grid');
                    if (grid) grid.innerHTML = '<div style="color:var(--text-muted);font-size:13px;grid-column:1/-1;text-align:center;padding:12px;">No project submitted yet  complete Step 1 to populate</div>';
                }
            },

            // Render the project summary card
            renderProjectSummary(data) {
                const card = document.getElementById('project-summary-card');
                const grid = document.getElementById('project-summary-grid');
                const buildingsDiv = document.getElementById('project-summary-buildings');

                const fields = [
                    { label: 'Project Name', value: data.name },
                    { label: 'Project Number', value: data.number || '' },
                    { label: 'Jurisdiction', value: data.jurisdiction || '' },
                    { label: 'Site Address', value: data.address || '' },
                    { label: 'Opening Year', value: data.openingYear || '' },
                    { label: 'Horizon Year', value: data.horizonYear || '' },
                    { label: 'Growth Rate', value: data.growthRate ? data.growthRate + '%' : '' },
                ];

                grid.innerHTML = fields.map(f =>
                    '<div class="project-summary-field"><div class="field-label">' + f.label + '</div><div class="field-value">' + f.value + '</div></div>'
                ).join('');

                if (data.buildings && data.buildings.length) {
                    buildingsDiv.innerHTML = '<div style="font-size:11px;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:8px;">Buildings</div>' +
                        data.buildings.map(b =>
                            '<span class="building-tag"> ' + b.name + (b.sqft ? '  ' + Number(b.sqft).toLocaleString() + ' SF' : '') + (b.luc ? ' (LUC ' + b.luc + ')' : '') + (b.driveThru ? ' ' : '') + '</span>'
                        ).join('');
                }

                card.classList.add('visible');
            },

            // Render the project folder tracker
            renderFolderTracker(data) {
                const tracker = document.getElementById('project-folder-tracker');
                tracker.classList.add('visible');

                const completed = data.stepsCompleted || {};
                const folderItems = data.folderItems || {};

                // Dependency map: which steps need output from prior steps
                const dependencies = {
                    3: { needs: 'TMC data from Step 2', check: ['folder-tmc-counts'] },
                    4: { needs: 'Trip generation from Step 3', check: ['folder-trip-calcs'] },
                    5: { needs: 'Distribution from Step 4', check: ['folder-distribution'] },
                    6: { needs: 'Volume scenarios from Step 5', check: ['folder-volumes'] },
                    7: { needs: 'Capacity results from Step 6', check: ['folder-synchro'] },
                    8: { needs: 'Capacity results from Step 6', check: ['folder-synchro'] },
                    9: { needs: 'All analysis steps (3-8)', check: ['folder-trip-calcs','folder-synchro'] },
                    10: { needs: 'Report draft from Step 9', check: ['folder-report'] }
                };

                // Update step groups
                document.querySelectorAll('.folder-step-group').forEach(group => {
                    const stepNum = parseInt(group.dataset.folderStep);
                    const badge = document.getElementById('folder-badge-' + stepNum);
                    const items = group.querySelectorAll('.folder-item');
                    let doneInStep = 0;
                    let totalInStep = items.length;

                    items.forEach(item => {
                        const statusEl = item.querySelector('.item-status');
                        if (folderItems[item.id]) {
                            item.classList.remove('pending');
                            if (statusEl) {
                                statusEl.textContent = 'Done';
                                statusEl.className = 'item-status done';
                            }
                            doneInStep++;
                        } else {
                            item.classList.add('pending');
                            if (statusEl) {
                                statusEl.textContent = 'Missing';
                                statusEl.className = 'item-status pending';
                            }
                        }
                    });

                    // Update badge: done / partial / pending
                    if (badge) {
                        badge.classList.remove('done', 'partial');
                        if (completed[stepNum] || doneInStep === totalInStep) {
                            badge.classList.add('done');
                            badge.textContent = '';
                        } else if (doneInStep > 0) {
                            badge.classList.add('partial');
                            badge.textContent = doneInStep + '/' + totalInStep;
                        } else {
                            badge.textContent = stepNum;
                        }
                    }

                    // Add/update dependency note
                    let depNote = group.querySelector('.folder-dep-note');
                    const dep = dependencies[stepNum];
                    if (dep) {
                        const depMet = dep.check.every(id => folderItems[id]);
                        if (!depMet) {
                            if (!depNote) {
                                depNote = document.createElement('div');
                                depNote.className = 'folder-dep-note';
                                group.appendChild(depNote);
                            }
                            depNote.innerHTML = '<span style="color:#fbbf24;font-size:11px;"> Requires: ' + dep.needs + '</span>';
                            depNote.style.display = 'block';
                        } else if (depNote) {
                            depNote.style.display = 'none';
                        }
                    }
                });

                // Update progress  count steps with ALL items done
                let fullyDone = 0;
                let partialDone = 0;
                document.querySelectorAll('.folder-step-group').forEach(group => {
                    const items = group.querySelectorAll('.folder-item');
                    const done = Array.from(items).filter(i => folderItems[i.id]).length;
                    if (done === items.length) fullyDone++;
                    else if (done > 0) partialDone++;
                });
                const progressText = fullyDone + ' complete' + (partialDone > 0 ? ', ' + partialDone + ' in progress' : '') + ' / 10 steps';
                document.getElementById('folder-tracker-progress').textContent = progressText;
            },

            // Save folder item as complete
            markFolderItem(itemId) {
                const saved = localStorage.getItem('tfe_active_project');
                if (saved) {
                    const data = JSON.parse(saved);
                    if (!data.folderItems) data.folderItems = {};
                    data.folderItems[itemId] = true;
                    localStorage.setItem('tfe_active_project', JSON.stringify(data));
                    this.renderFolderTracker(data);
                }
            },

            // Mark a step as complete in the folder
            markStepComplete(stepNum) {
                const saved = localStorage.getItem('tfe_active_project');
                if (saved) {
                    const data = JSON.parse(saved);
                    if (!data.stepsCompleted) data.stepsCompleted = {};
                    data.stepsCompleted[stepNum] = true;
                    localStorage.setItem('tfe_active_project', JSON.stringify(data));
                    this.renderFolderTracker(data);
                }
            },

            bindEvents() {
                // Modal controls
                document.getElementById('new-project-btn').addEventListener('click', () => this.openModal());
                document.getElementById('modal-close').addEventListener('click', () => this.closeModal());
                document.getElementById('modal-cancel').addEventListener('click', () => this.closeModal());
                document.getElementById('modal-create').addEventListener('click', () => this.createProject());

                // Project selection
                document.getElementById('project-select').addEventListener('change', (e) => this.selectProject(e.target.value));

                // Workflow step clicks
                document.querySelectorAll('.workflow-step').forEach(step => {
                    step.addEventListener('click', () => this.goToStep(parseInt(step.dataset.step)));
                });

                // Documents panel toggle
                document.getElementById('docs-panel-header').addEventListener('click', () => this.toggleDocsPanel());

                // Document checkbox changes (now disabled - system controlled)
                document.querySelectorAll('.doc-checkbox').forEach(cb => {
                    cb.disabled = true; // System controls this
                });

                // Action buttons
                document.getElementById('open-folder-btn').addEventListener('click', () => this.openProjectFolder());
                document.getElementById('next-step-btn').addEventListener('click', () => this.advanceStep());

                // Workspace: Add Building button
                document.getElementById('add-building-btn').addEventListener('click', () => {
                    const tbody = document.getElementById('buildings-tbody');
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td><input type="text" placeholder="e.g., Outparcel"></td>
                        <td><input type="number" placeholder="5,000"></td>
                        <td><input type="text" placeholder="e.g., 934"></td>
                        <td style="text-align:center"><input type="checkbox"></td>
                        <td><button class="remove-building-btn" onclick="this.closest('tr').remove()"></button></td>
                    `;
                    tbody.appendChild(row);
                });

                // Workspace: Drop zone
                const dropZone = document.getElementById('ws-drop-zone');
                if (dropZone) {
                    dropZone.addEventListener('dragover', (e) => {
                        e.preventDefault();
                        dropZone.classList.add('dragover');
                    });
                    dropZone.addEventListener('dragleave', () => {
                        dropZone.classList.remove('dragover');
                    });
                    dropZone.addEventListener('drop', (e) => {
                        e.preventDefault();
                        dropZone.classList.remove('dragover');
                        const files = e.dataTransfer.files;
                        if (files.length) {
                            dropZone.innerHTML = '<div class="ws-drop-icon"></div><div class="ws-drop-text">' + files.length + ' file(s) attached</div><div class="ws-drop-subtext">' + Array.from(files).map(f => f.name).join(', ') + '</div>';
                        }
                    });
                    dropZone.addEventListener('click', () => {
                        const input = document.createElement('input');
                        input.type = 'file';
                        input.accept = '.pdf,.png,.jpg,.jpeg';
                        input.multiple = true;
                        input.onchange = () => {
                            if (input.files.length) {
                                dropZone.innerHTML = '<div class="ws-drop-icon"></div><div class="ws-drop-text">' + input.files.length + ' file(s) attached</div><div class="ws-drop-subtext">' + Array.from(input.files).map(f => f.name).join(', ') + '</div>';
                            }
                        };
                        input.click();
                    });
                }

                // Workspace: Browse Files (Native Dialog via PowerShell)
                document.getElementById('ws-browse-files').addEventListener('click', async () => {
                    const attachDiv = document.getElementById('ws-attached-files');
                    try {
                        const invoke = getInvoke();
                        if (invoke) {
                            // Use PowerShell to open native file dialog
                            const result = await invoke('open_terminal_output', {
                                command: 'powershell',
                                args: ['-WindowStyle', 'Hidden', '-Command', `
                                    Add-Type -AssemblyName System.Windows.Forms
                                    $dlg = New-Object System.Windows.Forms.OpenFileDialog
                                    $dlg.Title = 'Select Site Documents'
                                    $dlg.InitialDirectory = 'G:\\My Drive\\00 - Trajanus USA'
                                    $dlg.Filter = 'Documents (*.pdf;*.png;*.jpg;*.jpeg)|*.pdf;*.png;*.jpg;*.jpeg|All files (*.*)|*.*'
                                    $dlg.Multiselect = $true
                                    if ($dlg.ShowDialog() -eq 'OK') { $dlg.FileNames -join '|' } else { '' }
                                `]
                            });
                            if (result && result.trim()) {
                                const files = result.trim().split('|');
                                attachDiv.innerHTML = files.map(f =>
                                    '<div style="display:flex;align-items:center;gap:8px;padding:8px 12px;background:var(--bg-base);border:1px solid var(--blue);border-radius:6px;margin-bottom:6px;font-size:13px;color:var(--text-light);"> ' + f.split('\\').pop() + '<span style="color:var(--text-muted);font-size:11px;margin-left:auto;">' + f + '</span></div>'
                                ).join('');
                            }
                        } else {
                            showNotification('Native file dialog requires Tauri desktop app', 'warning');
                        }
                    } catch(e) {
                        // Fallback: try run_powershell_script or show error
                        showNotification('File dialog: ' + e, 'warning');
                    }
                });

                // Workspace: Browse Local (HTML file input)
                document.getElementById('ws-browse-local').addEventListener('click', () => {
                    const input = document.createElement('input');
                    input.type = 'file';
                    input.accept = '.pdf,.png,.jpg,.jpeg';
                    input.multiple = true;
                    input.onchange = () => {
                        if (input.files.length) {
                            const attachDiv = document.getElementById('ws-attached-files');
                            attachDiv.innerHTML = Array.from(input.files).map(f =>
                                '<div style="display:flex;align-items:center;gap:8px;padding:8px 12px;background:var(--bg-base);border:1px solid var(--blue);border-radius:6px;margin-bottom:6px;font-size:13px;color:var(--text-light);"> ' + f.name + '<span style="color:var(--text-muted);font-size:11px;margin-left:auto;">' + (f.size / 1024).toFixed(1) + ' KB</span></div>'
                            ).join('');
                        }
                    };
                    input.click();
                });

                // ==================== STEP 2 VALIDATION ENGINE ====================

                // Helper: render a validation item
                function valItem(pass, label, detail) {
                    const icon = pass === true ? 'pass' : (pass === false ? 'fail' : 'warn');
                    const sym = pass === true ? '' : (pass === false ? '' : '!');
                    return '<div class="ws-val-item"><span class="ws-val-icon ' + icon + '">' + sym + '</span><span>' + label + '</span>' + (detail ? '<span class="ws-val-detail">' + detail + '</span>' : '') + '</div>';
                }

                // Helper: update a section badge
                function setBadge(id, state) {
                    const badge = document.getElementById(id);
                    if (!badge) return;
                    badge.className = 'ws-section-badge ' + state;
                    badge.textContent = state === 'valid' ? 'Complete' : (state === 'warning' ? 'Issues' : 'Incomplete');
                }

                // --- TMC COUNT INFO: live validation on change ---
                function validateTmcInfo() {
                    const panel = document.getElementById('val-tmc-info');
                    const items = document.getElementById('val-tmc-info-items');
                    const countDate = document.getElementById('ws-count-date')?.value;
                    const dayOfWeek = document.getElementById('ws-day-of-week')?.value;
                    const amStart = document.getElementById('ws-am-start')?.value;
                    const amEnd = document.getElementById('ws-am-end')?.value;
                    const pmStart = document.getElementById('ws-pm-start')?.value;
                    const pmEnd = document.getElementById('ws-pm-end')?.value;

                    // Only show panel once user starts filling fields
                    if (!countDate && !dayOfWeek) { panel.classList.remove('visible'); setBadge('badge-tmc-info', 'incomplete'); return; }

                    let html = '';
                    let allPass = true;
                    let hasWarning = false;

                    // Count date provided
                    html += valItem(!!countDate, 'Count date selected', countDate || 'Required');
                    if (!countDate) allPass = false;

                    // Day of week selected
                    html += valItem(!!dayOfWeek, 'Day of week selected', dayOfWeek ? dayOfWeek.charAt(0).toUpperCase() + dayOfWeek.slice(1) : 'Required');
                    if (!dayOfWeek) allPass = false;

                    // Preferred day check (Tue/Wed/Thu)
                    if (dayOfWeek) {
                        const preferred = ['tuesday','wednesday','thursday'].includes(dayOfWeek);
                        if (!preferred) {
                            html += valItem(null, 'Non-standard count day', 'Tue-Thu preferred per ADOT guidelines');
                            hasWarning = true;
                        } else {
                            html += valItem(true, 'Standard count day (Tue-Thu)', 'ADOT compliant');
                        }
                    }

                    // Date matches day-of-week
                    if (countDate && dayOfWeek) {
                        const d = new Date(countDate + 'T12:00:00');
                        const days = ['sunday','monday','tuesday','wednesday','thursday','friday','saturday'];
                        const actualDay = days[d.getDay()];
                        const match = actualDay === dayOfWeek;
                        html += valItem(match, 'Date matches day of week', match ? actualDay : 'Date is ' + actualDay + ', selected ' + dayOfWeek);
                        if (!match) { allPass = false; }
                    }

                    // AM window check
                    if (amStart && amEnd) {
                        const amOk = amStart <= '07:00' && amEnd >= '09:00';
                        html += valItem(amOk ? true : null, 'AM window covers peak (7:00-9:00)', amStart + ' - ' + amEnd);
                        if (!amOk) hasWarning = true;
                    }

                    // PM window check
                    if (pmStart && pmEnd) {
                        const pmOk = pmStart <= '16:00' && pmEnd >= '18:00';
                        html += valItem(pmOk ? true : null, 'PM window covers peak (4:00-6:00)', pmStart + ' - ' + pmEnd);
                        if (!pmOk) hasWarning = true;
                    }

                    items.innerHTML = html;
                    panel.classList.add('visible');
                    setBadge('badge-tmc-info', allPass ? (hasWarning ? 'warning' : 'valid') : 'warning');
                }

                // Bind live validation to TMC info fields
                ['ws-count-date','ws-day-of-week','ws-am-start','ws-am-end','ws-pm-start','ws-pm-end'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.addEventListener('change', validateTmcInfo);
                });

                // Auto-fill day-of-week from date
                const countDateEl = document.getElementById('ws-count-date');
                const dayOfWeekEl = document.getElementById('ws-day-of-week');
                if (countDateEl && dayOfWeekEl) {
                    countDateEl.addEventListener('change', () => {
                        if (countDateEl.value) {
                            const d = new Date(countDateEl.value + 'T12:00:00');
                            const days = ['','monday','tuesday','wednesday','thursday','friday',''];
                            const day = days[d.getDay()] || '';
                            if (day) { dayOfWeekEl.value = day; }
                        }
                    });
                }

                // --- TMC SPREADSHEET: upload + validate file ---
                const tmcDropZone = document.getElementById('ws-drop-zone-tmc');
                const tmcFileInfo = document.getElementById('ws-tmc-file-info');
                const parseTmcBtn = document.getElementById('ws-parse-tmc-btn');
                let tmcFileRef = null;

                function validateTmcFile(file) {
                    tmcFileRef = file;
                    const ext = file.name.split('.').pop().toLowerCase();
                    const sizeKB = file.size / 1024;
                    const sizeMB = sizeKB / 1024;

                    // Show file info
                    tmcFileInfo.innerHTML = '<div style="display:flex;align-items:center;gap:8px;padding:10px 14px;background:var(--bg-base);border:1px solid var(--success);border-radius:6px;font-size:13px;color:var(--text-light);"> ' + file.name + '<span style="ws-val-detail" style="color:var(--text-muted);font-size:11px;margin-left:auto;">' + (sizeKB < 1024 ? sizeKB.toFixed(1) + ' KB' : sizeMB.toFixed(2) + ' MB') + '</span></div>';

                    // Validate
                    const panel = document.getElementById('val-tmc-upload');
                    const items = document.getElementById('val-tmc-upload-items');
                    let html = '';
                    let allPass = true;

                    // File type
                    const validExt = ['xlsx','csv','xls'].includes(ext);
                    html += valItem(validExt, 'Valid file format', '.' + ext);
                    if (!validExt) allPass = false;

                    // File size
                    const sizeOk = file.size > 1024 && file.size < 52428800;
                    html += valItem(sizeOk, 'File size acceptable', sizeKB < 1024 ? sizeKB.toFixed(0) + ' KB' : sizeMB.toFixed(1) + ' MB');
                    if (!sizeOk) { allPass = false; html += valItem(false, file.size <= 1024 ? 'File too small  may be empty' : 'File too large (>50MB)', 'Check file'); }

                    // Filename check  should contain TMC or turning or count
                    const nameHint = /tmc|turning|count|movement/i.test(file.name);
                    html += valItem(nameHint ? true : null, 'Filename suggests TMC data', nameHint ? 'Detected' : 'No TMC keywords found  verify correct file');

                    // CSV-specific: try to read headers
                    if (ext === 'csv') {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            const firstLine = e.target.result.split('\n')[0];
                            const cols = firstLine.split(',').map(c => c.trim().replace(/"/g,''));
                            const rowCount = e.target.result.split('\n').filter(r => r.trim()).length - 1;

                            let csvHtml = '';
                            csvHtml += valItem(true, 'CSV readable', cols.length + ' columns, ' + rowCount + ' data rows');

                            // Check for expected TMC columns
                            const expectedCols = ['intersection','northbound','southbound','eastbound','westbound','left','through','right','time','period','am','pm'];
                            const foundCols = cols.filter(c => expectedCols.some(ec => c.toLowerCase().includes(ec)));
                            csvHtml += valItem(foundCols.length >= 2, 'TMC column headers detected', foundCols.length + ' of expected columns found');
                            if (foundCols.length < 2) {
                                csvHtml += valItem(null, 'Expected columns: Intersection, NB/SB/EB/WB, Left/Through/Right, Time/Period', 'Review spreadsheet format');
                            }

                            // Row count check
                            csvHtml += valItem(rowCount >= 4, 'Sufficient data rows', rowCount + ' rows');
                            if (rowCount < 4) csvHtml += valItem(false, 'Too few rows  TMC data typically has 12+ rows per intersection', 'Check data completeness');

                            items.innerHTML += csvHtml;
                        };
                        reader.readAsText(file.slice(0, 8192)); // Read first 8KB for headers
                    }

                    items.innerHTML = html;
                    panel.classList.add('visible');
                    parseTmcBtn.style.display = 'block';
                    setBadge('badge-tmc-upload', allPass ? 'valid' : 'warning');
                }

                if (tmcDropZone) {
                    tmcDropZone.addEventListener('click', () => {
                        const input = document.createElement('input');
                        input.type = 'file';
                        input.accept = '.xlsx,.csv,.xls';
                        input.onchange = () => { if (input.files.length) validateTmcFile(input.files[0]); };
                        input.click();
                    });
                    tmcDropZone.addEventListener('dragover', (e) => { e.preventDefault(); tmcDropZone.classList.add('dragover'); });
                    tmcDropZone.addEventListener('dragleave', () => { tmcDropZone.classList.remove('dragover'); });
                    tmcDropZone.addEventListener('drop', (e) => {
                        e.preventDefault();
                        tmcDropZone.classList.remove('dragover');
                        if (e.dataTransfer.files.length) validateTmcFile(e.dataTransfer.files[0]);
                    });
                }

                // Parse TMC button  deeper analysis
                if (parseTmcBtn) {
                    parseTmcBtn.addEventListener('click', () => {
                        parseTmcBtn.textContent = 'Parsing...';
                        parseTmcBtn.style.opacity = '0.7';

                        const parsedPanel = document.getElementById('val-tmc-parsed');
                        const parsedItems = document.getElementById('val-tmc-parsed-items');

                        setTimeout(() => {
                            let html = '';

                            if (tmcFileRef && tmcFileRef.name.endsWith('.csv')) {
                                const reader = new FileReader();
                                reader.onload = function(e) {
                                    const lines = e.target.result.split('\n').filter(r => r.trim());
                                    const headers = lines[0].split(',').map(c => c.trim().replace(/"/g,''));
                                    const dataRows = lines.length - 1;

                                    html += valItem(true, 'File parsed successfully', dataRows + ' records');
                                    html += valItem(true, 'Columns: ' + headers.slice(0,5).join(', ') + (headers.length > 5 ? '...' : ''), headers.length + ' total');

                                    // Check for zero/empty values
                                    let emptyCount = 0;
                                    for (let i = 1; i < Math.min(lines.length, 20); i++) {
                                        const vals = lines[i].split(',');
                                        vals.forEach(v => { if (!v.trim() || v.trim() === '0') emptyCount++; });
                                    }
                                    const emptyPct = ((emptyCount / (Math.min(dataRows, 19) * headers.length)) * 100).toFixed(0);
                                    html += valItem(emptyPct < 30, 'Data completeness', (100 - emptyPct) + '% cells populated');
                                    if (emptyPct >= 30) html += valItem(null, 'High percentage of empty/zero values', 'Review for missing count data');

                                    html += valItem(true, 'Ready for analysis', 'Proceed to Step 3: Trip Generation');

                                    parsedItems.innerHTML = html;
                                    parsedPanel.classList.add('visible');
                                };
                                reader.readAsText(tmcFileRef);
                            } else {
                                // XLSX  can't parse in browser without library, show guidance
                                html += valItem(true, 'XLSX file accepted', tmcFileRef ? tmcFileRef.name : '');
                                html += valItem(null, 'Full column analysis requires CSV format', 'Convert to CSV for detailed validation');
                                html += valItem(true, 'File staged for processing', 'Will be parsed during Step 3');
                                parsedItems.innerHTML = html;
                                parsedPanel.classList.add('visible');
                            }

                            parseTmcBtn.textContent = ' TMC Data Parsed';
                            parseTmcBtn.style.background = 'var(--success)';
                            parseTmcBtn.style.opacity = '1';
                            this.markFolderItem('folder-tmc-counts');
                        }, 800);
                    });
                }

                // --- INTERSECTION PHOTOS: upload + validate ---
                const photosDropZone = document.getElementById('ws-drop-zone-photos');
                const photosInfo = document.getElementById('ws-photos-info');

                function validatePhotos(files) {
                    const validExts = ['jpg','jpeg','png','heic','heif','webp'];
                    const fileArr = Array.from(files);

                    // Show file list
                    photosInfo.innerHTML = fileArr.map(f =>
                        '<div style="display:flex;align-items:center;gap:8px;padding:8px 12px;background:var(--bg-base);border:1px solid var(--blue);border-radius:6px;margin-bottom:6px;font-size:13px;color:var(--text-light);"> ' + f.name + '<span style="color:var(--text-muted);font-size:11px;margin-left:auto;">' + (f.size / 1024).toFixed(1) + ' KB</span></div>'
                    ).join('');

                    // Validate
                    const panel = document.getElementById('val-photos');
                    const items = document.getElementById('val-photos-items');
                    let html = '';
                    let allPass = true;

                    // File count
                    html += valItem(fileArr.length >= 1, 'Photos uploaded', fileArr.length + ' file(s)');

                    // Check each file type
                    const invalidFiles = fileArr.filter(f => !validExts.includes(f.name.split('.').pop().toLowerCase()));
                    if (invalidFiles.length > 0) {
                        html += valItem(false, 'Invalid file type(s)', invalidFiles.map(f => f.name).join(', '));
                        allPass = false;
                    } else {
                        html += valItem(true, 'All files are valid image formats', validExts.slice(0,4).join(', '));
                    }

                    // Size check  flag very small (<10KB, probably thumbnail) or very large (>20MB)
                    const tooSmall = fileArr.filter(f => f.size < 10240);
                    const tooLarge = fileArr.filter(f => f.size > 20971520);
                    if (tooSmall.length) {
                        html += valItem(null, tooSmall.length + ' file(s) under 10KB', 'May be thumbnails  verify image quality');
                    }
                    if (tooLarge.length) {
                        html += valItem(null, tooLarge.length + ' file(s) over 20MB', 'Consider compressing before submission');
                    }
                    if (!tooSmall.length && !tooLarge.length) {
                        html += valItem(true, 'File sizes within normal range', '');
                    }

                    // Check against Step 1 project data for intersection count
                    const projectData = localStorage.getItem('tfe_active_project');
                    if (projectData) {
                        try {
                            const proj = JSON.parse(projectData);
                            const buildingCount = proj.buildings ? proj.buildings.length : 0;
                            const expectedPhotos = Math.max(buildingCount, 1);
                            html += valItem(fileArr.length >= expectedPhotos, 'Coverage check', fileArr.length + ' photos for ' + expectedPhotos + ' site location(s)');
                            if (fileArr.length < expectedPhotos) {
                                html += valItem(null, 'Recommend at least 1 photo per intersection/access point', 'Add more photos for complete documentation');
                            }
                        } catch(e) {}
                    }

                    items.innerHTML = html;
                    panel.classList.add('visible');
                    setBadge('badge-photos', allPass ? 'valid' : 'warning');
                }

                if (photosDropZone) {
                    photosDropZone.addEventListener('click', () => {
                        const input = document.createElement('input');
                        input.type = 'file';
                        input.accept = '.jpg,.jpeg,.png,.heic,.heif,.webp';
                        input.multiple = true;
                        input.onchange = () => { if (input.files.length) validatePhotos(input.files); };
                        input.click();
                    });
                    photosDropZone.addEventListener('dragover', (e) => { e.preventDefault(); photosDropZone.classList.add('dragover'); });
                    photosDropZone.addEventListener('dragleave', () => { photosDropZone.classList.remove('dragover'); });
                    photosDropZone.addEventListener('drop', (e) => {
                        e.preventDefault();
                        photosDropZone.classList.remove('dragover');
                        if (e.dataTransfer.files.length) validatePhotos(e.dataTransfer.files);
                    });
                }

                // --- STEP 2 SUBMIT: final validation gate ---
                const submitStep2 = document.getElementById('ws-submit-step2');
                if (submitStep2) {
                    submitStep2.addEventListener('click', () => {
                        // Run TMC info validation to make sure panel is showing
                        validateTmcInfo();

                        // Check if minimum requirements are met
                        const countDate = document.getElementById('ws-count-date')?.value;
                        const dayOfWeek = document.getElementById('ws-day-of-week')?.value;
                        if (!countDate || !dayOfWeek) {
                            submitStep2.textContent = 'Fill Required Fields Above';
                            submitStep2.style.background = '#ef4444';
                            setTimeout(() => { submitStep2.textContent = 'Submit Data Collection'; submitStep2.style.background = 'var(--gold)'; }, 2000);
                            return;
                        }

                        this.markStepComplete(2);
                        if (tmcFileInfo.innerHTML) this.markFolderItem('folder-tmc-counts');
                        if (photosInfo.innerHTML) this.markFolderItem('folder-intersections');

                        const step2Data = {
                            countDate,
                            dayOfWeek,
                            amStart: document.getElementById('ws-am-start')?.value,
                            amEnd: document.getElementById('ws-am-end')?.value,
                            pmStart: document.getElementById('ws-pm-start')?.value,
                            pmEnd: document.getElementById('ws-pm-end')?.value,
                            tmcUploaded: !!tmcFileInfo.innerHTML,
                            photosUploaded: !!photosInfo.innerHTML
                        };
                        localStorage.setItem('tfe_step2_data', JSON.stringify(step2Data));

                        submitStep2.textContent = ' Data Collection Saved';
                        submitStep2.style.background = 'var(--success)';
                        setTimeout(() => { submitStep2.textContent = 'Submit Data Collection'; submitStep2.style.background = 'var(--gold)'; }, 2000);
                    });
                }

                // Workspace: Submit button  Step 1
                const submitBtn = document.getElementById('ws-submit-step1');
                if (submitBtn) {
                    submitBtn.addEventListener('click', () => {
                        const name = document.getElementById('ws-project-name').value.trim();
                        if (!name) {
                            alert('Please enter a Project Name.');
                            return;
                        }

                        // Gather project data
                        const projectData = {
                            name: name,
                            number: document.getElementById('ws-project-number').value.trim(),
                            address: document.getElementById('ws-site-address').value.trim(),
                            jurisdiction: document.getElementById('ws-jurisdiction').selectedOptions[0]?.text || '',
                            openingYear: document.getElementById('ws-opening-year').value,
                            horizonYear: document.getElementById('ws-horizon-year').value,
                            growthRate: document.getElementById('ws-growth-rate').value,
                            buildings: [],
                            stepsCompleted: { 1: true },
                            folderItems: { 'folder-project-info': true }
                        };

                        // Gather buildings
                        document.querySelectorAll('#buildings-tbody tr').forEach(row => {
                            const inputs = row.querySelectorAll('input');
                            if (inputs[0] && inputs[0].value.trim()) {
                                projectData.buildings.push({
                                    name: inputs[0].value.trim(),
                                    sqft: inputs[1]?.value || '',
                                    luc: inputs[2]?.value || '',
                                    driveThru: inputs[3]?.checked || false
                                });
                            }
                        });

                        // Save to localStorage
                        localStorage.setItem('tfe_active_project', JSON.stringify(projectData));

                        // Show summary card
                        this.renderProjectSummary(projectData);
                        this.renderFolderTracker(projectData);

                        submitBtn.textContent = ' Project Setup Saved';
                        submitBtn.style.background = 'var(--success)';
                        setTimeout(() => {
                            submitBtn.textContent = 'Submit Project Setup';
                            submitBtn.style.background = 'var(--gold)';
                        }, 2000);
                    });
                }
            },

            loadProjects() {
                // Load projects from localStorage
                const saved = localStorage.getItem('tse_projects');
                if (saved) {
                    this.projects = JSON.parse(saved);
                    this.populateProjectSelect();
                }
            },

            saveProjects() {
                localStorage.setItem('tse_projects', JSON.stringify(this.projects));
            },

            populateProjectSelect() {
                const select = document.getElementById('project-select');
                select.innerHTML = '<option value="">-- Select Project --</option>';
                this.projects.forEach((proj, idx) => {
                    const opt = document.createElement('option');
                    opt.value = idx;
                    opt.textContent = proj.name;
                    select.appendChild(opt);
                });
            },

            openModal() {
                document.getElementById('new-project-modal').classList.add('visible');
            },

            closeModal() {
                document.getElementById('new-project-modal').classList.remove('visible');
                // Clear form
                document.getElementById('project-name').value = '';
                document.getElementById('client-name').value = '';
                document.getElementById('jurisdiction').value = '';
                document.getElementById('study-type').value = 'tia';
            },

            async createProject() {
                const name = document.getElementById('project-name').value.trim();
                const client = document.getElementById('client-name').value.trim();
                const jurisdiction = document.getElementById('jurisdiction').value;
                const studyType = document.getElementById('study-type').value;

                if (!name) {
                    showNotification('Please enter a project name', 'warning');
                    return;
                }

                const project = {
                    name,
                    client,
                    jurisdiction,
                    studyType,
                    step: 1,
                    checklist: {},
                    created: new Date().toISOString()
                };

                // Add to projects list
                this.projects.push(project);
                this.saveProjects();
                this.populateProjectSelect();

                // Select the new project
                const select = document.getElementById('project-select');
                select.value = this.projects.length - 1;
                this.selectProject(this.projects.length - 1);

                this.closeModal();
                showNotification('Project created: ' + name, 'success');

                // Try to create folder structure if Tauri is available
                const invoke = getInvoke();
                if (invoke) {
                    const basePath = 'G:\\My Drive\\00 - Trajanus USA\\Traffic\\' + name;
                    try {
                        // Use write_file to create a placeholder - it auto-creates parent dirs
                        await invoke('write_file', {
                            path: basePath + '\\Traffic Counts\\.gitkeep',
                            content: ''
                        });
                        await invoke('write_file', {
                            path: basePath + '\\SYNCHRO Outputs\\Background\\.gitkeep',
                            content: ''
                        });
                        await invoke('write_file', {
                            path: basePath + '\\SYNCHRO Outputs\\Background Grown\\.gitkeep',
                            content: ''
                        });
                        await invoke('write_file', {
                            path: basePath + '\\SYNCHRO Outputs\\Background + Site\\.gitkeep',
                            content: ''
                        });
                        await invoke('write_file', {
                            path: basePath + '\\Deliverable\\.gitkeep',
                            content: ''
                        });
                        Terminal.success('Created folder structure at: ' + basePath);
                    } catch (e) {
                        Terminal.warning('Could not create folders: ' + e);
                    }
                }

                // Advance to step 2
                this.advanceStep();
            },

            selectProject(index) {
                if (index === '' || index === null) {
                    this.currentProject = null;
                    this.currentStep = 1;
                } else {
                    this.currentProject = this.projects[index];
                    this.currentStep = this.currentProject.step || 1;
                    this.restoreChecklist();
                }
                this.updateStepDisplay();
            },

            goToStep(step) {
                if (step < 1 || step > 10) return;

                // Toggle workspace: if clicking the already-active step, close panel
                const workspace = document.getElementById('workflow-workspace');
                if (step === this.currentStep && workspace.classList.contains('open')) {
                    workspace.classList.remove('open');
                    return;
                }

                this.currentStep = step;
                if (this.currentProject) {
                    this.currentProject.step = step;
                    this.saveProjects();
                }
                this.updateStepDisplay();

                // Show workspace panel for the step (if one exists)
                const allPanels = workspace.querySelectorAll('.workspace-panel');
                allPanels.forEach(p => p.classList.remove('active'));
                const targetPanel = document.getElementById('ws-panel-' + step);
                if (targetPanel) {
                    targetPanel.classList.add('active');
                    workspace.classList.add('open');
                } else {
                    workspace.classList.remove('open');
                }
            },

            advanceStep() {
                if (this.currentStep < 10) {
                    this.goToStep(this.currentStep + 1);
                }
            },

            updateStepDisplay() {
                // Update progress text
                document.getElementById('workflow-progress').textContent = 'Step ' + this.currentStep + ' of 10';

                // Update step indicators  based on actual completion, not position
                const saved = localStorage.getItem('tfe_active_project');
                const completedSteps = saved ? (JSON.parse(saved).stepsCompleted || {}) : {};

                document.querySelectorAll('.workflow-step').forEach(step => {
                    const stepNum = parseInt(step.dataset.step);
                    step.classList.remove('active', 'completed');
                    if (stepNum === this.currentStep) {
                        step.classList.add('active');
                    }
                    if (completedSteps[stepNum]) {
                        step.classList.add('completed');
                    }
                });

                // Update instructions
                const instructions = this.stepInstructions[this.currentStep];
                document.getElementById('step-title').textContent = instructions.title;
                document.getElementById('step-content').innerHTML = instructions.content;

                // Update step tools
                this.updateStepTools();

                // Send assistant message about current step
                if (this.currentProject) {
                    this.assistantGuide();
                }
            },

            updateStepTools() {
                const toolsGrid = document.getElementById('step-tools-grid');
                const tools = this.stepTools[this.currentStep] || [];

                if (tools.length === 0) {
                    toolsGrid.innerHTML = '<span style="color:var(--text-muted);">No tools needed for this step</span>';
                    return;
                }

                toolsGrid.innerHTML = tools.map(tool => `
                    <button class="step-tool-btn" data-action="${tool.action}">
                        <span class="step-tool-icon">${tool.icon}</span>
                        <span>${tool.label}</span>
                    </button>
                `).join('');

                // Bind click events
                toolsGrid.querySelectorAll('.step-tool-btn').forEach(btn => {
                    btn.addEventListener('click', () => this.executeTool(btn.dataset.action));
                });
            },

            async executeTool(action) {
                const invoke = getInvoke();

                switch(action) {
                    case 'openExplorer':
                    case 'openProjectFolder':
                        await this.openProjectFolder();
                        break;
                    case 'openSynchroFolder':
                        await this.openFolder('SYNCHRO Outputs');
                        break;
                    case 'openDeliverableFolder':
                        await this.openFolder('Deliverable');
                        break;
                    case 'launchSynchro':
                        Apps.launch('synchro');
                        break;
                    case 'launchExcel':
                        Apps.launch('excel');
                        break;
                    case 'launchWord':
                        Apps.launch('word');
                        break;
                    case 'launchAcrobat':
                        Apps.launch('acrobat');
                        break;
                    case 'runTripGen':
                        Scripts.run('trip-gen');
                        break;
                    case 'runTiaTemplate':
                        Scripts.run('tia-template');
                        break;
                    default:
                        showNotification('Tool action not found: ' + action, 'warning');
                }
            },

            async openProjectFolder() {
                if (!this.currentProject) {
                    showNotification('Please select or create a project first', 'warning');
                    return;
                }

                const basePath = 'G:\\My Drive\\00 - Trajanus USA\\Traffic\\' + this.currentProject.name;
                const invoke = getInvoke();

                if (invoke) {
                    try {
                        await invoke('open_path', { path: basePath });
                        Terminal.success('Opened project folder: ' + basePath);
                        showNotification('Opened project folder', 'success');
                    } catch (e) {
                        Terminal.error('Could not open folder: ' + e);
                        showNotification('Could not open folder', 'warning');
                    }
                } else {
                    showNotification('Folder: ' + basePath, 'info');
                }
            },

            async openFolder(subfolder) {
                if (!this.currentProject) {
                    showNotification('Please select or create a project first', 'warning');
                    return;
                }

                const basePath = 'G:\\My Drive\\00 - Trajanus USA\\Traffic\\' + this.currentProject.name + '\\' + subfolder;
                const invoke = getInvoke();

                if (invoke) {
                    try {
                        await invoke('open_path', { path: basePath });
                        Terminal.success('Opened folder: ' + basePath);
                        showNotification('Opened ' + subfolder, 'success');
                    } catch (e) {
                        Terminal.error('Could not open folder: ' + e);
                    }
                } else {
                    showNotification('Folder: ' + basePath, 'info');
                }
            },

            assistantGuide() {
                const stepMessages = {
                    1: 'Project setup complete. Click "+ New Project" to create your TIA project folder structure.',
                    2: 'Time to gather input documents. Click "Open Project Folder" to add your Site Plan, ITE Trip Generation worksheet, and traffic counts to the project folder.',
                    3: 'Now build your Synchro models. Click "Synchro 12" to start. Create Background, Background+Growth, and Background+Site scenarios.',
                    4: 'Run your analysis. Generate LOS tables and export capacity reports from Synchro. Save outputs to the Deliverable folder.',
                    5: 'Write your TIA report. Click "TIA Template" to start with the standard template. Reference your analysis outputs.',
                    6: 'Finalize the deliverable. Create exhibits, compile appendix, and export final PDF. All files go in the Deliverable folder.'
                };

                const msg = stepMessages[this.currentStep];
                if (msg) {
                    Chat.addMessage('assistant', msg);
                }
            },

            toggleDocsPanel() {
                const body = document.getElementById('docs-panel-body');
                const toggle = document.getElementById('docs-toggle');
                if (body.classList.contains('collapsed')) {
                    body.classList.remove('collapsed');
                    toggle.innerHTML = '&#9660; Collapse';
                } else {
                    body.classList.add('collapsed');
                    toggle.innerHTML = '&#9658; Expand';
                }
            },

            toggleDocItem(checkbox) {
                const item = checkbox.closest('.doc-item');
                if (checkbox.checked) {
                    item.classList.add('checked');
                } else {
                    item.classList.remove('checked');
                }

                // Save to project
                if (this.currentProject) {
                    this.currentProject.checklist[checkbox.id] = checkbox.checked;
                    this.saveProjects();
                }
            },

            restoreChecklist() {
                if (!this.currentProject || !this.currentProject.checklist) return;

                document.querySelectorAll('.doc-checkbox').forEach(cb => {
                    cb.checked = this.currentProject.checklist[cb.id] || false;
                    const item = cb.closest('.doc-item');
                    if (cb.checked) {
                        item.classList.add('checked');
                    } else {
                        item.classList.remove('checked');
                    }
                });
            }
        };

        // ==================== EVENT LISTENERS (CSP COMPLIANT) ====================
        document.addEventListener('DOMContentLoaded', () => {
            // App launchers
            document.querySelectorAll('[data-launch]').forEach(el => {
                el.addEventListener('click', () => Apps.launch(el.dataset.launch));
            });

            // Script cards
            document.querySelectorAll('[data-script]').forEach(el => {
                el.addEventListener('click', () => Scripts.run(el.dataset.script));
            });

            // Document cards
            document.querySelectorAll('[data-doc]').forEach(el => {
                el.addEventListener('click', () => Documents.open(el.dataset.doc));
            });

            // Agent buttons
            document.querySelectorAll('[data-agent]').forEach(el => {
                el.addEventListener('click', () => Agents.activate(el.dataset.agent));
            });

            // Agent Runner and Chat UI removed during TFE restructure
            // Their event bindings are no longer needed

            // Initialize TSE Workflow
            TseWorkflow.init();

            console.log('Traffic Studies workspace initialized with TSE workflow');

            // ==================== CHECKLIST PERSISTENCE ====================
            // Load saved checklist state
            const savedChecklist = localStorage.getItem('traffic-checklist-state');
            if (savedChecklist) {
                try {
                    const state = JSON.parse(savedChecklist);
                    document.querySelectorAll('.checklist-item').forEach(item => {
                        const task = item.dataset.task;
                        if (task && state.hasOwnProperty(task)) {
                            if (state[task]) {
                                item.classList.add('completed');
                            } else {
                                item.classList.remove('completed');
                            }
                        }
                    });
                } catch (e) {
                    console.error('Error loading checklist state:', e);
                }
            }

            // Update checklist count display
            function updateChecklistCount() {
                const items = document.querySelectorAll('.checklist-item');
                const completed = document.querySelectorAll('.checklist-item.completed').length;
                const countEl = document.getElementById('checklist-count');
                if (countEl) {
                    countEl.textContent = `${completed}/${items.length}`;
                }
            }
            updateChecklistCount();

            // Save checklist state to localStorage
            function saveChecklistState() {
                const state = {};
                document.querySelectorAll('.checklist-item').forEach(item => {
                    const task = item.dataset.task;
                    if (task) {
                        state[task] = item.classList.contains('completed');
                    }
                });
                localStorage.setItem('traffic-checklist-state', JSON.stringify(state));
            }

            // Add click handlers with persistence
            document.querySelectorAll('.checklist-item').forEach(item => {
                item.addEventListener('click', () => {
                    item.classList.toggle('completed');
                    updateChecklistCount();
                    saveChecklistState();
                });
            });
        });
    </script>

    <!-- KB Browser Component -->
    <script src="../js/kb-browser.js"></script>
    <script>
        // Initialize KB Browser for Traffic platform
        document.addEventListener('DOMContentLoaded', () => {
            kbBrowsers['traffic'] = new KBBrowserComponent('kb-browser-traffic', {
                platformName: 'traffic',
                sectionTitle: 'REFERENCE MATERIALS',
                officeTabLabel: 'Office Videos',
                claudeTabLabel: 'Claude Tutorials'
            });
        });
    </script>

    <!-- Jurisdiction Browser Component -->
    <script>
        // Jurisdiction Browser for TSE Workspace
        const JurisdictionBrowser = {
            data: null,
            selectedId: null,

            async init() {
                try {
                    const response = await fetch('../data/jurisdiction-templates.json');
                    this.data = await response.json();
                    this.renderList();
                    this.bindEvents();
                    console.log('[TSE] Jurisdiction Browser initialized with', this.data.jurisdictions.length, 'jurisdictions');
                } catch (error) {
                    console.error('[TSE] Failed to load jurisdiction templates:', error);
                    document.getElementById('jurisdiction-items').innerHTML =
                        '<div class="jurisdiction-error">Failed to load jurisdictions</div>';
                }
            },

            renderList() {
                const container = document.getElementById('jurisdiction-items');
                if (!this.data || !this.data.jurisdictions) return;

                container.innerHTML = this.data.jurisdictions.map(j => `
                    <div class="jurisdiction-item" data-id="${j.id}">
                        <span class="jurisdiction-icon">${this.getIcon(j.type)}</span>
                        <div class="jurisdiction-item-info">
                            <div class="jurisdiction-item-name">${j.name}</div>
                            <div class="jurisdiction-item-meta">${j.type}  Pop. ${this.formatPopulation(j.population)}</div>
                        </div>
                    </div>
                `).join('');
            },

            getIcon(type) {
                const icons = {
                    'city': '',
                    'town': '',
                    'municipality': ''
                };
                return icons[type?.toLowerCase()] || '';
            },

            formatPopulation(pop) {
                if (pop >= 1000000) return (pop / 1000000).toFixed(1) + 'M';
                if (pop >= 1000) return (pop / 1000).toFixed(0) + 'K';
                return pop.toString();
            },

            bindEvents() {
                // Search filter
                document.getElementById('jurisdiction-search').addEventListener('input', (e) => {
                    const query = e.target.value.toLowerCase();
                    document.querySelectorAll('.jurisdiction-item').forEach(item => {
                        const name = item.querySelector('.jurisdiction-item-name').textContent.toLowerCase();
                        item.style.display = name.includes(query) ? 'flex' : 'none';
                    });
                });

                // Item selection
                document.getElementById('jurisdiction-items').addEventListener('click', (e) => {
                    const item = e.target.closest('.jurisdiction-item');
                    if (item) {
                        document.querySelectorAll('.jurisdiction-item').forEach(i => i.classList.remove('active'));
                        item.classList.add('active');
                        this.selectedId = item.dataset.id;
                        this.renderDetail(this.selectedId);
                    }
                });
            },

            renderDetail(id) {
                const j = this.data.jurisdictions.find(j => j.id === id);
                if (!j) return;

                const container = document.getElementById('jurisdiction-detail');
                container.innerHTML = `
                    <div class="jurisdiction-header">
                        <h2>${j.name}</h2>
                        <span class="jurisdiction-type">${j.type}  ${j.county} County</span>
                    </div>

                    <div class="jurisdiction-section">
                        <h3> TIS Requirements</h3>
                        ${this.renderRequirements(j.requirements)}
                    </div>

                    <div class="jurisdiction-section">
                        <h3> Contacts</h3>
                        ${this.renderContacts(j.contacts)}
                    </div>

                    <div class="jurisdiction-section">
                        <h3> Submittal Procedure</h3>
                        ${this.renderProcedure(j.submittalProcedure)}
                    </div>

                    <div class="jurisdiction-section">
                        <h3> Approval Process</h3>
                        ${this.renderApproval(j.approvalProcess)}
                    </div>

                    <div class="jurisdiction-section">
                        <h3> Common Issues</h3>
                        ${this.renderIssues(j.commonIssues)}
                    </div>
                `;
            },

            renderRequirements(req) {
                const software = Array.isArray(req.softwareApproved) ? req.softwareApproved.join(', ') : (req.softwareApproved || 'N/A');
                const additional = req.additionalRequirements ?
                    `<div class="jurisdiction-field"><span class="field-label">Additional:</span><ul style="margin: 4px 0 0 20px; padding: 0;">${req.additionalRequirements.map(r => `<li>${r}</li>`).join('')}</ul></div>` : '';
                return `
                    <div class="jurisdiction-field"><span class="field-label">Study Threshold:</span> ${req.trafficStudyThreshold || 'N/A'}</div>
                    <div class="jurisdiction-field"><span class="field-label">LOS Standard:</span> ${req.levelOfService || 'N/A'}</div>
                    <div class="jurisdiction-field"><span class="field-label">Approved Software:</span> ${software}</div>
                    <div class="jurisdiction-field"><span class="field-label">Trip Generation:</span> ${req.tripGeneration || 'ITE Manual'}</div>
                    <div class="jurisdiction-field"><span class="field-label">Study Area:</span> ${req.studyArea || 'N/A'}</div>
                    <div class="jurisdiction-field"><span class="field-label">Horizon Year:</span> ${req.horizonYear || 'N/A'}</div>
                    <div class="jurisdiction-field"><span class="field-label">Peak Hours:</span> ${req.peakHours || 'N/A'}</div>
                    ${additional}
                `;
            },

            renderContacts(contacts) {
                return `
                    <div class="jurisdiction-contact-card">
                        <div class="contact-title">${contacts.department || 'Traffic Engineering'}</div>
                        <div class="contact-field">${contacts.trafficEngineering?.name || ''}</div>
                        <div class="contact-field"> ${contacts.trafficEngineering?.phone || 'N/A'}</div>
                        <div class="contact-field"> ${contacts.trafficEngineering?.email || 'N/A'}</div>
                        ${contacts.trafficEngineering?.address ? `<div class="contact-field"> ${contacts.trafficEngineering.address}</div>` : ''}
                    </div>
                    <div class="jurisdiction-contact-card">
                        <div class="contact-title">Plan Review / Development Services</div>
                        <div class="contact-field">${contacts.planReview?.name || ''}</div>
                        <div class="contact-field"> ${contacts.planReview?.phone || 'N/A'}</div>
                        <div class="contact-field"> ${contacts.planReview?.email || 'N/A'}</div>
                        ${contacts.planReview?.website ? `<div class="contact-field"> <a href="${contacts.planReview.website}" target="_blank">${contacts.planReview.website}</a></div>` : ''}
                    </div>
                `;
            },

            renderProcedure(proc) {
                return `
                    <div class="jurisdiction-field"><span class="field-label">Format:</span> ${proc.format || 'PDF'}</div>
                    <div class="jurisdiction-field"><span class="field-label">Copies:</span> ${proc.copies || 'N/A'}</div>
                    <div class="jurisdiction-field"><span class="field-label">Review Time:</span> ${proc.reviewTime || 'N/A'}</div>
                    <div class="jurisdiction-field"><span class="field-label">Resubmittal:</span> ${proc.resubmittalTime || 'N/A'}</div>
                    <div class="jurisdiction-field"><span class="field-label">Fee:</span> ${proc.fees || 'Contact for estimate'}</div>
                    ${proc.preSubmittalMeeting ? `<div class="jurisdiction-field"><span class="field-label">Pre-submittal:</span> ${proc.preSubmittalMeeting}</div>` : ''}
                    ${proc.steps && proc.steps.length ? `
                    <div class="jurisdiction-steps">
                        <div class="steps-title">Submittal Steps:</div>
                        <ol>
                            ${proc.steps.map(step => `<li>${step.replace(/^\d+\.\s*/, '')}</li>`).join('')}
                        </ol>
                    </div>` : ''}
                `;
            },

            renderApproval(approval) {
                const conditions = approval.conditionsCommon ?
                    `<div class="jurisdiction-field"><span class="field-label">Common Conditions:</span><ul style="margin: 4px 0 0 20px; padding: 0;">${approval.conditionsCommon.map(c => `<li>${c}</li>`).join('')}</ul></div>` : '';
                return `
                    <div class="jurisdiction-field"><span class="field-label">Review Authority:</span> ${approval.reviewAuthority || 'N/A'}</div>
                    <div class="jurisdiction-field"><span class="field-label">Appeal Process:</span> ${approval.appealProcess || 'N/A'}</div>
                    <div class="jurisdiction-field"><span class="field-label">Validity Period:</span> ${approval.validityPeriod || 'N/A'}</div>
                    ${conditions}
                `;
            },

            renderIssues(issues) {
                if (!issues || !issues.length) return '<p>No common issues documented.</p>';
                return `<ul class="issues-list" style="margin: 0; padding: 0 0 0 20px;">
                    ${issues.map(issue => `<li style="margin-bottom: 8px; color: #FFD700;">${issue}</li>`).join('')}
                </ul>`;
            }
        };

        // Initialize Jurisdiction Browser
        document.addEventListener('DOMContentLoaded', () => {
            JurisdictionBrowser.init();
            window.JurisdictionBrowser = JurisdictionBrowser;
        });
    </script>
</body>
</html>
