<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Traffic Studies - Trajanus Enterprise Hub</title>
    <link rel="stylesheet" href="../main.css">
    <style>
        /* ==================== WORKSPACE LAYOUT ==================== */
        .workspace-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            background: var(--bg-base);
            overflow: hidden;
        }

        .workspace-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 24px;
            background: var(--bg-surface);
            border-bottom: 1px solid var(--border-subtle);
            flex-shrink: 0;
        }

        .workspace-header h1 {
            color: var(--accent-gold);
            font-size: 18px;
            font-weight: 600;
            margin: 0;
        }

        .workspace-header p {
            color: var(--text-muted);
            font-size: 11px;
            margin: 2px 0 0 0;
        }

        .home-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: transparent;
            border: 1px solid var(--accent-gold);
            color: var(--accent-gold);
            font-size: 13px;
            border-radius: 4px;
            cursor: pointer;
            text-decoration: none;
            transition: all 0.2s;
        }

        .home-btn:hover {
            background: var(--accent-gold);
            color: var(--bg-base);
        }

        /* ==================== MAIN CONTENT ==================== */
        .workspace-main {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        /* ==================== LEFT SIDEBAR ==================== */
        .sidebar {
            width: 280px;
            background: var(--bg-surface);
            border-right: 1px solid var(--border-subtle);
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            flex-shrink: 0;
        }

        .section-divider {
            padding: 12px 16px 8px 16px;
            border-bottom: 1px solid var(--border-subtle);
        }

        .section-title {
            font-size: 10px;
            font-weight: 600;
            color: var(--accent-gold);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* ==================== EXTERNAL SYSTEMS ==================== */
        .systems-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            padding: 12px 16px;
        }

        .system-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 12px 8px;
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
        }

        .system-btn:hover {
            background: var(--bg-hover);
            border-color: var(--accent-gold);
        }

        .system-icon {
            font-size: 20px;
            color: var(--accent-gold);
        }

        .system-label {
            font-size: 10px;
            color: var(--text-light);
            text-align: center;
        }

        /* ==================== REFERENCE DOCUMENTS ==================== */
        .doc-category {
            padding: 8px 16px;
        }

        .doc-category-header {
            font-size: 11px;
            font-weight: 500;
            color: var(--text-muted);
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .doc-list {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .doc-item {
            display: flex;
            align-items: center;
            padding: 8px 10px;
            background: var(--bg-card);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 12px;
            color: var(--text-light);
            border-left: 2px solid transparent;
        }

        .doc-item:hover {
            background: var(--bg-hover);
            border-left-color: var(--accent-gold);
        }

        .doc-item.selected {
            background: rgba(212, 165, 116, 0.15);
            border-left-color: var(--accent-gold);
        }

        /* ==================== AGENTS SECTION ==================== */
        .agents-list {
            display: flex;
            flex-direction: column;
            gap: 6px;
            padding: 12px 16px;
        }

        .agent-btn {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .agent-btn:hover {
            background: var(--bg-hover);
            border-color: var(--accent-gold);
        }

        .agent-icon {
            font-size: 16px;
            color: var(--accent-gold);
        }

        .agent-info {
            flex: 1;
        }

        .agent-name {
            font-size: 12px;
            font-weight: 500;
            color: var(--text-light);
        }

        .agent-desc {
            font-size: 10px;
            color: var(--text-muted);
        }

        /* ==================== PANELS AREA ==================== */
        .panels-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            padding: 16px;
            gap: 12px;
        }

        .panel {
            background: var(--bg-surface);
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
            transition: all 0.3s ease;
            overflow: hidden;
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: var(--bg-card);
            border-bottom: 1px solid var(--border-subtle);
            cursor: pointer;
        }

        .panel-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--accent-gold);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .panel-expand-icon {
            color: var(--text-muted);
            transition: transform 0.3s;
        }

        .panel.compact {
            cursor: pointer;
        }

        .panel.compact .panel-content {
            display: none;
        }

        .panel.compact .panel-expand-icon {
            transform: rotate(0deg);
        }

        .panel.expanded {
            min-height: 600px;
        }

        .panel.expanded .panel-content {
            display: flex;
            flex-direction: column;
            height: 550px;
        }

        .panel.expanded .panel-expand-icon {
            transform: rotate(180deg);
        }

        .panel-content {
            padding: 16px;
            overflow: hidden;
        }

        /* ==================== DATA BROWSER ==================== */
        .browser-toolbar {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }

        .browser-path {
            flex: 1;
            padding: 8px 12px;
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 4px;
            font-size: 12px;
            color: var(--text-light);
        }

        .browser-path:focus {
            outline: none;
            border-color: var(--accent-gold);
        }

        .file-grid {
            flex: 1;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 8px;
            overflow-y: auto;
        }

        .file-card {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .file-card:hover {
            background: var(--bg-hover);
            border-color: var(--accent-gold);
        }

        .file-card.selected {
            background: rgba(212, 165, 116, 0.15);
            border-color: var(--accent-gold);
        }

        .file-icon {
            font-size: 24px;
            color: var(--accent-gold);
        }

        .file-info {
            flex: 1;
            overflow: hidden;
        }

        .file-name {
            font-size: 12px;
            color: var(--text-light);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .file-meta {
            font-size: 10px;
            color: var(--text-muted);
        }

        .file-status {
            font-size: 9px;
            padding: 2px 6px;
            border-radius: 3px;
            margin-top: 2px;
            display: inline-block;
        }

        .file-status.synchro { background: #20303a; color: #6495ed; }
        .file-status.hcs { background: #302030; color: #9370db; }
        .file-status.data { background: #1a3a1a; color: #4a9f4a; }

        /* ==================== ANALYSIS PANEL ==================== */
        .analysis-form {
            display: flex;
            flex-direction: column;
            gap: 16px;
            max-width: 500px;
        }

        .template-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .template-group label {
            font-size: 11px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .template-select {
            padding: 10px 12px;
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 4px;
            color: var(--text-light);
            font-size: 13px;
        }

        .template-select:focus {
            outline: none;
            border-color: var(--accent-gold);
        }

        .template-select option {
            background: var(--bg-card);
            color: var(--text-light);
        }

        /* ==================== OUTPUT PANEL ==================== */
        .output-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .output-area {
            flex: 1;
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 4px;
            padding: 12px;
            font-size: 13px;
            line-height: 1.6;
            overflow-y: auto;
            color: var(--text-light);
            white-space: pre-wrap;
        }

        .output-area.empty {
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
            font-style: italic;
        }

        .output-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        /* ==================== CHAT PANEL ==================== */
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 12px;
        }

        .chat-message {
            padding: 10px 14px;
            border-radius: 8px;
            margin-bottom: 8px;
            font-size: 13px;
            line-height: 1.5;
        }

        .chat-message.user {
            background: rgba(212, 165, 116, 0.15);
            margin-left: 20%;
            color: var(--text-light);
        }

        .chat-message.assistant {
            background: var(--bg-card);
            margin-right: 20%;
            color: var(--text-light);
        }

        .chat-input-area {
            display: flex;
            gap: 8px;
        }

        .chat-input {
            flex: 1;
            padding: 10px 12px;
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 4px;
            color: var(--text-light);
            font-size: 13px;
            resize: none;
            font-family: inherit;
        }

        .chat-input:focus {
            outline: none;
            border-color: var(--accent-gold);
        }

        .chat-input::placeholder {
            color: var(--text-muted);
        }

        /* ==================== BUTTONS ==================== */
        .btn {
            padding: 8px 16px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
        }

        .btn-primary {
            background: var(--accent-gold);
            color: var(--bg-base);
            font-weight: 500;
        }

        .btn-primary:hover {
            background: var(--accent-gold-bright);
        }

        .btn-secondary {
            background: transparent;
            color: var(--text-light);
            border: 1px solid var(--border-subtle);
        }

        .btn-secondary:hover {
            border-color: var(--accent-gold);
            color: var(--accent-gold);
        }

        /* ==================== TYPING INDICATOR ==================== */
        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 12px 14px;
            background: var(--bg-card);
            border-radius: 8px;
            margin-right: 20%;
            width: fit-content;
        }

        .typing-indicator span {
            width: 6px;
            height: 6px;
            background: var(--accent-gold);
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out;
        }

        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); opacity: 0.4; }
            30% { transform: translateY(-4px); opacity: 1; }
        }

        /* ==================== SYSTEM LOG ==================== */
        .system-log {
            background: var(--bg-base);
            border-top: 1px solid var(--border-subtle);
            height: 100px;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }

        .system-log-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 16px;
            background: var(--bg-surface);
            border-bottom: 1px solid var(--border-subtle);
        }

        .system-log-title {
            font-size: 10px;
            font-weight: 600;
            color: var(--accent-gold);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .clear-log-btn {
            background: transparent;
            border: 1px solid var(--border-subtle);
            color: var(--text-muted);
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 10px;
            cursor: pointer;
        }

        .clear-log-btn:hover {
            border-color: var(--accent-gold);
            color: var(--accent-gold);
        }

        .log-output {
            flex: 1;
            overflow-y: auto;
            padding: 6px 16px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 11px;
            line-height: 1.5;
        }

        .log-entry {
            margin-bottom: 2px;
        }

        .log-entry .timestamp {
            color: var(--text-muted);
        }

        .log-entry.success { color: var(--success); }
        .log-entry.info { color: var(--text-muted); }
        .log-entry.error { color: var(--error); }
    </style>
</head>
<body>
    <div class="workspace-container">
        <header class="workspace-header">
            <div>
                <h1>Traffic Studies</h1>
                <p>Traffic impact analysis, Synchro, HCS, jurisdiction compliance</p>
            </div>
            <a href="../index.html" class="home-btn">
                <span>&#9670;</span> Hub
            </a>
        </header>

        <div class="workspace-main">
            <!-- Left Sidebar -->
            <aside class="sidebar">
                <!-- External Systems -->
                <div class="section-divider">
                    <span class="section-title">External Systems</span>
                </div>
                <div class="systems-grid">
                    <a href="#" class="system-btn" onclick="Traffic.launchApp('synchro'); return false;">
                        <span class="system-icon">&#128736;</span>
                        <span class="system-label">Synchro</span>
                    </a>
                    <a href="#" class="system-btn" onclick="Traffic.launchApp('hcs'); return false;">
                        <span class="system-icon">&#128200;</span>
                        <span class="system-label">HCS 7</span>
                    </a>
                    <a href="https://maps.google.com" target="_blank" class="system-btn">
                        <span class="system-icon">&#128506;</span>
                        <span class="system-label">Google Maps</span>
                    </a>
                    <a href="https://www.fdot.gov" target="_blank" class="system-btn">
                        <span class="system-icon">&#9733;</span>
                        <span class="system-label">FDOT</span>
                    </a>
                    <a href="#" class="system-btn" onclick="Traffic.launchApp('excel'); return false;">
                        <span class="system-icon">&#9638;</span>
                        <span class="system-label">Excel</span>
                    </a>
                    <a href="#" class="system-btn" onclick="Traffic.launchApp('autocad'); return false;">
                        <span class="system-icon">&#9634;</span>
                        <span class="system-label">AutoCAD</span>
                    </a>
                </div>

                <!-- Reference Documents -->
                <div class="section-divider">
                    <span class="section-title">Reference Documents</span>
                </div>

                <div class="doc-category">
                    <div class="doc-category-header">Standards</div>
                    <div class="doc-list">
                        <div class="doc-item" onclick="Traffic.selectDoc(this, 'ite')">ITE Trip Generation (11th)</div>
                        <div class="doc-item" onclick="Traffic.selectDoc(this, 'hcm')">HCM 7th Edition</div>
                        <div class="doc-item" onclick="Traffic.selectDoc(this, 'mutcd')">MUTCD</div>
                    </div>
                </div>

                <div class="doc-category">
                    <div class="doc-category-header">Florida Standards</div>
                    <div class="doc-list">
                        <div class="doc-item" onclick="Traffic.selectDoc(this, 'fdot-qual')">FDOT Quality/LOS</div>
                        <div class="doc-item" onclick="Traffic.selectDoc(this, 'fdot-design')">FDOT Design Manual</div>
                        <div class="doc-item" onclick="Traffic.selectDoc(this, 'alachua')">Alachua County Std</div>
                    </div>
                </div>

                <div class="doc-category">
                    <div class="doc-category-header">Project Data</div>
                    <div class="doc-list">
                        <div class="doc-item" onclick="Traffic.selectDoc(this, 'counts')">Traffic Counts</div>
                        <div class="doc-item" onclick="Traffic.selectDoc(this, 'site-plan')">Site Plan</div>
                        <div class="doc-item" onclick="Traffic.selectDoc(this, 'existing')">Existing Conditions</div>
                    </div>
                </div>

                <!-- Agents -->
                <div class="section-divider">
                    <span class="section-title">Agents</span>
                </div>
                <div class="agents-list">
                    <div class="agent-btn" onclick="Traffic.deployAgent('trip-generator')">
                        <span class="agent-icon">&#128663;</span>
                        <div class="agent-info">
                            <div class="agent-name">Trip Generator</div>
                            <div class="agent-desc">ITE trip calculations</div>
                        </div>
                    </div>
                    <div class="agent-btn" onclick="Traffic.deployAgent('los-analyzer')">
                        <span class="agent-icon">&#128200;</span>
                        <div class="agent-info">
                            <div class="agent-name">LOS Analyzer</div>
                            <div class="agent-desc">Level of service analysis</div>
                        </div>
                    </div>
                    <div class="agent-btn" onclick="Traffic.deployAgent('signal-timer')">
                        <span class="agent-icon">&#128678;</span>
                        <div class="agent-info">
                            <div class="agent-name">Signal Timer</div>
                            <div class="agent-desc">Signal timing optimization</div>
                        </div>
                    </div>
                    <div class="agent-btn" onclick="Traffic.deployAgent('report-writer')">
                        <span class="agent-icon">&#128221;</span>
                        <div class="agent-info">
                            <div class="agent-name">Report Writer</div>
                            <div class="agent-desc">TIA report generation</div>
                        </div>
                    </div>
                </div>
            </aside>

            <!-- Panels Area -->
            <main class="panels-area">
                <!-- Data Browser Panel -->
                <section class="panel expanded" id="panel-browser" onclick="Traffic.Panels.handleClick(event, 'panel-browser')">
                    <div class="panel-header">
                        <span class="panel-title">Data Browser</span>
                        <span class="panel-expand-icon">&#9660;</span>
                    </div>
                    <div class="panel-content">
                        <div class="browser-toolbar">
                            <input type="text" class="browser-path" id="browser-path" value="G:\My Drive\00 - Trajanus USA\Projects\Grace Fellowship\">
                            <button class="btn btn-secondary" onclick="Traffic.browsePath()">Browse</button>
                        </div>
                        <div class="file-grid" id="file-grid">
                            <div class="file-card" onclick="Traffic.selectFile(this, 'Grace-Fellowship-Counts.xlsx')">
                                <span class="file-icon">&#128202;</span>
                                <div class="file-info">
                                    <div class="file-name">Grace-Fellowship-Counts.xlsx</div>
                                    <div class="file-meta">TMC Counts - Dec 2025</div>
                                    <span class="file-status data">Data</span>
                                </div>
                            </div>
                            <div class="file-card" onclick="Traffic.selectFile(this, 'Grace-Fellowship.syn')">
                                <span class="file-icon">&#128736;</span>
                                <div class="file-info">
                                    <div class="file-name">Grace-Fellowship.syn</div>
                                    <div class="file-meta">Synchro Model v12</div>
                                    <span class="file-status synchro">Synchro</span>
                                </div>
                            </div>
                            <div class="file-card" onclick="Traffic.selectFile(this, 'SR26-Existing-LOS.hco')">
                                <span class="file-icon">&#128200;</span>
                                <div class="file-info">
                                    <div class="file-name">SR26-Existing-LOS.hco</div>
                                    <div class="file-meta">HCS Analysis Output</div>
                                    <span class="file-status hcs">HCS</span>
                                </div>
                            </div>
                            <div class="file-card" onclick="Traffic.selectFile(this, 'Trip-Generation.xlsx')">
                                <span class="file-icon">&#128663;</span>
                                <div class="file-info">
                                    <div class="file-name">Trip-Generation.xlsx</div>
                                    <div class="file-meta">ITE 11th Ed Calc</div>
                                    <span class="file-status data">Data</span>
                                </div>
                            </div>
                            <div class="file-card" onclick="Traffic.selectFile(this, 'Site-Plan-Rev3.pdf')">
                                <span class="file-icon">&#128196;</span>
                                <div class="file-info">
                                    <div class="file-name">Site-Plan-Rev3.pdf</div>
                                    <div class="file-meta">Civil Site Plan</div>
                                    <span class="file-status data">PDF</span>
                                </div>
                            </div>
                            <div class="file-card" onclick="Traffic.selectFile(this, 'TIA-Draft-v2.docx')">
                                <span class="file-icon">&#128221;</span>
                                <div class="file-info">
                                    <div class="file-name">TIA-Draft-v2.docx</div>
                                    <div class="file-meta">Traffic Impact Analysis</div>
                                    <span class="file-status data">Draft</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Analysis Configuration Panel -->
                <section class="panel compact" id="panel-analysis" onclick="Traffic.Panels.handleClick(event, 'panel-analysis')">
                    <div class="panel-header">
                        <span class="panel-title">Analysis Configuration</span>
                        <span class="panel-expand-icon">&#9660;</span>
                    </div>
                    <div class="panel-content">
                        <div class="analysis-form">
                            <div class="template-group">
                                <label>Study Type</label>
                                <select class="template-select" id="study-type" onclick="event.stopPropagation()">
                                    <option value="">Select type...</option>
                                    <option value="tia">Traffic Impact Analysis</option>
                                    <option value="los">Level of Service Study</option>
                                    <option value="trip-gen">Trip Generation</option>
                                    <option value="signal">Signal Timing Analysis</option>
                                    <option value="safety">Safety Assessment</option>
                                    <option value="parking">Parking Study</option>
                                </select>
                            </div>
                            <div class="template-group">
                                <label>Jurisdiction</label>
                                <select class="template-select" id="jurisdiction" onclick="event.stopPropagation()">
                                    <option value="fdot">FDOT</option>
                                    <option value="alachua">Alachua County</option>
                                    <option value="gainesville">City of Gainesville</option>
                                    <option value="high-springs">City of High Springs</option>
                                    <option value="newberry">City of Newberry</option>
                                </select>
                            </div>
                            <div class="template-group">
                                <label>Analysis Year</label>
                                <select class="template-select" id="analysis-year" onclick="event.stopPropagation()">
                                    <option value="existing">Existing (2025)</option>
                                    <option value="opening">Opening Year (2026)</option>
                                    <option value="future">Future (2030)</option>
                                    <option value="buildout">Buildout (2035)</option>
                                </select>
                            </div>
                            <button class="btn btn-primary" onclick="event.stopPropagation(); Traffic.generateOutput();">Generate Analysis</button>
                        </div>
                    </div>
                </section>

                <!-- Output Panel -->
                <section class="panel compact" id="panel-output" onclick="Traffic.Panels.handleClick(event, 'panel-output')">
                    <div class="panel-header">
                        <span class="panel-title">Analysis Output</span>
                        <span class="panel-expand-icon">&#9660;</span>
                    </div>
                    <div class="panel-content">
                        <div class="output-container">
                            <div class="output-area empty" id="output-area">
                                Select data files and analysis type to generate output...
                            </div>
                            <div class="output-actions">
                                <button class="btn btn-secondary" onclick="event.stopPropagation(); Traffic.copyOutput();">Copy</button>
                                <button class="btn btn-secondary" onclick="event.stopPropagation(); Traffic.exportOutput();">Export to Word</button>
                                <button class="btn btn-primary" onclick="event.stopPropagation(); Traffic.sendToAssistant();">Send to Claude</button>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Claude Assistant Panel -->
                <section class="panel compact" id="panel-claude" onclick="Traffic.Panels.handleClick(event, 'panel-claude')">
                    <div class="panel-header">
                        <span class="panel-title">Claude Assistant (Traffic Specialist)</span>
                        <span class="panel-expand-icon">&#9660;</span>
                    </div>
                    <div class="panel-content">
                        <div class="chat-container">
                            <div class="chat-messages" id="chat-messages">
                                <div class="chat-message assistant">
                                    I'm your Traffic Engineering specialist. I can help with trip generation, LOS analysis, signal timing, TIA reports, and jurisdiction compliance. What would you like to work on?
                                </div>
                            </div>
                            <div class="chat-input-area">
                                <textarea class="chat-input" id="chat-input" rows="2" placeholder="Ask about trip generation, LOS, signal timing, or FDOT compliance..." onclick="event.stopPropagation()"></textarea>
                                <button class="btn btn-primary" onclick="event.stopPropagation(); Traffic.sendMessage();">Send</button>
                            </div>
                        </div>
                    </div>
                </section>
            </main>
        </div>

        <!-- System Log -->
        <div class="system-log">
            <div class="system-log-header">
                <span class="system-log-title">System Log</span>
                <button class="clear-log-btn" onclick="Traffic.clearLog()">Clear</button>
            </div>
            <div class="log-output" id="log-output">
                <div class="log-entry info"><span class="timestamp">[--:--:--]</span> Traffic Studies workspace ready.</div>
            </div>
        </div>
    </div>

    <script>
        // Safe Tauri API wrapper - returns null in browser mode
        function getInvoke() {
            if (window.__TAURI__ && window.__TAURI__.core && window.__TAURI__.core.invoke) {
                return window.__TAURI__.core.invoke;
            }
            return null;
        }

        // Notification helper for browser feedback
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `<span>${message}</span>`;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 12px 20px;
                border-radius: 8px;
                background: ${type === 'warning' ? '#2d2a00' : '#0a1929'};
                border: 1px solid ${type === 'warning' ? '#d4af37' : '#4fc3f7'};
                color: ${type === 'warning' ? '#d4af37' : '#e0e0e0'};
                font-size: 14px;
                z-index: 9999;
                animation: slideIn 0.3s ease;
            `;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
        }

        const Traffic = {
            selectedFile: null,
            selectedDoc: null,
            isProcessing: false,

            // ==================== PANEL MANAGEMENT ====================
            Panels: {
                activePanel: 'panel-browser',

                handleClick(event, panelId) {
                    const panel = document.getElementById(panelId);
                    if (panel.classList.contains('compact')) {
                        event.stopPropagation();
                        this.expand(panelId);
                    }
                },

                expand(panelId) {
                    const panel = document.getElementById(panelId);
                    if (panel.classList.contains('expanded')) return;

                    document.querySelectorAll('.panel').forEach(p => {
                        p.classList.remove('expanded');
                        p.classList.add('compact');
                    });

                    panel.classList.remove('compact');
                    panel.classList.add('expanded');
                    this.activePanel = panelId;

                    setTimeout(() => {
                        panel.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }, 50);

                    Traffic.log(`Panel expanded: ${panelId.replace('panel-', '')}`);
                }
            },

            // ==================== LOGGING ====================
            log(message, type = 'info') {
                const logOutput = document.getElementById('log-output');
                const timestamp = new Date().toLocaleTimeString('en-US', { hour12: false });
                const entry = document.createElement('div');
                entry.className = `log-entry ${type}`;
                entry.innerHTML = `<span class="timestamp">[${timestamp}]</span> ${message}`;
                logOutput.appendChild(entry);
                logOutput.scrollTop = logOutput.scrollHeight;
            },

            clearLog() {
                document.getElementById('log-output').innerHTML =
                    '<div class="log-entry info"><span class="timestamp">[--:--:--]</span> Log cleared.</div>';
            },

            // ==================== APP LAUNCHERS ====================
            webUrls: {
                'excel': 'https://office.live.com/start/excel.aspx'
            },

            async launchApp(app) {
                const invoke = getInvoke();

                // Browser fallback mode
                if (!invoke) {
                    if (this.webUrls[app]) {
                        window.open(this.webUrls[app], '_blank');
                        this.log(`Opening ${app} online...`, 'success');
                        showNotification(`Opening ${app} in browser...`, 'info');
                    } else {
                        this.log(`${app} requires the desktop app`, 'error');
                        showNotification(`${app} requires the desktop app`, 'warning');
                    }
                    return;
                }

                const commands = {
                    'synchro': 'start "" "C:\\Program Files\\Trafficware\\Synchro\\Synchro.exe"',
                    'hcs': 'start "" "C:\\Program Files\\McTrans\\HCS 7\\HCS.exe"',
                    'excel': 'start excel',
                    'autocad': 'start "" "C:\\Program Files\\Autodesk\\AutoCAD 2024\\acad.exe"'
                };

                if (commands[app]) {
                    this.log(`Launching ${app}...`);
                    try {
                        await invoke('open_terminal', { path: '.' });
                    } catch (e) {
                        this.log(`Failed to launch ${app}: ${e}`, 'error');
                    }
                }
            },

            // ==================== DOCUMENT SELECTION ====================
            selectDoc(element, docId) {
                document.querySelectorAll('.doc-item').forEach(el => el.classList.remove('selected'));
                element.classList.add('selected');
                this.selectedDoc = docId;
                this.log(`Selected reference: ${docId}`);
            },

            selectFile(element, filename) {
                document.querySelectorAll('.file-card').forEach(el => el.classList.remove('selected'));
                element.classList.add('selected');
                this.selectedFile = filename;
                this.log(`Selected: ${filename}`);
            },

            async browsePath() {
                const invoke = getInvoke();
                const path = document.getElementById('browser-path').value;

                // Browser fallback mode
                if (!invoke) {
                    this.log(`File browsing requires the desktop app`, 'error');
                    showNotification('File browsing requires the desktop app', 'warning');
                    return;
                }

                this.log(`Browsing: ${path}`);
                try {
                    const entries = await invoke('list_directory', { path });
                    this.log(`Found ${entries.length} items`, 'success');
                } catch (e) {
                    this.log(`Browse failed: ${e}`, 'error');
                }
            },

            // ==================== AGENT DEPLOYMENT ====================
            deployAgent(agentId) {
                const agents = {
                    'trip-generator': 'Trip Generator agent activated. Ready to calculate trip generation using ITE 11th Edition rates and local data.',
                    'los-analyzer': 'LOS Analyzer agent activated. Ready to perform level of service analysis for intersections and segments.',
                    'signal-timer': 'Signal Timer agent activated. Ready to optimize signal timing and analyze coordination.',
                    'report-writer': 'Report Writer agent activated. Ready to generate TIA reports in jurisdiction-compliant format.'
                };

                this.log(`Deploying agent: ${agentId}`, 'success');
                this.addChatMessage('assistant', agents[agentId] || `Agent ${agentId} activated.`);
                this.Panels.expand('panel-claude');
            },

            // ==================== OUTPUT GENERATION ====================
            generateOutput() {
                if (!this.selectedFile) {
                    this.log('Please select a data file first', 'error');
                    return;
                }
                const studyType = document.getElementById('study-type').value;
                if (!studyType) {
                    this.log('Please select a study type', 'error');
                    return;
                }

                const jurisdiction = document.getElementById('jurisdiction').value;
                const year = document.getElementById('analysis-year').value;
                const outputArea = document.getElementById('output-area');
                outputArea.classList.remove('empty');
                outputArea.textContent = `${studyType.toUpperCase()} ANALYSIS\n\nData File: ${this.selectedFile}\nJurisdiction: ${jurisdiction.toUpperCase()}\nAnalysis Year: ${year}\n\nAnalysis results and findings will appear here.\n\nThis is a placeholder for AI-generated traffic analysis.`;
                this.log(`Generated ${studyType} analysis for ${jurisdiction}`, 'success');
                this.Panels.expand('panel-output');
            },

            copyOutput() {
                const output = document.getElementById('output-area').textContent;
                if (output && !output.includes('Select data files')) {
                    navigator.clipboard.writeText(output);
                    this.log('Output copied to clipboard', 'success');
                }
            },

            exportOutput() {
                this.log('Exporting to Word...', 'info');
                // Would integrate with Word export
            },

            sendToAssistant() {
                const output = document.getElementById('output-area').textContent;
                if (output && !output.includes('Select data files')) {
                    this.addChatMessage('user', 'Please review this analysis:\n' + output);
                    this.sendToClaude('Please review and provide feedback on this traffic analysis:\n' + output);
                    this.Panels.expand('panel-claude');
                }
            },

            // ==================== CHAT FUNCTIONS ====================
            addChatMessage(role, content) {
                const messages = document.getElementById('chat-messages');
                const msg = document.createElement('div');
                msg.className = `chat-message ${role}`;
                msg.textContent = content;
                messages.appendChild(msg);
                messages.scrollTop = messages.scrollHeight;
            },

            showTyping() {
                const messages = document.getElementById('chat-messages');
                const typing = document.createElement('div');
                typing.className = 'typing-indicator';
                typing.id = 'typing-indicator';
                typing.innerHTML = '<span></span><span></span><span></span>';
                messages.appendChild(typing);
                messages.scrollTop = messages.scrollHeight;
            },

            async sendToClaude(message) {
                if (this.isProcessing) return;
                this.isProcessing = true;
                this.log('Sending to Claude...', 'info');
                this.showTyping();

                try {
                    const context = `You are a Traffic Engineering specialist for traffic impact studies in Florida.
                    You help with traffic impact analyses, level of service calculations, trip generation using ITE methods,
                    signal timing optimization, and safety assessments.
                    You are familiar with Synchro 12, HCS 7, FDOT Quality/LOS Manual, HCM 7th Edition, and local Florida jurisdiction standards.
                    Current project: Grace Fellowship Church TIA - High Springs, FL
                    Keep responses concise and technically accurate.`;

                    const response = await invoke('chat_with_claude', {
                        message: message,
                        context: context
                    });

                    document.getElementById('typing-indicator')?.remove();
                    this.addChatMessage('assistant', response);
                    this.log('Response received', 'success');
                } catch (error) {
                    document.getElementById('typing-indicator')?.remove();
                    this.addChatMessage('assistant', 'Error: ' + error);
                    this.log('API error: ' + error, 'error');
                } finally {
                    this.isProcessing = false;
                }
            },

            async sendMessage() {
                const input = document.getElementById('chat-input');
                const message = input.value.trim();
                if (message && !this.isProcessing) {
                    this.addChatMessage('user', message);
                    input.value = '';
                    await this.sendToClaude(message);
                }
            }
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            Traffic.log('Traffic workspace loaded', 'info');

            document.getElementById('chat-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    Traffic.sendMessage();
                }
            });
        });
    </script>
</body>
</html>
