<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Traffic Studies - Trajanus Enterprise Hub</title>
    <link rel="stylesheet" href="../styles/main.css">
    <style>
        /* Workspace Layout */
        .workspace-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            background: var(--bg-base);
        }

        .workspace-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 24px;
            background: var(--bg-surface);
            border-bottom: 1px solid var(--border-subtle);
        }

        .workspace-header h1 {
            color: var(--accent-gold);
            font-size: 20px;
            font-weight: 600;
            margin: 0;
        }

        .workspace-header p {
            color: var(--text-muted);
            font-size: 12px;
            margin: 4px 0 0 0;
        }

        .home-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: transparent;
            border: 1px solid var(--accent-gold);
            color: var(--accent-gold);
            font-size: 13px;
            border-radius: 4px;
            cursor: pointer;
            text-decoration: none;
            transition: all 0.2s;
        }

        .home-btn:hover {
            background: var(--accent-gold);
            color: var(--bg-base);
        }

        /* 4-Panel Grid */
        .workspace-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 1fr 1fr;
            gap: 1px;
            flex: 1;
            background: var(--border-subtle);
            overflow: hidden;
        }

        .panel {
            background: var(--bg-surface);
            padding: 16px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .panel-header {
            font-size: 11px;
            font-weight: 600;
            color: var(--accent-gold);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border-subtle);
        }

        .panel-content {
            flex: 1;
            overflow-y: auto;
        }

        /* Document Browser */
        .file-list {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .file-item {
            display: flex;
            align-items: center;
            padding: 10px 12px;
            background: var(--bg-card);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            border-left: 3px solid transparent;
        }

        .file-item:hover {
            background: var(--bg-hover);
        }

        .file-item.selected {
            background: rgba(212, 165, 116, 0.15);
            border-left-color: var(--accent-gold);
        }

        .file-name {
            font-size: 13px;
            color: var(--text-light);
        }

        /* Template Selection */
        .template-group {
            margin-bottom: 16px;
        }

        .template-group label {
            display: block;
            font-size: 11px;
            color: var(--text-muted);
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .template-select {
            width: 100%;
            padding: 10px 12px;
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 4px;
            color: var(--text-light);
            font-size: 13px;
        }

        .template-select:focus {
            outline: none;
            border-color: var(--accent-gold);
        }

        .template-select option {
            background: var(--bg-card);
            color: var(--text-light);
        }

        /* Output Area */
        .output-area {
            flex: 1;
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 4px;
            padding: 12px;
            font-size: 13px;
            line-height: 1.6;
            overflow-y: auto;
            min-height: 120px;
            color: var(--text-light);
        }

        .output-area.empty {
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
            font-style: italic;
        }

        .output-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        /* Buttons */
        .btn {
            padding: 8px 16px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--accent-gold);
            color: var(--bg-base);
            border: none;
            font-weight: 500;
        }

        .btn-primary:hover {
            background: var(--accent-gold-bright);
        }

        .btn-secondary {
            background: transparent;
            color: var(--text-light);
            border: 1px solid var(--border-subtle);
        }

        .btn-secondary:hover {
            border-color: var(--accent-gold);
            color: var(--accent-gold);
        }

        /* Chat */
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 12px;
            min-height: 80px;
        }

        .chat-message {
            padding: 10px 14px;
            border-radius: 8px;
            margin-bottom: 8px;
            font-size: 13px;
            line-height: 1.5;
        }

        .chat-message.user {
            background: rgba(212, 165, 116, 0.15);
            margin-left: 15%;
            color: var(--text-light);
        }

        .chat-message.assistant {
            background: var(--bg-card);
            margin-right: 15%;
            color: var(--text-light);
        }

        .chat-input-area {
            display: flex;
            gap: 8px;
        }

        .chat-input {
            flex: 1;
            padding: 10px 12px;
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 4px;
            color: var(--text-light);
            font-size: 13px;
            resize: none;
            font-family: inherit;
        }

        .chat-input:focus {
            outline: none;
            border-color: var(--accent-gold);
        }

        .chat-input::placeholder {
            color: var(--text-muted);
        }

        /* Typing Indicator */
        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 12px 14px;
            background: var(--bg-card);
            border-radius: 8px;
            margin-right: 15%;
            width: fit-content;
        }

        .typing-indicator span {
            width: 6px;
            height: 6px;
            background: var(--accent-gold);
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out;
        }

        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); opacity: 0.4; }
            30% { transform: translateY(-4px); opacity: 1; }
        }

        /* System Log */
        .system-log {
            background: var(--bg-base);
            border-top: 1px solid var(--border-subtle);
            height: 120px;
            display: flex;
            flex-direction: column;
        }

        .system-log-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 16px;
            background: var(--bg-surface);
            border-bottom: 1px solid var(--border-subtle);
        }

        .system-log-title {
            font-size: 10px;
            font-weight: 600;
            color: var(--accent-gold);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .clear-log-btn {
            background: transparent;
            border: 1px solid var(--border-subtle);
            color: var(--text-muted);
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 10px;
            cursor: pointer;
        }

        .clear-log-btn:hover {
            border-color: var(--accent-gold);
            color: var(--accent-gold);
        }

        .log-output {
            flex: 1;
            overflow-y: auto;
            padding: 8px 16px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 11px;
            line-height: 1.6;
        }

        .log-entry {
            margin-bottom: 2px;
        }

        .log-entry .timestamp {
            color: var(--text-muted);
        }

        .log-entry.success {
            color: var(--success);
        }

        .log-entry.info {
            color: var(--text-muted);
        }

        .log-entry.error {
            color: var(--error);
        }
    </style>
</head>
<body>
    <div class="workspace-container">
        <header class="workspace-header">
            <div>
                <h1>Traffic Studies</h1>
                <p>Traffic impact analysis, Synchro, HCS, jurisdiction compliance</p>
            </div>
            <a href="../index.html" class="home-btn">
                <span>&#9670;</span> Hub
            </a>
        </header>

        <!-- 4-Panel Workspace -->
        <div class="workspace-grid">
            <!-- Panel 1: Data Browser -->
            <section class="panel">
                <div class="panel-header">Data Browser</div>
                <div class="panel-content">
                    <div class="file-list" id="file-list">
                        <div class="file-item" onclick="Traffic.selectFile(this, 'Grace-Fellowship-Counts.xlsx')">
                            <span class="file-name">Grace-Fellowship-Counts.xlsx</span>
                        </div>
                        <div class="file-item" onclick="Traffic.selectFile(this, 'Grace-Fellowship-Synchro.syn')">
                            <span class="file-name">Grace-Fellowship-Synchro.syn</span>
                        </div>
                        <div class="file-item" onclick="Traffic.selectFile(this, 'SR-26-Existing-LOS.pdf')">
                            <span class="file-name">SR-26-Existing-LOS.pdf</span>
                        </div>
                        <div class="file-item" onclick="Traffic.selectFile(this, 'Trip-Generation-ITE.xlsx')">
                            <span class="file-name">Trip-Generation-ITE.xlsx</span>
                        </div>
                        <div class="file-item" onclick="Traffic.selectFile(this, 'HCS-Analysis-Results.hco')">
                            <span class="file-name">HCS-Analysis-Results.hco</span>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Panel 2: Analysis Configuration -->
            <section class="panel">
                <div class="panel-header">Analysis Configuration</div>
                <div class="panel-content">
                    <div class="template-group">
                        <label>Study Type</label>
                        <select class="template-select" id="study-type" onchange="Traffic.updateTemplate()">
                            <option value="">Select type...</option>
                            <option value="tia">Traffic Impact Analysis</option>
                            <option value="los">Level of Service Study</option>
                            <option value="trip-gen">Trip Generation</option>
                            <option value="signal">Signal Timing Analysis</option>
                            <option value="safety">Safety Assessment</option>
                        </select>
                    </div>
                    <div class="template-group">
                        <label>Jurisdiction</label>
                        <select class="template-select" id="jurisdiction">
                            <option value="fdot">FDOT</option>
                            <option value="alachua">Alachua County</option>
                            <option value="gainesville">City of Gainesville</option>
                            <option value="high-springs">City of High Springs</option>
                        </select>
                    </div>
                    <button class="btn btn-primary" onclick="Traffic.generateOutput()" style="width: 100%; margin-top: 16px;">
                        Generate Analysis
                    </button>
                </div>
            </section>

            <!-- Panel 3: Analysis Output -->
            <section class="panel">
                <div class="panel-header">Analysis Output</div>
                <div class="panel-content" style="display: flex; flex-direction: column;">
                    <div class="output-area empty" id="output-area">
                        Select data files and analysis type to generate output...
                    </div>
                    <div class="output-actions">
                        <button class="btn btn-secondary" onclick="Traffic.copyOutput()">Copy</button>
                        <button class="btn btn-secondary" onclick="Traffic.exportOutput()">Export</button>
                        <button class="btn btn-primary" onclick="Traffic.sendToAssistant()">Send to Claude</button>
                    </div>
                </div>
            </section>

            <!-- Panel 4: Claude Assistant -->
            <section class="panel">
                <div class="panel-header">Claude Assistant</div>
                <div class="panel-content" style="display: flex; flex-direction: column;">
                    <div class="chat-messages" id="chat-messages"></div>
                    <div class="chat-input-area">
                        <textarea class="chat-input" id="chat-input" rows="2" placeholder="Ask Claude about traffic analysis..."></textarea>
                        <button class="btn btn-primary" onclick="Traffic.sendMessage()">Send</button>
                    </div>
                </div>
            </section>
        </div>

        <!-- System Log -->
        <div class="system-log">
            <div class="system-log-header">
                <span class="system-log-title">System Log</span>
                <button class="clear-log-btn" onclick="Traffic.clearLog()">Clear</button>
            </div>
            <div class="log-output" id="log-output">
                <div class="log-entry info"><span class="timestamp">[--:--:--]</span> Traffic Studies workspace ready.</div>
            </div>
        </div>
    </div>

    <script>
        // Tauri API
        const { invoke } = window.__TAURI__.core;

        const Traffic = {
            selectedFile: null,
            isProcessing: false,

            log(message, type = 'info') {
                const logOutput = document.getElementById('log-output');
                const timestamp = new Date().toLocaleTimeString('en-US', { hour12: false });
                const entry = document.createElement('div');
                entry.className = `log-entry ${type}`;
                entry.innerHTML = `<span class="timestamp">[${timestamp}]</span> ${message}`;
                logOutput.appendChild(entry);
                logOutput.scrollTop = logOutput.scrollHeight;
            },

            clearLog() {
                document.getElementById('log-output').innerHTML =
                    '<div class="log-entry info"><span class="timestamp">[--:--:--]</span> Log cleared.</div>';
            },

            selectFile(element, filename) {
                document.querySelectorAll('.file-item').forEach(el => el.classList.remove('selected'));
                element.classList.add('selected');
                this.selectedFile = filename;
                this.log(`Selected: ${filename}`);
            },

            updateTemplate() {
                const studyType = document.getElementById('study-type').value;
                if (studyType) {
                    this.log(`Study type: ${studyType}`);
                }
            },

            generateOutput() {
                if (!this.selectedFile) {
                    this.log('Please select a data file first', 'error');
                    return;
                }
                const studyType = document.getElementById('study-type').value;
                if (!studyType) {
                    this.log('Please select a study type', 'error');
                    return;
                }

                const jurisdiction = document.getElementById('jurisdiction').value;
                const outputArea = document.getElementById('output-area');
                outputArea.classList.remove('empty');
                outputArea.textContent = `${studyType.toUpperCase()} ANALYSIS\n\nData File: ${this.selectedFile}\nJurisdiction: ${jurisdiction.toUpperCase()}\n\nAnalysis results and findings will appear here.\n\nThis is a placeholder for AI-generated traffic analysis based on the selected data and study type.`;
                this.log(`Generated ${studyType} analysis for ${jurisdiction}`, 'success');
            },

            copyOutput() {
                const output = document.getElementById('output-area').textContent;
                if (output && !output.includes('Select data files')) {
                    navigator.clipboard.writeText(output);
                    this.log('Output copied to clipboard', 'success');
                }
            },

            exportOutput() {
                this.log('Export functionality coming soon...', 'info');
            },

            sendToAssistant() {
                const output = document.getElementById('output-area').textContent;
                if (output && !output.includes('Select data files')) {
                    this.addChatMessage('user', 'Please review this analysis:\n' + output);
                    this.sendToClaude('Please review and provide feedback on this traffic analysis:\n' + output);
                }
            },

            addChatMessage(role, content) {
                const messages = document.getElementById('chat-messages');
                const msg = document.createElement('div');
                msg.className = `chat-message ${role}`;
                msg.textContent = content;
                messages.appendChild(msg);
                messages.scrollTop = messages.scrollHeight;
            },

            showTyping() {
                const messages = document.getElementById('chat-messages');
                const typing = document.createElement('div');
                typing.className = 'typing-indicator';
                typing.id = 'typing-indicator';
                typing.innerHTML = '<span></span><span></span><span></span>';
                messages.appendChild(typing);
                messages.scrollTop = messages.scrollHeight;
            },

            async sendToClaude(message) {
                if (this.isProcessing) return;
                this.isProcessing = true;
                this.log('Sending to Claude...', 'info');
                this.showTyping();

                try {
                    const context = `You are a Traffic Engineering assistant specializing in traffic impact studies.
                    You help with traffic impact analyses, level of service calculations, trip generation using ITE methods,
                    signal timing optimization, and safety assessments.
                    You are familiar with Synchro, HCS, FDOT requirements, and local Florida jurisdiction standards.
                    Keep responses concise and technically accurate.`;

                    const response = await invoke('chat_with_claude', {
                        message: message,
                        context: context
                    });

                    document.getElementById('typing-indicator')?.remove();
                    this.addChatMessage('assistant', response);
                    this.log('Response received', 'success');
                } catch (error) {
                    document.getElementById('typing-indicator')?.remove();
                    this.addChatMessage('assistant', 'Error: ' + error);
                    this.log('API error: ' + error, 'error');
                } finally {
                    this.isProcessing = false;
                }
            },

            async sendMessage() {
                const input = document.getElementById('chat-input');
                const message = input.value.trim();
                if (message && !this.isProcessing) {
                    this.addChatMessage('user', message);
                    input.value = '';
                    await this.sendToClaude(message);
                }
            }
        };

        document.addEventListener('DOMContentLoaded', () => {
            Traffic.log('Traffic workspace loaded', 'info');

            document.getElementById('chat-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    Traffic.sendMessage();
                }
            });
        });
    </script>
</body>
</html>
