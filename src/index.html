<!DOCTYPE html>
<!-- saved from url=(0032)http://127.0.0.1:1430/index.html -->
<html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><script>// Copyright 2019-2024 Tauri Programme within The Commons Conservancy
// SPDX-License-Identifier: Apache-2.0
// SPDX-License-Identifier: MIT

// taken from https://github.com/thedodd/trunk/blob/5c799dc35f1f1d8f8d3d30c8723cbb761a9b6a08/src/autoreload.js

;(function () {
  const reload_url = 'ws://127.0.0.1:1430/__tauri_cli'
  const url = reload_url ? reload_url : window.location.href
  const poll_interval = 5000
  const reload_upon_connect = () => {
    window.setTimeout(() => {
      // when we successfully reconnect, we'll force a
      // reload (since we presumably lost connection to
      // tauri-cli due to it being killed)
      const ws = new WebSocket(url)
      ws.onopen = () => window.location.reload()
      ws.onclose = reload_upon_connect
    }, poll_interval)
  }

  const ws = new WebSocket(url)
  ws.onmessage = (ev) => {
    const msg = JSON.parse(ev.data)
    if (msg.reload) {
      window.location.reload()
    }
  }
  ws.onclose = reload_upon_connect
})()
</script>
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trajanus Enterprise Hub</title>
    <link rel="stylesheet" href="./main.css">
</head>
<body>
    <div class="app-wrapper has-sidebar">
        <!-- Header Bar -->
        <header class="header-bar">
            <div class="header-brand">
                <span class="header-logo">‚óÜ</span>
                <span class="header-title">TRAJANUS</span>
            </div>
            <div class="header-controls">
                <button class="header-icon-btn quad-chat-btn" id="quad-chat-toggle" title="Quad Chat Mode" onclick="toggleQuadChat()">‚äû</button>
                <button class="header-icon-btn" title="Settings" onclick="log(&#39;Settings coming soon...&#39;, &#39;info&#39;)">‚öô</button>
                <button class="header-icon-btn" title="User" onclick="log(&#39;User profile coming soon...&#39;, &#39;info&#39;)">üë§</button>
            </div>
        </header>

        <!-- Project Sidebar -->
        <nav class="project-sidebar">
            <div class="sidebar-header">
                <h2>PROJECTS</h2>
                <button class="new-project-btn" onclick="showNewProjectModal()">+ New</button>
            </div>

            <div class="project-section">
                <div class="section-header-sidebar" onclick="toggleSection(&#39;traffic&#39;)">
                    <span>üö¶ Traffic Studies</span>
                    <span class="project-count" id="traffic-count">1</span>
                </div>
                <div class="project-list" id="traffic-projects">
                        <div class="project-item active " id="project-PRJ-2025-002" onclick="selectProject(&#39;PRJ-2025-002&#39;)">
                            <div class="project-name">Grace Fellowship TIS</div>
                            <div class="project-meta">Bill King ‚Ä¢ Dec 31</div>
                        </div>
                    </div>
            </div>

            <div class="project-section">
                <div class="section-header-sidebar" onclick="toggleSection(&#39;qcm&#39;)">
                    <span>‚úì Quality Control</span>
                    <span class="project-count" id="qcm-count">0</span>
                </div>
                <div class="project-list" id="qcm-projects"></div>
            </div>

            <div class="project-section">
                <div class="section-header-sidebar" onclick="toggleSection(&#39;pm&#39;)">
                    <span>üìã Project Management</span>
                    <span class="project-count" id="pm-count">2</span>
                </div>
                <div class="project-list" id="pm-projects">
                        <div class="project-item active " id="project-PRJ-2025-001" onclick="selectProject(&#39;PRJ-2025-001&#39;)">
                            <div class="project-name">SOUTHCOM Guatemala</div>
                            <div class="project-meta">Bill King ‚Ä¢ Dec 31</div>
                        </div>
                    
                        <div class="project-item active " id="project-PRJ-2025-003" onclick="selectProject(&#39;PRJ-2025-003&#39;)">
                            <div class="project-name">Base Housing - Kwajalein</div>
                            <div class="project-meta">Bill King ‚Ä¢ Dec 31</div>
                        </div>
                    </div>
            </div>

            <div class="project-section">
                <div class="section-header-sidebar" onclick="toggleSection(&#39;dev&#39;)">
                    <span>üõ† Development</span>
                    <span class="project-count" id="dev-count">0</span>
                </div>
                <div class="project-list" id="dev-projects"></div>
            </div>

            <div class="project-section delivered-section">
                <div class="section-header-sidebar" onclick="toggleSection(&#39;delivered&#39;)">
                    <span>üì¶ Client Deliverables</span>
                    <span class="project-count" id="delivered-count">0</span>
                </div>
                <div class="project-list" id="delivered-projects"></div>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Hero Title -->
            <section class="hero-title">
                <h1>TRAJANUS ENTERPRISE HUB <span class="trademark">| EI‚Ñ¢</span></h1>
            </section>

            <!-- Greeting Row -->
            <div class="greeting-row">
                <h2 class="greeting">
                    <span id="greeting-text">Good morning</span>, <span class="greeting-name">Bill</span>.
                </h2>
                <span class="current-date" id="current-date">January 3, 2026</span>
            </div>

            <!-- Welcome Section -->
            <section class="welcome-section">
                <h2 class="welcome-title">Welcome to the Trajanus Enterprise Hub</h2>
                <p class="welcome-intro">
                    The Enterprise Hub is your central command interface for construction project management,
                    quality control, traffic engineering, and development operations. Built on Trajanus
                    Engineered Intelligence (EI‚Ñ¢), this platform integrates federal contract management
                    workflows with AI-assisted tools and automation.
                </p>
            </section>

            <!-- AI Chat Section - Dual Pane -->
            <section class="ai-chat-section panel-section" id="panel-ai">
                <div class="section-header panel-header">
                    <h2 class="section-title">AI Assistants</h2>
                    <button class="panel-toggle" id="toggle-ai" aria-label="Toggle panel">‚ñº</button>
                </div>
                <div class="panel-content" id="content-ai">
                <div class="chat-dual-pane">
                    <!-- Left: Trajanus Assistant -->
                    <div class="chat-pane trajanus-pane">
                        <div class="chat-container" id="claude-chat">
                            <div class="chat-header">
                                <h3>TRAJANUS</h3>
                                <div class="chat-actions">
                                    <button class="chat-action" id="clear-chat-btn">Clear</button>
                                </div>
                            </div>
                            <div class="chat-messages" id="chat-messages">
                                <div class="chat-welcome">Ask Trajanus anything about the app...</div>
                            </div>
                            <div class="chat-input-area">
                                <textarea id="chat-input" placeholder="How can I help you navigate?" rows="1"></textarea>
                                <button class="tool-button primary" id="send-chat-btn">Send</button>
                            </div>
                        </div>
                    </div>
                    <!-- Right: Claude.ai Embed -->
                    <div class="chat-pane claude-pane">
                        <div class="chat-container">
                            <div class="chat-header">
                                <h3>CLAUDE.AI</h3>
                                <div class="chat-actions">
                                    <button class="chat-action" id="reload-claude-btn">Reload</button>
                                    <button class="chat-action" id="open-claude-external-btn">Open External</button>
                                </div>
                            </div>
                            <div class="claude-embed-container" id="claude-embed-container">
                                <div class="claude-embed-placeholder">
                                    <p>Claude.ai Chat</p>
                                    <button class="tool-button primary" id="launch-claude-btn">Launch Claude.ai</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                </div>
            </section>

            <!-- Platforms Section -->
            <section class="platforms-section panel-section" id="panel-platforms">
                <div class="section-header panel-header">
                    <h2 class="section-title">Platforms</h2>
                    <button class="panel-toggle" id="toggle-platforms" aria-label="Toggle panel">‚ñº</button>
                </div>
                <div class="panel-content" id="content-platforms">
                <div class="platforms-grid">
                    <!-- Developer Workspace -->
                    <a href="./toolkits/developer.html" class="platform-card">
                        <h3 class="platform-title">Developer Workspace</h3>
                        <p class="platform-subtitle">Knomad Prime's Workspace</p>
                        <p class="platform-description">
                            Session management, script execution, and AI-assisted development.
                            Central control for file conversion, automation, and Claude integration.
                        </p>
                        <div class="platform-tags">
                            <span class="platform-tag">Claude</span>
                            <span class="platform-tag">Scripts</span>
                        </div>
                    </a>

                    <!-- Project Management -->
                    <a href="./toolkits/pm.html" class="platform-card">
                        <h3 class="platform-title">Project Management</h3>
                        <p class="platform-subtitle">User Workspace</p>
                        <p class="platform-description">
                            Integrated scheduling, cost tracking, and document control for federal construction contracts.
                            Connects to Primavera P6, Procore, and Corps of Engineers systems.
                        </p>
                        <div class="platform-tags">
                            <span class="platform-tag">Procore</span>
                            <span class="platform-tag">P6</span>
                            <span class="platform-tag">RMS</span>
                        </div>
                    </a>

                    <!-- Quality Control -->
                    <a href="./toolkits/qcm.html" class="platform-card">
                        <h3 class="platform-title">Quality Control</h3>
                        <p class="platform-subtitle">User Workspace</p>
                        <p class="platform-description">
                            Submittal processing, inspection documentation, and deficiency tracking.
                            Interfaces with RMS 3.0 and generates QC reports for USACE compliance.
                        </p>
                        <div class="platform-tags">
                            <span class="platform-tag">RMS 3.0</span>
                            <span class="platform-tag">QC Logs</span>
                        </div>
                    </a>

                    <!-- Traffic Studies Engineer -->
                    <a href="./toolkits/tse.html" class="platform-card">
                        <h3 class="platform-title">Traffic Studies</h3>
                        <p class="platform-subtitle">Engineer Workspace</p>
                        <p class="platform-description">
                            Guided workflow for traffic impact studies. Document management, trip generation,
                            capacity analysis, and jurisdiction-compliant report assembly.
                        </p>
                        <div class="platform-tags">
                            <span class="platform-tag">Synchro</span>
                            <span class="platform-tag">HCS</span>
                        </div>
                    </a>
                </div>
                </div>
            </section>

            <!-- Projects Section -->
            <section class="projects-section panel-section" id="panel-projects">
                <div class="section-header panel-header">
                    <h2 class="section-title">Projects</h2>
                    <button class="panel-toggle" id="toggle-projects" aria-label="Toggle panel">‚ñº</button>
                </div>
                <div class="panel-content" id="content-projects">
                <div class="projects-grid compact" id="active-projects-grid">
                    <div class="project-card compact project-status-active" onclick="selectProject(&#39;PRJ-2025-001&#39;)" style="cursor: pointer;">
                        <div class="project-name">SOUTHCOM Guatemala</div>
                        <div class="project-subtitle">Project Management</div>
                        <div class="project-details">
                            <span class="project-client">USACE</span>
                            <span class="project-status-label">Active</span>
                        </div>
                    </div>
                
                    <div class="project-card compact project-status-active" onclick="selectProject(&#39;PRJ-2025-002&#39;)" style="cursor: pointer;">
                        <div class="project-name">Grace Fellowship TIS</div>
                        <div class="project-subtitle">Traffic Study</div>
                        <div class="project-details">
                            <span class="project-client">Grace Fellowship Church</span>
                            <span class="project-status-label">Active</span>
                        </div>
                    </div>
                
                    <div class="project-card compact project-status-active" onclick="selectProject(&#39;PRJ-2025-003&#39;)" style="cursor: pointer;">
                        <div class="project-name">Base Housing - Kwajalein</div>
                        <div class="project-subtitle">Project Management</div>
                        <div class="project-details">
                            <span class="project-client">US Army</span>
                            <span class="project-status-label">Active</span>
                        </div>
                    </div>
                </div>
                </div>
            </section>

            <!-- Quick Tools Section -->
            <section class="quick-tools-section panel-section" id="panel-tools">
                <div class="section-header panel-header">
                    <h2 class="section-title">Quick Tools</h2>
                    <button class="panel-toggle" id="toggle-tools" aria-label="Toggle panel">‚ñº</button>
                </div>
                <div class="panel-content" id="content-tools">
                <div class="quick-tools-grid">
                    <!-- Office Apps -->
                    <div class="quick-tool" data-tooltip="Launch Microsoft Word" onclick="Hub.launchApp('word')">
                        <div class="quick-tool-icon">W</div>
                        <div class="quick-tool-label">Word</div>
                    </div>
                    <div class="quick-tool" data-tooltip="Launch Microsoft Excel" onclick="Hub.launchApp('excel')">
                        <div class="quick-tool-icon">X</div>
                        <div class="quick-tool-label">Excel</div>
                    </div>
                    <div class="quick-tool" data-tooltip="Launch Microsoft Teams" onclick="Hub.launchApp('teams')">
                        <div class="quick-tool-icon">T</div>
                        <div class="quick-tool-label">Teams</div>
                    </div>
                    <div class="quick-tool" data-tooltip="Launch Microsoft Outlook" onclick="Hub.launchApp('outlook')">
                        <div class="quick-tool-icon">O</div>
                        <div class="quick-tool-label">Outlook</div>
                    </div>
                    <div class="quick-tool" data-tooltip="Launch Adobe Acrobat" onclick="Hub.launchApp('adobe')">
                        <div class="quick-tool-icon">A</div>
                        <div class="quick-tool-label">Adobe</div>
                    </div>
                    <div class="quick-tool" data-tooltip="Launch Calculator" onclick="Hub.launchApp('calc')">
                        <div class="quick-tool-icon">üî¢</div>
                        <div class="quick-tool-label">Calc</div>
                    </div>
                    <div class="quick-tool" data-tooltip="Open Gmail in browser" onclick="Hub.launchApp('gmail')">
                        <div class="quick-tool-icon">‚úâ</div>
                        <div class="quick-tool-label">Gmail</div>
                    </div>
                    <!-- Trajanus Tools -->
                    <div class="quick-tool" data-tooltip="Ingest documents into Knowledge Base" onclick="Hub.openTool('kb-ingestion')">
                        <div class="quick-tool-icon">üì•</div>
                        <div class="quick-tool-label">KB Ingest</div>
                    </div>
                    <div class="quick-tool" data-tooltip="Convert Markdown to Google Docs" onclick="Hub.openTool('md-converter')">
                        <div class="quick-tool-icon">üìÑ</div>
                        <div class="quick-tool-label">MD Convert</div>
                    </div>
                    <div class="quick-tool" data-tooltip="Query the Knowledge Base" onclick="Hub.openTool('query-kb')">
                        <div class="quick-tool-icon">üîç</div>
                        <div class="quick-tool-label">Query KB</div>
                    </div>
                    <div class="quick-tool" data-tooltip="Extract YouTube video transcripts" onclick="Hub.openTool('youtube-transcript')">
                        <div class="quick-tool-icon">‚ñ∂</div>
                        <div class="quick-tool-label">YT Transcript</div>
                    </div>
                </div>
                </div>
            </section>

            <!-- Applications -->
            <section class="applications-section">
                <div class="section-header">
                    <h2 class="section-title">Applications</h2>
                </div>

                <div class="applications-grid">
                    <div class="app-category">
                        <h4>Federal &amp; DoD</h4>
                        <ul class="app-list">
                            <li><a href="#" onclick="Hub.openEmbedded('https://rms.usace.army.mil/', 'RMS 3.0'); return false;" class="app-link"><span class="app-link-icon">‚óÜ</span> RMS 3.0</a></li>
                            <li><a href="#" onclick="Hub.openEmbedded('https://cefms.usace.army.mil/', 'CEFMS'); return false;" class="app-link"><span class="app-link-icon">‚óÜ</span> CEFMS</a></li>
                            <li><a href="#" onclick="log('ENG Form 4025 coming soon...', 'info'); return false;" class="app-link"><span class="app-link-icon">‚óÜ</span> ENG Form 4025</a></li>
                            <li><a href="#" onclick="log('eCMS coming soon...', 'info'); return false;" class="app-link"><span class="app-link-icon">‚óÜ</span> eCMS</a></li>
                        </ul>
                    </div>

                    <div class="app-category">
                        <h4>Project Controls</h4>
                        <ul class="app-list">
                            <li><a href="#" onclick="log('Primavera P6 integration coming soon...', 'info'); return false;" class="app-link"><span class="app-link-icon">‚óÜ</span> Primavera P6</a></li>
                            <li><a href="#" onclick="Hub.openEmbedded('https://app.procore.com/', 'Procore'); return false;" class="app-link"><span class="app-link-icon">‚óÜ</span> Procore</a></li>
                            <li><a href="#" onclick="log('Oracle Unifier coming soon...', 'info'); return false;" class="app-link"><span class="app-link-icon">‚óÜ</span> Oracle Unifier</a></li>
                            <li><a href="#" onclick="log('Microsoft Project coming soon...', 'info'); return false;" class="app-link"><span class="app-link-icon">‚óÜ</span> Microsoft Project</a></li>
                        </ul>
                    </div>

                </div>
            </section>
        </main>

        <!-- Sticky Navigation Buttons -->
        <div class="sticky-nav">
            <button class="nav-btn" onclick="window.scrollTo({top: 0, behavior: &#39;smooth&#39;})" title="Return to Top">
                ‚Üë Top
            </button>
            <button class="nav-btn" onclick="returnToHub()" title="Back to Hub">
                ‚åÇ Hub
            </button>
        </div>

        <!-- Footer -->
        <footer class="footer">
            <span class="footer-item">Trajanus USA</span>
            <span class="footer-item">High Springs, FL</span>
            <span class="footer-item">v0.5.0</span>
            <span class="footer-item footer-status">
                <span class="status-dot active"></span>
                Connected
            </span>
        </footer>
    </div>

    <!-- New Project Modal -->
    <div class="modal-overlay" id="newProjectModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>NEW PROJECT</h3>
                <button class="modal-close" onclick="hideNewProjectModal()">√ó</button>
            </div>
            <div class="form-group">
                <label for="newProjectName">Project Name</label>
                <input type="text" id="newProjectName" placeholder="e.g., Grace Fellowship TIS">
            </div>
            <div class="form-group">
                <label for="newProjectPlatform">Platform</label>
                <select id="newProjectPlatform">
                    <option value="">Select platform...</option>
                    <option value="traffic">Traffic Studies</option>
                    <option value="qcm">Quality Control</option>
                    <option value="pm">Project Management</option>
                    <option value="dev">Development</option>
                </select>
            </div>
            <div class="form-group">
                <label for="newProjectClient">Client Name</label>
                <input type="text" id="newProjectClient" placeholder="e.g., Grace Fellowship Church">
            </div>
            <div class="form-group">
                <label for="newProjectCreator">Creator</label>
                <input type="text" id="newProjectCreator" value="Bill King">
            </div>
            <div class="modal-actions">
                <button class="btn-secondary" onclick="hideNewProjectModal()">Cancel</button>
                <button class="btn-primary" onclick="createProject()">Create Project</button>
            </div>
        </div>
    </div>

    <script>
        // Tauri API - Browser-safe check
        function getInvoke() {
            if (window.__TAURI__ && window.__TAURI__.core && window.__TAURI__.core.invoke) {
                return window.__TAURI__.core.invoke;
            }
            return null;
        }
        const invoke = getInvoke();

        // ============================================
        // LOGGING SYSTEM
        // ============================================
        function log(message, type = 'info') {
            const prefix = {
                'info': '[INFO]',
                'success': '[SUCCESS]',
                'warning': '[WARNING]',
                'error': '[ERROR]'
            };
            console.log(`${prefix[type] || '[LOG]'} ${message}`);

            // Show toast notification
            showToast(message, type);
        }

        function showToast(message, type = 'info') {
            // Remove existing toast
            const existing = document.querySelector('.toast');
            if (existing) existing.remove();

            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = message;
            toast.style.cssText = `
                position: fixed;
                bottom: 80px;
                right: 20px;
                padding: 12px 20px;
                background: var(--bg-card);
                border: 1px solid var(--accent-dim);
                border-left: 3px solid ${type === 'error' ? 'var(--status-error)' : type === 'success' ? 'var(--status-success)' : 'var(--accent)'};
                color: var(--text-white);
                border-radius: 4px;
                z-index: 9999;
                animation: slideIn 0.3s ease;
            `;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // ============================================
        // PROJECT STORE
        // ============================================
        const projectStore = {
            projects: [],

            create: function(projectData) {
                const id = `PRJ-${new Date().getFullYear()}-${String(this.projects.length + 1).padStart(3, '0')}`;
                const project = {
                    id: id,
                    ...projectData,
                    createdAt: new Date().toISOString(),
                    status: 'active',
                    documents: [],
                    lastModified: new Date().toISOString(),
                    deliveredAt: null
                };
                this.projects.push(project);
                this.save();
                return project;
            },

            getByPlatform: function(platform) {
                return this.projects.filter(p => p.platform === platform && p.status !== 'delivered');
            },

            getActive: function() {
                return this.projects.filter(p => p.status === 'active');
            },

            getDelivered: function() {
                return this.projects.filter(p => p.status === 'delivered');
            },

            markComplete: function(id) {
                const project = this.projects.find(p => p.id === id);
                if (project) {
                    project.status = 'complete';
                    project.lastModified = new Date().toISOString();
                    this.save();
                }
            },

            deliver: function(id) {
                const project = this.projects.find(p => p.id === id);
                if (project) {
                    project.status = 'delivered';
                    project.deliveredAt = new Date().toISOString();
                    this.save();
                }
            },

            save: function() {
                localStorage.setItem('trajanus_projects', JSON.stringify(this.projects));
            },

            load: function() {
                const stored = localStorage.getItem('trajanus_projects');
                if (stored) {
                    this.projects = JSON.parse(stored);
                } else {
                    // Initialize with default projects
                    this.projects = [
                        {
                            id: 'PRJ-2025-001',
                            name: 'SOUTHCOM Guatemala',
                            platform: 'pm',
                            creator: 'Bill King',
                            createdAt: '2025-01-01T00:00:00Z',
                            status: 'active',
                            client: 'USACE',
                            documents: [],
                            notes: 'Contract: W9127823R0034, Value: $47.2M',
                            lastModified: new Date().toISOString(),
                            deliveredAt: null
                        },
                        {
                            id: 'PRJ-2025-002',
                            name: 'Grace Fellowship TIS',
                            platform: 'traffic',
                            creator: 'Bill King',
                            createdAt: '2025-12-01T00:00:00Z',
                            status: 'active',
                            client: 'Grace Fellowship Church',
                            documents: [],
                            notes: 'Traffic Impact Study',
                            lastModified: new Date().toISOString(),
                            deliveredAt: null
                        },
                        {
                            id: 'PRJ-2025-003',
                            name: 'Base Housing - Kwajalein',
                            platform: 'pm',
                            creator: 'Bill King',
                            createdAt: '2025-06-01T00:00:00Z',
                            status: 'active',
                            client: 'US Army',
                            documents: [],
                            notes: 'Military Housing, Kwajalein Atoll',
                            lastModified: new Date().toISOString(),
                            deliveredAt: null
                        }
                    ];
                    this.save();
                }
            }
        };

        // ============================================
        // PROJECT UI FUNCTIONS
        // ============================================
        let currentProject = null;

        function formatDate(isoString) {
            if (!isoString) return 'N/A';
            const date = new Date(isoString);
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }

        function renderProjectList() {
            const platforms = ['traffic', 'qcm', 'pm', 'dev'];

            platforms.forEach(platform => {
                const projects = projectStore.getByPlatform(platform);
                const container = document.getElementById(`${platform}-projects`);
                const countEl = document.getElementById(`${platform}-count`);

                if (countEl) countEl.textContent = projects.length;

                if (container) {
                    container.innerHTML = projects.map(p => `
                        <div class="project-item ${p.status} ${currentProject && currentProject.id === p.id ? 'selected' : ''}"
                             id="project-${p.id}"
                             onclick="selectProject('${p.id}')">
                            <div class="project-name">${p.name}</div>
                            <div class="project-meta">${p.creator} &bull; ${formatDate(p.lastModified)}</div>
                        </div>
                    `).join('');
                }
            });

            // Delivered projects
            const delivered = projectStore.getDelivered();
            const deliveredCount = document.getElementById('delivered-count');
            const deliveredContainer = document.getElementById('delivered-projects');

            if (deliveredCount) deliveredCount.textContent = delivered.length;
            if (deliveredContainer) {
                deliveredContainer.innerHTML = delivered.map(p => `
                    <div class="project-item delivered" id="project-${p.id}" onclick="selectProject('${p.id}')">
                        <div class="project-name">${p.name}</div>
                        <div class="project-meta">Delivered ${formatDate(p.deliveredAt)}</div>
                    </div>
                `).join('');
            }

            // Render active projects grid
            renderActiveProjectsGrid();
        }

        function renderActiveProjectsGrid() {
            const activeProjects = projectStore.getActive().slice(0, 6);
            const grid = document.getElementById('active-projects-grid');

            if (!grid) return;

            if (activeProjects.length === 0) {
                grid.innerHTML = '<div class="project-card"><div class="project-name">No active projects</div><div class="project-subtitle">Create a new project to get started</div></div>';
                return;
            }

            grid.innerHTML = activeProjects.map(p => {
                const platformLabels = {
                    'traffic': 'Traffic Study',
                    'qcm': 'Quality Control',
                    'pm': 'Project Management',
                    'dev': 'Development'
                };
                // Status color class: active=green, pending=yellow, complete=blue
                const statusClass = p.status === 'active' ? 'project-status-active' :
                                   p.status === 'pending' ? 'project-status-pending' :
                                   p.status === 'complete' ? 'project-status-completed' : 'project-status-active';
                return `
                    <div class="project-card compact ${statusClass}" onclick="selectProject('${p.id}')" style="cursor: pointer;">
                        <div class="project-name">${p.name}</div>
                        <div class="project-subtitle">${platformLabels[p.platform] || p.platform}</div>
                        <div class="project-details">
                            <span class="project-client">${p.client || 'N/A'}</span>
                            <span class="project-status-label">${p.status.charAt(0).toUpperCase() + p.status.slice(1)}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function selectProject(projectId) {
            const project = projectStore.projects.find(p => p.id === projectId);
            if (!project) return;

            currentProject = project;

            // Update sidebar selection
            document.querySelectorAll('.project-item').forEach(el => el.classList.remove('selected'));
            const projectEl = document.getElementById(`project-${projectId}`);
            if (projectEl) projectEl.classList.add('selected');

            // Navigate to appropriate platform
            const platformUrls = {
                'traffic': 'toolkits/tse.html',
                'qcm': 'toolkits/qcm.html',
                'pm': 'toolkits/pm.html',
                'dev': 'toolkits/developer.html'
            };

            if (platformUrls[project.platform]) {
                log(`Opening project: ${project.name}`, 'success');
                // Store selected project for the platform page
                sessionStorage.setItem('currentProject', JSON.stringify(project));
                window.location.href = platformUrls[project.platform];
            }
        }

        function toggleSection(platform) {
            const list = document.getElementById(`${platform}-projects`);
            if (list) {
                list.style.display = list.style.display === 'none' ? 'block' : 'none';
            }
        }

        // ============================================
        // NEW PROJECT MODAL
        // ============================================
        function showNewProjectModal() {
            document.getElementById('newProjectModal').classList.add('visible');
        }

        function hideNewProjectModal() {
            document.getElementById('newProjectModal').classList.remove('visible');
            // Clear form
            document.getElementById('newProjectName').value = '';
            document.getElementById('newProjectPlatform').value = '';
            document.getElementById('newProjectClient').value = '';
        }

        function createProject() {
            const name = document.getElementById('newProjectName').value.trim();
            const platform = document.getElementById('newProjectPlatform').value;
            const client = document.getElementById('newProjectClient').value.trim();
            const creator = document.getElementById('newProjectCreator').value.trim() || 'Bill King';

            if (!name || !platform) {
                log('Project name and platform are required', 'error');
                return;
            }

            const project = projectStore.create({
                name: name,
                platform: platform,
                client: client,
                creator: creator,
                notes: ''
            });

            renderProjectList();
            hideNewProjectModal();

            log(`Created project: ${project.name} (${project.id})`, 'success');
        }

        // ============================================
        // HUB CONTROLLER
        // ============================================
        const Hub = {
            init() {
                this.updateGreeting();
                this.updateDate();
                projectStore.load();
                renderProjectList();
            },

            updateGreeting() {
                const hour = new Date().getHours();
                let greeting = 'Good evening';
                if (hour < 12) greeting = 'Good morning';
                else if (hour < 17) greeting = 'Good afternoon';
                document.getElementById('greeting-text').textContent = greeting;
            },

            updateDate() {
                const options = { year: 'numeric', month: 'long', day: 'numeric' };
                const date = new Date().toLocaleDateString('en-US', options);
                document.getElementById('current-date').textContent = date;
            },

            async launchTool(tool) {
                const SCRIPTS_PATH = 'G:\\My Drive\\00 - Trajanus USA\\00-Command-Center\\05-Scripts\\';

                switch(tool) {
                    case 'md-to-docs':
                        try {
                            await invoke('run_python_script', {
                                scriptPath: SCRIPTS_PATH + 'CONVERT_MD_TO_GDOCS_PERMANENT.py'
                            });
                            log('Launching MD to Docs converter...', 'success');
                        } catch(e) {
                            log('Failed to launch MD to Docs: ' + e, 'error');
                        }
                        break;
                    case 'xer-parse':
                        log('XER Parse - Coming soon...', 'info');
                        break;
                    case 'converter':
                        window.location.href = 'toolkits/developer.html';
                        break;
                    case 'browser':
                        try {
                            await invoke('run_python_script', {
                                scriptPath: SCRIPTS_PATH + 'SCRIPT_BROWSER.py'
                            });
                            log('Launching Script Browser...', 'success');
                        } catch(e) {
                            log('Script Browser not found', 'warning');
                        }
                        break;
                    default:
                        log(`Unknown tool: ${tool}`, 'warning');
                }
            },

            async launchApp(app) {
                const appPaths = {
                    'word': 'winword',
                    'excel': 'excel',
                    'teams': 'ms-teams:',
                    'outlook': 'outlook',
                    'adobe': 'acrord32',
                    'calc': 'calc',
                    'gmail': 'https://mail.google.com'
                };

                const path = appPaths[app];
                if (!path) {
                    log(`Unknown app: ${app}`, 'warning');
                    return;
                }

                // Get fresh invoke reference
                const tauriInvoke = getInvoke();
                if (!tauriInvoke) {
                    // Fallback for browser mode - open URLs in new tab
                    if (path.startsWith('http')) {
                        window.open(path, '_blank');
                        log(`Opened ${app} in browser`, 'success');
                    } else {
                        log(`${app} requires desktop app (Tauri not available)`, 'warning');
                    }
                    return;
                }

                try {
                    await tauriInvoke('open_path', { path: path });
                    log(`Launching ${app}...`, 'success');
                } catch(e) {
                    log(`Failed to launch ${app}: ${e}`, 'error');
                }
            },

            // Open external URL in embedded modal webview (uses WindowManager)
            async openEmbedded(url, title) {
                try {
                    if (!invoke) {
                        log('Tauri not available - cannot embed external sites', 'warning');
                        return;
                    }
                    // Show loading toast
                    log(`Opening ${title}...`, 'info');

                    // Use WindowManager for consistent positioning
                    const windowId = `embedded-${title.toLowerCase().replace(/\s+/g, '-')}`;
                    const contentHTML = `
                        <div class="embedded-modal-body" id="embedded-container">
                            <div class="embedded-loading">Loading ${title}...</div>
                        </div>
                    `;
                    WindowManager.open(windowId, title, contentHTML);

                    // Store reference for closeEmbedded
                    this._currentEmbeddedId = windowId;

                    // Small delay to ensure window is rendered
                    await new Promise(r => setTimeout(r, 50));

                    // Get container position for webview
                    const container = document.getElementById('embedded-container');
                    const rect = container.getBoundingClientRect();

                    // Invoke Tauri to embed the URL
                    await invoke('embed_url', {
                        url: url,
                        x: rect.left,
                        y: rect.top,
                        width: rect.width,
                        height: rect.height
                    });

                    log(`${title} opened in embedded view`, 'success');
                } catch(e) {
                    log(`Failed to embed ${title}: ${e}`, 'error');
                    this.closeEmbedded();
                }
            },

            closeEmbedded() {
                if (this._currentEmbeddedId) {
                    WindowManager.close(this._currentEmbeddedId);
                    this._currentEmbeddedId = null;
                }
                if (invoke) {
                    invoke('close_embedded').catch(() => {});
                }
            },

            // Open Trajanus tool windows
            openTool(toolId) {
                const tools = {
                    'kb-ingestion': {
                        title: 'KB Ingestion',
                        content: `
                            <div class="tool-panel">
                                <div class="tool-section">
                                    <h3>Knowledge Base Ingestion</h3>
                                    <p>Ingest documents into the Trajanus Knowledge Base.</p>
                                </div>
                                <div class="tool-section">
                                    <label>Source Folder</label>
                                    <div class="input-row">
                                        <input type="text" id="kb-source-path" placeholder="Select folder..." readonly>
                                        <button class="tool-btn" onclick="Hub.browseFolder('kb-source-path')">Browse</button>
                                    </div>
                                </div>
                                <div class="tool-section">
                                    <label>Category</label>
                                    <select id="kb-category">
                                        <option value="session">Session Files</option>
                                        <option value="protocol">Protocols</option>
                                        <option value="reference">Reference Docs</option>
                                        <option value="code">Code Examples</option>
                                    </select>
                                </div>
                                <div class="tool-actions">
                                    <button class="tool-btn primary" onclick="Hub.runKBIngestion()">Start Ingestion</button>
                                </div>
                                <div class="tool-output" id="kb-output"></div>
                            </div>
                        `
                    },
                    'md-converter': {
                        title: 'MD Converter',
                        content: `
                            <div class="tool-panel">
                                <div class="tool-section">
                                    <h3>Markdown to Google Docs Converter</h3>
                                    <p>Convert .md files to Google Docs format.</p>
                                </div>
                                <div class="tool-section">
                                    <label>Source File or Folder</label>
                                    <div class="input-row">
                                        <input type="text" id="md-source-path" placeholder="Select file or folder..." readonly>
                                        <button class="tool-btn" onclick="Hub.browseFolder('md-source-path')">Browse</button>
                                    </div>
                                </div>
                                <div class="tool-actions">
                                    <button class="tool-btn primary" onclick="Hub.runMDConverter()">Convert</button>
                                </div>
                                <div class="tool-output" id="md-output"></div>
                            </div>
                        `
                    },
                    'query-kb': {
                        title: 'Query KB',
                        content: `
                            <div class="tool-panel">
                                <div class="tool-section">
                                    <h3>Query Knowledge Base</h3>
                                    <p>Search the Trajanus Knowledge Base.</p>
                                </div>
                                <div class="tool-section">
                                    <label>Search Query</label>
                                    <input type="text" id="kb-query" placeholder="Enter search terms...">
                                </div>
                                <div class="tool-section">
                                    <label>Max Results</label>
                                    <select id="kb-max-results">
                                        <option value="5">5</option>
                                        <option value="10" selected>10</option>
                                        <option value="20">20</option>
                                    </select>
                                </div>
                                <div class="tool-actions">
                                    <button class="tool-btn primary" onclick="Hub.runKBQuery()">Search</button>
                                </div>
                                <div class="tool-output" id="query-output"></div>
                            </div>
                        `
                    },
                    'youtube-transcript': {
                        title: 'YouTube Transcript',
                        content: `
                            <div class="tool-panel">
                                <div class="tool-section">
                                    <h3>YouTube Transcript Extractor</h3>
                                    <p>Extract transcripts from YouTube videos.</p>
                                </div>
                                <div class="tool-section">
                                    <label>YouTube URL</label>
                                    <input type="text" id="yt-url" placeholder="https://youtube.com/watch?v=...">
                                </div>
                                <div class="tool-actions">
                                    <button class="tool-btn primary" onclick="Hub.runYTTranscript()">Extract Transcript</button>
                                </div>
                                <div class="tool-output" id="yt-output"></div>
                            </div>
                        `
                    }
                };

                const tool = tools[toolId];
                if (!tool) {
                    log(`Unknown tool: ${toolId}`, 'warning');
                    return;
                }

                WindowManager.open(toolId, tool.title, tool.content);
                log(`Opened ${tool.title}`, 'success');
            },

            // Tool execution methods
            async browseFolder(inputId) {
                // For now, prompt user for path - full file picker requires Tauri dialog plugin
                const path = prompt('Enter folder path:');
                if (path) {
                    document.getElementById(inputId).value = path;
                }
            },

            async runKBIngestion() {
                const sourcePath = document.getElementById('kb-source-path')?.value;
                const category = document.getElementById('kb-category')?.value;
                const output = document.getElementById('kb-output');

                if (!sourcePath) {
                    log('Please select a source folder', 'warning');
                    return;
                }

                const tauriInvoke = getInvoke();
                if (!tauriInvoke) {
                    output.innerHTML = '<div class="error">Requires desktop app (Tauri not available)</div>';
                    log('KB Ingestion requires desktop app', 'warning');
                    return;
                }

                output.innerHTML = '<div class="loading">Processing...</div>';

                try {
                    const scriptPath = 'G:\\My Drive\\00 - Trajanus USA\\00-Command-Center\\05-Scripts\\BATCH_INGEST_TOOL.py';
                    const result = await tauriInvoke('run_python_script', {
                        scriptPath: scriptPath,
                        targetPath: sourcePath
                    });
                    output.innerHTML = `<div class="success">Ingestion complete: ${result}</div>`;
                    log('KB Ingestion complete', 'success');
                } catch (e) {
                    output.innerHTML = `<div class="error">Error: ${e}</div>`;
                    log('KB Ingestion failed: ' + e, 'error');
                }
            },

            async runMDConverter() {
                const sourcePath = document.getElementById('md-source-path')?.value;
                const output = document.getElementById('md-output');

                if (!sourcePath) {
                    log('Please select a source file or folder', 'warning');
                    return;
                }

                const tauriInvoke = getInvoke();
                if (!tauriInvoke) {
                    output.innerHTML = '<div class="error">Requires desktop app (Tauri not available)</div>';
                    log('MD Converter requires desktop app', 'warning');
                    return;
                }

                output.innerHTML = '<div class="loading">Converting...</div>';

                try {
                    const scriptPath = 'G:\\My Drive\\00 - Trajanus USA\\00-Command-Center\\05-Scripts\\CONVERT_MD_TO_GDOCS_PERMANENT.py';
                    const result = await tauriInvoke('run_python_script', {
                        scriptPath: scriptPath,
                        targetPath: sourcePath
                    });
                    output.innerHTML = `<div class="success">Conversion complete: ${result}</div>`;
                    log('MD Converter complete', 'success');
                } catch (e) {
                    output.innerHTML = `<div class="error">Error: ${e}</div>`;
                    log('MD Converter failed: ' + e, 'error');
                }
            },

            async runKBQuery() {
                const query = document.getElementById('kb-query')?.value;
                const maxResults = document.getElementById('kb-max-results')?.value || 10;
                const output = document.getElementById('query-output');

                if (!query) {
                    log('Please enter a search query', 'warning');
                    return;
                }

                const tauriInvoke = getInvoke();
                if (!tauriInvoke) {
                    output.innerHTML = '<div class="error">Requires desktop app (Tauri not available)</div>';
                    log('KB Query requires desktop app', 'warning');
                    return;
                }

                output.innerHTML = '<div class="loading">Searching...</div>';

                try {
                    const scriptPath = 'G:\\My Drive\\00 - Trajanus USA\\00-Command-Center\\05-Scripts\\QUERY_KB_TOOL.py';
                    const result = await tauriInvoke('run_python_script', {
                        scriptPath: scriptPath,
                        targetPath: query
                    });
                    output.innerHTML = `<div class="success">${result}</div>`;
                    log('KB Query complete', 'success');
                } catch (e) {
                    output.innerHTML = `<div class="error">Error: ${e}</div>`;
                    log('KB Query failed: ' + e, 'error');
                }
            },

            async runYTTranscript() {
                const url = document.getElementById('yt-url')?.value;
                const output = document.getElementById('yt-output');

                if (!url) {
                    log('Please enter a YouTube URL', 'warning');
                    return;
                }

                const tauriInvoke = getInvoke();
                if (!tauriInvoke) {
                    output.innerHTML = '<div class="error">Requires desktop app (Tauri not available)</div>';
                    log('YT Transcript requires desktop app', 'warning');
                    return;
                }

                output.innerHTML = '<div class="loading">Extracting transcript...</div>';

                try {
                    const scriptPath = 'G:\\My Drive\\00 - Trajanus USA\\00-Command-Center\\05-Scripts\\YOUTUBE_TRANSCRIPT_TOOL.py';
                    const result = await tauriInvoke('run_python_script', {
                        scriptPath: scriptPath,
                        targetPath: url
                    });
                    output.innerHTML = `<div class="success">${result}</div>`;
                    log('YT Transcript complete', 'success');
                } catch (e) {
                    output.innerHTML = `<div class="error">Error: ${e}</div>`;
                    log('YT Transcript failed: ' + e, 'error');
                }
            }
        };

        // ============================================
        // CLAUDE CHAT - Via Tauri Backend
        // ============================================
        const ChatAssistant = {
            systemPrompt: 'You are the Trajanus Enterprise Hub assistant. Help users navigate the application and understand its features. Respond conversationally with complete sentences, proper punctuation, and paragraph formatting. Never use bullet points or numbered lists unless the user explicitly requests a list. Be warm, professional, and helpful. The app has these main areas: Developer Workspace (for scripts and Claude integration), Project Management (PM Toolkit for schedules and contracts), Quality Control (QCM Toolkit for submittals and inspections), and Traffic Studies (for traffic impact analysis). Users can access these by clicking the platform cards on the landing page or using the sidebar.',
            conversationHistory: [],

            async send(userMessage) {
                const tauriInvoke = getInvoke();
                if (!tauriInvoke) {
                    throw new Error('Tauri not available');
                }

                // Build context with system prompt and conversation history
                let context = this.systemPrompt;
                if (this.conversationHistory.length > 0) {
                    context += '\n\nPrevious conversation:\n';
                    for (const msg of this.conversationHistory) {
                        context += `${msg.role}: ${msg.content}\n`;
                    }
                }

                try {
                    const response = await tauriInvoke('chat_with_claude', {
                        message: userMessage,
                        context: context
                    });

                    // Store in history for context
                    this.conversationHistory.push({ role: 'User', content: userMessage });
                    this.conversationHistory.push({ role: 'Assistant', content: response });

                    // Keep history manageable (last 10 exchanges)
                    if (this.conversationHistory.length > 20) {
                        this.conversationHistory = this.conversationHistory.slice(-20);
                    }

                    return response;
                } catch (error) {
                    console.error('Chat error:', error);
                    throw error;
                }
            },

            clear() {
                this.conversationHistory = [];
            }
        };

        function addMessage(content, role) {
            const messagesDiv = document.getElementById('chat-messages');
            const welcome = messagesDiv.querySelector('.chat-welcome');
            if (welcome) welcome.remove();

            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;
            messageDiv.textContent = content;
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function showTypingIndicator() {
            const messagesDiv = document.getElementById('chat-messages');
            const typing = document.createElement('div');
            typing.className = 'typing-indicator';
            typing.id = 'typing-indicator';
            typing.innerHTML = '<span></span><span></span><span></span>';
            messagesDiv.appendChild(typing);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function hideTypingIndicator() {
            const typing = document.getElementById('typing-indicator');
            if (typing) typing.remove();
        }

        async function sendMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            if (!message) return;

            input.value = '';
            addMessage(message, 'user');
            showTypingIndicator();

            try {
                const response = await ChatAssistant.send(message);
                hideTypingIndicator();
                addMessage(response, 'assistant');
            } catch (error) {
                hideTypingIndicator();
                addMessage('Error: ' + error.message, 'assistant');
                log('Chat error: ' + error.message, 'error');
            }
        }

        function handleChatKeydown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        function clearChat() {
            ChatAssistant.clear();
            const messagesDiv = document.getElementById('chat-messages');
            messagesDiv.innerHTML = '<div class="chat-welcome">Ask Trajanus anything...</div>';
            log('Chat cleared', 'info');
        }

        // Return to Hub function
        function returnToHub() {
            // If on a sub-page, navigate to main hub
            if (window.location.pathname.includes('toolkits/')) {
                window.location.href = '../index.html';
            } else {
                // Hide all workspaces/platforms
                document.querySelectorAll('.platform-workspace, .workspace-view').forEach(ws => {
                    ws.style.display = 'none';
                });
                // Show main hub/landing
                const hub = document.getElementById('main-hub') || document.getElementById('landing-page') || document.querySelector('.main-content');
                if (hub) hub.style.display = 'block';
                window.scrollTo({top: 0, behavior: 'smooth'});
                log('Returned to Hub', 'info');
            }
        }

        // ============================================
        // CLAUDE.AI EMBED
        // ============================================
        let claudeEmbedActive = false;

        async function launchClaudeEmbed() {
            const container = document.getElementById('claude-embed-container');
            if (!container) return;

            const tauriInvoke = getInvoke();
            if (!tauriInvoke) {
                log('Tauri not available - opening in browser', 'warning');
                window.open('https://claude.ai', '_blank');
                return;
            }

            try {
                log('Launching Claude.ai embed...', 'info');

                // Show loading state
                container.innerHTML = '<div class="claude-loading">Loading Claude.ai...</div>';

                // Get container position for webview
                const rect = container.getBoundingClientRect();

                // Use existing embed_claude command
                await tauriInvoke('embed_claude', {
                    x: rect.left,
                    y: rect.top,
                    width: rect.width,
                    height: rect.height
                });

                claudeEmbedActive = true;
                container.innerHTML = '<div class="claude-embed-active">Claude.ai embedded above</div>';
                log('Claude.ai embed launched', 'success');

                // Add scroll listener to keep webview positioned
                window.addEventListener('scroll', updateClaudePosition);
                window.addEventListener('resize', updateClaudePosition);
            } catch (e) {
                log('Failed to embed Claude.ai: ' + e, 'error');
                container.innerHTML = `
                    <div class="claude-embed-placeholder">
                        <p>Could not embed Claude.ai</p>
                        <button class="tool-button primary" id="launch-claude-btn">Try Again</button>
                    </div>
                `;
                // Re-attach event listener
                document.getElementById('launch-claude-btn')?.addEventListener('click', launchClaudeEmbed);
            }
        }

        function updateClaudePosition() {
            if (!claudeEmbedActive) return;
            const container = document.getElementById('claude-embed-container');
            if (!container) return;

            const tauriInvoke = getInvoke();
            if (!tauriInvoke) return;

            const rect = container.getBoundingClientRect();
            tauriInvoke('resize_embedded', {
                x: rect.left,
                y: rect.top,
                width: rect.width,
                height: rect.height
            }).catch(() => {});
        }

        async function reloadClaudeEmbed() {
            const tauriInvoke = getInvoke();
            if (!tauriInvoke) return;

            // Close and reopen
            try {
                await tauriInvoke('close_embedded');
                claudeEmbedActive = false;
                setTimeout(() => launchClaudeEmbed(), 100);
            } catch (e) {
                log('Failed to reload: ' + e, 'error');
            }
        }

        async function closeClaudeEmbed() {
            const tauriInvoke = getInvoke();
            if (!tauriInvoke) return;

            try {
                await tauriInvoke('close_embedded');
                claudeEmbedActive = false;
                const container = document.getElementById('claude-embed-container');
                if (container) {
                    container.innerHTML = `
                        <div class="claude-embed-placeholder">
                            <p>Claude.ai Chat</p>
                            <button class="tool-button primary" id="launch-claude-btn">Launch Claude.ai</button>
                        </div>
                    `;
                    document.getElementById('launch-claude-btn')?.addEventListener('click', launchClaudeEmbed);
                }
            } catch (e) {
                log('Failed to close: ' + e, 'error');
            }
        }

        // ============================================
        // QUAD CHAT MODE - Multiple Claude.ai Webviews
        // ============================================
        let quadChatEnabled = false;

        async function toggleQuadChat() {
            const btn = document.getElementById('quad-chat-toggle');

            try {
                if (!quadChatEnabled) {
                    // Enable Quad Chat Mode
                    log('Enabling Quad Chat Mode...', 'info');
                    const result = await invoke('enable_quad_chat');
                    log(result, 'success');
                    quadChatEnabled = true;
                    btn.classList.add('active');
                    btn.title = 'Exit Quad Chat Mode';
                } else {
                    // Disable Quad Chat Mode
                    log('Disabling Quad Chat Mode...', 'info');
                    const result = await invoke('disable_quad_chat');
                    log(result, 'success');
                    quadChatEnabled = false;
                    btn.classList.remove('active');
                    btn.title = 'Quad Chat Mode';
                }
            } catch (e) {
                log('Quad Chat Error: ' + e, 'error');
            }
        }

        // Check if quad chat is already enabled on page load
        async function checkQuadChatStatus() {
            try {
                quadChatEnabled = await invoke('is_quad_chat_enabled');
                const btn = document.getElementById('quad-chat-toggle');
                if (quadChatEnabled && btn) {
                    btn.classList.add('active');
                    btn.title = 'Exit Quad Chat Mode';
                }
            } catch (e) {
                // Ignore - command may not exist in older versions
            }
        }

        // ============================================
        // NAVIGATION - Close embedded webviews before leaving
        // ============================================
        window.addEventListener('beforeunload', async () => {
            const tauriInvoke = getInvoke();
            if (tauriInvoke && claudeEmbedActive) {
                try {
                    await tauriInvoke('close_embedded');
                } catch (e) {
                    console.log('Error closing embedded on unload:', e);
                }
            }
        });

        // Intercept all navigation links to close webviews first
        document.addEventListener('click', async (e) => {
            const link = e.target.closest('a[href]');
            if (link && !link.href.includes('#') && claudeEmbedActive) {
                e.preventDefault();
                const tauriInvoke = getInvoke();
                if (tauriInvoke) {
                    try {
                        await tauriInvoke('close_embedded');
                        claudeEmbedActive = false;
                    } catch (err) {
                        console.log('Error closing embedded:', err);
                    }
                }
                // Navigate after closing
                window.location.href = link.href;
            }
        });

        // ============================================
        // TRAJANUS WINDOW MANAGER - Phase 1.2
        // Ensures ALL windows open in SAME position, EVERY time
        // ============================================

        const WindowManager = {
            // Standard dimensions for ALL windows
            defaultSize: { width: '90%', height: '90%' },
            defaultPosition: { top: '50%', left: '50%', transform: 'translate(-50%, -50%)' },
            zIndexBase: 1000,
            activeWindows: [],

            /**
             * Opens a Trajanus-styled window with branded header
             * @param {string} id - Unique identifier for the window
             * @param {string} title - Title displayed in the hero bar
             * @param {string} content - HTML content for the window body
             * @param {object} options - Optional overrides (rarely used)
             * @returns {HTMLElement} The window element
             */
            open(id, title, content, options = {}) {
                // Remove existing window with same ID if present
                this.close(id);

                // Calculate z-index for this window
                const zIndex = this.zIndexBase + (this.activeWindows.length * 2);

                // Create overlay
                const overlay = document.createElement('div');
                overlay.className = 'trajanus-window-overlay';
                overlay.id = `trajanus-overlay-${id}`;
                overlay.style.zIndex = zIndex;
                overlay.addEventListener('click', () => this.close(id));

                // Create window with ENFORCED position and size
                const win = document.createElement('div');
                win.className = 'trajanus-window';
                win.id = `window-${id}`;

                // ENFORCE position - ALWAYS centered, ALWAYS 90%
                win.style.cssText = `
                    position: fixed;
                    top: ${this.defaultPosition.top};
                    left: ${this.defaultPosition.left};
                    transform: ${this.defaultPosition.transform};
                    width: ${this.defaultSize.width};
                    height: ${this.defaultSize.height};
                    z-index: ${zIndex + 1};
                `;

                win.innerHTML = `
                    <div class="trajanus-window-hero">
                        <div class="trajanus-window-brand">
                            <span class="trajanus-mark">‚ñ™</span>
                            <span class="trajanus-title">TRAJANUS</span>
                            <span class="trajanus-separator">|</span>
                            <span class="window-title">${title}</span>
                        </div>
                        <div class="trajanus-window-controls">
                            <button class="win-ctrl minimize" title="Minimize">_</button>
                            <button class="win-ctrl maximize" title="Maximize">‚ñ°</button>
                            <button class="win-ctrl close" title="Close">√ó</button>
                        </div>
                    </div>
                    <div class="trajanus-window-content">
                        ${content}
                    </div>
                `;

                // Add to DOM
                document.body.appendChild(overlay);
                document.body.appendChild(win);

                // Track this window
                this.activeWindows.push({ id, title, overlay, win, zIndex });

                // Attach event handlers
                win.querySelector('.win-ctrl.close').addEventListener('click', () => this.close(id));
                win.addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.bringToFront(id);
                });

                // Activate with slight delay for animation
                requestAnimationFrame(() => {
                    overlay.classList.add('active');
                    win.classList.add('active');
                });

                log(`Opened window: ${title}`, 'info');
                return win;
            },

            /**
             * Closes a window by ID
             * @param {string} id - The window identifier
             */
            close(id) {
                const overlay = document.getElementById(`trajanus-overlay-${id}`);
                const win = document.getElementById(`window-${id}`);

                if (overlay) {
                    overlay.classList.remove('active');
                    setTimeout(() => overlay.remove(), 200);
                }

                if (win) {
                    win.classList.remove('active');
                    setTimeout(() => win.remove(), 200);
                    log(`Closed window: ${id}`, 'info');
                }

                // Remove from tracking array
                this.activeWindows = this.activeWindows.filter(w => w.id !== id);
            },

            /**
             * Brings a window to the front (highest z-index)
             * @param {string} id - The window identifier
             */
            bringToFront(id) {
                const windowData = this.activeWindows.find(w => w.id === id);
                if (!windowData) return;

                // Get max z-index from all windows
                const maxZ = Math.max(...this.activeWindows.map(w => w.zIndex), this.zIndexBase);
                const newZ = maxZ + 2;

                // Update z-index
                windowData.zIndex = newZ;
                windowData.overlay.style.zIndex = newZ;
                windowData.win.style.zIndex = newZ + 1;
            },

            /**
             * Closes all open windows
             */
            closeAll() {
                // Create copy of array since close() modifies it
                const windowIds = this.activeWindows.map(w => w.id);
                windowIds.forEach(id => this.close(id));
                log('Closed all windows', 'info');
            },

            /**
             * Gets list of active window IDs
             * @returns {string[]} Array of window IDs
             */
            getActiveWindows() {
                return this.activeWindows.map(w => w.id);
            }
        };

        // Legacy function aliases for backward compatibility
        function openTrajanusWindow(id, title, contentHTML) {
            return WindowManager.open(id, title, contentHTML);
        }

        function closeTrajanusWindow(id) {
            WindowManager.close(id);
        }

        // ============================================
        // INITIALIZATION
        // ============================================
        document.addEventListener('DOMContentLoaded', () => {
            Hub.init();

            // Check quad chat status on load
            checkQuadChatStatus();

            // Manually attach chat event handlers (inline onclick blocked by CSP)
            const sendBtn = document.getElementById('send-chat-btn');
            const chatInput = document.getElementById('chat-input');
            const clearBtn = document.getElementById('clear-chat-btn');

            if (sendBtn) {
                sendBtn.addEventListener('click', sendMessage);
            }

            if (chatInput) {
                chatInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendMessage();
                    }
                });
            }

            if (clearBtn) {
                clearBtn.addEventListener('click', clearChat);
            }

            // Claude.ai embed handlers
            const launchClaudeBtn = document.getElementById('launch-claude-btn');
            const reloadClaudeBtn = document.getElementById('reload-claude-btn');
            const openExternalBtn = document.getElementById('open-claude-external-btn');

            if (launchClaudeBtn) {
                launchClaudeBtn.addEventListener('click', launchClaudeEmbed);
            }

            if (reloadClaudeBtn) {
                reloadClaudeBtn.addEventListener('click', reloadClaudeEmbed);
            }

            if (openExternalBtn) {
                openExternalBtn.addEventListener('click', () => {
                    const tauriInvoke = getInvoke();
                    if (tauriInvoke) {
                        tauriInvoke('open_path', { path: 'https://claude.ai' });
                    }
                });
            }

            // Panel toggle handlers
            const panels = ['ai', 'platforms', 'projects', 'tools'];
            panels.forEach(panelId => {
                const toggleBtn = document.getElementById(`toggle-${panelId}`);
                const panel = document.getElementById(`panel-${panelId}`);
                const header = panel?.querySelector('.panel-header');

                if (toggleBtn && panel) {
                    // Click on toggle button
                    toggleBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        panel.classList.toggle('collapsed');
                    });

                    // Click on header also toggles
                    if (header) {
                        header.addEventListener('click', () => {
                            panel.classList.toggle('collapsed');
                        });
                    }
                }
            });
        });
    </script>

    <style>
        /* Toast animation */
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Quad Chat Button Styles */
        .quad-chat-btn {
            font-size: 1.2rem;
            font-weight: bold;
        }

        .quad-chat-btn.active {
            background: linear-gradient(180deg, #2a4a6a 0%, #1a2d42 100%) !important;
            border-color: #4CAF50 !important;
            color: #4CAF50 !important;
            box-shadow: 0 0 8px rgba(76, 175, 80, 0.4);
        }

        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
           TRAJANUS WINDOW FRAME COMPONENT - BLACK/SILVER
           Colors: #c0c0c0 silver, #1a1a1a background
           ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

        .trajanus-window-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 999;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s ease, visibility 0.2s ease;
        }

        .trajanus-window-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .trajanus-window {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            height: 90%;
            background: #1a1a1a;
            border: 2px solid #c0c0c0;
            border-radius: 8px;
            box-shadow: 0 0 40px rgba(192, 192, 192, 0.3), 0 20px 60px rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s ease, visibility 0.2s ease;
        }

        .trajanus-window.active {
            opacity: 1;
            visibility: visible;
        }

        .trajanus-window-hero {
            height: 36px;
            max-height: 36px;
            min-height: 36px;
            background: linear-gradient(180deg, #3d3d3d 0%, #2d2d2d 100%);
            border-bottom: 1px solid #c0c0c0;
            border-radius: 6px 6px 0 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 12px;
            flex-shrink: 0;
        }

        .trajanus-window-brand {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #c0c0c0;
            font-family: 'Segoe UI', sans-serif;
        }

        .trajanus-mark {
            font-size: 10px;
            color: #c0c0c0;
        }

        .trajanus-title {
            font-size: 11px;
            font-weight: 700;
            letter-spacing: 1px;
            color: #e0e0e0;
        }

        .trajanus-separator {
            font-size: 11px;
            color: #808080;
            margin: 0 4px;
        }

        .window-title {
            font-size: 11px;
            font-weight: 600;
            color: #e0e0e0;
        }

        .trajanus-window-controls {
            display: flex;
            gap: 6px;
        }

        .trajanus-window-controls .win-ctrl {
            width: 24px;
            height: 24px;
            border: none;
            border-radius: 4px;
            background: rgba(45, 45, 45, 0.2);
            color: #2d2d2d;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.15s ease;
        }

        .trajanus-window-controls .win-ctrl:hover {
            background: rgba(45, 45, 45, 0.35);
        }

        .trajanus-window-controls .win-ctrl.close:hover {
            background: #c0392b;
            color: #fff;
        }

        .trajanus-window-content {
            flex: 1;
            overflow: auto;
            padding: 16px;
            background: #2d2d2d;
            border-radius: 0 0 6px 6px;
            color: #e0e0e0;
        }

        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
           TOOL PANEL STYLES - BLACK/SILVER
           Silver: #c0c0c0, Black: #1a1a1a, Panel: #2d2d2d
           ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

        .tool-panel {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .tool-section {
            background: #2d2d2d;
            padding: 16px;
            border-radius: 6px;
            border: 1px solid #4a4a4a;
        }

        .tool-section h3 {
            color: #c0c0c0;
            margin: 0 0 8px 0;
            font-size: 16px;
            font-weight: 600;
        }

        .tool-section p {
            color: #b0b0b0;
            margin: 0;
            font-size: 14px;
        }

        .tool-section label {
            display: block;
            color: #c0c0c0;
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .tool-section input,
        .tool-section select {
            width: 100%;
            padding: 10px 12px;
            background: #1a1a1a;
            border: 1px solid #4a4a4a;
            border-radius: 4px;
            color: #ffffff;
            font-size: 14px;
        }

        .tool-section input:focus,
        .tool-section select:focus {
            outline: none;
            border-color: #c0c0c0;
        }

        .tool-section select option {
            background: #1a1a1a;
            color: #ffffff;
        }

        .input-row {
            display: flex;
            gap: 8px;
        }

        .input-row input {
            flex: 1;
        }

        .tool-btn {
            padding: 10px 20px;
            border: 1px solid #4a4a4a;
            border-radius: 4px;
            background: #2d2d2d;
            color: #ffffff;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.15s ease;
        }

        .tool-btn:hover {
            background: #3d3d3d;
            border-color: #c0c0c0;
        }

        .tool-btn.primary {
            background: #c0c0c0;
            color: #1a1a1a;
            border-color: #c0c0c0;
            font-weight: 600;
        }

        .tool-btn.primary:hover {
            background: #e0e0e0;
        }

        .tool-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .tool-output {
            background: #1a1a1a;
            border: 1px solid #3d3d3d;
            border-radius: 4px;
            padding: 16px;
            min-height: 100px;
            max-height: 300px;
            overflow: auto;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 13px;
        }

        .tool-output .loading {
            color: #c0c0c0;
        }

        .tool-output .success {
            color: #4ade80;
        }

        .tool-output .error {
            color: #f87171;
        }

        /* Tooltip styles for buttons */
        [data-tooltip] {
            position: relative;
        }

        [data-tooltip]:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            padding: 6px 10px;
            background: #1d1d1d;
            color: #ffffff;
            font-size: 12px;
            border-radius: 4px;
            white-space: nowrap;
            z-index: 9999;
            margin-bottom: 6px;
            border: 1px solid #c0c0c0;
        }

        [data-tooltip]:hover::before {
            content: '';
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: #c0c0c0;
            z-index: 9999;
        }
    </style>


</body></html>